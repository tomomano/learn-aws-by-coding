<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="真野 智之 (Tomoyuki Mano) &lt;tomoyukimano@gmail.com&gt;">
<title>コードで学ぶAWS入門</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>コードで学ぶAWS入門</h1>
<div class="details">
<span id="author" class="author">真野 智之 (Tomoyuki Mano) &lt;tomoyukimano@gmail.com&gt;</span><br>
<span id="revnumber">version 1.0,</span>
<span id="revdate">2021-06-14</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_はじめに">1. はじめに</a>
<ul class="sectlevel2">
<li><a href="#_本書の目的内容">1.1. 本書の目的・内容</a></li>
<li><a href="#_本書のフィロソフィー">1.2. 本書のフィロソフィー</a></li>
<li><a href="#aws_account">1.3. AWSアカウント</a></li>
<li><a href="#environments">1.4. 環境構築</a></li>
<li><a href="#_前提知識">1.5. 前提知識</a></li>
<li><a href="#_講義に関連する資料">1.6. 講義に関連する資料</a></li>
<li><a href="#_本書で使用するノーテーションなど">1.7. 本書で使用するノーテーションなど</a></li>
</ul>
</li>
<li><a href="#chap_cloud_basics">2. クラウド概論</a>
<ul class="sectlevel2">
<li><a href="#_クラウドとは">2.1. クラウドとは？</a></li>
<li><a href="#_なぜクラウドを使うのか">2.2. なぜクラウドを使うのか？</a></li>
</ul>
</li>
<li><a href="#sec_aws_general_introduction">3. AWS入門</a>
<ul class="sectlevel2">
<li><a href="#_awsとは">3.1. AWSとは？</a></li>
<li><a href="#_awsの機能サービス">3.2. AWSの機能・サービス</a></li>
<li><a href="#_region_と_availability_zone">3.3. Region と Availability Zone</a></li>
<li><a href="#_awsでのクラウド開発">3.4. AWSでのクラウド開発</a></li>
<li><a href="#sec:intro_cloudformation">3.5. CloudFormation と AWS CDK</a></li>
</ul>
</li>
<li><a href="#sec_first_ec2">4. Hands-on #1: 初めてのEC2インスタンスを起動する</a>
<ul class="sectlevel2">
<li><a href="#handson_01_prep">4.1. 準備</a></li>
<li><a href="#_ssh">4.2. SSH</a></li>
<li><a href="#_アプリケーションの説明">4.3. アプリケーションの説明</a></li>
<li><a href="#sec_handson_ec2_run">4.4. プログラムを実行する</a></li>
<li><a href="#_小括">4.5. 小括</a></li>
</ul>
</li>
<li><a href="#sec_scientific_computing">5. クラウドで行う科学計算・機械学習</a>
<ul class="sectlevel2">
<li><a href="#_なぜ機械学習をクラウドで行うのか">5.1. なぜ機械学習をクラウドで行うのか？</a></li>
<li><a href="#_gpu_による深層学習の高速化">5.2. GPU による深層学習の高速化</a></li>
</ul>
</li>
<li><a href="#sec_jupyter_and_deep_learning">6. Hands-on #2: AWS でディープラーニングを実践</a>
<ul class="sectlevel2">
<li><a href="#sec:jupyter_and_deep_learning_setup">6.1. 準備</a></li>
<li><a href="#_アプリケーションの説明_2">6.2. アプリケーションの説明</a></li>
<li><a href="#_スタックのデプロイ">6.3. スタックのデプロイ</a></li>
<li><a href="#_ログイン">6.4. ログイン</a></li>
<li><a href="#_jupyter_notebook_の起動">6.5. Jupyter Notebook の起動</a></li>
<li><a href="#_pytorchはじめの一歩">6.6. PyTorchはじめの一歩</a></li>
<li><a href="#sec_mnist_using_jupyter">6.7. 実践ディープラーニング! MNIST手書き数字認識タスク</a></li>
<li><a href="#_スタックの削除">6.8. スタックの削除</a></li>
</ul>
</li>
<li><a href="#sec_docker_introduction">7. Docker 入門</a>
<ul class="sectlevel2">
<li><a href="#_機械学習の大規模化">7.1. 機械学習の大規模化</a></li>
<li><a href="#_docker_とは">7.2. Docker とは</a></li>
<li><a href="#_docker_チュートリアル">7.3. Docker チュートリアル</a></li>
<li><a href="#_elastic_container_service_ecs">7.4. Elastic Container Service (ECS)</a></li>
</ul>
</li>
<li><a href="#sec_fargate_qabot">8. Hands-on #3: AWS で自動質問回答ボットを走らせる</a>
<ul class="sectlevel2">
<li><a href="#_fargate">8.1. Fargate</a></li>
<li><a href="#_準備">8.2. 準備</a></li>
<li><a href="#_transformer_を用いた_question_answering_プログラム">8.3. Transformer を用いた question-answering プログラム</a></li>
<li><a href="#_アプリケーションの説明_3">8.4. アプリケーションの説明</a></li>
<li><a href="#_スタックのデプロイ_2">8.5. スタックのデプロイ</a></li>
<li><a href="#_タスクの実行">8.6. タスクの実行</a></li>
<li><a href="#_タスクの同時実行">8.7. タスクの同時実行</a></li>
<li><a href="#_スタックの削除_2">8.8. スタックの削除</a></li>
</ul>
</li>
<li><a href="#sec_aws_batch">9. Hands-on #4: AWS Batch を使って機械学習のハイパーパラメータサーチを並列化する</a>
<ul class="sectlevel2">
<li><a href="#_auto_scaling_groups_asg">9.1. Auto scaling groups (ASG)</a></li>
<li><a href="#_aws_batch">9.2. AWS Batch</a></li>
<li><a href="#_準備_2">9.3. 準備</a></li>
<li><a href="#sec_run_mnist_docker_local">9.4. MNIST 手書き文字認識 (再訪)</a></li>
<li><a href="#sec:aws_batch_code">9.5. アプリケーションの説明</a></li>
<li><a href="#_スタックのデプロイ_3">9.6. スタックのデプロイ</a></li>
<li><a href="#sec:aws_batch_deploy_docker_on_ecr">9.7. Docker image を ECR に配置する</a></li>
<li><a href="#_単一のジョブを実行する">9.8. 単一のジョブを実行する</a></li>
<li><a href="#sec:batch_parallel_jobs">9.9. 並列に複数の Job を実行する</a></li>
<li><a href="#sec:batch_destroy_app">9.10. スタックの削除</a></li>
<li><a href="#_小括_2">9.11. 小括</a></li>
</ul>
</li>
<li><a href="#_web_サービスの作り方">10. Web サービスの作り方</a>
<ul class="sectlevel2">
<li><a href="#_ウェブサービスの仕組みtwitter_を例に">10.1. ウェブサービスの仕組み&#8201;&#8212;&#8201;Twitter を例に</a></li>
<li><a href="#sec_rest_api">10.2. REST API</a></li>
<li><a href="#_twitter_api">10.3. Twitter API</a></li>
</ul>
</li>
<li><a href="#sec_serverless">11. Serverless architecture</a>
<ul class="sectlevel2">
<li><a href="#chap_serverful_cloud">11.1. Serverful クラウド (従来型)</a></li>
<li><a href="#_serverless_クラウドへ">11.2. Serverless クラウドへ</a></li>
<li><a href="#_サーバーレスクラウドを構成するコンポーネント">11.3. サーバーレスクラウドを構成するコンポーネント</a></li>
</ul>
</li>
<li><a href="#sec_intro_serverless">12. Hands-on #5: サーバーレス入門</a>
<ul class="sectlevel2">
<li><a href="#_lambda_ハンズオン">12.1. Lambda ハンズオン</a></li>
<li><a href="#sec:dynamodb_tutorial">12.2. DynamoDB ハンズオン</a></li>
<li><a href="#sec:s3_tutorial">12.3. S3 ハンズオン</a></li>
</ul>
</li>
<li><a href="#sec_bashoutter">13. Hands-on #6: Bashoutter</a>
<ul class="sectlevel2">
<li><a href="#_準備_3">13.1. 準備</a></li>
<li><a href="#_アプリケーションの説明_4">13.2. アプリケーションの説明</a></li>
<li><a href="#_アプリケーションのデプロイ">13.3. アプリケーションのデプロイ</a></li>
<li><a href="#sec:bashoutter_test_api">13.4. API リクエストを送信する</a></li>
<li><a href="#simulating_many_apis">13.5. 大量の API リクエストをシミュレートする</a></li>
<li><a href="#_bashoutter_gui_を動かしてみる">13.6. Bashoutter GUI を動かしてみる</a></li>
<li><a href="#_アプリケーションの削除">13.7. アプリケーションの削除</a></li>
<li><a href="#_小括_3">13.8. 小括</a></li>
</ul>
</li>
<li><a href="#_まとめ">14. まとめ</a></li>
<li><a href="#sec:appendix_settingup">15. Appendix: 環境構築</a>
<ul class="sectlevel2">
<li><a href="#sec:create_aws_account">15.1. AWS アカウントの取得</a></li>
<li><a href="#aws_secrets">15.2. AWS のシークレットキーの作成</a></li>
<li><a href="#aws_cli_install">15.3. AWS CLI のインストール</a></li>
<li><a href="#aws_cdk_install">15.4. AWS CDK のインストール</a></li>
<li><a href="#sec:install_wsl">15.5. WSL のインストール</a></li>
<li><a href="#sec:install_docker">15.6. Docker のインストール</a></li>
<li><a href="#venv_quick_guide">15.7. Python <code>venv</code> クイックガイド</a></li>
<li><a href="#sec_handson_docker">15.8. ハンズオン実行用の Docker image の使い方</a></li>
</ul>
</li>
<li><a href="#_謝辞">16. 謝辞</a></li>
<li><a href="#_著者紹介">17. 著者紹介</a></li>
<li><a href="#_ライセンス">18. ライセンス</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>ハンズオンで使うプログラムや教科書のソースコードは以下のウェブページで公開している．</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/tomomano/learn-aws-by-coding" class="bare">https://github.com/tomomano/learn-aws-by-coding</a></p>
</div>
<div class="paragraph">
<p><strong>📗告知📗</strong></p>
</div>
<div class="paragraph">
<p>各方面でご好評をいただいている本講義資料ですが，この度増補・改訂のうえ<strong>書籍として出版することが決定いたしました！</strong>
<strong>書籍限定の書き下ろしの３章 (約100ページ分！)を新たに追加</strong>して，<strong>2021年9月27日</strong>に発売予定です．
この資料を気に入っていただいた方は，手に取っていただけるとありがたいです．
ここで公開している資料は引き続きオンラインで無料で読めますので，ご安心ください🙇</p>
</div>
<div class="paragraph">
<p>書籍名: <strong>AWSではじめる クラウド開発入門</strong> (真野智之著，マイナビ出版，360ページ)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Amazon (紙媒体 or Kindle)</strong> &#8658; <a href="https://www.amazon.co.jp/dp/4839977607/" class="bare">https://www.amazon.co.jp/dp/4839977607/</a></p>
</li>
<li>
<p><strong>マイナビブックス (紙媒体 or PDF)</strong> &#8658; <a href="https://book.mynavi.jp/ec/products/detail/id=124113" class="bare">https://book.mynavi.jp/ec/products/detail/id=124113</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>🌎英語バージョン🌎</strong>
<a href="https://tomomano.github.io/learn-aws-by-coding/en/">こちら</a>
のリンクにて鋭意作成中！</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_はじめに">1. はじめに</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_本書の目的内容">1.1. 本書の目的・内容</h3>
<div class="paragraph">
<p>本書は，東京大学計数工学科で2021年度S1/S2タームに開講されている"システム情報工学特論"の講義資料として作成された．</p>
</div>
<div class="paragraph">
<p>本書の目的は，クラウドの初心者を対象とし，クラウドの基礎的な知識・概念を解説する．
また， Amazon Web Services (以下， AWS) の提供するクラウド環境を実例として，具体的なクラウドの利用方法をハンズオンを通して学ぶ．</p>
</div>
<div class="paragraph">
<p>とくに，科学・エンジニアリングの学生を対象として，研究などの目的でクラウドを利用するための実践的な手順を紹介する．
知識・理論の説明は最小限に留め，実践を行う中で必要な概念の解説を行う予定である．
読者が今後，研究などでクラウドを利用する際の，足がかりとなれば本書の目的は十分達成されたことになる．</p>
</div>
<div class="paragraph">
<p>本書は以下のような三部構成になっている．</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. 本書の構成</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">テーマ</th>
<th class="tableblock halign-left valign-top">ハンズオン</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">第一部 (1章-4章)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">クラウドの基礎</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>AWSに自分のサーバーを立ち上げる</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">第二部 (5章-9章)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">クラウドを活用した機械学習</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>AWS と Jupyter を使って始めるディープラーニング</p>
</li>
<li>
<p>スケーラブルな自動質問回答ボットを作る</p>
</li>
<li>
<p>並列化されたハイパーパラメータサーチの実装</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">第三部 (10章-13章)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">サーバーレスアーキテクチャ入門</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Lambda, DynamoDB, S3 の演習</p>
</li>
<li>
<p>俳句を投稿する SNS "Bashoutter" を作る</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>第一部は，クラウドの基礎となる概念・知識を解説する．
セキュリティやネットワークなど，クラウドを利用する上で最低限おさえなければいけないポイントを説明する．
ハンズオンでは，はじめての仮想サーバーを AWS に立ち上げる演習を行う．</p>
</div>
<div class="paragraph">
<p>第二部では，クラウド上で科学計算 (とくに機械学習) を走らせるための入門となる知識・技術を解説する．
あわせて，
<a href="https://www.docker.com/">Docker</a>
とよばれる仮想計算環境の使用方法を紹介する．
一つ目のハンズオンでは， AWS のクラウドで Jupyter Notebook を起動し簡単な機械学習の計算を走らせる課題を実践する．
二つ目のハンズオンでは，深層学習を用いた自然言語処理により，質問に自動で回答を生成するボットを作成する．
最後に，複数台の GPU インスタンスからなるクラスターを起動し，並列に深層学習のハイパーパラメータサーチを行う方法を紹介する．</p>
</div>
<div class="paragraph">
<p>第三部では，サーバーレスアーキテクチャとよばれる最新のクラウドのアーキテクチャを紹介する．
これは，サーバーの処理能力を負荷に応じてより柔軟に拡大・縮小するための概念であり，それ以前 (Serverful としばしばよばれる) と質的に異なる設計思想をクラウドに導入するものである．
ハンズオンでは，サーバーレスクラウドの主要なコンポーネントである Lambda, DynamoDB, S3 の演習を提供する．
さらに，サーバーレスの技術を使用して簡単な SNS をクラウド上に作成する．</p>
</div>
<div class="paragraph">
<p>これらの豊富なハンズオンにより， AWS 上にクラウドシステムを開発するための知識と技術が身につくはずである．
いずれのハンズオンも，実用性を重視したものになっており，これらをベースにカスタマイズを施すことで様々な応用が可能である．</p>
</div>
</div>
<div class="sect2">
<h3 id="_本書のフィロソフィー">1.2. 本書のフィロソフィー</h3>
<div class="paragraph">
<p>本書のフィロソフィーを一言で表すなら， <strong>"ロケットで宇宙まで飛んでいって一度地球を眺めてみよう！"</strong> である．</p>
</div>
<div class="paragraph">
<p>どういうことか？</p>
</div>
<div class="paragraph">
<p>ここでいう"地球"とは，クラウドコンピューティングの全体像のことである．
言うまでもなく，クラウドという技術は非常に広範かつ複雑な概念で，幾多の情報技術・ハードウェア・アルゴリズムが精緻に組み合わさってできた総体である．
そして，今日では科学研究から日常のインフラ設備に至るまで，我々の社会の多くの部分がクラウド技術によって支えられている．</p>
</div>
<div class="paragraph">
<p>ここでいう"ロケット"とはこの講義のことである．
この講義では，ロケットに乗って宇宙まで飛び立ち，地球(クラウド)の全体を自身の目で眺めてもらう．
その際，ロケットの成り立ちや仕組み (背後にある要素技術やプログラムのソースコード) を深くは問わない．
将来，自分が研究などの目的でクラウドを利用することになった際に，改めて学んでもらえば良い．
本書の目的はむしろ，クラウドの最先端に実際に触れ，そこからどんな景色が見えるか(どんな応用が可能か)を実感してもらうことである．</p>
</div>
<div class="paragraph">
<p>そのような理由で，本書はクラウドの基礎から応用まで幅広いテーマを取り扱う．
第一部はクラウドの基礎から始め，第二部では一気にレベルアップし機械学習(深層学習)をクラウドで実行する手法を解説する．
さらに第三部では，サーバーレス・アーキテクチャというここ数年のうちに確立した全く新しいクラウドの設計について解説する．
それぞれで本一冊分以上の内容に相当するものであるが，本書はあえてこれらを一冊にまとめ連続的に俯瞰するという野心的な意図をもって執筆された．</p>
</div>
<div class="paragraph">
<p>決して楽な搭乗体験ではないかもしれないが，このロケットにしがみついてきてもらえれば，とてもエキサイティングな景色が見られることを約束したい．</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="imgs/earth_from_earth.jpg" alt="cdk output" width="500">
</div>
<div class="title">Figure 1. 宇宙からみた地球 (Image from NASA <a href="https://www.nasa.gov/image-feature/planet-of-clouds" class="bare">https://www.nasa.gov/image-feature/planet-of-clouds</a>)</div>
</div>
</div>
<div class="sect2">
<h3 id="aws_account">1.3. AWSアカウント</h3>
<div class="paragraph">
<p>本書では，ハンズオン形式で AWS のクラウドを実際に動かす演習を提供する．
自分でハンズオンを実行してみたい読者は，各自で AWS のアカウントの作成をしていただく．
AWS のアカウントの作成の仕方は巻末付録 (<a href="#sec:create_aws_account">Section 15.1</a>) に簡単に記載したので，必要に応じて参照していただきたい．</p>
</div>
<div class="paragraph">
<p>AWS にはいくつかの機能に対して無料利用枠が設定されており，いくつかのハンズオンは無料の範囲内で実行できる．
一方，ほかのハンズオン (とくに機械学習を扱うもの) では数ドル程度のコストが発生する．
ハンズオンごとに発生するおおよそのコストについて記述があるので，注意をしながらハンズオンに取り組んでいただきたい．</p>
</div>
<div class="paragraph">
<p>また，大学などの教育機関における講義で AWS を使用する際は， <a href="https://aws.amazon.com/education/awseducate/">AWS Educate</a> というプログラムを利用することも可能である．
これは，講義の担当者が申請を行うことで，受講する学生に対し AWS クレジットが提供されるというプログラムである．
AWS Educate を利用することで金銭的な負担なしに AWS を体験することができる．
また，講義を経由せず個人でも AWS Educate に参加することも可能である．
AWS Educate からは様々な学習教材が提供されているので，ぜひ活用してもらいたい．</p>
</div>
</div>
<div class="sect2">
<h3 id="environments">1.4. 環境構築</h3>
<div class="paragraph">
<p>本書では， AWS 上にクラウドアプリケーションを展開するハンズオンを実施する．
そこで紹介するプログラムを実行するためには，以下の計算機環境が必要である．
インストールの方法については，巻末付録 (<a href="#sec:appendix_settingup">Section 15</a>) に記してある．
必要に応じて参照し，環境構築を各自実施していただきたい．</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>UNIX 系コンソール</strong>:
ハンズオンで紹介するコマンドを実行したり， SSH でサーバーにアクセスするため， UNIX 系のコンソール環境が必要である．
Mac または Linux のユーザーは， OS に標準搭載のコンソール(ターミナルとも呼ばれる)を使用すればよい．
Windows のユーザーは，
<a href="https://docs.microsoft.com/en-us/windows/wsl/about">Windows Subsystem for Linux (WSL)</a>
を使い， Linux の仮想環境のインストールを推奨する (<a href="#sec:install_wsl">Section 15.5</a> 参照)．</p>
</li>
<li>
<p><strong>Docker</strong>:
本書では Docker とよばれる仮想計算環境の利用方法を解説する．
インストール手順については <a href="#sec:install_docker">Section 15.6</a> を参照のこと．</p>
</li>
<li>
<p><strong>Python</strong>:
Version 3.6 以上をインストールする．
とくに，ハンズオンでは <code>venv</code> モジュールを使用する．
<code>venv</code> の使い方は <a href="#venv_quick_guide">Section 15.7</a> 参照のこと．</p>
</li>
<li>
<p><strong>Node.js</strong>:
version 12.0 以上 をインストールする．</p>
</li>
<li>
<p><strong>AWS CLI</strong>:
<a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html">Version 2</a>
をインストールする．
インストール手順については <a href="#aws_cli_install">Section 15.3</a> 参照のこと．</p>
</li>
<li>
<p><strong>AWS CDK</strong>:
Version 1.100 以上をインストールする．
Version 2 以降には未対応である．
インストール手順については <a href="#aws_cdk_install">Section 15.4</a> 参照のこと．</p>
</li>
<li>
<p><strong>AWS 認証鍵の設定</strong>:
AWS API をコマンドラインから呼ぶには，認証鍵 (secret key) が設定されている必要がある．
認証鍵の設定については <a href="#aws_cli_install">Section 15.3</a> 参照のこと．</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_ハンズオン実行用の_docker_image">1.4.1. ハンズオン実行用の Docker Image</h4>
<div class="paragraph">
<p>Python, Node.js, AWS CDK など，ハンズオンのプログラムを実行するために必要なプログラム/ライブラリがインストール済みの Docker image を用意した．
また，ハンズオンのソースコードもクローン済みである．
Docker の使い方を知っている読者は，これを使えば，諸々のインストールをする必要なく，すぐにハンズオンのプログラムを実行できる．</p>
</div>
<div class="paragraph">
<p>次のコマンドで起動する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>docker run <span class="nt">-it</span> tomomano/labc</code></pre>
</div>
</div>
<div class="paragraph">
<p>この Docker image の使い方や詳細は <a href="#sec_handson_docker">Section 15.8</a> に記載している．</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_前提知識">1.5. 前提知識</h3>
<div class="paragraph">
<p>本書を読むにあたり，要求する前提知識は大学初等程度の計算機科学の知識 (OS，プログラミングなど)のみである．
それ以上の前提知識はとくに仮定しない．
クラウドの利用経験もゼロで問題ない．
が，以下の事前知識があるとよりスムーズに理解をすることができるだろう．</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Python の基本的な理解</strong>:
本書ではPythonを使ってプログラムの作成を行う．
使用するライブラリは十分抽象化されており，関数の名前を見ただけで意味が明瞭なものがほとんどであるので， Python に詳しくなくても心配する必要はない．</p>
</li>
<li>
<p><strong>Linux コマンドラインの基礎的な理解</strong>:
クラウドを利用する際，クラウド上に立ち上がるサーバーは基本的に Linux である．
Linux のコマンドラインについて知識があると，トラブルシュートなどが容易になる．
筆者のおすすめの参考書は
<a href="http://linuxcommand.org/tlcl.php">The Linux Command Line by William Shotts</a>
である．
ウェブで無料で読むことができるので，読んだことのない人はぜひ一読を．</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_講義に関連する資料">1.6. 講義に関連する資料</h3>
<div class="paragraph">
<p>ハンズオンで使うプログラムや教科書のソースコードは以下のウェブページで公開している．</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/tomomano/learn-aws-by-coding" class="bare">https://github.com/tomomano/learn-aws-by-coding</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_本書で使用するノーテーションなど">1.7. 本書で使用するノーテーションなど</h3>
<div class="ulist">
<ul>
<li>
<p>コードやシェルのコマンドは <code>monospace letter</code> で記述する．</p>
</li>
<li>
<p>シェルに入力するコマンドは，それがシェルコマンドであると明示する目的で，先頭に <code>$</code> がつけてある．
<code>$</code> はコマンドをコピー&amp;ペーストするときは除かなければならない．
逆に，コマンドの出力には <code>$</code> はついていない点に留意する．</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>また，以下のような形式で注意やチップスを提供する．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
追加のコメントなどを記す．
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
発展的な議論やアイディアなどを紹介する．
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
陥りやすいミスなどの注意事項を述べる．
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
絶対に犯してはならないミスを指摘する．
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chap_cloud_basics">2. クラウド概論</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_クラウドとは">2.1. クラウドとは？</h3>
<div class="imageblock text-center">
<div class="content">
<img src="imgs/cloud_word_art.png" alt="Cloud" width="400">
</div>
</div>
<div class="paragraph">
<p>クラウドとはなにか？
クラウドという言葉は，それ自身がとても広い意味をもつので，厳密な定義付けを行うことは難しい．</p>
</div>
<div class="paragraph">
<p>学術的な意味でのクラウドの定義づけをするとしたら，NIST(米国・国立標準技術研究所) による <a href="https://csrc.nist.gov/publications/detail/sp/800-145/final">The NIST Definition of Cloud Computing</a> が引用されることが多い．
ここに記載されたクラウドの定義・モデルを図示したのが <a href="#fig:nist_cloud_definition">Figure 2</a> である．</p>
</div>
<div id="fig:nist_cloud_definition" class="imageblock text-center">
<div class="content">
<img src="imgs/nist_cloud_definition.png" alt="Cost" width="700">
</div>
<div class="title">Figure 2. The NIST Definition of Cloud Computing</div>
</div>
<div class="paragraph">
<p>これによると，クラウドとは以下の要件が満たされたハードウェア/ソフトウェアの総体のことをいう．</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>On-demand self-service</strong>
利用者のリクエストに応じて計算資源が自動的に割り当てられる．</p>
</li>
<li>
<p><strong>Broad network access</strong>
利用者はネットワークを通じてクラウドにアクセスできる．</p>
</li>
<li>
<p><strong>Resource pooling</strong>
クラウドプロバイダーは，所有する計算資源を分割することで複数の利用者に計算資源を割り当てる．</p>
</li>
<li>
<p><strong>Rapid elasticity</strong>
利用者のリクエストに応じて，迅速に計算資源の拡大あるいは縮小を行うことができる．</p>
</li>
<li>
<p><strong>Measured service</strong>
計算資源の利用量を計測・監視することができる．</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>&#8230;&#8203;と，いわれても抽象的でよくわからないかもしれない．もう少し具体的な話をする．</p>
</div>
<div class="paragraph">
<p>個人が所有する計算機で， CPU をアップグレードしようと思ったら，物理的に筐体を開け，CPUソケットを露出させ，新しいCPUに交換する必要があるだろう．
あるいは，ストレージがいっぱいになってしまったら，古いディスクを抜き取り，新しいディスクを挿入する必要がある．
計算機の場所を移動させたときには，新しい部屋の LAN ケーブルを差し込まないとネットワークには接続できない．</p>
</div>
<div class="paragraph">
<p>クラウドでは，これらの操作が<strong>プログラムからのコマンドによって実行できる</strong>．
CPUが1000個欲しいと思ったならば，そのようにクラウドプロバイダーにリクエストを送れば良い．
すると，数分もしないうちに 1000 CPUの計算資源が割り当てられる．
ストレージを1TBから10TBに拡張しようと思ったならば，そのようにコマンドを送ればよい (これは，Google Drive や Dropbox などのサービスなどで馴染みのある人も多いだろう)．
計算資源を使い終わったら，そのことをプロバイダーに伝えれば，割り当て分はすぐさま削除される．
クラウドプロバイダーは，使った計算資源の量を正確にモニタリングしており，その量をもとに利用料金の計算が行われる．</p>
</div>
<div class="paragraph">
<p>このように，クラウドの本質は物理的なハードウェアの仮想化・抽象化であり，利用者はコマンドを通じて，<strong>まるでソフトウェアの一部かのように，物理的なハードウェアの管理・運用を行うことができる</strong>．
もちろん，背後では，データセンターに置かれた膨大な数の計算機が大量の電力を消費しながら稼働している．
クラウドプロバイダーはデータセンターの計算資源を上手にやりくりし，ソフトウェアとしてのインターフェースをユーザーに提供することで，このような仮想化・抽象化を達成しているわけである．
クラウドプロバイダーの視点からすると，大勢のユーザーに計算機を貸し出し，データセンターの稼働率を常時100%に近づけることで，利益率の最大化を図っているのである．</p>
</div>
<div class="paragraph">
<p>著者の言葉で，クラウドの重要な特性を定義するならば，以下のようになる．</p>
</div>
<div class="quoteblock">
<blockquote>
クラウドとは計算機ハードウェアの抽象化である．つまり，物理的なハードウェアをソフトウェアの一部かのように自在に操作・拡大・接続することを可能にする技術である．
</blockquote>
</div>
<div class="paragraph">
<p>先述の The NIST Definition of Cloud Computing に戻ると，クラウドプロバイダーによるクラウドサービスの形態としては，次の三つが定義されている (<a href="#fig:nist_cloud_definition">Figure 2</a>)．</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Software as a Service (SaaS):
クラウド上で実行されるアプリケーションをサービスとして利用者に提供する形態．
例として， Google Drive や Slack などが挙げられる．
利用者は，背後にあるクラウドのインフラ (ネットワークやサーバーなど) には直接触れず，アプリケーションとして提供されているクラウドサービスを享受する．</p>
</li>
<li>
<p>Platform as a Service (PaaS):
顧客の作成したアプリケーション (多くの場合データベースと API リクエスト処理を行うサーバーのコードから構成される) をデプロイする環境をサービスとして利用者に提供する形態．
PaaS では利用者はクラウドのインフラに直接触れることはなく，計算負荷が増減した際のサーバーのスケーリングはクラウドプロバイダーによってなされる．
例としては， Google App Engine や Heroku などがある．</p>
</li>
<li>
<p>Infrastructure as a Service (IaaS):
クラウド上の計算インフラストラクチャーを従量課金制で利用者に提供する形態．
利用者は必要なネットワーク・サーバー・ストレージをプロバイダーから借り受け，そこに自身のアプリケーションを展開し運用する．
IaaS の例としては AWS EC2 などが挙げられる．</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>本書が扱うのは，主に IaaS におけるクラウド開発である．
すなわち，開発者がクラウドのインフラを直接操作し，所望のネットワーク・サーバー・ストレージなどを一から構成し，そこにアプリケーションを展開するというクラウド開発である．
この意味において，クラウドの開発とは<strong>クラウドインフラストラクチャーを定義・展開するプログラムを構築するステップ</strong>と<strong>インフラ上で実際に走るアプリケーションを作成するステップ</strong>の二つに分けることができる．
この二つは，プログラマーの技術としてはある程度分業を行うことが可能であるが，最も効率化・最適化されたクラウドシステムを構築するためには両方の理解が必須である．
本書では，前者 (クラウドインフラの記述) に重きを置きつつ，アプリケーションレイヤーの話題も取り扱う．
PaaS とは，開発者はアプリケーションレイヤーの開発に注力し，クラウドインフラの部分はクラウドプロバイダーに依存するという概念である．
PaaS は，クラウドインフラの開発が不要になることで開発の時間が短縮されるが，細かなインフラの挙動はコントロールできないという限界がある．
本書では PaaS についてはとくに取り扱わない．</p>
</div>
<div class="paragraph">
<p>SaaS は本書の文脈では開発による"成果物"と捉えられるだろう．
すなわち， IaaS を構成するプログラムを作成し展開することによって，一般の人が利用できるようなウェブ上の計算サービスやデータベースを提供することが開発の最終ゴールである．
本書のハンズオンではその実例として，シンプルな SNS の作成 (<a href="#sec_bashoutter">Section 13</a>) などの演習を提供する．</p>
</div>
<div class="paragraph">
<p>なお，最近では Function as a Service (FaaS) やサーバーレスコンピューティングなども新たなクラウドのカテゴリとして認知されている．
これらの概念については <a href="#sec_intro_serverless">Section 12</a> などの章で詳しく触れていく．
本書を読み進める中で明らかになるように，クラウドの技術は日進月歩である．
本書では実用的・教育的な観点から，従来的なクラウドの設計概念に触れたあと，サーバーレスなどの最新の技術も網羅するので，楽しみにしながら読み進めていただきたい．</p>
</div>
<div class="paragraph">
<p>最後に，The NIST Definition of Cloud Computing によると，クラウドの運用形態について次のような定義がなされている (<a href="#fig:nist_cloud_definition">Figure 2</a>)．
特定の組織・団体・企業の内部のみで使用されるクラウドを，<strong>プライベートクラウド (private cloud)</strong> とよぶ．
例えば，大学や研究機関では，その機関の構成員向けの大規模計算機サーバーが運用されていることが多い．
プライベートクラウドは，組織の構成員ならば無料もしくは極めて割安のコストで計算を実行できる．
しかし，使用できる計算資源の上限は限られる場合が多く，拡張時の柔軟性に欠ける場合もある．</p>
</div>
<div class="paragraph">
<p>一方，商用のサービスとして一般の顧客に向けたクラウドのことを，<strong>パブリッククラウド (public cloud)</strong> とよぶ．
有名なパブリッククラウドプラットフォームの例を挙げると， Google社が提供する <a href="https://cloud.google.com/">Google Cloud Platform (GCP)</a>， Microsoft 社が提供する <a href="https://azure.microsoft.com">Azure</a>， Amazon 社が提供する <a href="https://aws.amazon.com">Amazon Web Services (AWS)</a> などがある．
パブリッククラウドを利用する場合は，プロバイダーの設定した利用料金を支払うことになる．
その分，巨大なデータセンターを運用する企業の計算資源にアクセスすることができるので，計算のキャパシティは無尽蔵にあるといって過言でない．</p>
</div>
<div class="paragraph">
<p>第三のクラウドの運用形態として，コミュニティクラウド (community cloud) が挙げられる．
これは，例えば政府の省庁・機関など目的・役割を共有する団体・組織が共有して運用するクラウドを指す．
最後に，ハイブリッドクラウド (hybrid cloud) という形態もあり，これはプライベート・パブリック・コミュニティクラウドの二つ以上の組み合わせによって構成されるクラウドのことである．
データ保護の観点から，いくつかの機密データやプライバシーに関わる情報はプライベートクラウドに保持し，残りのシステムをパブリッククラウドに依存する，などの形態が想定される．</p>
</div>
<div class="paragraph">
<p>本書で説明するのは，基本的にパブリッククラウドを使ったクラウド開発である．
特に，Amazon Web Services (AWS) を使用して，具体的な技術と概念を学んでいく．
一方で，サーバーのスケーリングや仮想計算環境などのテクニックはすべてのクラウドに共通な概念であるので，クラウドのプラットフォームが変わろうと一般に通用する知識も同時に身につくはずだ．</p>
</div>
</div>
<div class="sect2">
<h3 id="_なぜクラウドを使うのか">2.2. なぜクラウドを使うのか？</h3>
<div class="paragraph">
<p>上述のように，クラウドとはプログラムを通じて自由に計算資源を操作することのできる計算環境である．
ここでは，リアルなローカル計算環境と比べて，なぜクラウドを使うと良いことがあるのかについて述べたい．</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>自由にサーバーのサイズをスケールできる</strong></p>
<div class="paragraph">
<p>なにか新しいプロジェクトを始めるとき，あらかじめ必要なサーバーのスペックを知るのは難しい．
いきなり大きなサーバーを買うのはリスクが高い．
一方で，小さすぎるサーバーでは，後のアップグレードが面倒である．
クラウドを利用すれば，プロジェクトを進めながら，必要な分だけの計算資源を確保することができる．</p>
</div>
</li>
<li>
<p><strong>自分でサーバーをメンテナンスする必要がない</strong></p>
<div class="paragraph">
<p>悲しいことに，コンピュータとは古くなるものである．最近の技術の進歩の速度からすると，5年も経てば，もはや当時の最新コンピュータも化石と同じである．
5年ごとにサーバーを入れ替えるのは相当な手間である．
またサーバーの停電や故障など不意の障害への対応も必要である．
クラウドでは，そのようなインフラの整備やメンテナンスはプロバイダーが自動でやってくれるので，ユーザーが心配する必要がない．</p>
</div>
</li>
<li>
<p><strong>初期コスト0</strong></p>
<div class="paragraph">
<p>自前の計算環境とクラウドの，経済的なコストのイメージを示したのが <a href="#cloud_economic_curve">Figure 3</a> である．
クラウドを利用する場合の初期コストは基本的に0である．
その後，使った利用量に応じてコストが増大していく．
一方，自前の計算環境では，大きな初期コストが生じる．
その分，初期投資後のコストの増加は，電気利用料やサーバー維持費などに留まるため，クラウドを利用した場合よりも傾きは小さくなる．
自前の計算機では，ある一定期間後，サーバーのアップグレードなどによる支出が生じることがある．
一方，クラウドを利用する場合は，そのような非連続なコストの増大は基本的に生じない．
クラウドのコストのカーブが，自前計算環境のコストのカーブの下にある範囲においては，クラウドを使うことは経済的なコスト削減につながる．</p>
</div>
<div id="cloud_economic_curve" class="imageblock text-center">
<div class="content">
<img src="imgs/cloud_cost.png" alt="Cost" width="500">
</div>
<div class="title">Figure 3. クラウドと自前計算機環境の経済的コストの比較</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>とくに，<strong>1.</strong>の点は研究の場面では重要であると筆者は感じる．
研究をやっていて，四六時中計算を走らせ続けるという場合は少ない．
むしろ，新しいアルゴリズムが完成したとき・新しいデータが届いたとき，集中的・突発的に計算タスクが増大することが多いだろう．
そういったときに，フレキシブルに計算力を増強させることができるのは，クラウドを使う大きなメリットである．</p>
</div>
<div class="paragraph">
<p>ここまでクラウドを使うメリットを述べたが，逆に，デメリットというのも当然存在する．</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>クラウドは賢く使わないといけない</strong></p>
<div class="paragraph">
<p><a href="#cloud_economic_curve">Figure 3</a> で示したコストのカーブにあるとおり，使い方によっては自前の計算環境のほうがコスト的に有利な場面は存在しうる．
クラウドを利用する際は，使い終わった計算資源はすぐに削除するなど，利用者が賢く管理を行う必要があり，これを怠ると思いもしない額の請求が届く可能性がある．</p>
</div>
</li>
<li>
<p><strong>セキュリティ</strong></p>
<div class="paragraph">
<p>クラウドは，インターネットを通じて世界のどこからでもアクセスできる状態にあり，セキュリティ管理を怠ると簡単にハッキングの対象となりうる．
ハッキングを受けると，情報流出だけでなく，経済的な損失を被る可能性がある．</p>
</div>
</li>
<li>
<p><strong>ラーニングカーブ</strong></p>
<div class="paragraph">
<p>上記のように，コスト・セキュリティなど，クラウドを利用する際に留意しなければならない点は多い．
賢くクラウドを使うには，十分なクラウドの理解が必要であり，そのラーニングカーブを乗り越える必要がある．</p>
</div>
</li>
</ol>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">コラム: Terminal の語源</div>
<div class="paragraph">
<p>Mac/Linuxなどでコマンドを入力するときに使用する，あの黒い画面のことを Terminal とよんだりする．
この言葉の語源をご存知だろうか？</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="imgs/terminal.png" alt="Terminal" width="400">
</div>
</div>
<div class="paragraph">
<p>この言葉の語源は，コンピュータが誕生して間もない頃の時代に遡る．
その頃のコンピュータというと，何千何万のという数の真空管が接続された，会議室一個分くらいのサイズのマシンであった．
そのような高価でメンテが大変な機材であるから，当然みんなでシェアして使うことが前提となる．
ユーザーがコンピュータにアクセスするため，マシンからは何本かのケーブルが伸び，それぞれにキーボードとスクリーンが接続されていた&#8230;&#8203;
これを <strong>Terminal</strong> とよんでいたのである．
人々は，代わる代わるTerminalの前に座って，計算機との対話を行っていた．</p>
</div>
<div class="paragraph">
<p>時代は流れ，WindowsやMacなどのいわゆるパーソナルコンピュータの出現により，コンピュータはみんなで共有するものではなく，個人が所有するものになった．</p>
</div>
<div class="paragraph">
<p>最近のクラウドの台頭は，みんなで大きなコンピュータをシェアするという，最初のコンピュータの使われ方に原点回帰していると捉えることもできる．
一方で，スマートフォンやウェアラブルなどのエッジデバイスの普及も盛んであり，個人が複数の"小さな"コンピュータを所有する，という流れも同時に進行しているのである．</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec_aws_general_introduction">3. AWS入門</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_awsとは">3.1. AWSとは？</h3>
<div class="paragraph">
<p>本書では，クラウドの実践を行うプラットフォームとして， AWS を用いる．
実践にあたって，最低限必要な AWS の知識を本章では解説しよう．</p>
</div>
<div class="paragraph">
<p><a href="https://aws.amazon.com">AWS (Amazon Web Services)</a> はAmazon社が提供する総合的なクラウドプラットフォームである．
AWS は Amazon 社が持つ膨大な計算リソースを貸し出すクラウドサービスとして，2006年に誕生した．
2021年では，クラウドプロバイダーとして最大のマーケットシェア (約32%) を保持している
(<a href="https://www.canalys.com/newsroom/global-cloud-market-Q121">参照</a>)．
Netflix や Slack をはじめとした多くのウェブ関連のサービスで，一部または全てのサーバーリソースが AWS から提供されているとのことである．
よって，知らないうちに AWS の恩恵にあずかっている人も少なくないはずだ．</p>
</div>
<div class="paragraph">
<p>最大のシェアをもつだけに，機能・サービスの幅広さはほかのクラウドプラットフォームと比べ抜きんでている．
また，利用者数が多いことを反映して，公式あるいはサードパーティによる技術紹介記事が数多くウェブ上に存在しているだけでなく，ライブラリのユーザーコミュニティも大きく問題解決が捗るのも魅力の一つだ．
初期のころウェブビジネスを行う企業がユーザーの大半を占めていたが，最近は大学などでの科学研究用途としても頻繁に用いられるようになってきている．</p>
</div>
</div>
<div class="sect2">
<h3 id="_awsの機能サービス">3.2. AWSの機能・サービス</h3>
<div class="paragraph">
<p><a href="#fig_aws_services">Figure 4</a> は，執筆時点においてAWSで提供されている主要な機能・サービスの一覧である．</p>
</div>
<div id="fig_aws_services" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_services.png" alt="AWS services" width="350">
</div>
<div class="title">Figure 4. AWSで提供されている主要なサービス一覧</div>
</div>
<div class="paragraph">
<p>計算，ストレージ，データベース，ネットワーク，セキュリティなど，クラウドの構築に必要な様々な要素が<strong>独立したコンポーネント</strong>として提供されている．
基本的に，これらを組み合わせることで一つのクラウドシステムができあがる．</p>
</div>
<div class="paragraph">
<p>また，機械学習・音声認識・AR/VR など，特定のアプリケーションにパッケージ済みのサービスも提供されている．
これらを合計すると全部で170個以上のサービスが提供されているとのことである (<a href="https://dev.classmethod.jp/articles/aws-summary-2020/">参照</a>)．</p>
</div>
<div class="paragraph">
<p>AWS の初心者が陥りがちなのは，<strong>大量のサービスの数に圧倒され，どこから手をつけたらよいのかわからなくなる</strong>，という状況である．
たくさんのサービスの中から，どのサービスをどの順番で学んでいったらいいのか，その道筋すら明らかでなく，大きな参入障壁となっていることは間違いない．
だが実のところ， AWS の<strong>基本的な構成要素はそのうちの数個</strong>のみに限られる．
基本要素となる機能の使い方を知れば， AWS のおおよそのリソースを使いこなすことが可能になる．
ほかの機能の多くは，基本の要素を組み合わせて特定のアプリケーションに特化したパッケージとして AWS が用意したものである．
そのポイントを認知することが， AWS の学習の最初のステップである．</p>
</div>
<div class="paragraph">
<p>ここでは， AWS 上でクラウドシステムを構築するときの基本となる構成要素を列挙する．
これらは後のハンズオンで実際にプログラムを書きながら体験する．
現時点では，名前だけでも頭の片隅に記憶してもらえればよい．</p>
</div>
<div class="sect3">
<h4 id="_計算">3.2.1. 計算</h4>
<div class="paragraph">
<p><span class="image left"><img src="imgs/aws_logos/EC2.png" alt="S3" width="40"></span>
<strong>EC2 (Elastic Compute Cloud)</strong>
様々なスペックの仮想マシンを作成し，計算を実行することができる．
クラウドの最も基本となる構成要素である．
<a href="#sec_first_ec2">Section 4</a>, <a href="#sec_jupyter_and_deep_learning">Section 6</a>, <a href="#sec_aws_batch">Section 9</a> で詳しく触れる．</p>
</div>
<div class="paragraph">
<p><span class="image left"><img src="imgs/aws_logos/Lambda.png" alt="S3" width="40"></span>
<strong>Lambda</strong>
Function as a Service (FaaS) とよばれる，小さな計算を<strong>サーバーなし</strong>で実行するためのサービス．
サーバーレスアーキテクチャの章 (<a href="#sec_serverless">Section 11</a>) で詳しく解説する．</p>
</div>
</div>
<div class="sect3">
<h4 id="_ストレージ">3.2.2. ストレージ</h4>
<div class="paragraph">
<p><span class="image left"><img src="imgs/aws_logos/EBS.png" alt="S3" width="40"></span>
<strong>EBS (Elastic Block Store)</strong>
EC2に付与することのできる仮想データドライブ．
いわゆる"普通の"(一般的なOSで使われている)ファイルシステムを思い浮かべてくれたらよい．</p>
</div>
<div class="paragraph">
<p><span class="image left"><img src="imgs/aws_logos/S3.png" alt="S3" width="40"></span>
<strong>S3 (Simple Storage Service)</strong>
Object Storage とよばれる，APIを使ってデータの読み書きを行う，いうなれば”クラウド・ネイティブ”なデータの格納システムである．
サーバーレスアーキテクチャの章 (<a href="#sec_serverless">Section 11</a>) で詳しく解説する．</p>
</div>
</div>
<div class="sect3">
<h4 id="_データベース">3.2.3. データベース</h4>
<div class="paragraph">
<p><span class="image left"><img src="imgs/aws_logos/DynamoDB.png" alt="S3" width="40"></span>
<strong>DynamoDB</strong>
NoSQL 型のデータベースサービス (知っている人は <code>mongoDB</code> などを思い浮かべたらよい)．
サーバーレスアーキテクチャの章 (<a href="#sec_serverless">Section 11</a>) で詳しく解説する．</p>
</div>
</div>
<div class="sect3">
<h4 id="_ネットワーク">3.2.4. ネットワーク</h4>
<div class="paragraph">
<p><span class="image left"><img src="imgs/aws_logos/VPC.png" alt="S3" width="40"></span>
<strong>VPC(Virtual Private Cloud)</strong>
AWS 上に仮想ネットワーク環境を作成し，仮想サーバー間の接続を定義したり，外部からのアクセスなどを管理する．
EC2 は VPC の内部に配置されなければならない．</p>
</div>
<div class="paragraph">
<p><strong>API Gateway</strong>
<span class="image left"><img src="imgs/aws_logos/APIGateway.png" alt="S3" width="40"></span>
API のエンドポイントとバックエンドのサービス (Lambda など) を接続する際に用いる，リバースプロキシとしての役割を担う．
<a href="#sec_bashoutter">Section 13</a> で詳しく解説する．</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_region_と_availability_zone">3.3. Region と Availability Zone</h3>
<div class="paragraph">
<p>AWS を使用する際に知っておかなければならない重要な概念として， <strong>リージョン (Region)</strong> と <strong>Availability Zone (AZ)</strong> がある (<a href="#fig_aws_regions_and_azs">Figure 5</a>)．
以下ではこの概念について簡単に記述する．</p>
</div>
<div id="fig_aws_regions_and_azs" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_region_and_az.png" alt="AWS regions and azs" width="500">
</div>
<div class="title">Figure 5. AWSにおける Region と Availability Zones</div>
</div>
<div class="paragraph">
<p><strong>リージョン (Region)</strong> とは，おおまかに言うとデータセンターの所在地のことである．
執筆時点において， AWS は世界の25の国と地域でデータセンターを所有している．
<a href="#fig_aws_regions">Figure 6</a> は執筆時点で利用できるリージョンの世界地図を示している．
日本では東京と大阪にデータセンターがある．
各リージョンには固有の ID がついており，例えば東京は <code>ap-northeast-1</code>, 米国オハイオ州は <code>us-east-2</code>，などと定義されている．</p>
</div>
<div id="fig_aws_regions" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_regions.png" alt="AWS regions" width="600">
</div>
<div class="title">Figure 6. Regions in AWS(出典: <a href="https://aws.amazon.com/about-aws/global-infrastructure/" class="bare">https://aws.amazon.com/about-aws/global-infrastructure/</a>)</div>
</div>
<div class="paragraph">
<p>AWSコンソールにログインすると，画面右上のメニューバーでリージョンを選択することができる(<a href="#fig_aws_console_regions">Figure 7</a>, 赤丸で囲った箇所)．
EC2, S3 などのAWSのリソースは，リージョンごとに完全に独立である．
したがって，<strong>リソースを新たにデプロイする際，あるいはデプロイ済みのリソースを閲覧する際は，コンソールのリージョンが正しく設定されているか，確認する必要がある</strong>．
ウェブビジネスを展開する場合などは，世界の各地にクラウドを展開する必要があるが，個人的な研究用途として用いる場合は，最寄りのリージョン (i.e. 東京) を使えば基本的に問題ない．</p>
</div>
<div id="fig_aws_console_regions" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_regions2.png" alt="AWS console select regions" width="600">
</div>
<div class="title">Figure 7. AWSコンソールでリージョンを選択</div>
</div>
<div class="paragraph">
<p><code>Avaialibity Zone (AZ)</code> とは，リージョン内で地理的に隔離されたデータセンターのことである．
それぞれのリージョンは2個以上のAZを有しており，もし一つのAZで火災や停電などが起きた場合でも，ほかのAZがその障害をカバーすることができる．
また， AZ 間は高速な AWS 専用ネットワーク回線で結ばれているため， AZ 間のデータ転送は極めて早い．
AZ は，ビジネスなどでサーバーダウンが許容されない場合などに注意すべき概念であり，個人的な用途で使う限りにおいてはあまり深く考慮する必要はない．言葉の意味だけ知っておけば十分である．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>AWS を使用する際，どこのリージョンを指定するのがよいのだろうか？
インターネットの接続速度の観点からは，地理的に一番近いリージョンを使用するのが一般的によいだろう．
一方， EC2 の利用料などはリージョンごとに価格設定が若干 (10-20%程度) 異なる．
したがって，自分が最も頻繁に利用するサービスの価格が最も安く設定されているリージョンを選択する，というのも重要な視点である．
また，いくつかのサービスは，特定のリージョンで利用できない場合もある．
これらのポイントから総合的に判断して使用するリージョンを決めると良い．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>AWS Educate を利用している読者へ</p>
</div>
<div class="paragraph">
<p>執筆時点において，AWS Educate による Starter Account を使用している場合は <code>us-east-1</code> region のみ利用できる
(<a href="https://awseducate-starter-account-services.s3.amazonaws.com/AWS_Educate_Starter_Account_Services_Supported.pdf">参照</a>)．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Further reading</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html">AWS documentation "Regions, Availability Zones, and Local Zones"</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_awsでのクラウド開発">3.4. AWSでのクラウド開発</h3>
<div class="paragraph">
<p>AWS のクラウドの全体像がわかってきたところで，次のトピックとして，どのようにしてAWS上にクラウドの開発を行い，展開していくかについての概略を解説しよう．</p>
</div>
<div class="paragraph">
<p>AWS のリソースを追加・編集・削除するなどの操作を実行するには，<strong>コンソールを用いる</strong>方法と，<strong> API を用いる方法</strong>の，二つの経路がある．</p>
</div>
<div class="sect3">
<h4 id="_コンソール画面からリソースを操作する">3.4.1. コンソール画面からリソースを操作する</h4>
<div class="paragraph">
<p>AWS のアカウントにログインすると，まず最初に表示されるのが<strong> AWS コンソール</strong>である (<a href="#aws_console_window">Figure 8</a>)．</p>
</div>
<div id="aws_console_window" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_console.png" alt="AWS console" width="600">
</div>
<div class="title">Figure 8. AWSマネージメントコンソール画面</div>
</div>
<div class="paragraph">
<p>コンソールを使うことで， EC2 のインスタンスを立ち上げたり，S3のデータを追加・削除したり，ログを閲覧したりなど，AWS上のあらゆるリソースの操作を GUI (Graphical User Interface) を通して実行することができる．
<strong>初めて触る機能をポチポチと試したり，デバッグを行うときなどにとても便利である</strong>．</p>
</div>
<div class="paragraph">
<p>コンソールはさらっと機能を試したり，開発中のクラウドのデバッグをするときには便利なのであるが，実際にクラウドの開発をする場面でこれを直接いじることはあまりない．
むしろ，次に紹介する API を使用して，プログラムとしてクラウドのリソースを記述することで開発を行うのが一般的である．
そのような理由で，本書ではAWSコンソールを使った AWS の使い方はあまり触れない．
AWS のドキュメンテーションには，たくさんの
<a href="https://aws.amazon.com/getting-started/hands-on/">チュートリアル</a>
が用意されており，コンソール画面から様々な操作を行う方法が記述されているので，興味がある読者はそちらを参照されたい．</p>
</div>
</div>
<div class="sect3">
<h4 id="_apiからリソースを操作する">3.4.2. APIからリソースを操作する</h4>
<div class="paragraph">
<p><strong>API (Application Programming Interface)</strong> を使うことで，コマンドをAWSに送信し，クラウドのリソースの操作をすることができる．
API とは，端的に言えば AWS が公開しているコマンドの一覧であり，<code>GET</code>, <code>POST</code>, <code>DELETE</code> などの <strong>REST API</strong> から構成されている (REST API については <a href="#sec_rest_api">Section 10.2</a> で簡単に解説する)．
が，直接REST APIを入力するのは面倒であるので，その手間を解消するための様々なツールが提供されている．</p>
</div>
<div class="paragraph">
<p>例えば，
<a href="https://docs.aws.amazon.com/cli/latest/index.html">AWS CLI</a>
は， UNIX コンソールから AWS API を実行するための CLI (Command Line Interface) である．
CLIに加えて，いろいろなプログラミング言語での SDK (Software Development Kit) が提供されている．以下に一例を挙げる．</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Python &#8658; <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html">boto3</a></p>
</li>
<li>
<p>Ruby &#8658; <a href="https://aws.amazon.com/sdk-for-ruby/">AWS SDK for Ruby</a></p>
</li>
<li>
<p>Node.js &#8658; <a href="https://aws.amazon.com/sdk-for-node-js/">AWS SDK for Node.js</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>具体的な API の使用例を見てみよう．</p>
</div>
<div class="paragraph">
<p>S3に新しい保存領域 (<code>Bucket (バケット)</code> とよばれる) を追加したいとしよう．
AWS CLI を使った場合は，次のようなコマンドを打てばよい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws s3 mb s3://my-bucket <span class="nt">--region</span> ap-northeast-1</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のコマンドは， <code>my-bucket</code> という名前のバケットを， <code>ap-northeast-1</code> のリージョンに作成する．</p>
</div>
<div class="paragraph">
<p>Pythonからこれと同じ操作を実行するには， <code>boto3</code> ライブラリを使って，次のようなスクリプトを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">boto3</span>

<span class="n">s3_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">"s3"</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s">"ap-northeast-1"</span><span class="p">)</span>
<span class="n">s3_client</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="s">"my-bucket"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>もう一つ例をあげよう．</p>
</div>
<div class="paragraph">
<p>新しいEC2のインスタンス(インスタンスとは，起動状態にある仮想サーバーの意味である)を起動するには，次のようなコマンドを打てば良い．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws ec2 run-instances <span class="nt">--image-id</span> ami-xxxxxxxx <span class="nt">--count</span> 1 <span class="nt">--instance-type</span> t2.micro <span class="nt">--key-name</span> MyKeyPair <span class="nt">--security-group-ids</span> sg-903004f8 <span class="nt">--subnet-id</span> subnet-6e7f829e</code></pre>
</div>
</div>
<div class="paragraph">
<p>このコマンドにより，
<a href="https://aws.amazon.com/ec2/instance-types/t2/">t2.micro</a>
というタイプ (1 vCPU, 1.0 GB RAM) のインスタンスが起動する．
ここではその他のパラメータの詳細の説明は省略する (ハンズオン (<a href="#sec_first_ec2">Section 4</a>) で詳しく解説する)．</p>
</div>
<div class="paragraph">
<p>Pythonから上記と同じ操作を実行するには，以下のようなスクリプトを使う．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">boto3</span>

<span class="n">ec2_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">"ec2"</span><span class="p">)</span>
<span class="n">ec2_client</span><span class="o">.</span><span class="n">run_instances</span><span class="p">(</span>
    <span class="n">ImageId</span><span class="o">=</span><span class="s">"ami-xxxxxxxxx"</span><span class="p">,</span>
    <span class="n">MinCount</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">MaxCount</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">KeyName</span><span class="o">=</span><span class="s">"MyKeyPair"</span><span class="p">,</span>
    <span class="n">InstanceType</span><span class="o">=</span><span class="s">"t2.micro"</span><span class="p">,</span>
    <span class="n">SecurityGroupIds</span><span class="o">=</span><span class="p">[</span><span class="s">"sg-903004f8"</span><span class="p">],</span>
    <span class="n">SubnetId</span><span class="o">=</span><span class="s">"subnet-6e7f829e"</span><span class="p">,</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>以上の例を通じて，APIによるクラウドのリソースの操作のイメージがつかめてきただろうか？
コマンド一つで，新しい仮想サーバーを起動したり，データの保存領域を追加したり，任意の操作を実行できるわけである．
基本的に，このようなコマンドを複数組み合わせていくことで，自分の望むCPU・RAM・ネットワーク・ストレージが備わった計算環境を構築することができる．
もちろん，逆の操作 (リソースの削除) も API を使って実行できる．</p>
</div>
</div>
<div class="sect3">
<h4 id="_ミニハンズオン_aws_cli_を使ってみよう">3.4.3. ミニ・ハンズオン: AWS CLI を使ってみよう</h4>
<div class="paragraph">
<p>ここでは，ミニ・ハンズオンとして，AWS CLI を実際に使ってみる．
AWS CLI は先述のとおり， AWS 上の任意のリソースの操作が可能であるが，ここでは一番シンプルな，<strong> S3 を使ったファイルの読み書きを実践する</strong>
(EC2の操作は少し複雑なので，第一回ハンズオンで行う)．
<code>aws s3</code> コマンドの詳しい使い方は <a href="https://docs.aws.amazon.com/cli/latest/reference/s3/index.html#cli-aws-s3">公式ドキュメンテーション</a>を参照．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>AWS CLI のインストールについては， <a href="#aws_cli_install">Section 15.3</a> を参照．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>以下に紹介するハンズオンは，基本的に <a href="https://aws.amazon.com/free/?all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc">S3 の無料枠</a> の範囲内で実行することができる．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>以下のコマンドを実行する前に，AWSの認証情報が正しく設定されていることを確認する．
これには <code>~/.aws/credentials</code> のファイルに設定が書き込まれているか，環境変数 (<code>AWS_ACCESS_KEY_ID</code>, <code>AWS_SECRET_ACCESS_KEY</code>, <code>AWS_DEFAULT_REGION</code>) が定義されている必要がある．
詳しくは <a href="#aws_cli_install">Section 15.3</a> を参照．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>まずは，S3にデータの格納領域 (<code>Bucket</code> とよばれる．一般的な OS での"ドライブ"に相当する) を作成するところから始めよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ bucketName</span><span class="o">=</span><span class="s2">"mybucket-</span><span class="si">$(</span>openssl rand <span class="nt">-hex</span> 12<span class="si">)</span><span class="s2">"</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$bucketName</span>
<span class="nv">$ </span>aws s3 mb <span class="s2">"s3://</span><span class="k">${</span><span class="nv">bucketName</span><span class="k">}</span><span class="s2">"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>S3のバケットの名前は， AWS 全体で一意的でなければならないことから，前述のコマンドではランダムな文字列を含んだバケットの名前を生成し，<code>bucketName</code> という変数に格納している．
そして， <code>aws s3 mb</code> (<code>mb</code> は make bucket の略) によって，新しいバケットを作成する．</p>
</div>
<div class="paragraph">
<p>次に，バケットの一覧を取得してみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws s3 <span class="nb">ls

</span>2020-06-07 23:45:44 mybucket-c6f93855550a72b5b66f5efe</code></pre>
</div>
</div>
<div class="paragraph">
<p>先ほど作成したバケットがリストにあることを確認できる．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>本書のノーテーションとして，コマンドラインに入力するコマンドは，それがコマンドであると明示する目的で先頭に <code>$</code> がつけてある．
<code>$</code> はコマンドをコピー&amp;ペーストするときは除かなければならない．
逆に，コマンドの出力は <code>$</code> なしで表示されている．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>次に，バケットにファイルをアップロードする．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"Hello world"</span> <span class="o">&gt;</span> hello_world.txt
<span class="nv">$ </span>aws s3 <span class="nb">cp </span>hello_world.txt <span class="s2">"s3://</span><span class="k">${</span><span class="nv">bucketName</span><span class="k">}</span><span class="s2">/hello_world.txt"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>上では <code>hello_world.txt</code> というダミーのファイルを作成して，それをアップロードした．</p>
</div>
<div class="paragraph">
<p>それでは，バケットの中にあるファイルの一覧を取得してみる．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws s3 <span class="nb">ls</span> <span class="s2">"s3://</span><span class="k">${</span><span class="nv">bucketName</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--human-readable</span>

2020-06-07 23:54:19   13 Bytes hello_world.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>先ほどアップロードしたファイルがたしかに存在することがわかる．</p>
</div>
<div class="paragraph">
<p>最後に，使い終わったバケットを削除する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws s3 rb <span class="s2">"s3://</span><span class="k">${</span><span class="nv">bucketName</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--force</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>rb</code> は remove bucket の略である．
デフォルトでは，バケットの中にファイルが存在すると削除できない．
空でないバケットを強制的に削除するには <code>--force</code> のオプションを付ける．</p>
</div>
<div class="paragraph">
<p>以上のように，AWS CLI を使って S3 バケットに対しての一連の操作を実行できた．
EC2 や Lambda,  DynamoDB などについても同様に AWS CLI を使ってあらゆる操作を実行できる．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Amazon Resource Name (ARN)</strong></p>
</div>
<div class="paragraph">
<p>AWS 上のあらゆるリソースには， Amazon Resource Name (ARN) という固有の ID が付与されている．
ARN は <code>arn:aws:s3:::my_bucket/</code> のようなフォーマットで記述され，ARN を使用することで，特定の AWS リソース (S3 のバケットや EC2 のインスタンス) を一意的に参照することができる．</p>
</div>
<div class="paragraph">
<p>S3 バケットや EC2 インスタンスなどには ARN に加えて，人間が読みやすい名前を定義することも可能である．
この場合は，ARN または名前のどちらを用いても同じリソースを参照することが可能である．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec:intro_cloudformation">3.5. CloudFormation と AWS CDK</h3>
<div class="sect3">
<h4 id="_cloudformation_による_infrastructure_as_code_iac">3.5.1. CloudFormation による Infrastructure as Code (IaC)</h4>
<div class="paragraph">
<p>前節で述べたように，AWS API を使うことでクラウドの<strong>あらゆる</strong>リソースの作成・管理が可能である．
よって，原理上は， API のコマンドを組み合わせていくことで，自分の作りたいクラウドを設計することができる．</p>
</div>
<div class="paragraph">
<p>しかし，ここで実用上考慮しなければならない点が一つある．
AWS API には大きく分けて，<strong>リソースを操作する</strong>コマンドと，<strong>タスクを実行する</strong>コマンドがあることである (<a href="#fig_aws_iac">Figure 9</a>)．</p>
</div>
<div id="fig_aws_iac" class="imageblock text-center">
<div class="content">
<img src="imgs/iac.png" alt="AWS console" width="500">
</div>
<div class="title">Figure 9. AWS APIはリソースを操作するコマンドとタスクを実行するコマンドに大きく分けられる．リソースを記述・管理するのに使われるのが， CloudFormation と CDK である．</div>
</div>
<div class="paragraph">
<p><strong>リソースを操作する</strong>とは，EC2のインスタンスを起動したり，S3のバケットを作成したり，データベースに新たなテーブルを追加する，などの<strong>静的なリソースを準備する</strong> 操作を指す．
"ハコ"を作る操作とよんでも良いだろう．
このようなコマンドは，<strong>クラウドのデプロイ時にのみ，一度だけ実行されればよい</strong>．</p>
</div>
<div class="paragraph">
<p><strong>タスクを実行するコマンド</strong> とは， EC2 のインスタンスにジョブを投入したり， S3 のバケットにデータを読み書きするなどの操作を指す．
これは， EC2 や S3 などのリソース ("ハコ") を前提として，その内部で実行されるべき計算を記述するものである．
前者に比べてこちらは<strong>動的な操作</strong>を担当する，と捉えることもできる．</p>
</div>
<div class="paragraph">
<p>そのような観点から，<strong>インフラを記述するプログラム</strong>と<strong>タスクを実行するプログラム</strong>はある程度分けて管理されるべきである．
クラウドの開発は，クラウドの(静的な)リソースを記述するプログラムを作成するステップと，インフラ上で動く動的な操作を行うプログラムを作成するステップの二段階に分けて考えることができる．</p>
</div>
<div class="paragraph">
<p>AWSでの静的リソースを管理するための仕組みが， <a href="https://aws.amazon.com/cloudformation/">CloudFormation</a> である．
CloudFormation とは， CloudFormation の文法に従ったテキストファイルを使って，AWSのインフラを記述する仕組みである．
CloudFormation を使って，たとえば，EC2のインスタンスをどれくらいのスペックで，何個起動するか，インスタンス間はどのようなネットワークで結び，どのようなアクセス権限を付与するか，などのリソースの要件を逐次的に記述することができる．
一度CloudFormation ファイルができ上がれば，それにしたがったクラウドシステムをコマンド一つで AWS 上に展開することができる．
また，CloudFormation ファイルを交換することで，全く同一のクラウド環境を他者が簡単に再現することも可能になる．
このように，本来は物理的な実体のあるハードウェアを，プログラムによって記述し，管理するという考え方を，<strong>Infrastructure as Code (IaC)</strong>とよぶ．</p>
</div>
<div class="paragraph">
<p>CloudFormation を記述するには，基本的に <strong>JSON</strong> (JavaScript Object Notation) とよばれるフォーマットを使う．
次のコードは，JSONで記述された CloudFormation ファイルの一例 (抜粋) である．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="code"><pre><span class="nl">"Resources"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="err">...</span><span class="w">
  </span><span class="nl">"WebServer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::EC2::Instance"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"ImageId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Fn::FindInMap"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"AWSRegionArch2AMI"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::Region"</span><span class="w"> </span><span class="p">},</span><span class="w">
                        </span><span class="p">{</span><span class="w"> </span><span class="nl">"Fn::FindInMap"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"AWSInstanceType2Arch"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"InstanceType"</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">"Arch"</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"InstanceType"</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"InstanceType"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"SecurityGroups"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="nl">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"WebServerSecurityGroup"</span><span class="p">}</span><span class="w"> </span><span class="p">],</span><span class="w">
      </span><span class="nl">"KeyName"</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"KeyName"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"UserData"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Fn::Base64"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Fn::Join"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w">
                     </span><span class="s2">"#!/bin/bash -xe</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span><span class="w">
                     </span><span class="s2">"yum update -y aws-cfn-bootstrap</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span><span class="w">

                     </span><span class="s2">"/opt/aws/bin/cfn-init -v "</span><span class="p">,</span><span class="w">
                     </span><span class="s2">"         --stack "</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::StackName"</span><span class="w"> </span><span class="p">},</span><span class="w">
                     </span><span class="s2">"         --resource WebServer "</span><span class="p">,</span><span class="w">
                     </span><span class="s2">"         --configsets wordpress_install "</span><span class="p">,</span><span class="w">
                     </span><span class="s2">"         --region "</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::Region"</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span><span class="w">

                     </span><span class="s2">"/opt/aws/bin/cfn-signal -e $? "</span><span class="p">,</span><span class="w">
                     </span><span class="s2">"         --stack "</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::StackName"</span><span class="w"> </span><span class="p">},</span><span class="w">
                     </span><span class="s2">"         --resource WebServer "</span><span class="p">,</span><span class="w">
                     </span><span class="s2">"         --region "</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::Region"</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="w">
      </span><span class="p">]]}}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="err">...</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="err">...</span><span class="w">
</span><span class="p">}</span><span class="err">,</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ここでは， "WebServer" という名前のつけられた EC2 インスタンスを定義している．かなり長大で複雑な記述であるが，これによって所望のスペック・OSをもつEC2インスタンスを自動的に生成することが可能になる．</p>
</div>
</div>
<div class="sect3">
<h4 id="_aws_cdk">3.5.2. AWS CDK</h4>
<div class="paragraph">
<p>前節で紹介した CloudFormation は，見てわかるとおり大変記述が複雑であり，またそれのどれか一つにでも誤りがあってはいけない．
また，基本的に"テキスト"を書いていくことになるので，プログラミング言語で使うような変数やクラスといった便利な概念が使えない　(厳密には， CloudFormation にも変数に相当するような機能は存在する)．
また，記述の多くの部分は繰り返しが多く，自動化できる部分も多い．</p>
</div>
<div class="paragraph">
<p>そのような悩みを解決してくれるのが， <a href="https://aws.amazon.com/cdk/">AWS Cloud Development Kit (CDK)</a> である．
<strong>CDKは Python などのプログラミング言語を使って CloudFormation を自動的に生成してくれるツールである．</strong>
CDK は2019年にリリースされたばかりの比較的新しいツールで，日々改良が進められている (<a href="https://github.com/aws/aws-cdk/releases">GitHub リポジトリ</a> のリリースを見ればその開発のスピードの速さがわかるだろう)．
CDK は TypeScript (JavaScript), Python, Java など複数の言語でサポートされている．</p>
</div>
<div class="paragraph">
<p>CDKを使うことで，CloudFormation に相当するクラウドリソースの記述を，より親しみのあるプログラミング言語を使って行うことができる．
かつ，典型的なリソース操作に関してはパラメータの多くの部分を自動で決定してくれるので，記述しなければならない量もかなり削減される．</p>
</div>
<div class="paragraph">
<p>以下に Python を使った CDK のコードの一例 (抜粋) を示す．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">aws_cdk</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">core</span><span class="p">,</span>
    <span class="n">aws_ec2</span> <span class="k">as</span> <span class="n">ec2</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">MyFirstEc2</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Stack</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">vpc</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span>
            <span class="o">...</span> <span class="c1"># some parameters
</span>        <span class="p">)</span>

        <span class="n">sg</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">SecurityGroup</span><span class="p">(</span>
            <span class="o">...</span> <span class="c1"># some parameters
</span>        <span class="p">)</span>

        <span class="n">host</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"MyGreatEc2"</span><span class="p">,</span>
            <span class="n">instance_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">InstanceType</span><span class="p">(</span><span class="s">"t2.micro"</span><span class="p">),</span>
            <span class="n">machine_image</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">MachineImage</span><span class="o">.</span><span class="n">latest_amazon_linux</span><span class="p">(),</span>
            <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
            <span class="o">...</span>
        <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>このコードは，一つ前に示した JSON を使った CloudFormation と実質的に同じことを記述している．
とても煩雑だった CloudFormation ファイルに比べて， CDK と Python を使うことで格段に短く，わかりやすく記述できることができるのがわかるだろう．</p>
</div>
<div class="paragraph">
<p>本書の主題は，<strong> CDK を使って，コードを書きながら AWS の概念や開発方法を学んでいくことである</strong>．
後の章では CDK を使って様々なハンズオンを実施していく．
早速，最初のハンズオンでは， CDK を使って EC2 インスタンスを作成する方法を学んでいこう．</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Further reading</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/aws-samples/aws-cdk-examples">AWS CDK Examples</a>: CDKを使ったプロジェクトの例が多数紹介されている．
ここにある例をテンプレートに自分のアプリケーションの開発を進めるとよい．</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec_first_ec2">4. Hands-on #1: 初めてのEC2インスタンスを起動する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ハンズオンの第一回では， CDK を使って EC2 のインスタンス(仮想サーバー)を作成し，SSHでサーバーにログインする，という演習を行う．
このハンズオンを終えれば，あなたは自分だけのサーバーを AWS 上に立ち上げ，自由に計算を走らせることができるようになるのである！</p>
</div>
<div class="sect2">
<h3 id="handson_01_prep">4.1. 準備</h3>
<div class="paragraph">
<p>ハンズオンのソースコードは GitHub の
<a href="https://github.com/tomomano/learn-aws-by-coding/tree/main/handson/ec2-get-started">handson/ec2-get-started</a>
に置いてある．</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このハンズオンは，基本的に
<a href="https://aws.amazon.com/free/?all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc">AWS の無料枠</a>
の範囲内で実行することができる．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>まずは，ハンズオンを実行するための環境を整える．
これらの環境整備は，後のハンズオンでも前提となるものなので確実にミスなく行っていただきたい．</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>AWS Account</strong>:
ハンズオンを実行するには個人の AWS アカウントが必要である．
AWSアカウントの取得については <a href="#sec:create_aws_account">Section 15.1</a> を参照のこと．</p>
</li>
<li>
<p><strong>Python と Node.js</strong>:
本ハンズオンを実行するには，Python (3.6 以上)，Node.js (12.0 以上) がインストールされていなければならない．</p>
</li>
<li>
<p><strong>AWS CLI</strong>:
AWS CLI のインストールについては， <a href="#aws_cli_install">Section 15.3</a> を参照．
ここに記載されている認証鍵の設定も済ませておくこと．</p>
</li>
<li>
<p><strong>AWS CDK</strong>:
AWS CDK のインストールについては， <a href="#aws_cdk_install">Section 15.4</a> を参照．</p>
</li>
<li>
<p><strong>ソースコードのダウンロード</strong>:
本ハンズオンで使用するプログラムのソースコードを，以下のコマンドを使って GitHub からダウンロードする．</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git clone https://github.com/tomomano/learn-aws-by-coding.git</pre>
</div>
</div>
<div class="paragraph">
<p>あるいは， <a href="https://github.com/tomomano/learn-aws-by-coding" class="bare">https://github.com/tomomano/learn-aws-by-coding</a> のページに行って，右上のダウンロードボタンからダウンロードすることもできる．</p>
</div>
<div class="paragraph">
<p><strong>Docker を使用する場合</strong></p>
</div>
<div class="paragraph">
<p>Python, Node.js, AWS CDK など，ハンズオンのプログラムを実行するために必要なプログラム/ライブラリがインストール済みの Docker image を用意した．
また，ハンズオンのソースコードもパッケージ済みである．
Docker の使い方を知っている読者は，これを使えば，諸々のインストールをする必要なく，すぐにハンズオンのプログラムを実行できる．</p>
</div>
<div class="paragraph">
<p>使用方法については <a href="#sec_handson_docker">Section 15.8</a> を参照のこと．</p>
</div>
</div>
<div class="sect2">
<h3 id="_ssh">4.2. SSH</h3>
<div class="paragraph">
<p><strong>SSH (secure shell)</strong> は Unix 系のリモートサーバーに安全にアクセスするためのツールである．
本ハンズオンでは， SSH を使って仮想サーバーにアクセスする．
SSH に慣れていない読者のため，簡単な説明をここで行おう．</p>
</div>
<div class="paragraph">
<p>SSH による通信はすべて暗号化されているので，機密情報をインターネットを介して安全に送受信することができる．
本ハンズオンで，リモートのサーバーにアクセスするための SSH クライアントがローカルマシンにインストールされている必要がある．
SSH クライアントは Linux/Mac には標準搭載されている．
Windows の場合は WSL をインストールすることで SSH クライアントを利用することを推奨する (<a href="#environments">Section 1.4</a> を参照)．</p>
</div>
<div class="paragraph">
<p>SSH コマンドの基本的な使い方を次に示す．
<code>&lt;host name&gt;</code> はアクセスする先のサーバーの IP アドレスや DNS によるホストネームが入る．
<code>&lt;user name&gt;</code> は接続する先のユーザー名である．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>ssh &lt;user name&gt;@&lt;host name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>SSH は平文のパスワードによる認証を行うこともできるが，より強固なセキュリティを施すため，<strong>公開鍵暗号方式(Public Key Cryptography)による認証</strong>を行うことが強く推奨されており， EC2 はこの方法でしかアクセスを許していない．
公開鍵暗号方式の仕組みについては各自勉強してほしい．
本ハンズオンにおいて大事なことは，<strong> EC2 インスタンスが公開鍵(Public key)を保持し，クライアントとなるコンピュータ(読者自身のコンピュータ)が秘密鍵(Private key)を保持する</strong>，という点である．
EC2のインスタンスには秘密鍵を持ったコンピュータのみがアクセスすることができる．逆に言うと，秘密鍵が漏洩すると第三者もサーバーにアクセスできることになるので，<strong>秘密鍵は絶対に漏洩することのないよう注意して管理する</strong>．</p>
</div>
<div class="paragraph">
<p>SSH コマンドでは，ログインのために使用する秘密鍵ファイルを <code>-i</code> もしくは <code>--identity_file</code> のオプションで指定することができる．
たとえば，次のように使う．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>ssh <span class="nt">-i</span> Ec2SecretKey.pem &lt;user name&gt;@&lt;host name&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_アプリケーションの説明">4.3. アプリケーションの説明</h3>
<div class="paragraph">
<p>このハンズオンで作成するアプリケーションの概要を <a href="#handson_01_architecture">Figure 10</a> に示す．</p>
</div>
<div id="handson_01_architecture" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-01/app_architecture.png" alt="hands-on 01 architecture" width="600">
</div>
<div class="title">Figure 10. ハンズオン#1で作製するアプリケーションのアーキテクチャ</div>
</div>
<div class="paragraph">
<p>このアプリケーションではまず，<strong>VPC (Virtual Private Cloud)</strong> を使ってプライベートな仮想ネットワーク環境を立ち上げている．
そのVPCの public subnet の内側に，<strong>EC2 (Elatic Compute Cloud)</strong> の仮想サーバーを配置する．
さらに，セキュリティのため， <strong>Security Group</strong> によるEC2インスタンスへのアクセス制限を設定している．
このようにして作成された仮想サーバーに，SSHを使ってアクセスし，簡単な計算を行う．</p>
</div>
<div class="paragraph">
<p><a href="#handson_01_architecture">Figure 10</a> のようなアプリケーションを，CDKを使って構築する．</p>
</div>
<div class="paragraph">
<p>早速ではあるが，今回のハンズオンで使用するプログラムを見てみよう
(<a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/ec2-get-started/app.py">handson/ec2-get-started/app.py</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">MyFirstEc2</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Stack</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">App</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="n">vpc</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"MyFirstEc2-Vpc"</span><span class="p">,</span>
            <span class="n">max_azs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">cidr</span><span class="o">=</span><span class="s">"10.10.0.0/23"</span><span class="p">,</span>
            <span class="n">subnet_configuration</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ec2</span><span class="o">.</span><span class="n">SubnetConfiguration</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s">"public"</span><span class="p">,</span>
                    <span class="n">subnet_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetType</span><span class="o">.</span><span class="n">PUBLIC</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="n">nat_gateways</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="n">sg</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">SecurityGroup</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"MyFirstEc2Vpc-Sg"</span><span class="p">,</span>
            <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
            <span class="n">allow_all_outbound</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">sg</span><span class="o">.</span><span class="n">add_ingress_rule</span><span class="p">(</span>
            <span class="n">peer</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">Peer</span><span class="o">.</span><span class="n">any_ipv4</span><span class="p">(),</span>
            <span class="n">connection</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">Port</span><span class="o">.</span><span class="n">tcp</span><span class="p">(</span><span class="mi">22</span><span class="p">),</span>
        <span class="p">)</span>

        <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="n">host</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"MyFirstEc2Instance"</span><span class="p">,</span>
            <span class="n">instance_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">InstanceType</span><span class="p">(</span><span class="s">"t2.micro"</span><span class="p">),</span>
            <span class="n">machine_image</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">MachineImage</span><span class="o">.</span><span class="n">latest_amazon_linux</span><span class="p">(),</span>
            <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
            <span class="n">vpc_subnets</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetSelection</span><span class="p">(</span><span class="n">subnet_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetType</span><span class="o">.</span><span class="n">PUBLIC</span><span class="p">),</span>
            <span class="n">security_group</span><span class="o">=</span><span class="n">sg</span><span class="p">,</span>
            <span class="n">key_name</span><span class="o">=</span><span class="n">key_name</span>
        <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>まず最初に，VPCを定義する．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>次に， security group (SG) を定義している．
ここでは，任意のIPv4のアドレスからの，ポート22 (SSHの接続に使用される)への接続を許可している．
それ以外の接続は拒絶される．</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>最後に，上記で作った VPCと SG が付与された EC2 インスタンスを作成している．
インスタンスタイプは <code>t2.micro</code> を選択し， <a href="https://aws.amazon.com/amazon-linux-ami/">Amazon Linux</a> をOSとして設定している．</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>それぞれについて，もう少し詳しく説明しよう．</p>
</div>
<div class="sect3">
<h4 id="_vpc_virtual_private_cloud">4.3.1. VPC (Virtual Private Cloud)</h4>
<div id="fig::vpc_logo" class="paragraph">
<div class="title">VPC のアイコン</div>
<p><span class="image"><img src="imgs/aws_logos/VPC.png" alt="VPC" width="100"></span></p>
</div>
<div class="paragraph">
<p>VPC は AWS 上にプライベートな仮想ネットワーク環境を構築するツールである．高度な計算システムを構築するには，複数のサーバーを連動させて計算を行う必要があるが，そのような場合に互いのアドレスなどを管理する必要があり，そういった目的でVPCは有用である．</p>
</div>
<div class="paragraph">
<p>本ハンズオンでは，サーバーは一つしか起動しないので，VPCの恩恵はよく分からないかもしれない．しかし，EC2インスタンスは必ずVPCの中に配置されなければならない，という制約があるので，このハンズオンでもミニマルなVPCを構成している．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>興味のある読者のために，VPCのコードについてもう少し詳しく説明しよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</pre></td><td class="code"><pre><span class="n">vpc</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"MyFirstEc2-Vpc"</span><span class="p">,</span>
    <span class="n">max_azs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">cidr</span><span class="o">=</span><span class="s">"10.10.0.0/23"</span><span class="p">,</span>
    <span class="n">subnet_configuration</span><span class="o">=</span><span class="p">[</span>
        <span class="n">ec2</span><span class="o">.</span><span class="n">SubnetConfiguration</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s">"public"</span><span class="p">,</span>
            <span class="n">subnet_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetType</span><span class="o">.</span><span class="n">PUBLIC</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">],</span>
    <span class="n">nat_gateways</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>max_azs=1</code> : このパラメータは，前章で説明した avaialibility zone (AZ) を設定している．
このハンズオンでは，特にデータセンターの障害などを気にする必要はないので <code>1</code> にしている．</p>
</li>
<li>
<p><code>cidr="10.10.0.0/23"</code> : このパラメータは，VPC内のIPv4のレンジを指定している．
CIDR記法については， <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing">Wikipedia</a>などを参照．
<code>10.10.0.0/23</code> は <code>10.10.0.0</code> から <code>10.10.1.255</code> までの512個の連続したアドレス範囲を指している．
つまり，このVPCでは最大で512個のユニークなIPv4アドレスが使えることになる．
今回はサーバーは一つなので512個は明らかに多すぎるが，VPCはアドレスの数はどれだけ作成しても無料なので，多めに作成した．</p>
</li>
<li>
<p><code>subnet_configuration=&#8230;&#8203;</code> : このパラメータは，VPCにどのようなサブネットを作るか，を決めている．
サブネットの種類には <strong>private subnet</strong> と <strong>public subnet</strong> の二種類がある．
private subnet は基本的にインターネットとは遮断されたサブネット環境である．
インターネットと繋がっていないので，セキュリティは極めて高く， VPC 内のサーバーとのみ通信を行えばよい EC2 インスタンスはここに配置する．
Public subnet とはインターネットに繋がったサブネットである．
本ハンズオンで作成するサーバーは，外からSSHでログインを行いたいので， Public subnet 内に配置する．
より詳細な記述は <a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html#vpc-subnet-basics">公式ドキュメンテーション</a> を参照．</p>
</li>
<li>
<p><code>natgateways=0</code> : これは少し高度な内容なので省略する
(興味のある読者は <a href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html">公式ドキュメンテーション</a>を参照)．
が，<strong>これを0にしておかないと，NAT Gateway の利用料金が発生してしまうので，注意！</strong></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_security_group">4.3.2. Security Group</h4>
<div class="paragraph">
<p>Security group (SG) は， EC2 インスタンスに付与することのできる仮想ファイアーウォールである．
たとえば，特定の IP アドレスから来た接続を許可・拒絶したり　(インバウンド・トラフィックの制限) ，逆に特定のIPアドレスへのアクセスを禁止したり (アウトバウンド・トラフィックの制限) することができる．</p>
</div>
<div class="paragraph">
<p>コードの該当部分を見てみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="n">sg</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">SecurityGroup</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"MyFirstEc2Vpc-Sg"</span><span class="p">,</span>
    <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
    <span class="n">allow_all_outbound</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">sg</span><span class="o">.</span><span class="n">add_ingress_rule</span><span class="p">(</span>
    <span class="n">peer</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">Peer</span><span class="o">.</span><span class="n">any_ipv4</span><span class="p">(),</span>
    <span class="n">connection</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">Port</span><span class="o">.</span><span class="n">tcp</span><span class="p">(</span><span class="mi">22</span><span class="p">),</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>本ハンズオンでは， SSH による外部からの接続を許容するため， <code>sg.add_ingress_rule(peer=ec2.Peer.any_ipv4(), connection=ec2.Port.tcp(22))</code> により，すべての IPv4 アドレスからのポート22番へのアクセスを許容している．
また， SSH で EC2 インスタンスにログインしたのち，インターネットからプログラムなどをダウンロードできるよう， <code>allow_all_outbound=True</code> のパラメータを設定している．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>SSH はデフォルトでは22番ポートを使用するのが慣例である．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>セキュリティ上の観点からは，SSHの接続は自宅や大学・職場など特定の地点からの接続のみを許す方が望ましい．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_ec2_elastic_compute_cloud">4.3.3. EC2 (Elastic Compute Cloud)</h4>
<div id="fig::ec2_handson_ec2_logo" class="paragraph">
<div class="title">EC2 のアイコン</div>
<p><span class="image"><img src="imgs/aws_logos/EC2.png" alt="EC2" width="100"></span></p>
</div>
<div class="paragraph">
<p>EC2 は AWS 上に仮想サーバーを立ち上げるサービスである．
個々の起動状態にある仮想サーバーのことをインスタンス (instance) とよぶ
(しかし，口語的なコミュニケーションにおいては，サーバーとインスタンスという言葉は相互互換的に用いられることが多い)．</p>
</div>
<div class="paragraph">
<p>EC2 では用途に応じて様々なインスタンスタイプが提供されている．
<a href="#ec2_instance_types">Table 2</a> に，代表的なインスタンスタイプの例を挙げる (執筆時点での情報)．
EC2 のインスタンスタイプのすべてのリストは
<a href="https://aws.amazon.com/ec2/instance-types/">公式ドキュメンテーション "Amazon EC2 Instance Types"</a>
で見ることができる．</p>
</div>
<table id="ec2_instance_types" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. EC2 instance types</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Instance</th>
<th class="tableblock halign-left valign-top">vCPU</th>
<th class="tableblock halign-left valign-top">Memory (GiB)</th>
<th class="tableblock halign-left valign-top">Network bandwidth (Gbps)</th>
<th class="tableblock halign-left valign-top">Price per hour ($)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">t2.micro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0116</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">t2.small</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.023</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">t2.medium</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0464</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">c5.24xlarge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">96</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">192</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.08</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">c5n.18xlarge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">72</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">192</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.888</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x1e.16xlarge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1952</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">13.344</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#ec2_instance_types">Table 2</a> からわかるように， CPU は1コアから96コアまで，メモリーは 1GB から 2TB 以上まで，ネットワーク帯域は最大で100Gbpsまで，幅広く選択することができる．
また，時間あたりの料金は，CPU・メモリーの占有数にほぼ比例する形で増加する．
EC2 はサーバーの起動時間を秒単位で記録しており，<strong>利用料金は使用時間に比例する形で決定される</strong>．
例えば， <code>t2.medium</code> のインスタンスを10時間起動した場合，0.0464 * 10 = 0.464 ドルの料金が発生する．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>AWS には <a href="https://aws.amazon.com/free/?all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc">無料利用枠</a> というものがあり， <code>t2.micro</code> であれば月に750時間までは無料で利用することができる．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="#ec2_instance_types">Table 2</a> の価格は <code>us-east-1</code> のものである．
リージョンによって多少価格設定が異なる．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>上記で t2.micro の $0.0116 / hour という金額は， On-demand インスタンスというタイプを選択した場合の価格である．
EC2 ではほかに， <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-spot-instances.html">Spot instance</a> とよばれるインスタンスも存在しする．
Spot instance は，AWSのデータセンターの負荷が増えた場合，ユーザーのプログラムが実行中であってもAWSの判断により強制シャットダウンされる，という不便さを抱えているのだが，その分大幅に安い料金設定になっている．
AWS で一時的に生じた余剰な空きCPUをユーザーに割安で貸し出す，という発想である．
科学計算やウェブサーバーなどの用途でコストを削減する目的で， Spot Instance を活用する事例も多数報告されている．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>EC2 インスタンスを定義しているコードの該当部分を見てみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="n">host</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"MyFirstEc2Instance"</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">InstanceType</span><span class="p">(</span><span class="s">"t2.micro"</span><span class="p">),</span>
    <span class="n">machine_image</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">MachineImage</span><span class="o">.</span><span class="n">latest_amazon_linux</span><span class="p">(),</span>
    <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
    <span class="n">vpc_subnets</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetSelection</span><span class="p">(</span><span class="n">subnet_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetType</span><span class="o">.</span><span class="n">PUBLIC</span><span class="p">),</span>
    <span class="n">security_group</span><span class="o">=</span><span class="n">sg</span><span class="p">,</span>
    <span class="n">key_name</span><span class="o">=</span><span class="n">key_name</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ここでは， <code>t2.micro</code> というインスタンスタイプを選択している．
さらに， <code>machine_image</code> として，
<a href="https://aws.amazon.com/amazon-linux-ami/">Amazon Linux</a>
を選択している
(Machine image は OS と似た概念である．
Machine image については， <a href="#sec_jupyter_and_deep_learning">Section 6</a> でより詳しく触れる)．
さらに，上で定義した VPC, SG をこのインスタンスに付与している．</p>
</div>
<div class="paragraph">
<p>以上が，今回使用するプログラムの簡単な解説であった．
ミニマルな形のプログラムではあるが，仮想サーバーを作成するのに必要なステップがおわかりいただけただろうか？</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec_handson_ec2_run">4.4. プログラムを実行する</h3>
<div class="paragraph">
<p>さて，ハンズオンのコードの理解ができたところで，プログラムを実際に実行してみよう．繰り返しになるが， <a href="#handson_01_prep">Section 4.1</a> での準備ができていることが前提である．</p>
</div>
<div class="sect3">
<h4 id="_python_の依存ライブラリのインストール">4.4.1. Python の依存ライブラリのインストール</h4>
<div class="paragraph">
<p>まずは，Python の依存ライブラリをインストールする．以下では，Python のライブラリを管理するツールとして， <a href="https://docs.python.org/3/library/venv.html">venv</a> を使用する．</p>
</div>
<div class="paragraph">
<p>まずは， <code>handson/ec2-get-started</code> のディレクトリに移動しよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cd </span>handson/ec2-get-started</code></pre>
</div>
</div>
<div class="paragraph">
<p>ディレクトリを移動したら， <code>venv</code> で新しい仮想環境を作成し，インストールを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python3 <span class="nt">-m</span> venv .env
<span class="nv">$ </span><span class="nb">source</span> .env/bin/activate
<span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>これで Python の環境構築は完了だ．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>venv</code> の簡単な説明は <a href="#venv_quick_guide">Section 15.7</a> に記述してある．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>環境によっては <code>pip</code> ではなく <code>pip3</code> あるいは <code>python3 -m pip</code> に置き換える必要がある．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_aws_のシークレットキーをセットする">4.4.2. AWS のシークレットキーをセットする</h4>
<div class="paragraph">
<p>AWS CLI および AWS CDK を使うには， AWS のシークレットキーが設定されている必要がある．
シークレットキーの発行については <a href="#aws_secrets">Section 15.2</a> を参照のこと．
シークレットキーを発行したら， <a href="#aws_cli_install">Section 15.3</a> を参照し，コマンドラインの設定を行う．</p>
</div>
<div class="paragraph">
<p>手順をここに短く要約すると，一つ目の方法は <code>AWS_ACCESS_KEY_ID</code> などの環境変数を設定するやり方である．
もう一つの方法は， <code>~/.aws/credentials</code> に認証情報を保存しておく方式である．
シークレットキーの設定は AWS CLI/CDK を使用するうえで共通のステップになるので，しっかりと理解しておくように．</p>
</div>
</div>
<div class="sect3">
<h4 id="_ssh鍵を生成">4.4.3. SSH鍵を生成</h4>
<div class="paragraph">
<p>EC2 インスタンスには SSH を使ってログインする．
EC2 インスタンスを作成するのに先行して，今回のハンズオンで専用に使うSSHの公開鍵・秘密鍵のペアを準備する必要がある．</p>
</div>
<div class="paragraph">
<p>次の AWS CLI コマンドにより， <code>HirakeGoma</code> という名前のついた鍵を生成する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">export </span><span class="nv">KEY_NAME</span><span class="o">=</span><span class="s2">"HirakeGoma"</span>
<span class="nv">$ </span>aws ec2 create-key-pair <span class="nt">--key-name</span> <span class="k">${</span><span class="nv">KEY_NAME</span><span class="k">}</span> <span class="nt">--query</span> <span class="s1">'KeyMaterial'</span> <span class="nt">--output</span> text <span class="o">&gt;</span> <span class="k">${</span><span class="nv">KEY_NAME</span><span class="k">}</span>.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>このコマンドを実行すると，現在のディレクトリに <code>HirakeGoma.pem</code> というファイルが作成される．これが，サーバーにアクセスするための秘密鍵である． SSH でこの鍵を使うため， <code>~/.ssh/</code> のディレクトリに鍵を移動する．
さらに，秘密鍵が書き換えられたり第三者に閲覧されないよう，ファイルのアクセス権限を <code>400</code> に設定する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mv </span>HirakeGoma.pem ~/.ssh/
<span class="nv">$ </span><span class="nb">chmod </span>400 ~/.ssh/HirakeGoma.pem</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_デプロイを実行">4.4.4. デプロイを実行</h4>
<div class="paragraph">
<p>これまでのステップで， EC2 インスタンスをデプロイするための準備が整った！
早速，次のコマンドによりアプリケーションを AWS にデプロイしよう．
<code>-c key_name="HirakeGoma"</code> というオプションで，先ほど生成した <code>HirakeGoma</code> という名前の鍵を使うよう指定している．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>cdk deploy <span class="nt">-c</span> <span class="nv">key_name</span><span class="o">=</span><span class="s2">"HirakeGoma"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>このコマンドを実行すると， VPC， EC2 などがAWS上に展開される．
そして，コマンドの出力の最後に <a href="#handson_01_cdk_output">Figure 11</a> のような出力が得られるはずである．
<strong>出力の中で <code>InstancePublicIp</code> に続く数字が，起動したインスタンスのパブリック IP アドレスである．</strong>
IP アドレスはデプロイごとにランダムなアドレスが割り当てられる．</p>
</div>
<div id="handson_01_cdk_output" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-01/cdk_output.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 11. CDKデプロイ実行後の出力</div>
</div>
</div>
<div class="sect3">
<h4 id="_ssh_でログイン">4.4.5. SSH でログイン</h4>
<div class="paragraph">
<p>早速，SSH　で接続してみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>ssh <span class="nt">-i</span> ~/.ssh/HirakeGoma.pem ec2-user@&lt;IP address&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>-i</code> オプションで，先ほど生成した秘密鍵を指定している．
EC2 インスタンスにはデフォルトで <code>ec2-user</code> という名前のユーザーが作られているので，それを使用する．
最後に， <code>&lt;IP address&gt;</code> の部分は自身が作成したEC2インスタンスのIPアドレスで置き換える (<code>12.345.678.9</code> など）．</p>
</div>
<div class="paragraph">
<p>ログインに成功すると， <a href="#fig_handson_01_ssh_login">Figure 12</a> のような画面が表示される．
リモートのサーバーにログインしているので，プロンプトが <code>[ec2-user@ip-10-10-1-217 ~]$</code> のようになっていることを確認しよう．</p>
</div>
<div id="fig_handson_01_ssh_login" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-01/ssh_login.png" alt="ssh_login" width="700">
</div>
<div class="title">Figure 12. SSH で EC2 インスタンスにログイン</div>
</div>
<div class="paragraph">
<p><strong>おめでとう！これで，めでたくAWS上にEC2仮想サーバーを起動し，リモートからアクセスできるようになった！</strong></p>
</div>
</div>
<div class="sect3">
<h4 id="_起動した_ec2_インスタンスで遊んでみる">4.4.6. 起動した EC2 インスタンスで遊んでみる</h4>
<div class="paragraph">
<p>せっかく新しいインスタンスを起動したので，少し遊んでみよう．</p>
</div>
<div class="paragraph">
<p>ログインした EC2 インスタンスで，次のコマンドを実行してみよう．
CPU の情報を取得することができる．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cat</span> /proc/cpuinfo

processor	: 0
vendor_id	: GenuineIntel
cpu family	: 6
model		: 63
model name	: Intel<span class="o">(</span>R<span class="o">)</span> Xeon<span class="o">(</span>R<span class="o">)</span> CPU E5-2676 v3 @ 2.40GHz
stepping	: 2
microcode	: 0x43
cpu MHz		: 2400.096
cache size	: 30720 KB</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に，実行中のプロセスやメモリの消費を見てみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span> top <span class="nt">-n</span> 1

top - 09:29:19 up 43 min,  1 user,  load average: 0.00, 0.00, 0.00
Tasks:  76 total,   1 running,  51 sleeping,   0 stopped,   0 zombie
Cpu<span class="o">(</span>s<span class="o">)</span>:  0.3%us,  0.3%sy,  0.1%ni, 98.9%id,  0.2%wa,  0.0%hi,  0.0%si,  0.2%st
Mem:   1009140k total,   270760k used,   738380k free,    14340k buffers
Swap:        0k total,        0k used,        0k free,   185856k cached

  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
    1 root      20   0 19696 2596 2268 S  0.0  0.3   0:01.21 init
    2 root      20   0     0    0    0 S  0.0  0.0   0:00.00 kthreadd
    3 root      20   0     0    0    0 I  0.0  0.0   0:00.00 kworker/0:0</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>t2.micro</code> インスタンスなので， 1009140k = 1GB のメモリーがあることがわかる．</p>
</div>
<div class="paragraph">
<p>今回起動したインスタンスには Python 2 はインストール済みだが， Python 3 は入っていない．
Python 3.6 のインストールを行ってみよう．
インストールは簡単である．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>yum update <span class="nt">-y</span>
<span class="nv">$ </span><span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> python36</code></pre>
</div>
</div>
<div class="paragraph">
<p>インストールした Python を起動してみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python3
Python 3.6.10 <span class="o">(</span>default, Feb 10 2020, 19:55:14<span class="o">)</span>
<span class="o">[</span>GCC 4.8.5 20150623 <span class="o">(</span>Red Hat 4.8.5-28<span class="o">)]</span> on linux
Type <span class="s2">"help"</span>, <span class="s2">"copyright"</span>, <span class="s2">"credits"</span> or <span class="s2">"license"</span> <span class="k">for </span>more information.
<span class="o">&gt;&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Python のインタープリタが起動した！
<code>Ctrl + D</code> あるいは <code>exit()</code> と入力することで，インタープリタを閉じることができる．</p>
</div>
<div class="paragraph">
<p>さて，サーバーでのお遊びはこんなところにしておこう (興味があれば各自いろいろと試してみると良い) ．
次のコマンドでログアウトする．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">exit</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_aws_コンソールから確認">4.4.7. AWS コンソールから確認</h4>
<div class="paragraph">
<p>これまでは，すべてコマンドラインから EC2 に関連する操作を行ってきた．
EC2インスタンスの状態を確認したり，サーバーをシャットダウンするなどの操作は，AWS コンソールから実行することもできる．
軽くこれを紹介しよう．</p>
</div>
<div class="paragraph">
<p>まず，ウェブブラウザを開いて AWS コンソールにログインする．
ログインしたら， <code>Services</code> から <code>EC2</code> を検索(選択)する．
次に，左のサイドバーの <code>Instances</code> とページをたどる.
すると， <a href="#aws_ec2_console">Figure 13</a> のような画面が得られるはずである．
この画面で，自分のアカウントの管理下にあるインスタンスを確認できる．
同様に，VPC・SG についてもコンソールから確認できる．</p>
</div>
<div id="aws_ec2_console" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-01/ec2_console.png" alt="ec2_console" width="700">
</div>
<div class="title">Figure 13. EC2 コンソール画面</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>コンソール右上で，正しいリージョン (今回の場合は ap-northeast-1, Tokyo) が選択されているか，注意する！</strong></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>前章で CloudFormation について触れたが，今回デプロイしたアプリケーションも，CloudFormation のスタックとして管理されている．
<strong>スタック (stack)</strong> とは， AWS リソースの集合のことを指す．
今回の場合は， VPC/EC2/SG などがスタックの中に含まれている．
コンソールで <code>CloudFormation</code> のページに行ってみよう (<a href="#aws_cloudformation_console">Figure 14</a>)．</p>
</div>
<div id="aws_cloudformation_console" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-01/cloudformation_console.png" alt="cloudformation console" width="700">
</div>
<div class="title">Figure 14. CloudFormation コンソール画面</div>
</div>
<div class="paragraph">
<p>"MyFirstEc2" という名前のスタックがあることが確認できる．
クリックをして中身を見てみると，EC2, VPC などのリソースがこのスタックに紐付いていることがわかる．</p>
</div>
</div>
<div class="sect3">
<h4 id="handson_01_delete_stack">4.4.8. スタックを削除</h4>
<div class="paragraph">
<p>これにて，第一回のハンズオンで説明すべき事柄はすべて完了した．
最後に，使わなくなったスタックを削除しよう．
スタックの削除には，二つの方法がある．</p>
</div>
<div class="paragraph">
<p>一つ目の方法は，前節の Cloudformation のコンソール画面で， "Delete" ボタンを押すことである (<a href="#cloudformation_delete">Figure 15</a>)．
すると，スタックの状態が <code>"DELETE_IN_PROGRESS"</code> に変わり，削除が完了すると CloudFormation のスタックの一覧から消える．</p>
</div>
<div id="cloudformation_delete" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-01/cloudformation_delete.png" alt="cloudformation delete" width="700">
</div>
<div class="title">Figure 15. CloudFormationコンソール画面から，スタックを削除</div>
</div>
<div class="paragraph">
<p>二つ目の方法は，コマンドラインから行う方法である．
先ほど，デプロイを行ったコマンドラインに戻ろう．
そうしたら，次のコマンドを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>cdk destroy</code></pre>
</div>
</div>
<div class="paragraph">
<p>このコマンドを実行すると，スタックの削除が始まる．
削除した後は，VPC, EC2 など，すべて跡形もなく消え去っていることを自身で確かめよう．
CloudFormation を用いることで関連するすべての AWS リソースを一度に管理・削除することができるので，大変便利である．</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>スタックの削除は各自で必ず行うこと！</strong>
行わなかった場合， EC2 インスタンスの料金が発生し続けることになる！</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>また，本ハンズオンのために作成した SSH 鍵ペアも不要なので，削除しておく．
まず， EC2 側に登録してある公開鍵を削除する．
これも，コンソールおよびコマンドラインの二つの方法で実行できる．</p>
</div>
<div class="paragraph">
<p>コンソールから実行するには， <code>EC2</code> の画面に行き，左のサイドバーの <code>Key Pairs</code> を選択する．
鍵の一覧が表示されるので， <code>HirakeGoma</code> とある鍵にチェックを入れ，画面右上の <code>Actions</code> から， <code>Delete</code> を実行する (<a href="#delete_ec2_key_pair">Figure 16</a>)．</p>
</div>
<div id="delete_ec2_key_pair" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-01/ec2_keypair_console.png" alt="ec2_keypair_console" width="700">
</div>
<div class="title">Figure 16. EC2でSSH鍵ペアを削除</div>
</div>
<div class="paragraph">
<p>コマンドラインから実行するには，次のコマンドを使う．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws ec2 delete-key-pair <span class="nt">--key-name</span> <span class="s2">"HirakeGoma"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>最後に，ローカルのコンピュータから鍵を削除する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">rm</span> <span class="nt">-f</span> ~/.ssh/HirakeGoma.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>これで，クラウドの片付けもすべて終了だ．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>なお，頻繁に EC2 インスタンスを起動したりする場合は，いちいち SSH 鍵を削除する必要はない．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_小括">4.5. 小括</h3>
<div class="paragraph">
<p>ここまでが，本書の第一部の内容である．
盛りだくさんの内容であったが，ついてこれたであろうか？</p>
</div>
<div class="paragraph">
<p><a href="#chap_cloud_basics">Section 2</a> では，クラウドの定義と用語の説明を行ったあと，なぜクラウドを使うのか，という点を議論した．
続いて <a href="#sec_aws_general_introduction">Section 3</a> では，クラウドを学ぶ具体的なプラットフォームとして AWS を取り上げ， AWS を使用するにあたり最低限必要な知識と用語の説明を行った．
さらに， <a href="#sec_first_ec2">Section 4</a> のハンズオンでは AWS CLI と AWS CDK を使って，自身のプライベートなサーバーを AWS 上に立ち上げる演習を行った．</p>
</div>
<div class="paragraph">
<p>これらを通じて，いかに簡単に (たった数行のコマンドで！) 仮想サーバーを立ち上げたり，削除したりすることができるか，体験できただろう．
筆者は，<a href="#chap_cloud_basics">Section 2</a> でクラウドの最も重要な側面はダイナミックに計算リソースを拡大・縮小できることである，と述べた．
この言葉の意味が，ハンズオンを通じてより明らかになっただろうか？
ここで学んだ技術を少し応用するだけで，自分のウェブページをホストする仮想サーバーを作成したり，大量のコアを搭載した EC2 インスタンスを用意して科学計算を実行するなど，いろいろなアプリケーションが実現できる．</p>
</div>
<div class="paragraph">
<p>次章からは，今回学んだクラウドの技術を基に，より現実に即した問題を解くことを体験してもらう．
お楽しみに！</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec_scientific_computing">5. クラウドで行う科学計算・機械学習</h2>
<div class="sectionbody">
<div class="paragraph">
<p>計算機が発達した現代では，計算機によるシミュレーションやビッグデータの解析は，科学・エンジニアリングの研究の主要な柱である．
これらの大規模な計算を実行するには，クラウドは最適である．
本章から始まる第二部では，どのようにしてクラウド上で科学計算を実行するのかを，ハンズオンとともに体験してもらう．
科学計算の具体的な題材として，今回は機械学習(深層学習)を取り上げる．</p>
</div>
<div class="paragraph">
<p>なお，本書では <a href="https://pytorch.org/">PyTorch</a> ライブラリを使って深層学習のアルゴリズムを実装するが，深層学習および PyTorch の知識は不要である．
講義ではなぜ・どうやって深層学習をクラウドで実行するかに主眼を置いているので，実行するプログラムの詳細には立ち入らない．
将来，自分で深層学習を使う機会が来たときに，詳しく学んでもらいたい．</p>
</div>
<div class="sect2">
<h3 id="_なぜ機械学習をクラウドで行うのか">5.1. なぜ機械学習をクラウドで行うのか？</h3>
<div class="paragraph">
<p>2010年頃に始まった第三次 AI ブームのおかげで，学術研究だけでなく社会・ビジネスの文脈でも機械学習に高い関心が寄せられている．
とくに，<strong>深層学習 (ディープラーニング)</strong> とよばれる多層のレイヤーからなるニューラルネットワークを用いたアルゴリズムは，画像認識や自然言語処理などの分野で圧倒的に高い性能を実現し，革命をもたらしている．</p>
</div>
<div class="paragraph">
<p>深層学習の特徴は，なんといってもそのパラメータの多さである．
層が深くなるほど，層間のニューロンを結ぶ重みパラメータの数が増大していく．
たとえば，最新の言語モデルである <a href="https://arxiv.org/abs/2005.14165">GPT-3</a> には<strong>1750億個</strong>ものパラメータが含まれている．
このような膨大なパラメータを有することで，深層学習は高い表現力と汎化性能を実現しているのである．</p>
</div>
<div class="paragraph">
<p>GPT-3 に限らず，最近の SOTA (State-of-the-art) の性能を達成するニューラルネットワークでは，百万から億のオーダーのパラメータを内包することは頻繁になってきている．
そのような巨大なニューラルネットを訓練 (最適化) させるのは，当然のことながら膨大な計算コストがかかる．
結果として，ひとつの計算機では丸一日以上の時間がかかる場合も珍しくない．
深層学習の発展の速度は目覚ましく，研究・ビジネス両方の観点からも，いかにスループットよくニューラルネットワークの最適化を行えるかが鍵となってくる．
そのような問題を解決するのにとても有効な手段が，クラウドである！
<a href="#sec_first_ec2">Section 4</a> でその片鱗を見たように，クラウドを使用することでゼロから数千に至るまでの数のインスタンスを動的に起動し，並列に計算を実行することができる．
さらに，深層学習を加速させる目的で，深層学習の演算に専用設計された計算チップ (GPU など) がある．
クラウドを利用すると，そのような専用計算チップも無尽蔵に利用することができる．
事実，先述した GPT-3 の学習も，詳細は明かされていないが，Microsoft 社のクラウドを使って行われたと報告されている．</p>
</div>
</div>
<div class="sect2">
<h3 id="_gpu_による深層学習の高速化">5.2. GPU による深層学習の高速化</h3>
<div class="paragraph">
<p>深層学習の計算で欠かすことのできない技術として， <strong>GPU (Graphics Processing Unit)</strong> について少し説明する．</p>
</div>
<div class="paragraph">
<p>GPU は，その名のとおり，元々はコンピュータグラフィックスを出力するための専用計算チップである．
CPU (Central Processing Unit) に対し，グラフィックスの演算に特化した設計がなされている．
身近なところでは， XBox や PS5 などのゲームコンソールなどに搭載されているし，ハイエンドなノート型・デスクトップ型計算機にも搭載されていることがある．
コンピュータグラフィックスでは，スクリーンにアレイ状に並んだ数百万個の画素をビデオレート (30 fps) 以上で処理する必要がある．
そのため，GPUはコアあたりの演算能力は比較的小さいかわりに，チップあたり数百から数千のコアを搭載しており (<a href="#gpu_architecture">Figure 17</a>)，スクリーンの画素を並列的に処理することで，リアルタイムでの描画を実現している．</p>
</div>
<div id="gpu_architecture" class="imageblock text-center">
<div class="content">
<img src="imgs/gpu_architecture.jpg" alt="cdk output" width="500">
</div>
<div class="title">Figure 17. GPUのアーキテクチャ．GPUには数百から数千の独立した計算コアが搭載されている． (画像出典: <a href="https://devblogs.nvidia.com/nvidia-turing-architecture-in-depth/" class="bare">https://devblogs.nvidia.com/nvidia-turing-architecture-in-depth/</a>)</div>
</div>
<div class="paragraph">
<p>このように，コンピュータグラフィクスの目的で生まれた GPU だが，2010年前後から，その高い並列計算能力をグラフィックス以外の計算 (科学計算など) に用いるという流れ (<strong>General-purpose computing on GPU; GPGPU</strong>) が生まれた．
GPUのコアは，その設計から，行列の計算など，単純かつ規則的な演算が得意であり，そのような演算に対しては数個程度のコアしかもたない CPU に比べて圧倒的に高い計算速度を実現することができる．
現在では GPGPU は分子動力学や気象シミュレーション，そして機械学習など多くの分野で使われている．</p>
</div>
<div class="paragraph">
<p>ディープラーニングで最も頻繁に起こる演算が，ニューロンの出力を次の層のニューロンに伝える<strong>畳み込み (Convolution)</strong> 演算である (<a href="#fig:convolution">Figure 18</a>)．
畳み込み演算は，まさに GPU が得意とする演算であり， CPU ではなく GPU を用いることで学習を飛躍的に (最大で数百倍程度) 加速させることができる．</p>
</div>
<div id="fig:convolution" class="imageblock text-center">
<div class="content">
<img src="imgs/cnn.png" alt="cnn" width="400">
</div>
<div class="title">Figure 18. ニューラルネットワークにおける畳み込み演算．</div>
</div>
<div class="paragraph">
<p>このように GPU は機械学習の計算で欠かせないものであるが，なかなか高価である．
たとえば，科学計算・機械学習に専用設計された NVIDIA 社の Tesla V100 というチップは，一台で約百万円の価格が設定されている．
機械学習を始めるのに，いきなり百万円の投資はなかなか大きい．
だが，クラウドを使えば，初期コスト０で GPU を使用することができる．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>機械学習を行うのに， V100 が必ずしも必要というわけではない．
むしろ，研究者などでしばしば行われるのは，コンピュータゲームに使われるグラフィックス用の GPU を買ってきて (NVIDIA GeForce シリーズなど)，開発のときはをそれを用いる，というアプローチである．
グラフィックス用のいわゆる"コンシューマ GPU"は，市場の需要が大きいおかげで，10万円前後の価格で購入することができる．
V100 と比べると，コンシューマ GPU はコアの数が少なかったり，メモリーが小さかったりなどで劣る点があるが，
それらを除いては計算能力にとくに制限があるわけではなく，開発の段階では十分な性能である場合がほとんどである．
プログラムができあがって，ビッグデータの解析や，モデルをさらに大きくしたいときなどに，クラウドは有効だろう．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>クラウドで GPU を使うには， GPU が搭載されたEC2インスタンスタイプ (<code>P3</code>, <code>P2</code>, <code>G3</code>, <code>G4</code> など) を選択しなければならない．
<a href="#table_gpu_instances">Table 3</a> に，代表的な GPU 搭載のインスタンスタイプを挙げる (執筆時点での情報)．</p>
</div>
<table id="table_gpu_instances" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. GPUを搭載したEC2インスタンスタイプ</caption>
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Instance</th>
<th class="tableblock halign-left valign-top">GPUs</th>
<th class="tableblock halign-left valign-top">GPU model</th>
<th class="tableblock halign-left valign-top">GPU Mem (GiB)</th>
<th class="tableblock halign-left valign-top">vCPU</th>
<th class="tableblock halign-left valign-top">Mem (GiB)</th>
<th class="tableblock halign-left valign-top">Price per hour ($)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">p3.2xlarge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NVIDIA V100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">61</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.06</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">p3n.16xlarge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NVIDIA V100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">128</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">488</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">24.48</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">p2.xlarge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NVIDIA K80</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">61</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.9</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">g4dn.xlarge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NVIDIA T4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.526</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#table_gpu_instances">Table 3</a> からわかるとおり， CPU のみのインスタンスと比べると少し高い価格設定になっている．
また，古い世代の GPU (V100 に対しての K80) はより安価な価格で提供されている．
1インスタンスあたりの GPU の搭載数は1台から最大で8台まで選択することが可能である．</p>
</div>
<div class="paragraph">
<p>GPU を搭載した一番安いインスタンスタイプは， <code>g4dn.xlarge</code> であり，これには廉価かつ省エネルギー設計の NVIDIA T4 が搭載されている．
後のハンズオンでは，このインスタンスを使用して，ディープラーニングの計算を行ってみる．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="#table_gpu_instances">Table 3</a> の価格は <code>us-east-1</code> のものである．
リージョンによって多少価格設定が異なる．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>V100 を一台搭載した <code>p3.2xlarge</code> の利用料金は一時間あたり $3.06 である．
V100 が約百万円で売られていることを考えると，約3000時間 (= 124日間)，通算で計算を行った場合に，クラウドを使うよりもV100を自分で買ったほうがお得になる，という計算になる
(実際には，自前で V100 を用意する場合は， V100 だけでなく， CPU やネットワーク機器，電気使用料も必要なので，百万円よりもさらにコストがかかる)．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>GPT-3 で使われた計算リソースの詳細は論文でも明かされていないのだが， <a href="https://lambdalabs.com/blog/demystifying-gpt-3/">Lambda 社のブログ</a>で興味深い考察が行われている
(Lambda 社は機械学習に特化したクラウドサービスを提供している)．</p>
</div>
<div class="paragraph">
<p>記事によると，1750億のパラメータを訓練するには，一台の GPU (NVIDIA V100) を用いた場合，342年の月日と460万ドルのクラウド利用料が必要となる，とのことである．
GPT-3 のチームは，複数の GPU に処理を分散することで現実的な時間のうちに訓練を完了させたのであろうが，このレベルのモデルになってくるとクラウド技術の限界を攻めないと達成できないことは確かである．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Further reading</div>
<div class="paragraph">
<p>深層学習を詳しく勉強したい人には以下の参考書を推薦したい．
深層学習の基礎的な概念や理論は普遍的であるが，この分野は日進月歩なので，常に最新の情報を取り入れることを忘れずに．</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.deeplearningbook.org/">Deep Learning (Ian Goodfellow, Yoshua Bengio and Aaron Courville)</a>
出版されてから数年が経つが，深層学習の理論的な側面を学びたいならばおすすめの入門書．
ウェブで無料で読むことができる．
日本語版も出版されている．
実装についてはほとんど触れられていないので，理論家向けの本．</p>
</li>
<li>
<p><a href="https://www.oreilly.co.jp/books/9784873117584/">ゼロから作る Deep Learning (斎藤 康毅)</a>
合計三冊からなるシリーズ．
理論と実装がバランスよく説明されていて，深層学習の入門書の決定版．</p>
</li>
<li>
<p><a href="https://d2l.ai/">Dive into Deep Learning (Aston Zhang, Zachary C. Lipton, Mu Li, and Alexander J. Smola)</a>
深層学習の基礎から最新のアルゴリズムまでを，実装を通して学んでいくスタイルの本．
ウェブで無料で読むことができる，1000ページ越えの超大作．
これを読破することができれば，深層学習の実装で困ることはないだろう．</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec_jupyter_and_deep_learning">6. Hands-on #2: AWS でディープラーニングを実践</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="sec:jupyter_and_deep_learning_setup">6.1. 準備</h3>
<div class="paragraph">
<p>ハンズオン第二回では， GPU を搭載したEC2インスタンスを起動し，深層学習モデルの学習と推論を実行する演習を行う．</p>
</div>
<div class="paragraph">
<p>ハンズオンのソースコードは GitHub の
<a href="https://github.com/tomomano/learn-aws-by-coding/tree/main/handson/mnist">handson/mnist</a>
に置いてある．</p>
</div>
<div class="paragraph">
<p>本ハンズオンの実行には，第一回ハンズオンで説明した準備 (<a href="#handson_01_prep">Section 4.1</a>) が整っていることを前提とする．
それ以外に必要な準備はない．</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>初期状態の AWS アカウントでは， GPU 搭載の Gタイプのインスタンスの起動上限が0になっていることがある．
これを確認するには， AWS コンソールから EC2 の画面を開き，左のメニューから <code>Limits</code> を選択する．
その中の <code>Running On-Demand All G instances</code> という数字が G インスタンスの起動上限を表している．</p>
</div>
<div class="paragraph">
<p>もし，これが 0 になっていた場合は， AWS の自動申請フォームから上限緩和のリクエストを送る必要がある．
詳しくは
<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-resource-limits.html">公式ドキュメンテーション "Amazon EC2 service quotas"</a>
を参照のこと．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このハンズオンは， <code>g4dn.xlarge</code> タイプの EC2 インスタンスを使うので，東京 (<code>ap-northeast-1</code>) リージョンでは 0.71 $/hour のコストが発生する．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>AWS Educate Starter Account を使用している読者へ:
執筆時点においては， Starter Account には GPU 搭載型インスタンスを起動できないという制限が設けられている．
したがって， Starter Account のユーザーはこのハンズオンを実行することはできない．
興味のある読者は，制限のない一般アカウントを自分自身で取得する必要があることに注意．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_アプリケーションの説明_2">6.2. アプリケーションの説明</h3>
<div class="paragraph">
<p>このハンズオンで作成するアプリケーションの概要を <a href="#handson_02_architecture">Figure 19</a> に示す．</p>
</div>
<div id="handson_02_architecture" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-jupyter/handson-02-architecture.png" alt="hands-on 01 architecture" width="600">
</div>
<div class="title">Figure 19. ハンズオン#2で作製するアプリケーションのアーキテクチャ</div>
</div>
<div class="paragraph">
<p>図の多くの部分が，第一回ハンズオンで作成したアプリケーションと共通していることに気がつくだろう．
少しの変更で，簡単にディープラーニングを走らせる環境を構築することができるのである！主な変更点は次の３点である．</p>
</div>
<div class="ulist">
<ul>
<li>
<p>GPUを搭載した <code>g4dn.xlarge</code> インスタンスタイプを使用</p>
</li>
<li>
<p>ディープラーニングに使うプログラムがあらかじめインストールされた DLAMI (後述) を使用</p>
</li>
<li>
<p>SSHにポートフォワーディングのオプションつけてサーバーに接続し，サーバーで起動しているJupyter Notebook (後述) を使ってプログラムを書いたり実行したりする</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ハンズオンで使用するプログラムのコードをみてみよう
<a href="https://github.com/tomomano/learn-aws-by-coding/tree/main/handson/mnist/app.py">handson/mnist/app.py</a>)．
コードは第一回目とほとんど共通である．変更点のみ解説を行う．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">Ec2ForDl</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Stack</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">App</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">vpc</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"Ec2ForDl-Vpc"</span><span class="p">,</span>
            <span class="n">max_azs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">cidr</span><span class="o">=</span><span class="s">"10.10.0.0/23"</span><span class="p">,</span>
            <span class="n">subnet_configuration</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ec2</span><span class="o">.</span><span class="n">SubnetConfiguration</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s">"public"</span><span class="p">,</span>
                    <span class="n">subnet_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetType</span><span class="o">.</span><span class="n">PUBLIC</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="n">nat_gateways</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">sg</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">SecurityGroup</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"Ec2ForDl-Sg"</span><span class="p">,</span>
            <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
            <span class="n">allow_all_outbound</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">sg</span><span class="o">.</span><span class="n">add_ingress_rule</span><span class="p">(</span>
            <span class="n">peer</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">Peer</span><span class="o">.</span><span class="n">any_ipv4</span><span class="p">(),</span>
            <span class="n">connection</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">Port</span><span class="o">.</span><span class="n">tcp</span><span class="p">(</span><span class="mi">22</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">host</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"Ec2ForDl-Instance"</span><span class="p">,</span>
            <span class="n">instance_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">InstanceType</span><span class="p">(</span><span class="s">"g4dn.xlarge"</span><span class="p">),</span> <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="n">machine_image</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">MachineImage</span><span class="o">.</span><span class="n">generic_linux</span><span class="p">({</span>
                <span class="s">"us-east-1"</span><span class="p">:</span> <span class="s">"ami-060f07284bb6f9faf"</span><span class="p">,</span>
                <span class="s">"ap-northeast-1"</span><span class="p">:</span> <span class="s">"ami-09c0c16fc46a29ed9"</span>
            <span class="p">}),</span> <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
            <span class="n">vpc_subnets</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetSelection</span><span class="p">(</span><span class="n">subnet_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetType</span><span class="o">.</span><span class="n">PUBLIC</span><span class="p">),</span>
            <span class="n">security_group</span><span class="o">=</span><span class="n">sg</span><span class="p">,</span>
            <span class="n">key_name</span><span class="o">=</span><span class="n">key_name</span>
        <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ここで， <code>g4dn.xlarge</code> インスタンスタイプを選択している (第一回では， CPU のみの <code>t2.micro</code> だった)．
<code>g4dn.xlarge</code> のインスタンスタイプは， <a href="#sec_scientific_computing">Section 5</a> ですでに触れた通り， <code>NVIDIA T4</code> と呼ばれる廉価版モデルの GPU を搭載したインスタンスである．
CPU は 4 core, メインメモリーは 16GB が割り当てあられている．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ここでは，Deep Learning 用の諸々のソフトウェアがプリンストールされたAMI (<a href="https://docs.aws.amazon.com/dlami/latest/devguide/what-is-dlami.html">Deep Learning Amazon Machine Image; DLAMI</a>) を選択している
(第一回では，Amazon Linux というAMIを使用していた)．
使用する AMI のIDは リージョンごとに指定する必要があり，ここでは <code>us-east-1</code> と <code>ap-northeast-1</code> でそれぞれ定義している．</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>DLAMI という新しい概念が出てきたので，説明しよう．</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>AMI が <code>us-east-1</code> と <code>ap-northeast-1</code> でしか定義されていないので，提供されているコードはこの二つのリージョンのみでデプロイ可能である．
もしほかのリージョンを利用したい場合は， AMI の ID を自身で検索し，コードに書き込む必要がある．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_dlami_deep_learning_amazon_machine_image">6.2.1. DLAMI (Deep Learning Amazon Machine Image)</h4>
<div class="paragraph">
<p><strong>AMI (Amazon Machine Image)</strong> とは，大まかには OS (Operating System) に相当する概念である．
当然のことながら， OS がなければコンピュータはなにもできないので，EC2 インスタンスを起動するときには必ずなにかの OS を"インストール"する必要がある．
EC2 が起動したときにロードされる OS に相当するものが， AMI である．
AMI には，たとえば <a href="https://ubuntu.com/">Ubuntu</a> などの Linux 系 OS に加えて，Windows Server を選択することもできる．
また， EC2 での使用に最適化された <a href="https://aws.amazon.com/amazon-linux-ami/">Amazon Linux</a> という AMI も提供されている．</p>
</div>
<div class="paragraph">
<p>しかしながら， AMI を単なる OS と理解するのは過剰な単純化である．
AMI には，ベースとなる (空っぽの) OS を選択することもできるが，それに加えて，各種のプログラムがインストール済みの AMI も定義することができる．
必要なプログラムがインストールされている AMI を見つけることができれば，自身でインストールを行ったり環境設定したりする手間が大幅に省ける．
具体例を挙げると，ハンズオン第一回では EC2 インスタンスに Python 3.6 をインストールする例を示したが，そのような操作をインスタンスが起動するたびに行うのは手間である！</p>
</div>
<div class="paragraph">
<p>AMI は， AWS 公式のものに加えて，サードパーティから提供されているものもある．
また，自分自身の AMI を作って登録することも可能である (<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/creating-an-ami-instance-store.html">参考</a>)．
AMI は EC2 のコンソールから検索することが可能である．
あるいは，AWS CLI を使って，次のコマンドでリストを取得することができる (<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/finding-an-ami.html">参考</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws ec2 describe-images <span class="nt">--owners</span> amazon</code></pre>
</div>
</div>
<div class="paragraph">
<p>ディープラーニングで頻繁に使われるプログラムがあらかじめインストールしてあるAMIが， <a href="https://docs.aws.amazon.com/dlami/latest/devguide/what-is-dlami.html">DLAMI (Deep Learning AMI)</a> である．
DLAMI には <code>TensorFlow</code>, <code>PyTorch</code> などの人気の高いディープラーニングのフレームワーク・ライブラリがすでにインストールされているため， EC2 インスタンスを起動してすぐさまディープラーニングの計算を実行できる．</p>
</div>
<div class="paragraph">
<p>本ハンズオンでは， Amazon Linux 2 をベースにした DLAMI を使用する (AMI ID = ami-09c0c16fc46a29ed9．この AMI は ap-northeast-1 でしか使用できない点に注意)．
AWS CLI を使って，このAMIの詳細情報を取得してみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws ec2 describe-images <span class="nt">--owners</span> amazon <span class="nt">--image-ids</span> <span class="s2">"ami-09c0c16fc46a29ed9"</span> <span class="nt">--region</span> ap-northeast-1</code></pre>
</div>
</div>
<div id="handson_02_ami-info" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-jupyter/ami-info.png" alt="ami-info" width="700">
</div>
<div class="title">Figure 20. AMI ID = ami-09c0c16fc46a29ed9 の詳細情報</div>
</div>
<div class="paragraph">
<p><a href="#handson_02_ami-info">Figure 20</a> のような出力が得られるはずである．得られた出力から，この DLAMI には PyTorch のバージョン1.4.0 と 1.5.0 がインストールされていることがわかる．
このDLAMIを使って，早速ディープラーニングの計算を実行してみよう．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>DLAMIには具体的には何がインストールされているのだろうか？
興味のある読者のために，簡単な解説をしよう
(参考: <a href="https://docs.aws.amazon.com/dlami/latest/devguide/what-is-dlami.html">公式ドキュメンテーション "What Is the AWS Deep Learning AMI?"</a>)．</p>
</div>
<div class="paragraph">
<p>最も low-level なレイヤーとしては， GPU ドライバー がインストールされている．
GPU ドライバーなしには OS は GPU とコマンドのやり取りをすることができない．
次のレイヤーが <a href="https://developer.nvidia.com/about-cuda">CUDA</a> と <a href="https://developer.nvidia.com/cudnn">cuDNN</a> である．
CUDA は， NVIDIA 社が開発した， GPU 上で汎用コンピューティングを行うための言語であり， C++ 言語を拡張したシンタックスを備える．
cuDNN は CUDA で書かれたディープラーニングのライブラリであり，n次元の畳み込みなどの演算が実装されている．
ここまでが， "Base" とよばれるタイプの DLAMI の中身である．</p>
</div>
<div class="paragraph">
<p>これに加えて， "Conda" とよばれるタイプには， "Base" のプログラム基盤の上に， <code>TensorFlow</code> や <code>PyTorch</code> などのライブラリがインストールされている．
さらに， <a href="https://docs.conda.io/projects/conda/en/latest/index.html">Anaconda</a> による仮想環境を使うことによって， <code>TensorFlow</code> の環境・ <code>PyTorch</code> の環境・ <code>MxNet</code> の環境など，フレームワークを簡単に切り替えることができる (これについては，後のハンズオンで触れる)．
また， Jupyter Notebook もインストール済みである．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_スタックのデプロイ">6.3. スタックのデプロイ</h3>
<div class="paragraph">
<p>スタックの中身が理解できたところで，早速スタックをデプロイしてみよう．</p>
</div>
<div class="paragraph">
<p>デプロイの手順は，ハンズオン1とほとんど共通である．
ここでは，コマンドのみ列挙する (<code>#</code> で始まる行はコメントである)．
それぞれのコマンドの意味を忘れてしまった場合は，ハンズオン1に戻って復習していただきたい．
シークレットキーの設定も忘れずに (<a href="#aws_cli_install">Section 15.3</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c"># プロジェクトのディレクトリに移動</span>
<span class="nv">$ </span><span class="nb">cd </span>handson/mnist

<span class="c"># venv を作成し，依存ライブラリのインストールを行う</span>
<span class="nv">$ </span>python3 <span class="nt">-m</span> venv .env
<span class="nv">$ </span><span class="nb">source</span> .env/bin/activate
<span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt

<span class="c"># SSH鍵を生成</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">KEY_NAME</span><span class="o">=</span><span class="s2">"HirakeGoma"</span>
<span class="nv">$ </span>aws ec2 create-key-pair <span class="nt">--key-name</span> <span class="k">${</span><span class="nv">KEY_NAME</span><span class="k">}</span> <span class="nt">--query</span> <span class="s1">'KeyMaterial'</span> <span class="nt">--output</span> text <span class="o">&gt;</span> <span class="k">${</span><span class="nv">KEY_NAME</span><span class="k">}</span>.pem
<span class="nv">$ </span><span class="nb">mv </span>HirakeGoma.pem ~/.ssh/
<span class="nv">$ </span><span class="nb">chmod </span>400 ~/.ssh/HirakeGoma.pem

<span class="c"># デプロイを実行</span>
<span class="nv">$ </span>cdk deploy <span class="nt">-c</span> <span class="nv">key_name</span><span class="o">=</span><span class="s2">"HirakeGoma"</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ハンズオン1で作成した SSH 鍵の削除を行わなかった場合は， SSH 鍵を改めて作成する必要はない．
逆に言うと，同じ名前のSSHがすでに存在する場合は，鍵生成のコマンドはエラーを出力する．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>デプロイのコマンドが無事に実行されれば， <a href="#handson_02_cdk_output">Figure 21</a> のような出力が得られるはずである．AWSにより割り振られたIPアドレス (<code>InstancePublicIp</code> に続く文字列) をメモしておこう．</p>
</div>
<div id="handson_02_cdk_output" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-jupyter/cdk_output.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 21. CDKデプロイ実行後の出力</div>
</div>
</div>
<div class="sect2">
<h3 id="_ログイン">6.4. ログイン</h3>
<div class="paragraph">
<p>早速，デプロイしたインスタンスにSSHでログインしてみよう．
ここでは，この後で使う Jupyter Notebook に接続するため，<strong>ポートフォワーディング (port forwarding)</strong> のオプション (<code>-L</code>) をつけてログインする．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>ssh <span class="nt">-i</span> ~/.ssh/HirakeGoma.pem <span class="nt">-L</span> localhost:8931:localhost:8888 ec2-user@&lt;IP address&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>ポートフォワーディングとは，クライアントマシンの特定のアドレスへの接続を， SSH の暗号化された通信を介して，リモートマシンの特定のアドレスへ転送する，という意味である．
このコマンドの <code>-L localhost:8931:localhost:8888</code> は，自分のローカルマシンの <code>localhost:8931</code> へのアクセスを，リモートサーバーの <code>localhost:8888</code> のアドレスに転送せよ，という意味である
(<code>:</code> につづく数字はTCP/IPポートの番号を意味している)．
リモートサーバーのポート8888には，後述する Jupyter Notebook が起動している．
したがって，ローカルマシンの <code>localhost:8931</code> にアクセスすることで，リモートサーバーの Jupyter Notebook にアクセスすることができるのである (<a href="#fig:ssh_port_forwarding">Figure 22</a>)．
このようなSSHによる接続方式を<strong>トンネル接続</strong>とよぶ．</p>
</div>
<div id="fig:ssh_port_forwarding" class="imageblock text-center">
<div class="content">
<img src="imgs/ssh_port_forwarding.png" alt="ssh_port_forwarding" width="700">
</div>
<div class="title">Figure 22. SSH のポートフォワーディングによる Jupyter Notebook へのアクセス</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ポートフォワーディングのオプションで，ポートの番号 (<code>:8931</code>, <code>:8888</code> など) には1から65535までの任意の整数を指定できる．
しかし，たとえば ポート 22 (SSH) やポート 80 (HTTP) など，いくつかすでに使われているポート番号もあることに注意する．
また， Jupyter Notebook はデフォルトではポート8888番を使用する．
したがって，リモート側のポート番号は，8888を使うのがよい．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>SSH ログインコマンドの <code>&lt;IP address&gt;</code> 部分は自身のインスタンスのIPアドレスを代入することを忘れずに．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>本書の提供している Docker を使ってデプロイを実行した人へ</strong></p>
</div>
<div class="paragraph">
<p>SSH によるログインは， <strong>Docker の外</strong> (すなわちクライアントマシン本体) から行わなければならない．
なぜなら，Jupyter を開くウェブブラウザは Docker の外にあるからである．</p>
</div>
<div class="paragraph">
<p>その際，秘密鍵を Docker の外にもってこなければならない．
手っ取り早い方法は， <code>cat ~/.ssh/HirakeGoma</code> と打って，出力結果をコピーしてホストマシンのファイルに書き込む方法である．
あるいは <code>-v</code> オプションをつけて，ファイルシステムをマウントしてもよい
(詳しくは
<a href="https://docs.docker.com/storage/volumes/">Docker 公式ドキュメンテーション "Use volumes"</a>
を参照)．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>SSHによるログインができたら，早速， GPU の状態を確認してみよう．
次のコマンドを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>nvidia-smi</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#handson_02_nvidia-smi">Figure 23</a> のような出力が得られるはずである．
出力を見ると， Tesla T4 型のGPUが1台搭載されていることが確認できる．
その他，GPU Driver や CUDA のバージョン， GPU の負荷・メモリー使用率などの情報を確認することができる．</p>
</div>
<div id="handson_02_nvidia-smi" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-jupyter/nvidia-smi.png" alt="nvidia-smi" width="700">
</div>
<div class="title">Figure 23. nvidia-smi の出力</div>
</div>
</div>
<div class="sect2">
<h3 id="_jupyter_notebook_の起動">6.5. Jupyter Notebook の起動</h3>
<div class="paragraph">
<p><a href="https://jupyter.org/">Jupyter Notebook</a> とは，インタラクティブに Python のプログラムを書いたり実行したりするためのツールである．
Jupyter は GUI としてウェブブラウザを介してアクセスする形式をとっており，まるでノートを書くように，プロットやテーブルのデータも美しく表示することができる (<a href="#handson_02_welcome_jupyter">Figure 24</a>)．
Python に慣れている読者は，きっと一度は使ったことがあるだろう．</p>
</div>
<div id="handson_02_welcome_jupyter" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-jupyter/welcome_to_jupyter.png" alt="welcome to jupyter" width="700">
</div>
<div class="title">Figure 24. Jupyter Notebook の画面</div>
</div>
<div class="paragraph">
<p>このハンズオンでは， Jupyter Notebook を使ってディープラーニングのプログラムをインタラクティブに実行していく．
DLAMI には既に Jupyter がインストールされているので，特段の設定なしに使い始めることができる．</p>
</div>
<div class="paragraph">
<p>早速， Jupyter を起動しよう．
SSHでログインした先の EC2 インスタンスで，次のコマンドを実行すればよい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cd</span> ~ <span class="c"># go to home directory</span>
<span class="nv">$ </span>jupyter notebook</code></pre>
</div>
</div>
<div class="paragraph">
<p>このコマンドを実行すると， <a href="#handson_02_jupyter_launch">Figure 25</a> のような出力が確認できるだろう．
この出力から，Jupyter のサーバーが EC2 インスタンスの <code>localhost:8888</code> というアドレスに起動していることがわかる．
また， <code>localhost:8888</code> に続く <code>?token=XXXX</code> は，アクセスに使うための一時的なトークンである．</p>
</div>
<div id="handson_02_jupyter_launch" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-jupyter/jupyter_launch.png" alt="jupyter launch" width="700">
</div>
<div class="title">Figure 25. Jupyter Notebook サーバーを起動</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Jupyter Notebook を初回に起動するときは，起動に数分程度の時間がかかることがある．
ほかの動作も起動直後は遅く，いくつかプログラムを走らせていくうちに俊敏に反応するようになってくる．
これは， AWS の GPU 搭載型仮想マシンの運用方法に起因する現象だと考えられる．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>先ほど，ポートフォワーディングのオプションをつけて SSH 接続をしているので， Jupyter の起動している <code>localhost:8888</code> には，ローカルマシンの <code>localhost:8931</code> からアクセスすることができる．
したがって，ローカルマシンから Jupyter にアクセスするには，ウェブブラウザ (Chrome, FireFox など)から次のアドレスにアクセスすれば良い．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>http://localhost:8931/?token=XXXX</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>?token=XXXX</code> の部分は，上で Jupyter を起動したときに発行されたトークンの値に置き換える．</p>
</div>
<div class="paragraph">
<p>上のアドレスにアクセスすると， Jupyter のホーム画面が起動するはずである (<a href="#handson_02_jupyter_home">Figure 26</a>)．
これで， Jupyter の準備が整った！</p>
</div>
<div id="handson_02_jupyter_home" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-jupyter/jupyter_home.png" alt="jupyter home" width="700">
</div>
<div class="title">Figure 26. Jupyter ホーム画面</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Jupyter Notebook の使い方 (超簡易版)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Shift</code> + <code>Enter</code>: セルを実行</p>
</li>
<li>
<p><code>Esc</code>: <strong>Command mode</strong> に遷移</p>
</li>
<li>
<p>メニューバーの "+" ボタン または Command mode で <code>A</code> &#8658; セルを追加</p>
</li>
<li>
<p>メニューバーの "ハサミ" ボタン または Command mode で <code>X</code> &#8658; セルを削除</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ショートカットの一覧などは <a href="https://towardsdatascience.com/jypyter-notebook-shortcuts-bf0101a98330">Ventsislav Yordanov 氏によるブログ</a> が参考になる．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_pytorchはじめの一歩">6.6. PyTorchはじめの一歩</h3>
<div class="paragraph">
<p><a href="https://pytorch.org/">PyTorch</a> は Facebook AI Research LAB (FAIR) が中心となって開発を進めている，オープンソースのディープラーニングのライブラリである．
PyTorch は 有名な例で言えば Tesla 社の自動運転プロジェクトなどで使用されており，執筆時点において最も人気の高いディープラーニングライブラリの一つである．
本ハンズオンでは， PyTorch を使ってディープラーニングの実践を行う．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>PyTorch の歴史のお話</p>
</div>
<div class="paragraph">
<p>Facebook は PyTorch のほかに Caffe2 とよばれるディープラーニングのフレームワークを開発していた
(初代Caffe は UC Berkley の博士課程学生だった Yangqing Jia によって創られた)．
Caffe2 は 2018年に PyTorch プロジェクトに合併された．</p>
</div>
<div class="paragraph">
<p>また，2019年12月，日本の Preferred Networks 社が開発していた <a href="https://chainer.org/">Chainer</a> も開発を終了し，PyTorchの開発チームと協業していくことが発表された
(詳しくは <a href="https://chainer.org/announcement/2019/12/05/released-v7-ja.html">プレスリリース</a> を参照)．
PyTorch には，開発統合前から Chainer からインスパイアされた API がいくつもあり， Chainer の DNA は今も PyTorch に引き継がれているのである&#8230;&#8203;!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>本格的なディープラーニングの計算に移る前に， PyTorch ライブラリを使って， GPU で計算を行うとはどういうものか，その入り口に触れてみよう．</p>
</div>
<div class="paragraph">
<p>まずは，新しいノートブックを作成する．
Jupyterのホーム画面の右上の "New" を押し，"conda_pytorch_p36" という環境を選択したうえで，新規ノートブックを作成する (<a href="#handson_02_jupyeter_new">Figure 27</a>)．
"conda_pytorch_p36" の仮想環境には， PyTorch がインストール済みである．</p>
</div>
<div id="handson_02_jupyeter_new" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-jupyter/jupyter_new.png" alt="jupyter_new" width="700">
</div>
<div class="title">Figure 27. 新規ノートブックの作成． "conda_pytorch_p36" の環境を選択する．</div>
</div>
<div class="paragraph">
<p>ここでは，次のようなプログラムを書いて，実行していく． (<a href="#handson_02_jupyeter_pytorch">Figure 28</a>)．</p>
</div>
<div id="handson_02_jupyeter_pytorch" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-jupyter/jupyter_pytorch.png" alt="jupyter_pytorch" width="700">
</div>
<div class="title">Figure 28. PyTorch始めの一歩</div>
</div>
<div class="paragraph">
<p>まずは， PyTorch をインポートする．さらに， GPU が使える環境にあるか，確認する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">torch</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Is CUDA ready?"</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>出力:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>Is CUDA ready? True</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に，3x3 のランダムな行列を <strong>CPU</strong> 上に作ってみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>出力:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>tensor([[0.6896, 0.2428, 0.3269],
        [0.0533, 0.3594, 0.9499],
        [0.9764, 0.5881, 0.0203]])</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に，行列を <strong>GPU</strong> 上に作成する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s">"cuda"</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s">"cuda"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>そして，行列 <code>x</code> と <code>y</code> の加算を，<strong>GPU上で実行する</strong>．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<span class="k">print</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>出力:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>tensor([[1.6896, 1.2428, 1.3269],
        [1.0533, 1.3594, 1.9499],
        [1.9764, 1.5881, 1.0203]], device='cuda:0')</code></pre>
</div>
</div>
<div class="paragraph">
<p>最後に， GPU 上にある行列を， CPU に戻す．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s">"cpu"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>出力:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>tensor([[1.6896, 1.2428, 1.3269],
        [1.0533, 1.3594, 1.9499],
        [1.9764, 1.5881, 1.0203]])</code></pre>
</div>
</div>
<div class="paragraph">
<p>以上の例は， GPU を使った計算の初歩の初歩であるが，雰囲気はつかめただろうか？
CPU と GPU で明示的にデータを交換するのが肝である．
この例はたった 3x3 の行列の足し算なので， GPU を使う意味はまったくないが，これが数千，数万のサイズの行列になったとき， GPU は格段の威力を発揮する．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>完成した Jupyter Notebook は
<a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/mnist/pytorch/pytorch_get_started.ipynb">/handson/mnist/pytorch/pytorch_get_started.ipynb</a>
にある．
Jupyter の画面右上の "Upload" からこのファイルをアップロードして，コードを走らせることが可能である．</p>
</div>
<div class="paragraph">
<p>しなしながら，勉強のときにはコードはすべて自分の手で打つことが，記憶に残りやすくより効果的である，というのが筆者の意見である．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>実際にベンチマークを取ることでGPUとCPUの速度を比較をしてみよう．
実行時間を計測するツールとして， Jupyter の提供する <a href="https://ipython.readthedocs.io/en/stable/interactive/magics.html">%time</a> マジックコマンドを利用する．</p>
</div>
<div class="paragraph">
<p>まずは CPU を使用して，10000x10000 の行列の行列積を計算した場合の速度を測ってみよう．
先ほどのノートブックの続きに，次のコードを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="n">s</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">device</span> <span class="o">=</span> <span class="s">"cpu"</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="o">%</span><span class="n">time</span> <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>出力は以下のようなものが得られるだろう．
これは，行列積の計算に実時間で5.8秒かかったことを意味する (実行のたびに計測される時間はばらつくことに留意)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>CPU times: user 11.5 s, sys: 140 ms, total: 11.6 s
Wall time: 5.8 s</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に， GPU を使用して，同じ演算を行った場合の速度を計測しよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="n">s</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">device</span> <span class="o">=</span> <span class="s">"cuda"</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>

<span class="o">%</span><span class="n">time</span> <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>出力は以下のようなものになるだろう．
GPU では 553ミリ秒 で計算を終えることができた！</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>CPU times: user 334 ms, sys: 220 ms, total: 554 ms
Wall time: 553 ms</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>PyTorch において， GPU での演算は asynchronous (非同期) で実行される．
その理由で，上のベンチマークコードでは， <code>torch.cuda.synchronize()</code> というステートメントを埋め込んである．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このベンチマークでは， <code>dtype=torch.float32</code> と指定することで，32bitの浮動小数点型を用いている．
ディープラーニングの学習および推論の計算には，32bit型，場合によっては16bit型が使われるのが一般的である．
これの主な理由として，教師データやミニバッチに起因するノイズが，浮動小数点の精度よりも大きいことがあげられる．
32bit/16bit を採用することで，メモリー消費を抑えたり，計算速度の向上が達成できる．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>上記のベンチマークから，GPUを用いることで，<strong>約10倍のスピードアップ</strong>を実現することができた．
スピードアップの性能は，演算の種類や行列のサイズに依存する．
行列積は，そのなかでも最も速度向上が見込まれる演算の一つである．</p>
</div>
</div>
<div class="sect2">
<h3 id="sec_mnist_using_jupyter">6.7. 実践ディープラーニング! MNIST手書き数字認識タスク</h3>
<div class="paragraph">
<p>ここまで，AWS上でディープラーニングの計算をするための概念や前提知識をながながと説明してきたが，ついにここからディープラーニングの計算を実際に走らせてみる．</p>
</div>
<div class="paragraph">
<p>ここでは，機械学習のタスクで最も初歩的かつ有名な <strong>MNIST データセットを使った数字認識</strong>を扱う (<a href="#handson_02_mnist_examples">Figure 29</a>)．
これは，0から9までの手書きの数字の画像が与えられ，その数字が何の数字なのかを当てる，というシンプルなタスクである．</p>
</div>
<div id="handson_02_mnist_examples" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-jupyter/mnist_examples.png" alt="mnist_examples" width="400">
</div>
<div class="title">Figure 29. MNIST 手書き数字データセット</div>
</div>
<div class="paragraph">
<p>今回は， MNIST 文字認識タスクを，<strong>畳み込みニューラルネットワーク (Convolutional Neural Network; CNN)</strong> を使って解く．
ソースコードは
<a href="https://github.com/tomomano/learn-aws-by-coding-source-code/tree/main/handson/mnist/pytorch">/handson/minist/pytorch/</a>
にある <code>mnist.ipynb</code> と <code>simple_mnist.py</code> である．
なお，このプログラムは， <a href="https://github.com/pytorch/examples/tree/master/mnist">PyTorch の公式 Example Project 集</a> を参考に，多少の改変を行ったものである．</p>
</div>
<div class="paragraph">
<p>まずは，カスタムのクラスや関数が定義された <code>simple_mnist.py</code> をアップロードしよう (<a href="#handson_02_jupyter_upload">Figure 30</a>)．
画面右上の "Upload" ボタンをクリックし，ファイルを選択することでアップロードができる．
この Python プログラムの中に，CNN のモデルや，学習の各イテレーションにおけるパラメータの更新などが記述されている．
今回はこの中身を説明することはしないが，興味のある読者は自身でソースコードを読んでみるとよい．</p>
</div>
<div id="handson_02_jupyter_upload" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-jupyter/jupyter_upload.png" alt="jupyter upload" width="600">
</div>
<div class="title">Figure 30. <code>simple_mnist.py</code> をアップロード</div>
</div>
<div class="paragraph">
<p><code>simple_mnist.py</code> をアップロードできたら，次に新しい notebook を作成しよう．
"conda_pytorch_p36" の環境を選択することを忘れずに．</p>
</div>
<div class="paragraph">
<p>新しいノートブックが起動したら，まずは必要なライブラリをインポートしよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="n">optim</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">transforms</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># custom functions and classes
</span><span class="kn">from</span> <span class="nn">simple_mnist</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">evaluate</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://pytorch.org/docs/stable/torchvision/index.html">torchvision</a> パッケージには，MNIST データセットをロードするなどの便利な関数が含まれている．
また，今回のハンズオンで使うカスタムのクラス・関数 (<code>Model</code>, <code>train</code>, <code>evaluate</code>) のインポートを行っている．</p>
</div>
<div class="paragraph">
<p>次に，MNIST テストデータをダウンロードしよう．
同時に，画像データの輝度の正規化も行っている．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="n">transf</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                             <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.1307</span><span class="p">,),</span> <span class="p">(</span><span class="mf">0.3081</span><span class="p">,))])</span>

<span class="n">trainset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s">'./data'</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transf</span><span class="p">)</span>
<span class="n">trainloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">trainset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">testset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s">'./data'</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transf</span><span class="p">)</span>
<span class="n">testloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">testset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>今回扱う MNIST データは 28x28 ピクセルの正方形の画像(モノクロ)と，それぞれのラベル(0 - 9 の数字)の組で構成されている．
いくつかのデータを抽出して，可視化してみよう．
<a href="#handson_02_mnist_ground_truth">Figure 31</a> のような出力が得られるはずである．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="n">examples</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">testloader</span><span class="p">)</span>
<span class="n">example_data</span><span class="p">,</span> <span class="n">example_targets</span> <span class="o">=</span> <span class="n">examples</span><span class="o">.</span><span class="nb">next</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Example data size:"</span><span class="p">,</span> <span class="n">example_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">example_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">'none'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Ground Truth: {}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">example_targets</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div id="handson_02_mnist_ground_truth" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-jupyter/mnist_ground_truth.png" alt="mnist_ground_truth" width="700">
</div>
<div class="title">Figure 31. MNIST の手書き数字画像とその教師ラベル</div>
</div>
<div class="paragraph">
<p>次に， CNN のモデルを定義する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s">"cuda"</span><span class="p">)</span> <span class="c1"># load to GPU</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>今回使う <code>Model</code> は <code>simple_mnist.py</code> の中で定義されている．
このモデルは，<a href="#handson_02_cnn_architecture">Figure 32</a> に示したような，２層の畳み込み層と2層の全結合層からなるネットワークである．
出力層 (output layer) には Softmax 関数を使用し，損失関数 (Loss function) には 負の対数尤度関数 (Negative log likelyhood; NLL) を使用している．</p>
</div>
<div id="handson_02_cnn_architecture" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-jupyter/cnn_architecture.png" alt="cnn architecture" width="700">
</div>
<div class="title">Figure 32. 本ハンズオンで使用するニューラルネットの構造．</div>
</div>
<div class="paragraph">
<p>続いて， CNN のパラメータを更新する最適化アルゴリズムを定義する．
ここでは， <strong>確率的勾配降下法 (Stochastic Gradient Descent; SGD)</strong> を使用している．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>これで，準備が整った．
CNN の学習ループを開始しよう!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</pre></td><td class="code"><pre><span class="n">train_losses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">trainloader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
    <span class="n">train_losses</span> <span class="o">=</span> <span class="n">train_losses</span> <span class="o">+</span> <span class="n">losses</span>
    <span class="n">test_loss</span><span class="p">,</span> <span class="n">test_accuracy</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">testloader</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Test set: Average loss: {test_loss:.4f}, Accuracy: {test_accuracy:.1f}</span><span class="si">%</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_losses</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">"Iterations"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">"Train loss"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ここでは5エポック分の学習を行っている．
GPU を使えば，これくらいの計算であれば1分程度で完了するだろう．</p>
</div>
<div class="paragraph">
<p>出力として， <a href="#handson_02_train_loss">Figure 33</a> のようなプロットが得られるはずである．
イテレーションを重ねるにつれて，損失関数 (Loss function) の値が減少している (=精度が向上している) ことがわかる．</p>
</div>
<div id="handson_02_train_loss" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-jupyter/train_loss.png" alt="train_loss" width="500">
</div>
<div class="title">Figure 33. 学習の進行に対する Train loss の変化</div>
</div>
<div class="paragraph">
<p>出力にはテキスト形式で各エポック終了後のテストデータに対する精度も表示されている．
最終的には 98% 以上の極めて高い精度を実現できていることが確認できるだろう (<a href="#handson_02_mnist_final_score">Figure 34</a>)．</p>
</div>
<div id="handson_02_mnist_final_score" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-jupyter/mnist_final_score.png" alt="mnist_final_score" width="700">
</div>
<div class="title">Figure 34. 学習したCNNのテストデータに対するスコア (5エポック後)</div>
</div>
<div class="paragraph">
<p>学習した CNN の推論結果を可視化してみよう．
次のコードを実行することで， <a href="#handson_02_mnist_mnist_prediction">Figure 35</a> のような出力が得られるだろう．
この図で，下段右から二番目は，"1"に近い見た目をしているが，きちんと"9"と推論できている．
なかなか賢い CNN を作り出すことができたようだ！</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="n">model</span><span class="o">.</span><span class="nb">eval</span><span class="p">()</span>

<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">example_data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s">"cuda"</span><span class="p">))</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">example_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">'none'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Prediction: {}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div id="handson_02_mnist_mnist_prediction" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-jupyter/mnist_prediction.png" alt="mnist_prediction" width="700">
</div>
<div class="title">Figure 35. 学習した CNN による，MNIST画像の推論結果</div>
</div>
<div class="paragraph">
<p>最後に，学習したニューラルネットワークのパラメータを <code>mnist_cnn.pt</code> というファイル名で保存しておこう．
これで，将来いつでも今回学習したモデルを再現し，別の実験に使用することができる．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s">"mnist_cnn.pt"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>以上が， AWS クラウドの仮想サーバーを立ち上げ，最初のディープラーニングの計算を行う一連の流れである．
MNIST 文字認識のタスクを行うニューラルネットを，クラウド上の GPU を使って高速に学習させ，現実的な問題を一つ解くことができたのである．
興味のある読者は，今回のハンズオンを雛形に，自分の所望の計算を走らせてみるとよいだろう．</p>
</div>
</div>
<div class="sect2">
<h3 id="_スタックの削除">6.8. スタックの削除</h3>
<div class="paragraph">
<p>これにて，ハンズオン第二回の内容はすべて説明した．
クラウドの利用料金を最小化するため，使い終わったEC2インスタンスはすぐさま削除しよう．</p>
</div>
<div class="paragraph">
<p>ハンズオン第一回と同様に， AWS の CloudFormation コンソールか， AWS CLI により削除を実行する (詳細は <a href="#handson_01_delete_stack">Section 4.4.8</a> 参照)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>cdk destroy</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>スタックの削除は各自で必ず行うこと！</strong>
行わなかった場合，EC2インスタンスの料金が発生し続けることになる！
<code>g4dn.xlarge</code> は $0.71 / hour の料金設定なので，一日起動しつづけると約$17の請求が発生することになる！</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>AWS のバジェットアラート</strong></p>
</div>
<div class="paragraph">
<p>AWS の初心者が (あるいは経験者も) しばしば陥る失敗が，インスタンスの停止忘れなどで無駄なリソースがクラウドで放置されてしまい，巨大な額の請求が届く，というミスだ．
特に，開発を行っている間はこのような事態は起こりうるものだと思って，備えておかなければならない．
このような事態を未然に防ぐため， AWS Budgets という機能が無料で提供されている．
AWS Budgets を利用することで，月の利用金額がある閾値を超えた場合にユーザーにメールが送信される，などのアラートを設定することができる．
詳細な手順は
<a href="https://aws.amazon.com/blogs/aws-cost-management/getting-started-with-aws-budgets/">AWS の公式ブログ "Getting Started with AWS Budgets"</a>
を参照のこと．
本書の読者も，ぜひこのタイミングでアラートを設定しておくことを推奨する．</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec_docker_introduction">7. Docker 入門</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ここまでの章で扱ってきたハンズオンでは，<strong>単一のサーバー</strong>を立ち上げ，それに SSH でログインをして，コマンドを叩くことで計算を行ってきた．
いわば，<em>パーソナルコンピュータの延長</em>のような形でクラウドを使ってきたわけである．
このような，インターネットのどこからでもアクセスできるパーソナルコンピュータとしてのクラウドという使い方も，もちろん便利であるし，いろいろな応用の可能性がある．
しかし，これだけではクラウドの本当の価値は十分に発揮されていないと言うべきだろう．
<a href="#chap_cloud_basics">Section 2</a> で述べたように，現代的なクラウドの一番の強みは自由に計算機の規模を拡大できることにある．
すなわち，<strong>多数のサーバーを同時に起動し，複数のジョブを分散並列的に実行させることで大量のデータを処理してこそ，クラウドの本領が発揮される</strong>のである．</p>
</div>
<div class="paragraph">
<p>本章からはじまる3章分 (<a href="#sec_docker_introduction">Section 7</a>, <a href="#sec_fargate_qabot">Section 8</a>, <a href="#sec_aws_batch">Section 9</a>) を使って，クラウドを利用することでどのように大規模な計算システムを構築しビッグデータの解析に立ち向かうのか，その片鱗をお見せしたい．
とくに，前章で扱った深層学習をどのようにビッグデータに適用していくかという点に焦点を絞って議論していきたい．
そのための前準備として，本章では <a href="https://www.docker.com/">Docker</a> とよばれる計算機環境の仮想化ソフトウェアを紹介する (<a href="#fig:docker_logo">Figure 38</a>)．
現代のクラウドは Docker なしには成り立たないといっても過言ではないだろう．
クラウドに限らず，ローカルで行う計算処理にも Docker は大変便利である．
AWS からは少し話が離れるが，しっかりと理解して前に進んでもらいたい．</p>
</div>
<div class="sect2">
<h3 id="_機械学習の大規模化">7.1. 機械学習の大規模化</h3>
<div class="paragraph">
<p>先ほどから"計算システムの大規模化"と繰り返し唱えているが，それは具体的にはどのようなものを指しているのか？
ここでは大規模データを処理するための計算機システムを，機械学習を例にとって見てみよう．</p>
</div>
<div class="paragraph">
<p><a href="#sec_scientific_computing">Section 5</a> で紹介した <a href="https://github.com/openai/gpt-3">GPT-3</a> のような，超巨大な数のパラメータを有する深層学習モデルを学習させたいとしよう．
そのような計算を行いたい場合，一つのサーバーでは計算力が到底足りない．
したがって，典型的には <a href="#big_dnn_training">Figure 36</a> に示すような計算システムの設計がなされる．
すなわち，大量の教師データを小さなチャンクとして複数のマシンに分散し，並列的にニューラルネットのパラメータを最適化していくという構造である．</p>
</div>
<div id="big_dnn_training" class="imageblock text-center">
<div class="content">
<img src="imgs/big_dnn_training.png" alt="big_dnn_training" width="700">
</div>
<div class="title">Figure 36. 複数の計算機を使った大規模な深層学習モデルの訓練</div>
</div>
<div class="paragraph">
<p>あるいは，学習済みのモデルを大量のデータに適用し，解析を行いたいとしよう．
たとえば， SNS のプラットフォームで大量の画像が与えられて，それぞれの写真に何が写っているのかをラベルづけする，などのアプリケーションを想定できる．
そのような場合は， <a href="#big_dnn_inference">Figure 37</a> のようなアーキテクチャが考えられるだろう．
すなわち，大量のデータを複数のマシンで分割し，それぞれのマシンで推論の計算を行うというような構造である．</p>
</div>
<div id="big_dnn_inference" class="imageblock text-center">
<div class="content">
<img src="imgs/big_dnn_inference.png" alt="big_dnn_inference" width="700">
</div>
<div class="title">Figure 37. 複数の計算機による深層学習モデルを使った推論計算</div>
</div>
<div class="paragraph">
<p>このような複数の計算機を同時に走らせるようなアプリケーションをクラウド上で実現するには，どのようにすればよいのだろうか？</p>
</div>
<div class="paragraph">
<p>重要なポイントとして， <a href="#big_dnn_training">Figure 36</a> や <a href="#big_dnn_inference">Figure 37</a> で起動している複数のマシンは，<strong>基本的に全く同一のOS・計算環境を有している</strong>点である．
ここで，個人のコンピュータで行うようなインストールの操作を，各マシンで行うこともできるが，それは大変な手間であるし，メンテナンスも面倒だろう．
すなわち，大規模な計算システムを構築するには，<strong>簡単に計算環境を複製できるような仕組み</strong>が必要であるということがわかる．</p>
</div>
<div class="paragraph">
<p>そのような目的を実現するために使われるのが， <a href="https://www.docker.com/">Docker</a> とよばれるソフトウェアである．</p>
</div>
</div>
<div class="sect2">
<h3 id="_docker_とは">7.2. Docker とは</h3>
<div id="fig:docker_logo" class="imageblock text-center">
<div class="content">
<img src="imgs/docker_log.png" alt="docker" width="500">
</div>
<div class="title">Figure 38. Docker のアイコン</div>
</div>
<div class="paragraph">
<p>Docker とは， <strong>コンテナ (Container)</strong> とよばれる仮想環境下で，ホストOSとは独立した別の計算環境を走らせるためのソフトウェアである．
Docker を使うことで， OS を含めたすべてのプログラムをコンパクトにパッケージングすることが可能になる (パッケージされた一つの計算環境のことを <strong>イメージ (Image) </strong>とよぶ)．
Dockerを使うことで，クラウドのサーバー上に瞬時に計算環境を複製することが可能になり， <a href="#big_dnn_inference">Figure 37</a> で見たような複数の計算機を同時に走らせるためのシステムが実現できる．</p>
</div>
<div class="paragraph">
<p>Docker は2013年に Solomon Hykes らを中心に開発され，それ以降爆発的に普及し，クラウドコンピューティングだけでなく，機械学習・科学計算の文脈などでも欠かすことのできないソフトウェアとなった．
Docker はエンタープライズ向けの製品を除き無料で使用することができ，コアの部分は
<a href="https://github.com/moby/moby">オープンソースプロジェクト</a>
として公開されている．
Docker は Linux, Windows, Mac いずれの OS でも提供されている．
概念としては， Docker は仮想マシン (Virtual machine; VM) にとても近い．
ここでは， VM との対比をしながら，Docker とはなにかを簡単に説明しよう．</p>
</div>
<div class="paragraph">
<p>仮想マシン (VM) とは，ホストとなるマシンの上に，仮想化されたOSを走らせる技術である (<a href="#docker_vs_vm">Figure 39</a>)．
VM には <strong>ハイパーバイザー (Hypervisor)</strong> とよばれるレイヤーが存在する．
Hypervisor はまず，物理的な計算機リソース (CPU, RAM, network など) を分割し，仮想化する．
たとえば， ホストマシンに物理的な CPU が4コアあるとして，ハイパーバイザーはそれを (2,2) 個の組に仮想的に分割することができる．
VM 上で起動する OS には，ハイパーバイザーによって仮想化されたハードウェアが割り当てられる．
VM 上で起動する OS は基本的に完全に独立であり，たとえば OS-A は OS-B に割り当てられたCPUやメモリー領域にアクセスすることはできない (これを isolation とよぶ)．
VM を作成するための有名なソフトウェアとしては， <a href="https://www.vmware.com/">VMware</a>， <a href="https://www.virtualbox.org/">VirtualBox</a>， <a href="https://xenproject.org/">Xen</a> などがある．
また，これまで触ってきた EC2 も，基本的に VM 技術を使うことで所望のスペックをもった仮想マシンがユーザーに提示される．</p>
</div>
<div class="paragraph">
<p>Docker も， VM と同様に，仮想化された OS をホストのOS上に走らせるための技術である．
VM に対し， Docker ではハードウェアレベルの仮想化は行われておらず，すべての<strong>仮想化はソフトウェアレベルで実現されている</strong> (<a href="#docker_vs_vm">Figure 39</a>)．
Docker で走る仮想 OS は，<strong>多くの部分をホストのOSに依存しており，結果として非常にコンパクトである</strong>．
その結果， Docker で仮想 OS を起動するために要する時間は， VM に比べて圧倒的に早い．
また， パッケージ化された環境 (=イメージ) のサイズも完全なOSに比べ圧倒的に小さくなるので，ネットワークを通じたやり取りが非常に高速化される点も重要である
加えて， VM のいくつかの実装では，メタル (仮想化マシンに対して，物理的なハードウェア上で直接起動する場合のこと) と比べ，ハイパーバイザーレイヤーでのオーバーヘッドなどにより性能が低下することが知られているが， Docker ではメタルとほぼ同様の性能を引き出すことができるとされている．</p>
</div>
<div class="paragraph">
<p>その他， VM との相違点などはたくさんあるのだが，ここではこれ以上詳細には立ち入らない．
大事なのは， <strong>Docker とはとてもコンパクトかつハイパフォーマンスな仮想計算環境を作るツールである</strong>，という点である．
その手軽さゆえに，2013年の登場以降，クラウドシステムでの利用が急速に増加し，現代のクラウドでは欠くことのできない中心的な技術になっている．</p>
</div>
<div id="docker_vs_vm" class="imageblock text-center">
<div class="content">
<img src="imgs/docker_vs_vm.png" alt="docker_vs_vm" width="700">
</div>
<div class="title">Figure 39. Docker (左) と VM (右) の比較 (画像出典: <a href="https://www.docker.com/blog/containers-replacing-virtual-machines/" class="bare">https://www.docker.com/blog/containers-replacing-virtual-machines/</a>)</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">コラム: プログラマー三種の神器?</div>
<div class="paragraph">
<p>職業的プログラマーにとっての"三種の神器"とはなんだろうか？
多様な意見があると思うが，筆者は <strong>Git</strong>, <strong>Vim</strong> そして <strong>Docker</strong> を挙げたい．</p>
</div>
<div class="paragraph">
<p>Git は多くの読者がご存じの通り，コードの変更を追跡するためのシステムである．
Linux の作成者である Linus Torvalds によって2005年に誕生した．
チームでの開発を進める際には欠かせないツールだ．</p>
</div>
<div class="paragraph">
<p>Vim は1991年から30年以上の間プログラマーたちに愛されてきたテキストエディターである．
<a href="https://insights.stackoverflow.com/survey/2019#technology-development-environments-and-tools-all-respondents">Stackoverflow が行った2019年のアンケート</a>
によると，開発環境の部門で5位の人気を獲得している．
たくさんのショートカットと様々なカスタム設定が提供されているので，初見の人にはなかなかハードルが高いが，一度マスターすれば他のモダンなエディターや統合開発環境に負けない，あるいはそれ以上の開発体験を実現することができる．</p>
</div>
<div class="paragraph">
<p>これらの十年以上の歴史あるツールに並んで，第三番目の三種の神器として挙げたいのが Docker だ．
Docker はプログラマーの開発のワークフローを一変させた．
たとえば，プロジェクトごとに Docker イメージを作成することで，どの OS・コンピュータ でも全く同じ計算環境で開発・テストを実行することができるようになった．
また，
<a href="https://en.wikipedia.org/wiki/DevOps">DevOps</a>
や
<a href="https://en.wikipedia.org/wiki/Continuous_integration">CI</a> / <a href="https://en.wikipedia.org/wiki/Continuous_delivery">CD</a>
(Continuous Integration / Continuous Deployment)
といった最近の開発ワークフローも Docker のようなコンテナ技術の存在に立脚している．
さらにはサーバーレスコンピューティング (<a href="#sec_serverless">Section 11</a>) といった概念も，コンテナ技術の生んだ大きな技術革新といえる．</p>
</div>
<div class="paragraph">
<p>あなたにとっての三種の神器はなんだろうか？
また，これからの未来ではどんな新しいツールが三種の神器としてプログラマーのワークフローを革新していくだろうか？</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_docker_チュートリアル">7.3. Docker チュートリアル</h3>
<div class="paragraph">
<p>Docker とはなにかを理解するためには，実際に触って動かしてみるのが一番有効な手立てである．
ここでは， Docker の簡単なチュートリアルを行っていく．</p>
</div>
<div class="paragraph">
<p>Docker のインストールについては， <a href="#sec:install_docker">Section 15.6</a> および <a href="https://docs.docker.com/engine/install/">公式のドキュメンテーション</a> を参照してもらいたい．
Docker のインストールが完了している前提で，以下は話を進めるものとする．</p>
</div>
<div class="sect3">
<h4 id="_docker_用語集">7.3.1. Docker 用語集</h4>
<div class="paragraph">
<p>Docker を使い始めるに当たり，最初に主要な用語を解説しよう．
次のパラグラフで太字で強調された用語を頭に入れた上で，続くチュートリアルに取り組んでいただきたい．</p>
</div>
<div class="paragraph">
<p>Docker を起動する際の大まかなステップを示したのが <a href="#fig:docker_image_container">Figure 40</a> である．
パッケージされた一つの計算環境のことを <strong>イメージ (Image) </strong>とよぶ．
イメージは， Docker Hub などのリポジトリで配布されているものをダウンロードするか，自分でカスタムのイメージを作成することも可能である．
イメージを作成するための”レシピ”を記述したファイルが <strong>Dockerfile</strong> である．
Dockerfile からイメージを作成する操作を <strong>build</strong> とよぶ．
イメージがホストマシンのメモリにロードされ，起動状態にある計算環境のことを <strong>コンテナ (Container)</strong> とよぶ．
Container を起動するために使用されるコマンドが <strong>run</strong> である．</p>
</div>
<div id="fig:docker_image_container" class="imageblock text-center">
<div class="content">
<img src="imgs/docker_image_container.png" alt="docker_image_container" width="700">
</div>
<div class="title">Figure 40. Image と Container</div>
</div>
</div>
<div class="sect3">
<h4 id="_イメージをダウンロード">7.3.2. イメージをダウンロード</h4>
<div class="paragraph">
<p>パッケージ化された Docker の仮想環境 (= <strong>イメージ (Image)</strong>) は， <a href="https://hub.docker.com/">Docker Hub</a> からダウンロードできる．
Docker Hub には，個人や企業・団体が作成した Docker イメージが集められており， GitHub などと同じ感覚で，オープンな形で公開されている．</p>
</div>
<div class="paragraph">
<p>たとえば， Ubuntu のイメージは <a href="https://hub.docker.com/_/ubuntu">Ubuntu の公式リポジトリ</a> で公開されており， <code>pull</code> コマンドを使うことでローカルにダウンロードすることができる．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>docker pull ubuntu:18.04</code></pre>
</div>
</div>
<div class="paragraph">
<p>ここで，イメージ名の <code>:</code> (コロン) 以降に続く文字列を <strong>タグ (tag)</strong> と呼び，主にバージョンを指定するなどの目的で使われる．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>pull</code> コマンドはデフォルトでは Docker Hub でイメージを検索し，ダウンロードを行う．
Docker イメージを公開するためのデータベース (レジストリ (registry) とよぶ) は Docker Hub だけではなく，たとえば GitLab や GitHub は独自のレジストリ機能を提供しているし，個人のサーバーでレジストリを立ち上げることも可能である．
Docker Hub 以外のレジストリから pull するには， <code>myregistry.local:5000/testing/test-image</code> のように，イメージ名の先頭につける形でレジストリのアドレス (さらにオプションとしてポート番号) を指定する．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_コンテナを起動">7.3.3. コンテナを起動</h4>
<div class="paragraph">
<p>Pull してきたイメージを起動するには， <code>run</code> コマンドを使う．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>docker run <span class="nt">-it</span> ubuntu:18.04</code></pre>
</div>
</div>
<div class="paragraph">
<p>ここで， <code>-it</code> とは，インタラクティブな shell のセッションを開始するために必要なオプションである．</p>
</div>
<div class="paragraph">
<p>このコマンドを実行すると，仮想化された Ubuntu が起動され，コマンドラインからコマンドが打ち込めるようになる (<a href="#docker_shell">Figure 41</a>)．
このように起動状態にある計算環境 (ランタイム) のことを <strong>Container (コンテナ)</strong> とよぶ．</p>
</div>
<div id="docker_shell" class="imageblock text-center">
<div class="content">
<img src="imgs/docker_shell.png" alt="docker_shell" width="600">
</div>
<div class="title">Figure 41. Docker を使って ubuntu:18.04 イメージを起動</div>
</div>
<div class="paragraph">
<p>ここで使用した <code>ubuntu:18.04</code> のイメージは，空の Ubuntu OS だが，すでにプログラムがインストール済みのものもある．
これは， <a href="#sec_jupyter_and_deep_learning">Section 6</a> でみた DLAMI と概念として似ている．
たとえば， PyTorch がインストール済みのイメージは <a href="https://hub.docker.com/r/pytorch/pytorch">PyTorch 公式の Docker Hub リポジトリ</a> で公開されている．</p>
</div>
<div class="paragraph">
<p>これを起動してみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ docker run -it pytorch/pytorch</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>docker run</code> を実行したとき，ローカルに該当するイメージが見つからない場合は，自動的に Docker Hub からダウンロードされる．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>pytorch のコンテナが起動したら， Python のシェルを立ち上げて， pytorch をインポートしてみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python3
Python 3.7.7 <span class="o">(</span>default, May  7 2020, 21:25:33<span class="o">)</span>
<span class="o">[</span>GCC 7.3.0] :: Anaconda, Inc. on linux
Type <span class="s2">"help"</span>, <span class="s2">"copyright"</span>, <span class="s2">"credits"</span> or <span class="s2">"license"</span> <span class="k">for </span>more information.
<span class="o">&gt;&gt;&gt;</span> import torch
<span class="o">&gt;&gt;&gt;</span> torch.cuda.is_available<span class="o">()</span>
False</code></pre>
</div>
</div>
<div class="paragraph">
<p>このように， Docker を使うことで簡単に特定のOS・プログラムの入った計算環境を再現することが可能になる．</p>
</div>
</div>
<div class="sect3">
<h4 id="_自分だけのイメージを作る">7.3.4. 自分だけのイメージを作る</h4>
<div class="paragraph">
<p>自分の使うソフトウェア・ライブラリがインストールされた，自分だけのイメージを作ることも可能である．</p>
</div>
<div class="paragraph">
<p>たとえば， <a href="https://hub.docker.com/repository/docker/tomomano/labc">本書のハンズオン実行用に提供している docker イメージ</a>
には， Python, Node.js, AWS CLI, AWS CDK などのソフトウェアがインストール済みであり，ダウンロードしてくるだけですぐにハンズオンのプログラムが実行できるようになっている．</p>
</div>
<div class="paragraph">
<p>カスタムの docker イメージを作るには， <code>Dockerfile</code> という名前のついたファイルを用意し，その中にどんなプログラムをインストールするかなどを記述していく．</p>
</div>
<div class="paragraph">
<p>具体例として，本書で提供している Docker イメージのレシピを見てみよう
(<a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/docker/Dockerfile">docker/Dockerfile</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="docker"><span class="k">FROM</span><span class="s"> node:12</span>
<span class="k">LABEL</span><span class="s"> maintainer="Tomoyuki Mano"</span>

<span class="k">RUN </span>apt-get update <span class="se">\
</span>    <span class="o">&amp;&amp;</span> apt-get <span class="nb">install </span>nano

<i class="conum" data-value="1"></i><b>(1)</b>
<span class="k">RUN </span><span class="nb">cd</span> /opt <span class="se">\
</span>    <span class="o">&amp;&amp;</span> curl <span class="nt">-q</span> <span class="s2">"https://www.python.org/ftp/python/3.7.6/Python-3.7.6.tgz"</span> <span class="nt">-o</span> Python-3.7.6.tgz <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">tar</span> <span class="nt">-xzf</span> Python-3.7.6.tgz <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">cd </span>Python-3.7.6 <span class="se">\
</span>    <span class="o">&amp;&amp;</span> ./configure <span class="nt">--enable-optimizations</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> make <span class="nb">install</span>

<span class="k">RUN </span><span class="nb">cd</span> /opt <span class="se">\
</span>    <span class="o">&amp;&amp;</span> curl <span class="s2">"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"</span> <span class="nt">-o</span> <span class="s2">"awscliv2.zip"</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> unzip awscliv2.zip <span class="se">\
</span>    <span class="o">&amp;&amp;</span> ./aws/install

<i class="conum" data-value="2"></i><b>(2)</b>
<span class="k">RUN </span>npm <span class="nb">install</span> <span class="nt">-g</span> aws-cdk@1.100

<span class="c"># clean up unnecessary files</span>
<span class="k">RUN </span><span class="nb">rm</span> <span class="nt">-rf</span> /opt/<span class="k">*</span>

<span class="c"># copy hands-on source code in /root/</span>
<span class="k">COPY</span><span class="s"> handson/ /root/handson</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Dockerfile</code> の中身の説明は詳しくは行わないが，たとえば上のコードで &lt;1&gt; で示したところは， Python 3.7 のインストールを実行している．
また， &lt;2&gt; で示したところは， AWS CDK のインストールを行っていることがわかるだろう．
このように，リアルな OS で行うのと同じ流れでインストールのコマンドを逐一記述していくことで，自分だけの Docker イメージを作成することができる．
一度イメージを作成すれば，それを配布することで，他者も同一の計算環境を簡単に再構成することができる．</p>
</div>
<div class="paragraph">
<p>"ぼくの環境ではそのプログラム走ったのにな&#8230;&#8203;" というのは，プログラミング初心者ではよく耳にする会話だが， Docker を使いこなせばそのような心配とは無縁である．
そのような意味で，クラウド以外の場面でも， Docker の有用性・汎用性は極めて高い．</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">コラム: Is Docker alone?</div>
<div class="paragraph">
<p>コンテナを用いた仮想計算環境ツールとして Docker を紹介したが， ほかに選択肢はないのか？
よくぞ聞いてくれた！
Docker の登場以降，複数のコンテナベースの仮想環境ツールが開発されてきた．
いずれのツールも，概念や API については Docker と共通するものが多いが，Docker にはない独自の特徴を提供している．
ここではその中でも有名ないくつかを紹介しよう．</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/hpcng/singularity">Singularity</a> は科学計算や HPC (High Performance Computing) の分野で人気の高いコンテナプラットフォームである．
Singularity では大学・研究機関の HPC クラスターでの運用に適したような設計が施されている．
たとえば， Docker は基本的には root 権限で実行されるのに対し， Singularity はユーザー権限 (コマンドを実行したユーザー自身) でプログラムが実行される．
root 権限での実行は Web サーバーのように個人・企業がある特定のサービスのために運用するサーバーでは問題ないが，多数のユーザーが多様な目的で計算を実行する HPC クラスターでは問題となる．
また，Singularity は独自のイメージの作成方法・エコシステムをもっているが， Docker イメージを Singularity のイメージに変換し実行する機能も有している．</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/containers/podman">podman</a> は Red Hat 社によって開発されたもう一つのコンテナプラットフォームである．
podman は基本的に Docker と同一のコマンドを採用しているが，実装は Red Hat によってスクラッチから行われた．
podman では， Singularity と同様にユーザー権限でのプログラムの実行を可能であり，クラウドおよび HPC の両方の環境に対応するコンテナプラットフォームを目指して作られた．
また，その名前にあるとおり pod とよばれる独自の概念が導入されている．</p>
</div>
<div class="paragraph">
<p>著者の個人的な意見としては，現時点では Docker をマスターしておけば当面は困ることはないと考えるが，興味のある読者はぜひこれらのツールも試してみてはいかがだろうか？</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_elastic_container_service_ecs">7.4. Elastic Container Service (ECS)</h3>
<div id="fig:logo_ecs" class="imageblock">
<div class="content">
<img src="imgs/aws_logos/ECS.png" alt="ECS" width="100">
</div>
<div class="title">Figure 42. ECS のアイコン</div>
</div>
<div class="paragraph">
<p>ここまでに説明してきたように， Docker を使うことで仮想計算環境を簡単に複製・起動することが可能になる．
本章の最後の話題として， AWS 上で Docker を使った計算システムを構築する方法を解説しよう．</p>
</div>
<div class="paragraph">
<p><strong>Elastic Container Service (ECS)</strong> とは， Docker を使った計算機クラスターを AWS 上に作成するためのツールである (<a href="#fig:logo_ecs">Figure 42</a>)．
ECS を使用することで， Docker にパッケージされたアプリケーションを計算機クラスターに投入したり，計算機クラスターのインスタンスを追加・削除する操作 (=スケーリング) を行うことができる．</p>
</div>
<div class="paragraph">
<p>ECS の概要を示したのが <a href="#ecs_overview">Figure 43</a> である．
ECS は，<strong>タスク (Task)</strong> と呼ばれる単位で管理された計算ジョブを受け付ける．
システムにタスクが投入されると，ECS は最初にタスクで指定された Docker イメージを外部レジストリからダウンロードしてくる．
外部レジストリとしては， Docker Hub や AWS 独自の Docker レジストリである <strong>ECR (Elastic Container Registry)</strong> を指定することができる．</p>
</div>
<div class="paragraph">
<p>ECS の次の重要な役割はタスクの配置である．
あらかじめ定義されたクラスター内で，計算負荷が小さい仮想インスタンスを選び出し，そこに Docker イメージを配置することで指定された計算タスクが開始される．
"計算負荷が小さい仮想インスタンスを選び出す" と言ったが，具体的にどのような戦略・ポリシーでこの選択を行うかは，ユーザーの指定したパラメータに従う．</p>
</div>
<div class="paragraph">
<p>また，クラスターのスケーリングもECSにおける重要な概念である．
スケーリングとは，クラスター内のインスタンスの計算負荷をモニタリングし，計算負荷に応じてインスタンスの起動・停止を行う操作を指す．
クラスター全体の計算負荷が指定された閾値 (たとえば80%の稼働率) を超えていた場合，新たな仮想インスタンスをクラスター内に立ち上げる操作を scale-out (スケールアウト) とよび，
負荷が減った場合に不要なインスタンスを停止する操作を scale-in (スケールイン) とよぶ．
クラスターのスケーリングは， ECS がほかの AWS のサービスと連携することで実現される．
具体的には， EC2 の <strong>Auto scaling group (ASG)</strong> や <strong>Fargate</strong> の２つの選択肢が多くの場合選択される．
<strong>ASG</strong> については <a href="#sec_aws_batch">Section 9</a>, Fargate については <a href="#sec_fargate_qabot">Section 8</a> でより詳細に解説する．</p>
</div>
<div class="paragraph">
<p>これら一連のタスクの管理を， ECS は自動でやってくれる．
クラスターのスケーリングやタスクの配置に関してのパラメータを一度指定してしまえば，ユーザーは (ほとんどなにも考えずに) 大量のタスクを投入することができる．
クラスターのスケーリングによってタスクの量にちょうど十分なだけのインスタンスが起動し，タスクが完了した後は不要なインスタンスはすべて停止される．</p>
</div>
<div class="paragraph">
<p>さて，ここまで説明的な話が続いてしまったが，次章からは早速 Docker と AWS を使って大規模な並列計算システムを構築していこう！</p>
</div>
<div id="ecs_overview" class="imageblock text-center">
<div class="content">
<img src="imgs/ecs.png" alt="ecs" width="500">
</div>
<div class="title">Figure 43. ECS の概要</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec_fargate_qabot">8. Hands-on #3: AWS で自動質問回答ボットを走らせる</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ハンズオン第三回では， Docker と ECS を駆使した機械学習アプリケーションを実装しよう．
具体的には，深層学習による自然言語処理を行うことで，クライアントから与えられた文章題に対して回答を生成する，自動 Question &amp; Answering ボットを作成しよう．
ECS を利用することで，ジョブの数によって動的にインスタンスの数を制御し，並列にタスクを実行するようなシステムを構築しよう．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>通常の機械学習のワークフローでは，モデルの訓練 &#8658; 推論 (データへの適用) が基本的な流れである．
しかしながら， GPU 搭載型の EC2 クラスターを使ったモデルの訓練はやや難易度が高いため，次章 (<a href="#sec_aws_batch">Section 9</a>) で取り扱う．
本章は，クラウド上でのクラスターの構築・タスクの管理などの概念に慣れるため，よりシンプルな実装で実現できるFargate クラスターを用いた推論計算の並列化を紹介する．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_fargate">8.1. Fargate</h3>
<div class="paragraph">
<p>ハンズオンに入っていく前に， <strong>Fargate</strong> という AWS の機能を知っておく必要がある (<a href="#fig:fargate_logo">Figure 44</a>)．</p>
</div>
<div id="fig:fargate_logo" class="imageblock">
<div class="content">
<img src="imgs/aws_logos/Fargate.png" alt="Fargate" width="100">
</div>
<div class="title">Figure 44. Fargate のアイコン</div>
</div>
<div class="paragraph">
<p>ECS の概要を示した <a href="#ecs_overview">Figure 43</a> をもう一度見てみよう．
この図で， ECS の管理下にあるクラスターが示されているが，このクラスターの中で計算を行う実体としては二つの選択肢がある．
<strong>EC2 あるいは Fargate</strong> のいずれかである．
EC2 を用いた場合は，先の章 (<a href="#sec_first_ec2">Section 4</a>, <a href="#sec_jupyter_and_deep_learning">Section 6</a>) で説明したような流れでインスタンスが起動し，計算が実行される．
しかし， EC2 を用いた計算機クラスターの作成・管理は技術的な難易度がやや高いので，次章 (<a href="#sec_aws_batch">Section 9</a>) で説明することにする．</p>
</div>
<div class="paragraph">
<p>Fargate とは， <strong>ECS での利用に特化</strong>して設計された，<strong>コンテナを使用した計算タスク</strong>を走らせるための仕組みである．
計算を走らせるという点では EC2 と役割は似ているが， Fargate は EC2 インスタンスのような物理的実体はもたない．
物理的実体をもたないというのは，たとえば SSH でログインすることは基本的に想定されていないし，なにかのソフトウェアをインストールしたりなどの概念も存在しない．
Fargate ではすべての計算は Docker コンテナを介して行われる．
すなわち， Fargate を利用するには，ユーザーは最初に所望の Docker イメージを指定しておき， Fargate は <code>docker run</code> のコマンドを使用することで計算タスクを実行する．
Fargate を用いる利点は， Fargate を ECS のクラスターに指定すると，スケーリングなどの操作が簡単な設定・プログラムで構築できる点である．</p>
</div>
<div class="paragraph">
<p>Fargate では， EC2 と同様に CPU とメモリーのサイズを必要な分だけ指定できる．
執筆時点では， CPU は 0.25 - 4 コア， RAM は 0.5 - 30 GB の間で選択することができる (詳しくは
<a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/AWS_Fargate.html">公式ドキュメンテーション "Amazon ECS on AWS Fargate"</a>
参照)．
クラスターのスケーリングが容易な分， Fargate では EC2 ほど大きな CPU コア・ RAM 容量を単一インスタンスに付与することができず，また GPU を利用することもできない．</p>
</div>
<div class="paragraph">
<p>以上が Fargate の概要であったが，くどくど言葉で説明してもなかなかピンとこないだろう．
ここからは実際に手を動かしながら， ECS と Fargate を使った並列タスクの処理の仕方を学んでいこう．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>厳密には， ECS に付与するクラスターには EC2 と Fargate のハイブリッドを使用することも可能である．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_準備">8.2. 準備</h3>
<div class="paragraph">
<p>ハンズオンのソースコードは GitHub の
<a href="https://github.com/tomomano/learn-aws-by-coding/tree/main/handson/qa-bot">handson/qa-bot</a>
にある．</p>
</div>
<div class="paragraph">
<p>本ハンズオンの実行には，第一回ハンズオンで説明した準備 (<a href="#handson_01_prep">Section 4.1</a>) が整っていることを前提とする．
また， Docker が自身のローカルマシンにインストール済みであることも必要である．</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このハンズオンでは 1CPU/4GB RAM の Fargate インスタンスを使用する．
計算の実行には 0.025 $/hour のコストが発生することに注意．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_transformer_を用いた_question_answering_プログラム">8.3. Transformer を用いた question-answering プログラム</h3>
<div class="paragraph">
<p>このハンズオンで開発する，自動質問回答システムをより具体的に定義しよう．
次のような文脈 (context) と質問 (question) が与えられた状況を想定する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre>context: Albert Einstein (14 March 1879 – 18 April 1955) was a German-born theoretical physicist who developed the theory of relativity, one of the two pillars of modern physics (alongside quantum mechanics). His work is also known for its influence on the philosophy of science. He is best known to the general public for his mass–energy equivalence formula E = mc2, which has been dubbed \"the world's most famous equation\". He received the 1921 Nobel Prize in Physics \"for his services to theoretical physics, and especially for his discovery of the law of the photoelectric effect\", a pivotal step in the development of quantum theory.

question: In what year did Einstein win the Nobel prize?</pre>
</div>
</div>
<div class="paragraph">
<p>今回作成する自動回答システムは，このような問題に対して， context に含まれる文字列から正解となる言葉を見つけ出すものとする．
上の問題では，次のような回答を返すべきである．</p>
</div>
<div class="listingblock">
<div class="content">
<pre>answer: 1921</pre>
</div>
</div>
<div class="paragraph">
<p>人間にとっては，このような文章を理解することは容易であるが，コンピュータにそれを解かせるのは難しいことは容易に想像ができるだろう．
しかし，近年の深層学習を使った自然言語処理の進歩は著しく，上で示したような例題などは極めて高い正答率で回答できるモデルを作ることができる．</p>
</div>
<div class="paragraph">
<p>今回は， <a href="https://github.com/huggingface/transformers">huggingface/transformers</a> で公開されている学習済みの言語モデルを利用することで，上で定義した問題を解く Q&amp;A ボットを作る．
この Q&amp;A ボットは <a href="https://en.wikipedia.org/wiki/Transformer_(machine_learning_model)">Transformer</a>
とよばれるモデルを使った自然言語処理に支えられえている (<a href="#transformer_architecture">Figure 45</a>)．
このプログラムを， Docker にパッケージしたものが
<a href="https://hub.docker.com/repository/docker/tomomano/qabot">著者の Docker Hub リポジトリ</a>
に用意してある．
クラウドの設計に入る前に，まずはこのプログラムを単体で動かしてみよう．</p>
</div>
<div id="transformer_architecture" class="imageblock text-center">
<div class="content">
<img src="imgs/transformer.png" alt="transformer" width="400">
</div>
<div class="title">Figure 45. Transformer モデルアーキテクチャ (画像出典: <a href="https://arxiv.org/abs/1706.03762">Vaswani+ 2017</a>)</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>なお，今回は学習済みのモデルを用いているので，私達が行うのは与えられた入力をモデルに投入して予測を行う (推論) のみである．
推論の演算は， CPU だけでも十分高速に行うことができるので，コストの削減と，実装をシンプルにする目的で，このハンズオンでは GPU は利用しない．
一般的に， ニューラルネットは学習のほうが圧倒的に計算コストが大きく，そのような場合に GPU はより威力を発揮する．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>次のコマンドで，今回使う Docker image を ローカルにダウンロード (pull) してこよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>docker pull tomomano/qabot:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>pull できたら，早速この Docker に質問を投げかけてみよう．
まずは context とquestion をコマンドラインの変数として定義する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ context</span><span class="o">=</span><span class="s2">"Albert Einstein (14 March 1879 – 18 April 1955) was a German-born theoretical physicist who developed the theory of relativity, one of the two pillars of modern physics (alongside quantum mechanics). His work is also known for its influence on the philosophy of science. He is best known to the general public for his mass–energy equivalence formula E = mc2, which has been dubbed the world's most famous equation. He received the 1921 Nobel Prize in Physics for his services to theoretical physics, and especially for his discovery of the law of the photoelectric effect, a pivotal step in the development of quantum theory."</span>
<span class="nv">$ question</span><span class="o">=</span><span class="s2">"In what year did Einstein win the Nobel prize ?"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>そうしたら，次のコマンドによってコンテナを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>docker run tomomano/qabot <span class="s2">"</span><span class="k">${</span><span class="nv">context</span><span class="k">}</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">question</span><span class="k">}</span><span class="s2">"</span> foo <span class="nt">--no_save</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>今回用意した Docker image は，第一引数に context となる文字列を，第二引数に question に相当する文字列を受けつける．
第三引数，第四引数については，クラウドに展開するときの実装上の都合なので，いまは気にしなくてよい．</p>
</div>
<div class="paragraph">
<p>このコマンドを実行すると，次のような出力が得られるはずである．</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{'score': 0.9881729286683587, 'start': 437, 'end': 441, 'answer': '1921'}</pre>
</div>
</div>
<div class="paragraph">
<p>"score" は正解の自信度を表す数字で， [0,1] の範囲で与えられる．
"start", "end" は， context 中の何文字目が正解に相当するかを示しており， "answer" が正解と予測された文字列である．
1921 年という，正しい答えが返ってきていることに注目してほしい．</p>
</div>
<div class="paragraph">
<p>もう少し難しい質問を投げかけてみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ question</span><span class="o">=</span><span class="s2">"Why did Einstein win the Nobel prize ?"</span>
<span class="nv">$ </span>docker run tomomano/qabot <span class="s2">"</span><span class="k">${</span><span class="nv">context</span><span class="k">}</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">question</span><span class="k">}</span><span class="s2">"</span> foo <span class="nt">--no_save</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>出力：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{'score': 0.5235594527494207, 'start': 470, 'end': 506, 'answer': 'his services to theoretical physics,'}</pre>
</div>
</div>
<div class="paragraph">
<p>今度は， score が 0.52 と，少し自信がないようだが，それでも正しい答えにたどりつけていることがわかる．</p>
</div>
<div class="paragraph">
<p>このように， 深層学習に支えられた言語モデルを用いることで，実用にも役に立ちそうな Q&amp;A ボットを実現できていることがわかる．
以降では，このプログラムをクラウドに展開することで，大量の質問に自動で対応できるようなシステムを設計していく．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>今回使用する Question &amp; Answering システムには， DistilBERT という Transformer を基にした言語モデルが用いられている．
興味のある読者は， <a href="https://arxiv.org/abs/1910.01108">原著論文</a> を参照してもらいたい．
また， huggingface/transformers による DistilBert の実装のドキュメンテーションは <a href="https://huggingface.co/transformers/model_doc/distilbert.html">公式ドキュメンテーション</a> を参照のこと．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>今回提供する Q-A ボットの Docker のソースコードは <a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/qa-bot/docker/Dockerfile" class="bare">https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/qa-bot/docker/Dockerfile</a> にある．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_アプリケーションの説明_3">8.4. アプリケーションの説明</h3>
<div class="paragraph">
<p>このハンズオンで作成するアプリケーションの概要を <a href="#handson_03_architecture">Figure 46</a> に示す．</p>
</div>
<div id="handson_03_architecture" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-03/handson-03-architecture.png" alt="hands-on 03 architecture" width="600">
</div>
<div class="title">Figure 46. アプリケーションのアーキテクチャ</div>
</div>
<div class="paragraph">
<p>簡単にまとめると，以下のような設計である．</p>
</div>
<div class="ulist">
<ul>
<li>
<p>クライアントは，質問を AWS 上のアプリケーションに送信する．</p>
</li>
<li>
<p>質問のタスクは ECS によって処理される．</p>
</li>
<li>
<p>ECS は， Docker Hub から，イメージをダウンロードする．</p>
</li>
<li>
<p>次に，ECS はクラスター内に新たな Fargate インスタンスを立ち上げ，ダウンロードされた Docker イメージをこの新規インスタンスに配置する．</p>
<div class="ulist">
<ul>
<li>
<p>このとき，一つの質問に対し一つの Fargate インスタンスを立ち上げることで，複数の質問を並列的に処理できるようにする．</p>
</li>
</ul>
</div>
</li>
<li>
<p>ジョブが実行される．</p>
</li>
<li>
<p>ジョブの実行結果 (質問への回答) は， データベース (DynamoDB) に書き込まれる．</p>
</li>
<li>
<p>最後に，クライアントは DynamoDB から質問への回答を読み取る．</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>それでは，プログラムのソースコードを見てみよう
(<a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/qa-bot/app.py">handson/qa-bot/app.py</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">EcsClusterQaBot</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Stack</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">App</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="c1"># dynamoDB table to store questions and answers
</span>        <span class="n">table</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"EcsClusterQaBot-Table"</span><span class="p">,</span>
            <span class="n">partition_key</span><span class="o">=</span><span class="n">dynamodb</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s">"item_id"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">dynamodb</span><span class="o">.</span><span class="n">AttributeType</span><span class="o">.</span><span class="n">STRING</span>
            <span class="p">),</span>
            <span class="n">billing_mode</span><span class="o">=</span><span class="n">dynamodb</span><span class="o">.</span><span class="n">BillingMode</span><span class="o">.</span><span class="n">PAY_PER_REQUEST</span><span class="p">,</span>
            <span class="n">removal_policy</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">RemovalPolicy</span><span class="o">.</span><span class="n">DESTROY</span>
        <span class="p">)</span>

        <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="n">vpc</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"EcsClusterQaBot-Vpc"</span><span class="p">,</span>
            <span class="n">max_azs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="n">cluster</span> <span class="o">=</span> <span class="n">ecs</span><span class="o">.</span><span class="n">Cluster</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"EcsClusterQaBot-Cluster"</span><span class="p">,</span>
            <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
        <span class="p">)</span>

        <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="n">taskdef</span> <span class="o">=</span> <span class="n">ecs</span><span class="o">.</span><span class="n">FargateTaskDefinition</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"EcsClusterQaBot-TaskDef"</span><span class="p">,</span>
            <span class="n">cpu</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="c1"># 1 CPU
</span>            <span class="n">memory_limit_mib</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span> <span class="c1"># 4GB RAM
</span>        <span class="p">)</span>

        <span class="c1"># grant permissions
</span>        <span class="n">table</span><span class="o">.</span><span class="n">grant_read_write_data</span><span class="p">(</span><span class="n">taskdef</span><span class="o">.</span><span class="n">task_role</span><span class="p">)</span>
        <span class="n">taskdef</span><span class="o">.</span><span class="n">add_to_task_role_policy</span><span class="p">(</span>
            <span class="n">iam</span><span class="o">.</span><span class="n">PolicyStatement</span><span class="p">(</span>
                <span class="n">effect</span><span class="o">=</span><span class="n">iam</span><span class="o">.</span><span class="n">Effect</span><span class="o">.</span><span class="n">ALLOW</span><span class="p">,</span>
                <span class="n">resources</span><span class="o">=</span><span class="p">[</span><span class="s">"*"</span><span class="p">],</span>
                <span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="s">"ssm:GetParameter"</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="n">container</span> <span class="o">=</span> <span class="n">taskdef</span><span class="o">.</span><span class="n">add_container</span><span class="p">(</span>
            <span class="s">"EcsClusterQaBot-Container"</span><span class="p">,</span>
            <span class="n">image</span><span class="o">=</span><span class="n">ecs</span><span class="o">.</span><span class="n">ContainerImage</span><span class="o">.</span><span class="n">from_registry</span><span class="p">(</span>
                <span class="s">"tomomano/qabot:latest"</span>
            <span class="p">),</span>
        <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ここでは，回答の結果を書き込むためのデータベースを用意している．
DynamoDB については，サーバーレスアーキテクチャの章で扱うので，今は気にしなくてよい．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ここでは，ハンズオン #1, #2 で行ったのと同様に， VPC を定義している．</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>ここで， ECS のクラスター (cluster) を定義している．
クラスターとは，仮想サーバーのプールのことであり，クラスターの中に複数の仮想インスタンスを配置する．</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>ここで，実行するタスクを定義している (task definition)．</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>ここで， タスクの実行で使用する Docker イメージを定義している．</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_ecs_と_fargate">8.4.1. ECS と Fargate</h4>
<div class="paragraph">
<p>ECS と Fargate の部分について，コードをくわしく見てみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="n">cluster</span> <span class="o">=</span> <span class="n">ecs</span><span class="o">.</span><span class="n">Cluster</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"EcsClusterQaBot-Cluster"</span><span class="p">,</span>
    <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">taskdef</span> <span class="o">=</span> <span class="n">ecs</span><span class="o">.</span><span class="n">FargateTaskDefinition</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"EcsClusterQaBot-TaskDef"</span><span class="p">,</span>
    <span class="n">cpu</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="c1"># 1 CPU
</span>    <span class="n">memory_limit_mib</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span> <span class="c1"># 4GB RAM
</span><span class="p">)</span>

<span class="n">container</span> <span class="o">=</span> <span class="n">taskdef</span><span class="o">.</span><span class="n">add_container</span><span class="p">(</span>
    <span class="s">"EcsClusterQaBot-Container"</span><span class="p">,</span>
    <span class="n">image</span><span class="o">=</span><span class="n">ecs</span><span class="o">.</span><span class="n">ContainerImage</span><span class="o">.</span><span class="n">from_registry</span><span class="p">(</span>
        <span class="s">"tomomano/qabot:latest"</span>
    <span class="p">),</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>cluster =</code> の箇所で，空の ECS クラスターを定義している．</p>
</div>
<div class="paragraph">
<p>次に， <code>taskdef=ecs.FargateTaskDefinition</code> の箇所で， Fargate インスタンスを使ったタスクを定義しており，とくにここでは 1 CPU, 4GB RAM というマシンスペックを指定している．
また，このようにして定義されたタスクは，デフォルトで1タスクにつき1インスタンスが使用される．</p>
</div>
<div class="paragraph">
<p>最後に， <code>container =</code> の箇所で，タスクの実行で使用する Docker image を定義している．
ここでは， Docker Hub に置いてある image をダウンロードしてくるよう指定している．</p>
</div>
<div class="paragraph">
<p>このようにわずか数行のコードであるが，これだけで前述したような，タスクのスケジューリングなどが自動で実行される．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このコードで <code>cpu=1024</code> と指定されているのに注目してほしい．
これは CPU ユニットと呼ばれる数で， 以下の換算表に従って仮想CPU (virtual CPU; vCPU) が割り当てられる．
1024 が 1 CPU に相当する．
0.25 や 0.5 vCPU などの数字は，それぞれ実効的に 1/4, 1/2 の CPU 時間が割り当てられることを意味する．
また， CPU ユニットによって使用できるメモリー量も変わってくる．
たとえば， 1024 CPU ユニットを選択した場合は， 2 から 8 GB の範囲でのみメモリー量を指定することができる．
最新の情報は <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/AWS_Fargate.html">公式ドキュメンテーション "Amazon ECS on AWS Fargate"</a> を参照のこと．</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. CPU　ユニットと 指定可能なメモリー量の換算表</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CPU ユニット</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">メモリーの値</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">256 (.25 vCPU)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.5 GB, 1 GB, 2 GB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">512 (.5 vCPU)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 GB, 2 GB, 3 GB, 4 GB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1024 (1 vCPU)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 GB, 3 GB, 4 GB, 5 GB, 6 GB, 7 GB, 8 GB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2048 (2 vCPU)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Between 4 GB and 16 GB in 1-GB increments</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4096 (4 vCPU)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Between 8 GB and 30 GB in 1-GB increments</p></td>
</tr>
</tbody>
</table>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_スタックのデプロイ_2">8.5. スタックのデプロイ</h3>
<div class="paragraph">
<p>スタックの中身が理解できたところで，早速スタックをデプロイしてみよう．</p>
</div>
<div class="paragraph">
<p>デプロイの手順は，これまでのハンズオンとほとんど共通である．
SSH によるログインの必要がないので，むしろ単純なくらいである．
ここでは，コマンドのみ列挙する (<code>#</code> で始まる行はコメントである)．
それぞれの意味を忘れてしまった場合は，ハンズオン1, 2に戻って復習していただきたい．
シークレットキーの設定も忘れずに (<a href="#aws_cli_install">Section 15.3</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c"># プロジェクトのディレクトリに移動</span>
<span class="nv">$ </span><span class="nb">cd </span>handson/qa-bot

<span class="c"># venv を作成し，依存ライブラリのインストールを行う</span>
<span class="nv">$ </span>python3 <span class="nt">-m</span> venv .env
<span class="nv">$ </span><span class="nb">source</span> .env/bin/activate
<span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt

<span class="c"># デプロイを実行</span>
<span class="nv">$ </span>cdk deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>デプロイのコマンドが無事に実行されれば， <a href="#handson_03_cdk_output">Figure 47</a> のような出力が得られるはずである．</p>
</div>
<div id="handson_03_cdk_output" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-03/cdk_output.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 47. CDKデプロイ実行後の出力</div>
</div>
<div class="paragraph">
<p>AWS コンソールにログインして，デプロイされたスタックの中身を確認してみよう．
コンソールから，ECS のページに行くと <a href="#handson_03_ecs_console">Figure 48</a> のような画面が表示されるはずである．
<code>EcsClusterQaBot-XXXX</code> という名前ついたクラスターを見つけよう．</p>
</div>
<div class="paragraph">
<p>Cluster というのが，先ほど説明したとおり，複数の仮想インスタンスを束ねる一つの単位である．
<a href="#handson_03_ecs_console">Figure 48</a> で， FARGATE という文字の下に <code>0 Running tasks</code>, <code>0 Pending tasks</code> と表示されていることを確認しよう．
この時点では一つもタスクが走っていないので，数字はすべて0になっている．</p>
</div>
<div id="handson_03_ecs_console" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-03/ecs_console.png" alt="ecs_console" width="700">
</div>
<div class="title">Figure 48. ECS コンソール画面</div>
</div>
<div class="paragraph">
<p>続いて，この画面の左のメニューバーから <code>Task Definitions</code> という項目を見つけ，クリックしよう．
移動した先のページで <code>EcsClusterQaBotEcsClusterQaBotTaskDefXXXX</code> という項目が見つかるので，開く．
開いた先のページをスクロールすると <a href="#handson_03_ecs_task_definition">Figure 49</a> に示したような情報が見つかるだろう．
使用する CPU ・メモリーの量や， Docker container の実行に関する設定などが，この Task Definition の画面から確認することができる．</p>
</div>
<div id="handson_03_ecs_task_definition" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-03/ecs_task_definition.png" alt="task_definition" width="700">
</div>
<div class="title">Figure 49. Task definition の確認</div>
</div>
</div>
<div class="sect2">
<h3 id="_タスクの実行">8.6. タスクの実行</h3>
<div class="paragraph">
<p>それでは，質問をデプロイしたクラウドに提出してみよう．</p>
</div>
<div class="paragraph">
<p>ECS にタスクを投入するのはやや複雑なので，タスクの投入を簡単にするプログラム (<code>run_task.py</code>) を用意した
(<a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/qa-bot/run_task.py">handson/qa-bot/run_task.py</a>)．</p>
</div>
<div class="paragraph">
<p>次のようなコマンドで，ECSクラスターに新しい質問を投入することができる．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python run_task.py ask <span class="s2">"A giant peach was flowing in the river. She picked it up and brought it home. Later, a healthy baby was born from the peach. She named the baby Momotaro."</span> <span class="s2">"What is the name of the baby?"</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>run_task.py</code> を実行するには， コマンドラインで AWS の認証情報が設定されていることが前提である．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>"ask" の引数に続き，文脈 (context) と質問 (question) を引数として渡している．</p>
</div>
<div class="paragraph">
<p>このコマンドを実行すると， "Waiting for the task to finish&#8230;&#8203;" と出力が表示され，回答を得るまでしばらく待たされる．
この間， AWS では ECS がタスクを受理し，新しい Fargate のインスタンスを起動し， Docker イメージをそのインスタンスに配置する，という一連の処理がなされている．
AWS コンソールから，この一連の様子をモニタリングしてみよう．</p>
</div>
<div class="paragraph">
<p>先ほどの ECS コンソール画面にもどり，クラスターの名前をクリックすることで，クラスターの詳細画面を開く．
次に， "Tasks" という名前のタブがあるので，それを開く (<a href="#ecs_task_monitoring">Figure 50</a>)．
すると，実行中のタスクの一覧が表示されるだろう．</p>
</div>
<div id="ecs_task_monitoring" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-03/ecs_task_monitoring.png" alt="ecs_task_monitoring" width="700">
</div>
<div class="title">Figure 50. ECS のタスクの実行状況をモニタリング</div>
</div>
<div class="paragraph">
<p><a href="#ecs_task_monitoring">Figure 50</a> で見て取れるように， "Last status = Pending" となっていることから，この時点では，タスクを実行する準備をしている段階である，ということがわかる．
Fargate のインスタンスを起動し， Docker image を配置するまでおよそ1-2分の時間がかかる．</p>
</div>
<div class="paragraph">
<p>しばらく待つうちに， Status が "RUNNING" に遷移し，計算が始まる．
計算が終わると， Status は "STOPPED" に遷移し， ECS によって Fargate インスタンスは自動的にシャットダウンされる．</p>
</div>
<div class="paragraph">
<p><a href="#ecs_task_monitoring">Figure 50</a> の画面から， "Task" の列にあるタスクIDクリックすることで，タスクの詳細画面を開いてみよう (<a href="#ecs_task_detail">Figure 51</a>)．
"Last status", "Platform version" など，タスクの情報が表示されている．
また， "Logs" のタブを開くことで，コンテナの吐き出した実行ログを閲覧することができる．</p>
</div>
<div id="ecs_task_detail" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-03/ecs_task_detail.png" alt="ecs_task_detail" width="700">
</div>
<div class="title">Figure 51. 質問タスクの実行結果</div>
</div>
<div class="paragraph">
<p>さて， <code>run_task.py</code> を実行したコマンドラインに戻ってきてみると， <a href="#ask_question_output">Figure 52</a> のような出力が得られているはずである．
"Momotaro" という正しい回答が返ってきている！</p>
</div>
<div id="ask_question_output" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-03/ask_question_output.png" alt="ask_question_output" width="700">
</div>
<div class="title">Figure 52. 質問タスクの実行結果</div>
</div>
</div>
<div class="sect2">
<h3 id="_タスクの同時実行">8.7. タスクの同時実行</h3>
<div class="paragraph">
<p>さて，先ほどはたった一つの質問を投入したわけだが，今回設計したアプリケーションは， ECS と Fargate を使うことで同時にたくさんの質問を処理することができる．
実際に，たくさんの質問を一度に投入してみよう．
<code>run_task.py</code> に <code>ask_many</code> というオプションを付けることで，複数の質問を一度に送信できる．
質問の内容は
<a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/qa-bot/problems.json">handson/qa-bot/problems.json</a> に定義されている．</p>
</div>
<div class="paragraph">
<p>次のようなコマンドを実行しよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python run_task.py ask_many</code></pre>
</div>
</div>
<div class="paragraph">
<p>このコマンドを実行した後で，先ほどの ECS コンソールに行き，タスクの一覧を見てみよう (<a href="#ecs_many_tasks">Figure 53</a>)．
複数の Fargate インスタンスが起動され，タスクが並列に実行されているのがわかる．</p>
</div>
<div id="ecs_many_tasks" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-03/ecs_many_tasks.png" alt="ecs_many_tasks" width="700">
</div>
<div class="title">Figure 53. 複数の質問タスクを同時に投入する</div>
</div>
<div class="paragraph">
<p>すべてのタスクのステータスが "STOPPED" になったことを確認した上で，質問への回答を取得しよう．
それには，次のコマンドを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python run_task.py list_answers</code></pre>
</div>
</div>
<div class="paragraph">
<p>結果として， <a href="#ask_many_output">Figure 54</a> のような出力が得られるだろう．
複雑な文章問題に対し，高い正答率で回答できていることがわかるだろう．</p>
</div>
<div id="ask_many_output" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-03/ask_many_output.png" alt="ask_many_output" width="700">
</div>
<div class="title">Figure 54. <code>$ python run_task.py list_answers</code> の実行結果</div>
</div>
<div class="paragraph">
<p>おめでとう！
ここまでついてこれた読者はとても初歩的ながらも，深層学習による言語モデルを使って自動で質問への回答を生成するシステムを創り上げることができた！
それも，数百の質問にも同時に対応できるような，とても高いスケーラビリティーをもったシステムである！
今回は GUI (Graphical User Interface) を用意することはしなかったが，このシステムに簡単な GUI を追加すればなかなか立派なウェブサービスとして運用できるだろう．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>run_task.py</code> で質問を投入し続けると，回答を記録しているデータベースにどんどんエントリーが溜まっていく．
これらのエントリーをすべて消去するには，次のコマンドを使う．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python run_task.py clear</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_スタックの削除_2">8.8. スタックの削除</h3>
<div class="paragraph">
<p>これにて，今回のハンズオンは終了である．
最後にスタックを削除しよう．</p>
</div>
<div class="paragraph">
<p>スタックを削除するには，前回までと同様に， AWS コンソールにログインし CloudFormation の画面から DELETE ボタンをクリックするか，コマンドラインからコマンドを実行する．
コマンドラインから行う場合は，次のコマンドを使用する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>cdk destroy</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec_aws_batch">9. Hands-on #4: AWS Batch を使って機械学習のハイパーパラメータサーチを並列化する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ハンズオン第三回では， ECS と Fargate を使って自動質問回答システムを構築した．
シンプルながらも，複数の質問が送られた場合には並列にジョブが実行され，ユーザーに答えが返されるシステムを作ることができた．
ここでは，すでに学習済みの言語モデルを用いてアプリケーションを構築した．
しかし，一般的に言って，機械学習のワークフローでは自分で作ったモデルを訓練することが最初のステップにあるはずである．
そこで，ハンズオン第四回では，クラウドを用いて機械学習の訓練を並列化・高速化することを考える．</p>
</div>
<div class="paragraph">
<p>本ハンズオンでは深層学習におけるハイパーパラメータ最適化を取り上げる．
ハイパーパラメータとは，勾配降下法によって最適化されるニューラルネットのパラメータの外にあるパラメータのことであり，具体的にはモデルの層の幅・深さなどネットワークのアーキテクチャに関わるもの，学習率やモメンタムなどパラメータの更新則に関わるものなどが含まる．
深層学習においてハイパーパラメータの調整はとても重要なタスクである．
しかしながら，ハイパーパラメータを調整するには，少しずつ条件を変えながら何度もニューラルネットを学習させる必要があり，多くの計算時間がかかる．
研究・開発においては，スループットよくたくさんのモデルの可能性を探索することが生産性を決める重要なファクターであり，ハイパーパラメータ探索を高速に解くという問題は極めて関心が高い．
本ハンズオンでは，クラウドの強力な計算リソースを利用して並列的にニューラルネットの訓練を実行することで，この問題を解く方法を学んでいこう．</p>
</div>
<div class="sect2">
<h3 id="_auto_scaling_groups_asg">9.1. Auto scaling groups (ASG)</h3>
<div class="paragraph">
<p>ハンズオンに入っていく前に， <strong>Auto scaling groups (ASG)</strong> とよばれる EC2 の概念を知っておく必要がある．</p>
</div>
<div class="paragraph">
<p>ECS の概要を示した <a href="#ecs_overview">Figure 43</a> を振り返って見てほしい．
前章 (<a href="#sec_fargate_qabot">Section 8</a>) でも説明したが， ECS のクラスターで計算を担う実体としては EC2 と Fargate を指定することができる．
Fargate については前章で記述した．
Fargate を用いると，自在にスケールする計算環境をとても簡単な設定で構築することができた．
しかし， GPU を利用することができないなど，いくつかの制約があった．
EC2 を使用した計算環境を指定することで，プログラミングの複雑度は増すが， GPU やその他のより高度かつ複雑な設定を伴ったクラスターを構築することができる．</p>
</div>
<div class="paragraph">
<p>EC2 クラスターには <strong>ASG</strong> と呼ばれるサービスが配置される．
ASG は複数の EC2 インスタンスをロジカルな単位でグループ化することでクラスターを構成する．
ASG はクラスター内に新しいインスタンスを起動する，あるいは不要になったインスタンスを停止するなどのスケーリングを担う．
ASG で重要な概念として， <strong>desired capacity</strong>, <strong>minimum capacity</strong>, <strong>maximum capacity</strong> というパラメータがある．
minimum capacity， maximum capacity は，それぞれクラスター内に配置できるインスタンスの数の最小値・最大値を指定するパラメータである．
前者は，クラスターに負荷がかかっていない場合でもアイドリング状態にあるインスタンスを維持することで，急に負荷が増大した時などのバッファーとして作用することができる．
後者は，負荷が急に増えたときに，過剰な数のインスタンスが起動する事態を防ぎ，経済的なコストの上限を定める役割を果たす．</p>
</div>
<div class="paragraph">
<p>desired capacity が，その時々でシステムが要求するインスタンスの数を指定する．
desired capacity は，例えば24時間のリズムに合わせてインスタンスの数を増減させる (昼は多く夜は少なくなど) などの決まったスケジュールに基づいた設定を適用することができる．
あるいはクラスター全体にかかっている負荷に応じて， desired capacity を動的に制御することも可能である．
どのような基準でクラスターのスケーリングを行うかを定めるルールのことを，<strong>スケーリングポリシー</strong>とよぶ．
たとえば，クラスター全体の稼働率 (負荷) を常に 80% に維持する，などのスケーリングポリシーが想定できる．
この場合，クラスター全体の負荷が80%を下回ったときにはクラスターからインスタンスが削除され，80%を超える (あるいは超えると予測される) 場合はインスタンスを追加する，という操作が ASG によって自動的に行われる．</p>
</div>
<div class="paragraph">
<p>上記のようなパラメータを検討し，ユーザーは ASG を作成する．
ASG を作成したのち， ECS との連携をプログラムしてあげることで， ECS を介して ASG による EC2 クラスターにタスクを投入することが可能になる．</p>
</div>
</div>
<div class="sect2">
<h3 id="_aws_batch">9.2. AWS Batch</h3>
<div class="imageblock">
<div class="content">
<img src="imgs/aws_logos/Batch.png" alt="Batch" width="100">
</div>
<div class="title">Figure 55. AWS Batch のアイコン</div>
</div>
<div class="paragraph">
<p>先に説明したように， ECS と ASG を組み合わせることで，所望の計算クラスターを構築することが可能である．
しかしながら， ECS と ASG にはかなり込み入った設定が必要であり，初心者にとっても経験者にとってもなかなか面倒なプログラミングが要求される．
そこで， ECS と ASG によるクラスターの設計を自動化してくれるサービスが提供されている．
それが <strong>AWS Batch</strong> である．</p>
</div>
<div class="paragraph">
<p>AWS Batch はその名のとおりバッチ (Batch) 化されたジョブ (入力データだけが異なる独立した演算が繰り返し実行されること) を想定している．
多くの科学計算や機械学習がバッチ計算に当てはまる．
たとえば，初期値のパラメータを変えて複数のシミュレーションを走らせる，といったケースだ．
AWS Batch を用いることの利点は，クラスターのスケーリングやジョブの割り振りはすべて自動で実行され，
ユーザーはクラウドの舞台裏の詳細を気にすることなく，大量のジョブを投入できるシステムが手に入る点である．
が，知識として背後では ECS/ASG/EC2 の三つ巴が協調して動作しているという点は知っておいてほしい．</p>
</div>
<div class="paragraph">
<p>AWS Batch では，ジョブの投入・管理をスムーズに行うため，次のような概念が定義されている (<a href="#fig_batch_concept">Figure 56</a>)．
まず， <strong>ジョブ (Job)</strong> というのが，AWS Batch によって実行される一つの計算の単位である．
<strong>Job definitions</strong> とはジョブの内容を定義するものであり，これには実行されるべき Docker のイメージのアドレスや，割り当てる CPU・RAM の容量，環境変数などの設定が含まれる．
Job definition に基づいて個々のジョブが実行される．
ジョブが実行されると，ジョブは <strong>Job queues</strong> に入る．
Job queues とは，実行待ち状態にあるジョブの列のことであり，時間的に最も先頭に投入されたジョブが最初に実行される．
また，複数の queue を配置し， queue ごとに priority (優先度) を設定することが可能であり， priority の高い queue に溜まったジョブが優先的に実行される
(筆者はこれをディズニーランドの"ファストパス"を連想して捉えている)．
<strong>Compute environment</strong> とは，先述したクラスターとほぼ同義の概念であり，計算が実行される場所 (EC2 や Fargate からなるクラスター) を指す．
Compute environment には，使用する EC2 のインスタンスタイプや同時に起動するインスタンス数の上限などの簡易なスケーリングポリシーが指定されている．
Job queues は Compute environment の空き状況を監視しており， それに応じてジョブを Compute environment に投下する．</p>
</div>
<div class="paragraph">
<p>以上が AWS Batch を使用するうえで理解しておかなければならない概念であるが，くどくど言葉で説明してもなかなかピンとこないだろう．
ここからは，実際に自分で手を動かしながら学んでいこう．</p>
</div>
<div id="fig_batch_concept" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/batch_concepts.png" alt="batch concepts" width="700">
</div>
<div class="title">Figure 56. AWS Batch の主要な概念</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>EC2 or Fargate?</strong></p>
</div>
<div class="paragraph">
<p>ECS でクラスターを構成する際，計算を実行する場として EC2 と Fargate の二つの選択肢があることを説明した．
それぞれ長所と短所を抱えているのだが，どのような場合にどちらを使うべきだろうか？
それを検討するため，まずは <a href="#tab:ec2_vs_fargate">Table 5</a> を見てみよう．
これはEC2 と Fargate の特徴をまとめたものである．
説明の都合上，大幅な粗視化が行われている点は留意していただきたい．</p>
</div>
<table id="tab:ec2_vs_fargate" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. EC2 vs Fargate</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">EC2</th>
<th class="tableblock halign-left valign-top">Fargate</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compute capacity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Medium to large</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Small to medium</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPU</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Launch speed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Slow</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fast</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Task placement flexibility</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Programming complexity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>これまでに見てきたように， EC2 は最大の CPU 数・メモリーサイズが大きかったり， GPU を利用できたりするなど，単一のインスタンスでの計算能力は高い．
対して， Fargate は単一インスタンスの最大 CPU 数は4コアが上限である．
その一方で，インスタンスの起動に要する時間は Fargate のほうが圧倒的に早く，より俊敏にクラスターのスケーリングを行うことができる．
また，タスクをクラスターに投入する際のフレキシビリティも Fargate のほうが高い．
フレキシビリティというのは，例えば一つのインスタンスで2つ以上のコンテナを走らせる，などの状況である．
単位 CPU あたりで処理されるタスクの数を最大化する際には，このような設計がしばしば採用される．
プログラミングの複雑さという観点からは， Fargate のほうが一般的にシンプルな実装になる．</p>
</div>
<div class="paragraph">
<p>このように， EC2 と Fargate は互いに相補的な特性を有しており，アプリケーションによって最適な計算環境は検討される必要がある．
また，EC2 と Fargate を両方用いたハイブリッドクラスターというのも定義可能であり，そのような選択肢もしばしば用いられる．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_準備_2">9.3. 準備</h3>
<div class="paragraph">
<p>ハンズオンのソースコードは GitHub の
<a href="https://github.com/tomomano/learn-aws-by-coding/tree/main/handson/aws-batch">handson/aws-batch</a>
にある．</p>
</div>
<div class="paragraph">
<p>本ハンズオンの実行には，第一回ハンズオンで説明した準備 (<a href="#handson_01_prep">Section 4.1</a>) が整っていることを前提とする．
また， Docker が自身のローカルマシンにインストール済みであることも必要である．</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このハンズオンは， <code>g4dn.xlarge</code> タイプの EC2 インスタンスを使うので，アメリカ東部 (<code>us-east-1</code>) リージョンでは 0.526 $/hour のコストが発生する．
東京 (<code>ap-northeast-1</code>) を選択した場合は 0.71 $/hour のコストが発生する．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="#sec:jupyter_and_deep_learning_setup">Section 6.1</a> でも注意したが，このハンズオンを始める前に G タイプインスタンスの起動上限を AWS コンソールの EC2 管理画面から確認しよう．
もし上限が0になっていた場合は，上限緩和の申請を行う必要がある．
<a href="#sec:aws_batch_code">Section 9.5</a> にも関連した情報を記載しているので，併せて参照されたい．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="sec_run_mnist_docker_local">9.4. MNIST 手書き文字認識 (再訪)</h3>
<div class="paragraph">
<p>今回のハンズオンでは，機械学習のハイパーパラメータ調整を取り上げると冒頭で述べた．
その最もシンプルな例題として， <a href="#sec_mnist_using_jupyter">Section 6.7</a> で扱った MNIST 手書き文字認識の問題を再度取り上げよう．
<a href="#sec_mnist_using_jupyter">Section 6.7</a> では，適当にチョイスしたハイパーパラメータを用いてモデルの訓練を行った．
ここで使用したプログラムのハイパーパラメータとしては，確率的勾配降下法 (SGD) における学習率やモメンタムが含まれる．
コードでいうと，次の行が該当する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>ここで使用された 学習率 (<code>lr=0.01</code>) やモメンタム (<code>momentum=0.5</code>) は恣意的に選択された値であり，これがベストな数値であるのかはわからない．
たまたまこのチョイスが最適であるかもしれないし，もっと高い精度を出すハイパーパラメータの組が存在するかもしれない．
この問題に答えるため，ハイパーパラメータサーチを行おう．
今回は，最もシンプルなアプローチとして，<strong>グリッドサーチ</strong>によるハイパーパラメータサーチを行おう．</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">ハイパーパラメータの最適化について</div>
<div class="paragraph">
<p>機械学習のハイパーパラメータの最適化には大きく３つのアプローチが挙げられる．
グリッドサーチ，ランダムサーチ，そしてベイズ最適化による方法である．</p>
</div>
<div class="paragraph">
<p>グリッドサーチとは，ハイパーパラメータの組をある範囲の中で可能な組み合わせをすべて計算し，最適なパラメータの組を見出す方法である．
最もシンプルかつ確実な方法であるが，すべての組み合わせの可能性を愚直に計算するので計算コストが大きい．</p>
</div>
<div class="paragraph">
<p>ランダムサーチ法とは，ハイパーパラメータの組をある範囲の中でランダムに抽出し，大量に試行されたランダムな組の中から最適なパラメータの組を見出す方法である．
すべての可能性を網羅的に探索できるわけではないが，調整すべきパラメータの数が多数ある場合に，グリッドサーチよりも効率的に広い探索空間をカバーすることができる．</p>
</div>
<div class="paragraph">
<p>ベイズ最適化を用いた方法では，過去の探索結果から次にどの組み合わせを探索すべきかという指標を計算し，次に探索するパラメータを決定する．
これにより，理論的にはグリッドサーチやランダムサーチ法よりも少ない試行回数で最適なパラメータにたどり着くことができる．</p>
</div>
<div class="paragraph">
<p>並列化の観点でいうと，グリッドサーチとランダムサーチは各ハイパーパラメータの組の計算は独立に実行することができるため並列化が容易である．
このように独立したジョブとして分割・並列化可能な問題を Embarrassingly parallel な問題とよぶ (直訳すると"恥ずかしいほど並列化可能な問題"，ということになる)．
Embarrassingly parallel な問題はクラウドの強力な計算リソースを用いることで，非常なシンプルな実装で解くことができる．
この章ではこのようなタイプの並列計算を取り上げる．</p>
</div>
<div class="paragraph">
<p>一方，ベイズ最適化による方法は，過去の結果をもとに次の探索が決定されるので，並列化はそれほど単純ではない．
最近では <a href="https://optuna.org/">optuna</a> などのハイパーパラメータ探索のためのライブラリが発達しており，ベイズ最適化の数理的な処理を自動で実行してくれるので便利である．
これらのライブラリを使うと，もし一台のコンピュータ (ノード) の中に複数の GPU が存在する場合は，並列に計算を実行することができる．
しかしながら，一台のノードにとどまらず，複数のノードをまたいだ並列化は，高度なプログラミングテクニックが必要とされるだけでなく，ノード間の接続様式などクラウドのアーキテクチャにも深く依存するものである．
本書ではここまで高度なクラウドの使用方法には立ち入らない．</p>
</div>
</div>
</div>
<div class="paragraph">
<p>まずは，本ハンズオンで使用する Docker イメージをローカルで実行してみよう．</p>
</div>
<div class="paragraph">
<p>Docker イメージのソースコードは
<a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/aws-batch/docker">handson/aws-batch/docker</a>
にある．
基本的に <a href="#sec_mnist_using_jupyter">Section 6.7</a> のハンズオンを元にし，本ハンズオン専用の軽微な変更が施してある．
興味のある読者はソースコードも含めて読んでいただきたい．</p>
</div>
<div class="paragraph">
<p>練習として，この Docker イメージを手元でビルドするところからはじめてみよう．
<code>Dockerfile</code> が保存されているディレクトリに移動し， <code>mymnist</code> という名前 (Tag) をつけてビルドを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cd </span>handson/aws-batch/docker
<span class="nv">$ </span>docker build <span class="nt">-t</span> mymnist .</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>docker build</code> でエラーが出たときは次の可能性を疑ってほしい．
ビルドの中で， MNIST の画像データセットを <a href="http://yann.lecun.com/exdb/mnist/" class="bare">http://yann.lecun.com/exdb/mnist/</a> からダウンロードするのだが，ダウンロード先のサーバーがしばしばダウンしている．
世界中の機械学習ユーザーがアクセスするので，これはしばしば発生するようである．
サーバーがダウンしているとビルドも失敗してしまう．
エラーメッセージにそれらしい文言が含まれていたら，この可能性を疑おう．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>手元でビルドするかわりに， Docker Hub から pull することも可能である．
その場合は次のコマンドを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>docker pull tomomano/mymnist:latest</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>イメージの準備ができたら，次のコマンドでコンテナを起動し， MNIST の学習を実行する．．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>docker run mymnist <span class="nt">--lr</span> 0.1 <span class="nt">--momentum</span> 0.5 <span class="nt">--epochs</span> 10</code></pre>
</div>
</div>
<div class="paragraph">
<p>このコマンドを実行すると，指定したハイパーパラメータ (<code>--lr</code> で与えられる学習率と <code>--momentum</code> で与えられるモメンタム) を使ってニューラルネットの最適化が始まる．
学習を行う最大のエポック数は <code>--epochs</code> パラメータで指定する．
<a href="#sec_jupyter_and_deep_learning">Section 6</a> のハンズオンで見たような， Loss の低下がコマンドライン上に出力されるだろう (<a href="#fig_mnist_log_output">Figure 57</a>)．</p>
</div>
<div id="fig_mnist_log_output" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/mnist_log_output.png" alt="mnist log" width="600">
</div>
<div class="title">Figure 57. Docker を実行した際の出力</div>
</div>
<div class="paragraph">
<p>上に示したコマンドを使うと，計算は CPU を使って実行される．
もし，ローカルの計算機に GPU が備わっており， <a href="https://github.com/NVIDIA/nvidia-docker">nvidia-docker</a> の設定が済んでいるならば，
次のコマンドにより GPU を使って計算を実行できる．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>docker run <span class="nt">--gpus</span> all mymnist <span class="nt">--lr</span> 0.1 <span class="nt">--momentum</span> 0.5 <span class="nt">--epochs</span> 10</code></pre>
</div>
</div>
<div class="paragraph">
<p>このコマンドでは，<code>--gpus all</code> というパラメータが加わった．</p>
</div>
<div class="paragraph">
<p>CPU/GPU どちらで実行した場合でも，エポックを重ねるにつれて訓練データ (Train データ) の Loss は単調に減少していくのが見て取れるだろう．
一方，<strong>検証データ (Validation データ) の Loss および Accuracy は，ある程度まで減少した後，それ以上性能が向上しない</strong>ことに気がつくだろう．
これを実際にプロットしてみると <a href="#fig_loss_epoch_profile">Figure 58</a> のようになるはずである．</p>
</div>
<div id="fig_loss_epoch_profile" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/loss_epoch_profile.png" alt="loss epochs" width="600">
</div>
<div class="title">Figure 58. (左) Train/Validation データそれぞれの Loss のエポックごとの変化． (右) Validation データの Accuracy のエポックごとの変化</div>
</div>
<div class="paragraph">
<p>これは<strong>オーバーフィッティング</strong>とよばれる現象で，ニューラルネットが訓練データに過度に最適化され，訓練データの外のデータに対しての精度 (汎化性能) が向上していないことを示している．
このような場合の対処法として， <strong>Early stopping</strong> とよばれるテクニックが知られている．
Early stopping とは，検証データの Loss を追跡し，それが減少から増加に転じるエポックで学習をうち止め，そのエポックでのウェイトパラメータを採用する，というものである．
本ハンズオンでも， Early stopping によって訓練の終了を判断し，モデルの性能評価を行っていく．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>MNIST 手書き文字データセットでは，訓練データとして 60,000 枚，テストデータとして 10,000 枚の画像が与えられている．
本ハンズオンで使用するコードでは，訓練データのうち 80% の 48,000 枚を訓練データとして使用し，残り 20% の 12,000 枚を検証データとして用いている．
詳しくはソースコードを参照のこと．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="sec:aws_batch_code">9.5. アプリケーションの説明</h3>
<div class="paragraph">
<p>このハンズオンで作成するアプリケーションの概要を <a href="#fig_batch_architecture">Figure 59</a> に示す．</p>
</div>
<div id="fig_batch_architecture" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/architecture.png" alt="architecture" width="600">
</div>
<div class="title">Figure 59. アプリケーションのアーキテクチャ</div>
</div>
<div class="paragraph">
<p>簡単にまとめると，次のような設計である．</p>
</div>
<div class="ulist">
<ul>
<li>
<p>クライアントは，あるハイパーパラメータの組を指定して Batch にジョブを提出する</p>
</li>
<li>
<p>Batch はジョブを受け取ると， EC2 からなるクラスターで計算を実行する</p>
</li>
<li>
<p>クラスター内では <code>g4dn.xlarge</code> インスタンスが起動する</p>
</li>
<li>
<p>Docker イメージは， AWS 内に用意された ECR (Elastic Container Registry) から取得される</p>
</li>
<li>
<p>複数のジョブが投下された場合は，その数だけのインスタンスが起動し並列に実行される</p>
</li>
<li>
<p>各ジョブによる計算の結果は S3 に保存される</p>
</li>
<li>
<p>最後にクライアントは S3 から結果をダウンロードし，最適なハイパーパラメータの組を決定する</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>それでは，プログラムのソースコードを見てみよう
(<a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/aws-batch/app.py">handson/aws-batch/app.py</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">SimpleBatch</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Stack</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">App</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="n">bucket</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"bucket"</span><span class="p">,</span>
            <span class="n">removal_policy</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">RemovalPolicy</span><span class="o">.</span><span class="n">DESTROY</span><span class="p">,</span>
            <span class="n">auto_delete_objects</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">vpc</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"vpc"</span><span class="p">,</span>
            <span class="c1"># other parameters...
</span>        <span class="p">)</span>

        <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="n">managed_env</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">ComputeEnvironment</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"managed-env"</span><span class="p">,</span>
            <span class="n">compute_resources</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">ComputeResources</span><span class="p">(</span>
                <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
                <span class="n">allocation_strategy</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">AllocationStrategy</span><span class="o">.</span><span class="n">BEST_FIT</span><span class="p">,</span>
                <span class="n">desiredv_cpus</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">maxv_cpus</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                <span class="n">minv_cpus</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">instance_types</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">ec2</span><span class="o">.</span><span class="n">InstanceType</span><span class="p">(</span><span class="s">"g4dn.xlarge"</span><span class="p">)</span>
                <span class="p">],</span>
            <span class="p">),</span>
            <span class="n">managed</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">compute_environment_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stack_name</span> <span class="o">+</span> <span class="s">"compute-env"</span>
        <span class="p">)</span>

        <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="n">job_queue</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">JobQueue</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"job-queue"</span><span class="p">,</span>
            <span class="n">compute_environments</span><span class="o">=</span><span class="p">[</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">JobQueueComputeEnvironment</span><span class="p">(</span>
                    <span class="n">compute_environment</span><span class="o">=</span><span class="n">managed_env</span><span class="p">,</span>
                    <span class="n">order</span><span class="o">=</span><span class="mi">100</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="n">job_queue_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stack_name</span> <span class="o">+</span> <span class="s">"job-queue"</span>
        <span class="p">)</span>

        <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="n">job_role</span> <span class="o">=</span> <span class="n">iam</span><span class="o">.</span><span class="n">Role</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"job-role"</span><span class="p">,</span>
            <span class="n">assumed_by</span><span class="o">=</span><span class="n">iam</span><span class="o">.</span><span class="n">CompositePrincipal</span><span class="p">(</span>
                <span class="n">iam</span><span class="o">.</span><span class="n">ServicePrincipal</span><span class="p">(</span><span class="s">"ecs-tasks.amazonaws.com"</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># allow read and write access to S3 bucket
</span>        <span class="n">bucket</span><span class="o">.</span><span class="n">grant_read_write</span><span class="p">(</span><span class="n">job_role</span><span class="p">)</span>

        <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">ecr</span><span class="o">.</span><span class="n">Repository</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"repository"</span><span class="p">,</span>
            <span class="n">removal_policy</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">RemovalPolicy</span><span class="o">.</span><span class="n">DESTROY</span><span class="p">,</span>
        <span class="p">)</span>

        <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="n">job_def</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">JobDefinition</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"job-definition"</span><span class="p">,</span>
            <span class="n">container</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">JobDefinitionContainer</span><span class="p">(</span>
                <span class="n">image</span><span class="o">=</span><span class="n">ecs</span><span class="o">.</span><span class="n">ContainerImage</span><span class="o">.</span><span class="n">from_ecr_repository</span><span class="p">(</span><span class="n">repo</span><span class="p">),</span>
                <span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="s">"python3"</span><span class="p">,</span> <span class="s">"main.py"</span><span class="p">],</span>
                <span class="n">vcpus</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                <span class="n">gpu_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">memory_limit_mib</span><span class="o">=</span><span class="mi">12000</span><span class="p">,</span>
                <span class="n">job_role</span><span class="o">=</span><span class="n">job_role</span><span class="p">,</span>
                <span class="n">environment</span><span class="o">=</span><span class="p">{</span>
                    <span class="s">"BUCKET_NAME"</span><span class="p">:</span> <span class="n">bucket</span><span class="o">.</span><span class="n">bucket_name</span>
                <span class="p">}</span>
            <span class="p">),</span>
            <span class="n">job_definition_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stack_name</span> <span class="o">+</span> <span class="s">"job-definition"</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">Duration</span><span class="o">.</span><span class="n">hours</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
        <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>で，計算結果を保存するための S3 バケットを用意している</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>で， Compute environment を定義している．
ここでは <code>g4dn.xlarge</code> のインスタンスタイプを使用するとし，最大の vCPU 使用数は 64 と指定している．
また，最小の vCPU は 0 である．
今回は，負荷がかかっていないときにアイドリング状態にあるインスタンスを用意する利点は全くないので，ここは0にするのが望ましい．</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>で， &lt;2&gt; で作成した Compute environment と紐付いた Job queue を定義している．</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>で，ジョブが計算結果を S3 に書き込むことができるよう， IAM ロールを定義している．
(IAM とはリソースがもつ権限を管理する仕組みである．詳しくは <a href="#sec:bashoutter_iam">Section 13.2.5</a> を参照)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>では， Docker image を配置するための ECR を定義している．</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>で Job definition を作成している．
ここでは，4 vCPU， 12000 MB (=12GB) の RAM を使用するように指定している．
また，今後必要となる環境変数 (<code>BUCKET_NAME</code>) を設定している．
さらに， &lt;4&gt; で作った IAM を付与している．</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>g4dn.xlarge</code> は 1台あたり 4 vCPU が割り当てられている．
このプログラムでは Compute environment の maximum vCPUs を 64 と指定しているので，最大で 16 台のインスタンスが同時に起動することになる．
ここで maxium vCPUs を64に限定しているのは，なんらかのミスで意図せぬジョブを大量にクラスターに投入してしまった事態で，高額の AWS 利用料金が発生するのを防ぐためである．
もし，自分のアプリケーションで必要と判断したならば自己責任において64よりも大きな数を設定して構わない．</p>
</div>
<div class="paragraph">
<p>ここで注意が一点ある．
AWS では各アカウントごとに EC2 で起動できるインスタンスの上限が設定されている．
この上限は AWS コンソールにログインし， EC2コンソールの左側メニューバーの <code>Limits</code> をクリックすることで確認できる (<a href="#fig_ec2_limits">Figure 60</a>)．
<code>g4dn.xlarge</code> (EC2 の区分でいうと G ファミリーに属する) の制限を確認するには， <code>Running On-Demand All G instances</code> という名前の項目を見る．
ここにある数字が， AWS によって課されたアカウントの上限であり，この上限を超えたインスタンスを起動することはできない．
もし，自分の用途に対して上限が低すぎる場合は，上限の緩和申請を行うことができる．
詳しくは <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-resource-limits.html">公式ドキュメンテーション "Amazon EC2 service quotas"</a> を参照のこと．</p>
</div>
<div id="fig_ec2_limits" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/ec2_limits.png" alt="EC2 limits" width="700">
</div>
<div class="title">Figure 60. EC2コンソールから各種の上限を確認する</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_スタックのデプロイ_3">9.6. スタックのデプロイ</h3>
<div class="paragraph">
<p>スタックの中身が理解できたところで，早速スタックをデプロイしてみよう．</p>
</div>
<div class="paragraph">
<p>デプロイの手順は，これまでのハンズオンとほとんど共通である．
ここでは，コマンドのみ列挙する (# で始まる行はコメントである)．
シークレットキーの設定も忘れずに (<a href="#aws_cli_install">Section 15.3</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c"># プロジェクトのディレクトリに移動</span>
<span class="nv">$ </span><span class="nb">cd </span>handson/aws-batch

<span class="c"># venv を作成し，依存ライブラリのインストールを行う</span>
<span class="nv">$ </span>python3 <span class="nt">-m</span> venv .env
<span class="nv">$ </span><span class="nb">source</span> .env/bin/activate
<span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt

<span class="c"># デプロイを実行</span>
<span class="nv">$ </span>cdk deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>デプロイのコマンドが無事に実行されたことが確認できたら，AWS コンソールにログインして，デプロイされたスタックを確認してみよう．
コンソールの検索バーで <code>batch</code> と入力し， AWS Batch の管理画面を開く (<a href="#fig_batch_console">Figure 61</a>)．</p>
</div>
<div id="fig_batch_console" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/batch_console.png" alt="batch console" width="700">
</div>
<div class="title">Figure 61. AWS Batch のコンソール画面 (ダッシュボード)</div>
</div>
<div class="paragraph">
<p>まず目を向けてほしいのが，画面の一番下にある Compute environment overview の中の <code>SimpleBatchcompute-env</code> という名前の項目だ．
Compute environment とは，先ほど述べたとおり，計算が実行される環境 (クラスターと読み替えてもよい) である．
プログラムで指定したとおり， <code>g4dn.xlarge</code> が実際に使用されるインスタンスタイプとして表示されている．
また， <code>Minimum vCPUs</code> が0，<code>Maximum vCPUs</code> が 64 と設定されていることも見て取れる．
加えて，この時点では一つもジョブが走っていないので， <code>Desired vCPUs</code> は0になっている．
より詳細な Compute environment の情報を閲覧したい場合は，名前をクリックすることで詳細画面が開く．</p>
</div>
<div class="paragraph">
<p>次に，Job queue overview にある <code>SimpleBatch-queue</code> という項目に注目してほしい．
ここでは実行待ちのジョブ・実行中のジョブ・実行が完了したジョブを一覧で確認することができる．
<code>PENDING</code>, <code>RUNNING</code>, <code>SUCCEEDED</code>, <code>FAILED</code> などのカラムがあることが確認できる．ジョブが進行するにつれて，ジョブの状態がこのカラムにしたがって遷移していく．
後でジョブを実際にサブミットしたときに戻ってこよう．</p>
</div>
<div class="paragraph">
<p>最後に，今回作成した Job definition を確認しよう．
左側のメニューから　<code>Job definitions</code> を選択し，次の画面で <code>SimpleBatchjob-definition</code> という項目を見つけて開く．
ここから Job definition の詳細を閲覧することができる (<a href="#fig:batch_job_definition">Figure 62</a>)．
中でも重要な情報としては，　<code>vCPUs</code>, <code>Memory</code>, <code>GPU</code> がそれぞれ Docker に割り当てられる vCPU・メモリー・ GPU の量を規定している．
また， <code>Image</code> と書いてあるところに，ジョブで使用される Docker イメージが指定されている．
ここでは， ECR のレポジトリを参照している．
現時点ではこの ECR は空である．
次のステップとして，この ECR にイメージを配置する作業を行おう．</p>
</div>
<div id="fig:batch_job_definition" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/batch_job_definition.png" alt="batch_job_definition" width="700">
</div>
<div class="title">Figure 62. AWS Batch から Job definition を確認</div>
</div>
</div>
<div class="sect2">
<h3 id="sec:aws_batch_deploy_docker_on_ecr">9.7. Docker image を ECR に配置する</h3>
<div class="paragraph">
<p>さて， Batch がジョブを実行するには，どこか指定された場所から Docker イメージをダウンロード (pull) してくる必要がある．
前回のハンズオン (<a href="#sec_fargate_qabot">Section 8</a>) では，公開設定にしてある Docker Hub からイメージを pull してきた．
今回のハンズオンでは， AWS から提供されているレジストリである <strong>ECR (Elastic Container Registry)</strong> に image を配置するという設計を採用する．
ECR を利用する利点は，自分だけがアクセスすることのできるプライベートなイメージの置き場所を用意できる点である．
Batch は ECR からイメージを pull してくることで，タスクを実行する (<a href="#fig_batch_architecture">Figure 59</a>)．</p>
</div>
<div class="paragraph">
<p>スタックのソースコードでいうと，次の箇所が ECR を定義している．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><i class="conum" data-value="1"></i><b>(1)</b>
<span class="n">repo</span> <span class="o">=</span> <span class="n">ecr</span><span class="o">.</span><span class="n">Repository</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"repository"</span><span class="p">,</span>
    <span class="n">removal_policy</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">RemovalPolicy</span><span class="o">.</span><span class="n">DESTROY</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">job_def</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">JobDefinition</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"job-definition"</span><span class="p">,</span>
    <span class="n">container</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">JobDefinitionContainer</span><span class="p">(</span>
        <span class="n">image</span><span class="o">=</span><span class="n">ecs</span><span class="o">.</span><span class="n">ContainerImage</span><span class="o">.</span><span class="n">from_ecr_repository</span><span class="p">(</span><span class="n">repo</span><span class="p">),</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="o">...</span>
    <span class="p">),</span>
    <span class="o">...</span>
<span class="p">)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>で，新規の ECR を作成している．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>で Job definition を定義する中で，イメージを &lt;1&gt; で作った ECR から取得するように指定している．
これと同時に， Job definition には ECR へのアクセス権限が IAM を通じて自動的に付与される．</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>さて，スタックをデプロイした時点では， ECR は空っぽである．
ここに自分のアプリケーションで使う Docker イメージを push してあげる必要がある．</p>
</div>
<div class="paragraph">
<p>そのために，まずは AWS コンソールから ECR の画面を開こう (検索バーに <code>Elastic Container Registry</code> と入力すると出てくる)．
<code>Private</code> というタブを選択すると， <code>simplebatch-repositoryXXXXXX</code> という名前のレポジトリが見つかるだろう (<a href="#fig_ecr_console1">Figure 63</a>)．</p>
</div>
<div id="fig_ecr_console1" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/ecr_console1.png" alt="ecr console" width="700">
</div>
<div class="title">Figure 63. ECR のコンソール画面</div>
</div>
<div class="paragraph">
<p>次に，このレポジトリの名前をクリックするとレポジトリの詳細画面に遷移する．
そうしたら，画面右上にある <code>View push commands</code> というボタンをクリックする．
すると <a href="#fig_ecr_push_command">Figure 64</a> のようなポップアップ画面が立ち上がる．</p>
</div>
<div id="fig_ecr_push_command" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/ecr_push_command.png" alt="ecr push command" width="700">
</div>
<div class="title">Figure 64. ECR への push コマンド</div>
</div>
<div class="paragraph">
<p>このポップアップ画面で表示されている四つのコマンドを順番に実行していくことで，手元の Docker イメージを ECR に push することができる．
<strong>push を実行する前に， AWS の認証情報が設定されている</strong>ことを確認しよう．
そのうえで，ハンズオンのソースコードの中にある <strong><code>docker/</code> という名前のディレクトリに移動</strong>する．
そうしたら，ポップアップ画面で表示されたコマンドを上から順に実行していく．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ポップアップで表示されるコマンドの2つめを見てみると <code>docker build -t XXXXX .</code> となっている．
最後の <code>.</code> が重要で，これは <em>現在のディレクトリにある Dockerfile を使ってイメージをビルドせよ</em> という意味である．
このような理由で， <code>Dockerfile</code> が置いてあるディレクトリに移動する必要がある．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>四つ目のコマンドは，数GBあるイメージを ECR にアップロードするので少し時間がかかるかもしれないが，これが完了するとめでたくイメージが ECR に配置されたことになる．
もう一度 ECR のコンソールを見てみると，確かにイメージが配置されていることが確認できる (<a href="#fig_ecr_console2">Figure 65</a>)．
これで，AWS Batch を使ってジョブを実行させるための最後の準備が完了した．</p>
</div>
<div id="fig_ecr_console2" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/ecr_console2.png" alt="ecr console 2" width="700">
</div>
<div class="title">Figure 65. ECR へ image の配置が完了した</div>
</div>
</div>
<div class="sect2">
<h3 id="_単一のジョブを実行する">9.8. 単一のジョブを実行する</h3>
<div class="paragraph">
<p>さて，ここからは実際に AWS Batch にジョブを投入する方法を見ていこう．</p>
</div>
<div class="paragraph">
<p>ハンズオンのディレクトリの <code>notebook/</code> というディレクトリの中に，
<a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/aws-batch/notebook/run_single.ipynb">run_single.ipynb</a>
というファイルが見つかるはずである (<code>.ipynb</code> は Jupyter notebook のファイル形式)．
これを Jupyter notebook から開こう．</p>
</div>
<div class="paragraph">
<p>今回のハンズオンでは， <code>venv</code> による仮想環境の中に Jupyter notebook もインストール済みである．
なので，ローカルマシンから以下のコマンドで Jupyter notebook を立ち上げる．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c"># .env の仮想環境にいることを確認</span>
<span class="o">(</span>.env<span class="o">)</span> <span class="nv">$ </span><span class="nb">cd </span>notebook
<span class="o">(</span>.env<span class="o">)</span> <span class="nv">$ </span>jupyter notebook</code></pre>
</div>
</div>
<div class="paragraph">
<p>Jupyter notebook が起動したら， <code>run_single.ipynb</code> を開く．</p>
</div>
<div class="paragraph">
<p>最初の [1], [2], [3] 番のセルは，ジョブをサブミットするための関数 (<code>submit_job()</code>) を定義している．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="code"><pre><span class="c1"># [1]
</span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">argparse</span>

<span class="c1"># [2]
# AWS 認証ヘルパー ...省略...
</span>
<span class="c1"># [3]
</span><span class="k">def</span> <span class="nf">submit_job</span><span class="p">(</span><span class="n">lr</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">momentum</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">epochs</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="s">"default"</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">profile_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">profile_name</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">"batch"</span><span class="p">)</span>

    <span class="n">title</span> <span class="o">=</span> <span class="s">"lr"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"."</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span> <span class="o">+</span> <span class="s">"_m"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">momentum</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"."</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span>
        <span class="n">jobName</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
        <span class="n">jobQueue</span><span class="o">=</span><span class="s">"SimpleBatchjob-queue"</span><span class="p">,</span>
        <span class="n">jobDefinition</span><span class="o">=</span><span class="s">"SimpleBatchjob-definition"</span><span class="p">,</span>
        <span class="n">containerOverrides</span><span class="o">=</span><span class="p">{</span>
            <span class="s">"command"</span><span class="p">:</span> <span class="p">[</span><span class="s">"--lr"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lr</span><span class="p">),</span>
                        <span class="s">"--momentum"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">momentum</span><span class="p">),</span>
                        <span class="s">"--epochs"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">epochs</span><span class="p">),</span>
                        <span class="s">"--uploadS3"</span><span class="p">,</span> <span class="s">"true"</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Job submitted!"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"job name"</span><span class="p">,</span> <span class="n">resp</span><span class="p">[</span><span class="s">"jobName"</span><span class="p">],</span> <span class="s">"job ID"</span><span class="p">,</span> <span class="n">resp</span><span class="p">[</span><span class="s">"jobId"</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>submit_job()</code> 関数について簡単に説明しよう．
<a href="#sec_run_mnist_docker_local">Section 9.4</a> で， MNIST の Docker をローカルで実行したとき，次のようなコマンドを使用した．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>docker run <span class="nt">-it</span> mymnist <span class="nt">--lr</span> 0.1 <span class="nt">--momentum</span> 0.5 <span class="nt">--epochs</span> 10</code></pre>
</div>
</div>
<div class="paragraph">
<p>ここで， <code>--lr 0.1 --momentum 0.5 --epochs 10</code> の部分が，コンテナに渡されるコマンドである．</p>
</div>
<div class="paragraph">
<p>AWS Batch でジョブを実行する際も，<code>ContainerOverrides</code> の <code>command</code> というパラメータを使用することで，コンテナに渡されるコマンドを指定することができる．
コードでは以下の部分が該当する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="n">containerOverrides</span><span class="o">=</span><span class="p">{</span>
    <span class="s">"command"</span><span class="p">:</span> <span class="p">[</span><span class="s">"--lr"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lr</span><span class="p">),</span>
                <span class="s">"--momentum"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">momentum</span><span class="p">),</span>
                <span class="s">"--epochs"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">epochs</span><span class="p">),</span>
                <span class="s">"--uploadS3"</span><span class="p">,</span> <span class="s">"true"</span><span class="p">]</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>続いて， [4] 番のセルに移ろう．
ここでは，上記の <code>submit_job()</code> 関数を用いて， 学習率 = 0.01, モメンタム=0.1, エポック数=100 を指定したジョブを投入する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="c1"># [4]
</span><span class="n">submit_job</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>AWS の認証情報は， Jupyter Notebook の内部から再度定義する必要がある．
これを手助けするため， Notebook の [2] 番のセル (デフォルトではすべてコメントアウトされている) を用意した．
これを使うにはコメントアウトを解除すればよい．
このセルを実行すると， AWS の認証情報を入力する対話的なプロンプトが表示される．
プロンプトに従って aws secret key などを入力することで， (Jupyter のセッションに固有な) 環境変数に AWS の認証情報が記録される．</p>
</div>
<div class="paragraph">
<p>もう一つの認証方法として， <code>submit_job()</code> 関数に <code>profile_name</code> というパラメータを用意した．
もし <code>~/.aws/credentials</code> に認証情報が書き込まれているのならば (詳しくは <a href="#aws_cli_install">Section 15.3</a>)， <code>profile_name</code> に使用したいプロファイルの名前を渡すだけで，
認証を行うことができる．
慣れている読者は後者のほうが便利であると感じるだろう．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>[4] 番のセルを実行したら，ジョブが実際に投入されたかどうかを AWS コンソールから確認してみよう．
AWS Batch の管理コンソールを開くと， <a href="#fig_batch_running_job">Figure 66</a> のような画面が表示されるだろう．</p>
</div>
<div id="fig_batch_running_job" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/batch_running_job.png" alt="batch running job" width="700">
</div>
<div class="title">Figure 66. AWS Batch でジョブが実行されている様子</div>
</div>
<div class="paragraph">
<p><a href="#fig_batch_running_job">Figure 66</a> で赤で囲った箇所に注目してほしい．
一つのジョブが投入されると，それは <code>SUBMITTED</code> という状態を経て <code>RUNNABLE</code> という状態に遷移する．
<code>RUNNABLE</code> とは， ジョブを実行するためのインスタンスが Compute environment に不足しているため，新たなインスタンスが起動されるのを待っている状態に相当する．
インスタンスの準備が整うと，ジョブの状態は <code>STARTING</code> を経て <code>RUNNING</code> に至る．</p>
</div>
<div class="paragraph">
<p>次に，ジョブのステータスが <code>RUNNING</code> のときの Compute environment の <code>Desired vCPU</code> を見てみよう (<a href="#fig_batch_running_job">Figure 66</a> で紫で囲った箇所)．
ここで 4 と表示されているのは， <code>g4dn.xlarge</code> インスタンス一つ分の vCPU の数である．
ジョブの投入に応じて，それを実行するのに最低限必要な EC2 インスタンスが起動されたことが確認できる
(興味のある人は， EC2 コンソールも同時に覗いてみるとよい)．</p>
</div>
<div class="paragraph">
<p>しばらく経つと，ジョブの状態は <code>RUNNING</code> から <code>SUCCEEDED</code> (あるいは何らかの理由でエラーが発生したときには <code>FAILED</code>) に遷移する．
今回のハンズオンで使っている MNIST の学習はだいたい 10 分くらいで完了するはずである．
ジョブの状態が <code>SUCCEEDED</code> になるまで見届けよう．</p>
</div>
<div class="paragraph">
<p>ジョブが完了すると，学習の結果 (エポックごとの Loss と Accuracy を記録した CSV ファイル) は S3 に保存される．
AWS コンソールからこれを確認しよう．</p>
</div>
<div class="paragraph">
<p>S3 のコンソールに行くと <code>simplebatch-bucketXXXX</code> (XXXX の部分はユーザーによって異なる) という名前のバケットが見つかるはずである．
これをクリックして中身を見てみると， <code>metrics_lr0.0100_m0.1000.csv</code> という名前の CSV があることが確認できるだろう (<a href="#fig_s3_saved_file">Figure 67</a>)．
これが， 学習率 = 0.01, モメンタム = 0.1 として学習を行ったときの結果である．</p>
</div>
<div id="fig_s3_saved_file" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/s3_saved_file.png" alt="s3 saved file" width="700">
</div>
<div class="title">Figure 67. ジョブの実行結果は S3 に保存される</div>
</div>
<div class="paragraph">
<p>さて，ここで <code>run_single.ipynb</code> に戻ってこよう．
[5] から [7] 番のセルでは，学習結果の CSV ファイルのダウンロードを行っている．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="code"><pre><span class="c1"># [5]
</span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># [6]
</span><span class="k">def</span> <span class="nf">read_table_from_s3</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">profile_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">profile_name</span><span class="p">)</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">"s3"</span><span class="p">)</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Body"</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>

<span class="c1"># [7]
</span><span class="n">bucket_name</span> <span class="o">=</span> <span class="s">"simplebatch-bucket43879c71-mbqaltx441fu"</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">read_table_from_s3</span><span class="p">(</span>
    <span class="n">bucket_name</span><span class="p">,</span>
    <span class="s">"metrics_lr0.0100_m0.1000.csv"</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>[6] で S3 から CSV データをダウンロードし， pandas の <code>DataFrame</code> オブジェクトとしてロードする関数を定義している．
[7] を実行する際， <code>bucket_name</code> という変数の値を，<strong>自分自身のバケットの名前に置き換える</strong>ことに注意しよう
(先ほど S3 コンソールから確認した <code>simplebatch-bucketXXXX</code> のことである)．</p>
</div>
<div class="paragraph">
<p>続いて， [9] 番のセルで， CSV のデータをプロットしている (<a href="#fig_loss_epoch_profile2">Figure 68</a>)．
ローカルで実行したときと同じように， AWS Batch を用いて MNIST モデルを訓練することに成功した！</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="c1"># [9]
</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s">"train_loss"</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">"Train"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s">"val_loss"</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">"Val"</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s">"val_accuracy"</span><span class="p">])</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">"Epochs"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">"Loss"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">"Epochs"</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">"Accuracy"</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Best loss:"</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s">"val_loss"</span><span class="p">]</span><span class="o">.</span><span class="nb">min</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Best loss epoch:"</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s">"val_loss"</span><span class="p">]</span><span class="o">.</span><span class="n">argmin</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Best accuracy:"</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s">"val_accuracy"</span><span class="p">]</span><span class="o">.</span><span class="nb">max</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Best accuracy epoch:"</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s">"val_accuracy"</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">())</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div id="fig_loss_epoch_profile2" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/loss_epoch_profile2.png" alt="loss_epoch_profile2" width="600">
</div>
<div class="title">Figure 68. AWS Batch で行った MNIST モデルの学習の結果</div>
</div>
</div>
<div class="sect2">
<h3 id="sec:batch_parallel_jobs">9.9. 並列に複数の Job を実行する</h3>
<div class="paragraph">
<p>さて，ここからが最後の仕上げである．
ここまでのハンズオンで構築した AWS Batch のシステムを使って，ハイパーパラメータサーチを実際に行おう．</p>
</div>
<div class="paragraph">
<p>先ほど実行した <code>run_single.ipynb</code> と同じディレクトリにある <code>run_sweep.ipynb</code> を開く．</p>
</div>
<div class="paragraph">
<p>セル [1], [2], [3] は <code>run_single.ipynb</code> と同一である．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
</pre></td><td class="code"><pre><span class="c1"># [1]
</span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">argparse</span>

<span class="c1"># [2]
# AWS 認証ヘルパー ...省略...
</span>
<span class="c1"># [3]
</span><span class="k">def</span> <span class="nf">submit_job</span><span class="p">(</span><span class="n">lr</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">momentum</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">epochs</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c1"># ...省略...</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>セル [4] の for ループを使って，グリッド状にハイパーパラメータの組み合わせを用意し， batch にジョブを投入している．
ここでは 3x3=9個のジョブを作成した．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="c1"># [4]
</span><span class="k">for</span> <span class="n">lr</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]:</span>
        <span class="n">submit_job</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>セル [4] を実行したら， Batch のコンソールを開こう．
先ほどと同様に，ジョブのステータスは <code>SUBMITTED</code> &gt; <code>RUNNABLE</code> &gt; <code>STARTING</code> &gt; <code>RUNNING</code> と移り変わっていくことがわかるだろう．
最終的に 9 個のジョブがすべて <code>RUNNING</code> の状態になることを確認しよう (<a href="#fig_batch_many_parallel_jobs">Figure 69</a>)．
また，このとき Compute environment の <code>Desired vCPUs</code> は 4x9=36 となっていることを確認しよう (<a href="#fig_batch_many_parallel_jobs">Figure 69</a>)．</p>
</div>
<div id="fig_batch_many_parallel_jobs" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/batch_many_parallel_jobs.png" alt="batch many parallel jobs" width="700">
</div>
<div class="title">Figure 69. 複数のジョブを同時投入したときの Batch コンソール</div>
</div>
<div class="paragraph">
<p>次に，Batch のコンソールの左側のメニューから <code>Jobs</code> をクリックしてみよう．
ここでは，実行中のジョブの一覧が確認することができる (<a href="#fig_batch_parallel_job_list">Figure 70</a>)．
ジョブのステータスでフィルタリングをすることも可能である．
9個のジョブがどれも <code>RUNNING</code> 状態にあることが確認できるだろう．</p>
</div>
<div id="fig_batch_parallel_job_list" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/batch_parallel_job_list.png" alt="batch many parallel jobs" width="700">
</div>
<div class="title">Figure 70. 複数のジョブを同時投入したときの Job 一覧</div>
</div>
<div class="paragraph">
<p>今度は EC2 コンソールを見てみよう．
左のメニューから <code>Instances</code> を選択すると， <a href="#fig_ec2_instances_list">Figure 71</a> に示すような起動中のインスタンスの一覧が表示される．
<code>g4dn.xlarge</code> が 9 台稼働しているのが確認できる．
Batch がジョブの投下に合わせて必要な数のインスタンスを起動してくれたのだ！</p>
</div>
<div id="fig_ec2_instances_list" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/ec2_instances_list.png" alt="ec2 instances list" width="700">
</div>
<div class="title">Figure 71. 複数のジョブを同時投入したときの EC2 インスタンスの一覧</div>
</div>
<div class="paragraph">
<p>ここまで確認できたら，それぞれの Job が終了するまでしばらく待とう (だいたい 10-15 分くらいで終わる)．
すべてのジョブが終了すると，ダッシュボードの <code>SUCCEEDED</code> が 9 となっているはずだ．
また， Compute environment の <code>Desired vCPUs</code> も 0 に落ちていることを確認しよう．
最後に EC2 コンソールに行って，すべての g4dn インスタンスが停止していることを確認しよう．</p>
</div>
<div class="paragraph">
<p>以上から， AWS Batch を使うことで，<strong>ジョブの投入に応じて自動的に EC2 インスタンスが起動され，ジョブの完了とともに，ただちにインスタンスの停止が行われる</strong>一連の挙動を観察することができた．
一つのジョブの完了におよそ10分の時間がかかるので，9個のハイパーパラメータの組を逐次的に計算していた場合は90分の時間を要することになる．
AWS Batch を使ってこれらの計算を並列に実行することで，ジョブ一個分の計算時間 (=10分) ですべての計算を終えることができた！</p>
</div>
<div class="paragraph">
<p>さて，再び <code>run_sweep.ipynb</code> に戻ってこよう．
[5] 以降のセルでは，グリッドサーチの結果を可視化している．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="code"><pre><span class="c1"># [5]
</span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># [6]
</span><span class="k">def</span> <span class="nf">read_table_from_s3</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">profile_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">profile_name</span><span class="p">)</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">"s3"</span><span class="p">)</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Body"</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>

<span class="c1"># [7]
</span><span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lr</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">]):</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">f</span><span class="s">"metrics_lr{lr:0.4f}_m{m:0.4f}.csv"</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">read_table_from_s3</span><span class="p">(</span><span class="s">"simplebatch-bucket43879c71-mbqaltx441fu"</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"val_accuracy"</span><span class="p">]</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span>

<span class="c1"># [8]
</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s">'equal'</span><span class="p">)</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolor</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s">'w'</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">f</span><span class="s">"{grid[i, j]:0.1f}"</span><span class="p">,</span>
                       <span class="n">ha</span><span class="o">=</span><span class="s">"center"</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s">"center"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"w"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>最終的に出力されるプロットが <a href="#fig_grid_search_result">Figure 72</a> である．</p>
</div>
<div id="fig_grid_search_result" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/grid_search_result.png" alt="grid_search_result" width="400">
</div>
<div class="title">Figure 72. ハイパーパラメータのグリッドサーチの結果</div>
</div>
<div class="paragraph">
<p>このプロットから，差は僅かであるが，学習率が 0.1 のときに精度は最大となることがわかる．
また，学習率 0.1 のときはモメンタムを変えても大きな差は生じないことが見て取れる．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>今回のパラメータサーチは勉強用に極めて単純化されたものである点は承知いただきたい．</p>
</div>
<div class="paragraph">
<p>たとえば，今回は学習率が 0.1 が最も良いとされたが，それは訓練のエポックを 100 に限定しているからかもしれない．
学習率が低いとその分訓練に必要なエポック数も多くなる．
訓練のエポック数をもっと増やせばまた違った結果が観察される可能性はある．</p>
</div>
<div class="paragraph">
<p>また，今回は MNIST の訓練データ 60,000 枚のうち， 48,000 枚を訓練データ，残り 12,000 枚を検証データとして用いた．
この分割は乱数を固定してランダムに行ったが，もしこの分割によるデータのバイアスを気にするならば， k 個の異なる学習・検証データの分割をあらかじめ用意して，複数回モデルの評価を行う (<strong>k-fold cross-validation</strong>) 方法も，より精緻なアプローチとして考えられる．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>以上のようにして， CNN を用いた MNIST 分類モデルのハイパーパラメータの最適化の一連の流れを体験した．
AWS Batch を利用することで，比較的少ないプログラミングで，動的に EC2 クラスターを制御し，並列にジョブを処理するシステムが構築できた．
ここまで EC2 を使いこなすことができれば，多くの問題を自力で解くことが可能になるだろう！</p>
</div>
</div>
<div class="sect2">
<h3 id="sec:batch_destroy_app">9.10. スタックの削除</h3>
<div class="paragraph">
<p>これにて，本ハンズオンは終了である．最後にスタックを削除しよう．
今回のスタックを削除するにあたり，ECR に配置された Docker のイメージは手動で削除されなければならない
(これをしないと， <code>cdk destroy</code> を実行したときにエラーになってしまう．
これは CloudFormation の仕様なので従うしかない)．</p>
</div>
<div class="paragraph">
<p>ECR の Docker image を削除するには， ECR のコンソールに行き，イメージが配置されたレポジトリを開く．
そして，画面右上の <code>DELETE</code> ボタンを押して削除する (<a href="#fig_delete_ecr">Figure 73</a>)．</p>
</div>
<div id="fig_delete_ecr" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/delete_ecr.png" alt="delete_ecr" width="700">
</div>
<div class="title">Figure 73. ECR から Docker image を削除する</div>
</div>
<div class="paragraph">
<p>あるいは， AWS CLI から同様の操作を行うには，以下のコマンドを用いる (<code>XXXX</code> は自分の ECR レポジトリ名に置き換える)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws ecr batch-delete-image <span class="nt">--repository-name</span> XXXX <span class="nt">--image-ids</span> <span class="nv">imageTag</span><span class="o">=</span>latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>image の削除が完了したうえで，次のコマンドでスタックを削除する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>cdk destroy</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#sec:batch_development_and_debug">[sec:batch_development_and_debug]</a>
=== クラウドを用いた機械学習アプリケーションの開発とデバッグ</p>
</div>
<div class="paragraph">
<p>本章で紹介したハンズオンでは， AWS Batch を使用することでニューラルネットの学習を複数並列に実行し，高速化を実現した．
本章の最後の話題として，クラウドを用いた機械学習アプリケーションの開発とデバッグの方法について述べよう．</p>
</div>
<div class="paragraph">
<p>ローカルに GPU を搭載した強力なマシンがなく，クラウドを利用する予算が確保されているのであれば， <a href="#fig:cloud_development">Figure 74</a> のような開発のスキームが理想的であると考える．
最初の段階では， <a href="#sec_jupyter_and_deep_learning">Section 6</a> で見たような方法で， GPU 搭載型の EC2 インスタンスを作成し， Jupyter Notebook などのインタラクティブな環境で様々なモデルを試し実験を行う．
Jupyter である程度アプリケーションが完成してきたタイミングで，作成したアプリケーションを Docker イメージにパッケージングする．
そして， EC2 上で <code>docker run</code> を行い，作成したイメージがバグなく動作するか確認を行う．
その次に，ハイパーパラメータの最適化などのチューニングを， <a href="#sec_aws_batch">Section 9</a> のハンズオンで学んだ AWS Batch などの計算システムを利用して行う．
よい深層学習モデルが完成したら，仕上げに大規模データへの推論処理を行うシステムを <a href="#sec_fargate_qabot">Section 8</a> を参考に構築する．</p>
</div>
<div class="paragraph">
<p>実際，本書ではこの流れに沿って演習を進めてきた．
MNIST タスクを解くモデルを，最初 Jupyter Notebook を使用して実験し，そのコードをほとんどそのまま Docker にパッケージし， AWS Batch を用いてハイパーパラメータサーチを行った．
このサイクルを繰り返すことで，クラウドを最大限に活用した機械学習アプリケーションの開発を進めることができる．</p>
</div>
<div id="fig:cloud_development" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/cloud_development.png" alt="cloud_development" width="700">
</div>
<div class="title">Figure 74. クラウドを活用した機械学習アプリケーションの開発フロー</div>
</div>
</div>
<div class="sect2">
<h3 id="_小括_2">9.11. 小括</h3>
<div class="paragraph">
<p>ここまでが，本書第二部の内容である．
第一部に引き続き盛りだくさんの内容であったが，ついてこれたであろうか？</p>
</div>
<div class="paragraph">
<p>第二部ではまず最初に，深層学習の計算をクラウドで実行するため， GPU 搭載型の EC2 インスタンスの起動について解説した．
さらに，ハンズオンでは，クラウドに起動した仮想サーバーを使って MNIST 文字認識タスクを解くニューラルネットを訓練した (<a href="#sec_jupyter_and_deep_learning">Section 6</a>)．</p>
</div>
<div class="paragraph">
<p>また，より大規模な機械学習アプリケーションを作るための手段として， Docker と ECS によるクラスターの初歩を説明した (<a href="#sec_docker_introduction">Section 7</a>)．
その応用として，英語で与えられた文章問題への回答を自動で生成するボットをクラウドに展開した (<a href="#sec_fargate_qabot">Section 8</a>)．
タスクの投入に応じて動的に計算リソースが作成・削除される様子を実際に体験できただろう．</p>
</div>
<div class="paragraph">
<p>さらに， <a href="#sec_aws_batch">Section 9</a> では AWS Batch を用いてニューラルネットの学習を並列に実行する方法を紹介した．
ここで紹介した方法は，ミニマムであるが，計算機システムを大規模化していくためのエッセンスが網羅されている．
これらのハンズオン体験から，クラウド技術を応用してどのように現実世界の問題を解いていくのか，なんとなくイメージが伝わっただろうか？</p>
</div>
<div class="paragraph">
<p>本書の第三部では，さらにレベルアップし，サーバーレスアーキテクチャという最新のクラウドの設計手法について解説する．
その応用として，ハンズオンでは簡単な SNS サービスをゼロから実装する．
引き続きクラウドの最先端の世界を楽しんでいこう！</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_web_サービスの作り方">10. Web サービスの作り方</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ここからが，本書第三部の内容になる．
これまでのセクションでは，仮想サーバーをクラウド上に起動し，そこで計算を走らせる方法について解説をしてきた．
EC2, ECS, Fargate, Batch などを利用して，動的にスケールするクラスターを構成し，並列にタスクを実行するクラウドシステムを実装してきた．
振り返ると，これまで紹介してきた内容は，<strong>自分自身が行いたい計算をクラウドを駆使することで実現する</strong>，という用途にフォーカスしていたことに気がつくだろう．
一方で，<strong>広く一般の人々に使ってもらえるような計算サービス・データベース</strong>を提供する，というのもクラウドの重要な役割として挙げられる．</p>
</div>
<div class="paragraph">
<p>本章から始まる第三部では，前回までとは少し方向性を変え，どのようにしてクラウド上にアプリケーションを展開し，広く一般の人に使ってもらうか，という点を講義したいと思う．
これを通じて，どのようにして世の中のウェブサービスができ上がっているのかを知り，さらにどうやって自分でそのようなアプリケーションをゼロから構築するのか，という点を学んでもらう．
その過程で，サーバーレスアーキテクチャという最新のクラウド設計手法を解説する．</p>
</div>
<div class="paragraph">
<p>その前準備として，本章ではどのようにしてウェブサービスが出来上がっているのか，その背後にある技術の概要を解説する．
用語の解説が中心となるが，後のハンズオンを実装するために必須の知識であるので，理解して前に進むよう心がけよう．</p>
</div>
<div class="sect2">
<h3 id="_ウェブサービスの仕組みtwitter_を例に">10.1. ウェブサービスの仕組み&#8201;&#8212;&#8201;Twitter を例に</h3>
<div class="paragraph">
<p>あなたがパソコンやスマートフォンから Twitter, Facebook, YouTube などのウェブサービスにアクセスしたとき，実際にどのようなことが行われ，コンテンツが提示されているのだろうか？</p>
</div>
<div class="paragraph">
<p>HTTP を通じたサーバーとクライアントのデータのやり取りは，すでに知っている読者も多いだろうし，逆にすべて解説しようとすると紙面が足りないので，ここではエッセンスの説明のみにとどめる．
以降では <a href="https://twitter.com">Twitter</a> を具体例として，背後にあるサーバーとクライアントの間の通信を概説しよう．
概念図としては <a href="#fig:web_server">Figure 75</a> のような通信がクライアントとサーバーの間で行われていることになる．</p>
</div>
<div id="fig:web_server" class="imageblock text-center">
<div class="content">
<img src="imgs/web_server.png" alt="web_server" width="700">
</div>
<div class="title">Figure 75. クライアントと Web サーバーの通信の概念図</div>
</div>
<div class="paragraph">
<p>前提として，クライアントとサーバーの通信は <strong>HTTP (Hypertext Transfer Protocol)</strong> を使って行われる．
また，最近では，暗号化された HTTP である <strong>HTTPS (HTTPS (Hypertext Transfer Protocol Secure))</strong> を用いることがスタンダードになってきている．
第一のステップとして，クライアントは HTTP(S) 通信によってサーバーから静的なコンテンツを取得する．
静的なコンテンツとは， <strong>HTML (Hyptertext Markup Language)</strong> で記述されたウェブページの文書本体， <strong>CSS (Cascading Style Sheets)</strong> で記述されたページのデザインやレイアウトファイル，そして <strong>JavaScript (JS)</strong> で記述されたページの動的な挙動を定義したプログラム，が含まれる．
Twitter を含む現代的なウェブアプリケーションの設計では，この静的なファイル群はページの”枠”を定義するだけで，中身となるコンテンツ (例: ツイートの一覧) は別途 <strong>API (Application Programming Interface)</strong> によって取得されなければならない．
そこで，クライアントは先のステップで取得された JavaScript で定義されたプログラムに従って，サーバーに API を送信し，ツイートや画像データを取得する．
この際，テキストデータのやり取りには <strong>JSON (JavaScript Object Notation)</strong> というフォーマットが用いられることが多い．
画像や動画などのコンテンツも同様にAPIにより取得される．
このようにして取得されたテキストや画像が，HTMLの文書に埋め込まれることで，最終的にユーザーに提示されるページが完成するのである．
また，新しいツイートを投稿するときにも，クライアントから API を通じてサーバーのデータベースにデータが書き込まれる．</p>
</div>
</div>
<div class="sect2">
<h3 id="sec_rest_api">10.2. REST API</h3>
<div class="paragraph">
<p>API (Application Programming Interface) とはこれまで何度も出てきた言葉であるが，ここではよりフォーマルな定義付けを行う．
API とはあるソフトウェア・アプリケーションが，外部のソフトウェアに対してコマンドやデータをやり取りするための媒介の一般的総称である．
とくに，ウェブサービスの文脈では，サーバーが外界に対して提示しているコマンドの一覧のことを意味する．
クライアントは，提示されている API から適切なコマンドを使うことによって，所望のデータを取得したり，あるいはサーバーにデータを送信したりする．</p>
</div>
<div class="paragraph">
<p>とくに，ウェブの文脈では <strong>REST (Representational State Transfer)</strong> とよばれる設計思想に基づいた API が現在では最も一般的に使われている．
REST の設計指針に従った API のことを <strong>REST API</strong> あるいは <strong>RESTful API</strong> とよんだりする．</p>
</div>
<div class="paragraph">
<p>REST API は， <a href="#rest_api">Figure 76</a> に示したような <strong>Method</strong> と <strong>URI (Universal Resource Identifier)</strong> の組からなる．</p>
</div>
<div id="rest_api" class="imageblock text-center">
<div class="content">
<img src="imgs/rest_api.png" alt="rest_api" width="700">
</div>
<div class="title">Figure 76. REST API</div>
</div>
<div class="paragraph">
<p>Method (メソッド) とは，どのような操作を行いたいかを抽象的に表す，<strong>"動詞"</strong> として捉えることができる．
メソッドには HTTP 規格で定義された9個の動詞 (verb) を使用することができる．
この中でも， <code>GET</code>, <code>POST</code>, <code>PUT</code>, <code>PATCH</code>, <code>DELETE</code> の5個が最も頻繁に使用される (<a href="#tab:rest_api_methods">Table 6</a>)．
この5つのメソッドによる操作を総称して <strong>CRUD</strong> (create, read, update, and delete) とよぶ．</p>
</div>
<table id="tab:rest_api_methods" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. REST API Methods</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">メソッド</th>
<th class="tableblock halign-left valign-top">意図される動作</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">要素を取得する</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">POST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">新しい要素を作成する</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">既存の要素を新しい要素と置き換える</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PATCH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">既存の要素の一部を更新する</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DELETE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">要素を削除する</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>一方， URI は操作が行われる対象，すなわち <strong>"目的語"</strong> を表す．
ウェブの文脈では操作が行われる対象のことをしばしば <strong>リソース</strong> とよぶ．
URI は多くの場合 http または https から始まるウェブサーバーのアドレスから始まり， / (スラッシュ) 以降に所望のリソースのパスが指定される．
<a href="#rest_api">Figure 76</a> の例で言えば， <code><a href="https://api.twitter.com" class="bare">https://api.twitter.com</a></code> というアドレスの <code>/1.1/status/home_timeline</code> というリソースを取得 (GET) せよ，という意味になる
(なお，ここで <code>1.1</code> という数字は API のバージョンを示している)．
この API リクエストによって，ユーザーのホームのタイムラインのツイートの一覧が取得される．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>REST API のメソッドには， <a href="#tab:rest_api_methods">Table 6</a> で挙げたもの以外に， HTTP プロトコルで定義されているほかのメソッド (OPTIONS, TRACE など) を用いることもできるが，あまり一般的ではない．</p>
</div>
<div class="paragraph">
<p>また，これらのメソッドだけでは動詞として表現しきれないこともあるが， URI の名前でより意味を明確にすることもある．
メソッドの使い方も，要素を削除する際は必ず <code>DELETE</code> を使わなければならない，という決まりもなく，たとえば， Twitter API でツイートを消す API は <code>POST statuses/destroy/:id</code> で定義されている．
最終的には，各ウェブサービスが公開している API ドキュメンテーションを読んで，それぞれの API がどんな操作をするのかを調べる必要がある．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>REST の概念は2000年代初頭に確立され，今日の API 設計のスタンダードとなった．
一方で，ウェブのテクノロジーが進歩するにつれて，新たな API の設計アプローチの需要も高まっている．
近年とくに人気を集めているのが，
<a href="https://graphql.org/">GraphQL</a>
と呼ばれる API の設計方法である．
GraphQL は Facebook 社によって最初に作られ，現在は GraghQL Foundation によって維持と更新がされている．
GraphQL を使用すると，クライアントは REST と比較してより柔軟性の高いデータのクエリを行うことができるなど，いくつかの利点がある．
キーワードだけでも知っておくと，今後役に立つだろう．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_twitter_api">10.3. Twitter API</h3>
<div class="paragraph">
<p>もう少し具体的にウェブサービスのAPIを体験する目的で，ここでは Twitter のAPIを見てみよう．
Twitter が提供している API の一覧は
<a href="https://developer.twitter.com/en/docs/api-reference-index">Twitter の Developer Documentation</a>
で見ることができる．
いくつかの代表的な API を <a href="#tab_twitter_api">Table 7</a> にまとめた．</p>
</div>
<table id="tab_twitter_api" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Twitter API</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">エンドポイント</th>
<th class="tableblock halign-left valign-top">動作</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET statuses/home_timeline</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ホームのタイムラインのツイートの一覧を取得する．</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET statuses/show/:id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:id</code> で指定されたツイートの詳細情報を取得する．</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET search</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ツイートの検索を実行する．</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST statuses/update</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">新しいツイートを投稿する．</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST media/upload</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">画像をアップロードする</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST statuses/destroy/:id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:id</code> で指定されたツイートを削除する．</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST statuses/retweet/:id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:id</code> で指定されたツイートをリツイートする．</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST statuses/unretweet/:id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:id</code> で指定されたツイートのリツイートを取り消す．</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST favorites/create</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">選択したツイートを"いいね"する．</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST favorites/destroy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">選択したツイートを"いいね"を取り消す．</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>この API リストをもとに， Twitter のアプリまたはウェブサイトを開いたときに起こるクライアントとサーバーの通信をシミュレートしてみよう．</p>
</div>
<div class="paragraph">
<p>ユーザーが Twitter を開くと，まず最初に  <code>GET statuses/home_timeline</code> の API リクエストによって，ユーザーのホームのタイムラインのツイートのリストが取得される．
個々のツイートは JSON 形式のデータになっており， <code>id</code>, <code>text</code>, <code>user</code>, <code>coordinates</code>, <code>entities</code> などの属性を含む．
<code>id</code> はツイートに固有な ID を表し， <code>text</code> はツイートの本文を含んでいる．
<code>user</code> はツイートを投稿したユーザーの名前やプロフィール画像の URL などを含んだ JSON データになっている．
<code>coordinates</code> にはツイートが発信された地理的な座標が記録されている．
また， <code>entities</code> にはツイートに関連するメディアファイル (画像など) のリンクなどの情報が埋め込まれている．
<code>GET statuses/home_timeline</code> からは直近のツイートのリスト (リストが長すぎる場合は途中で切られたもの) が取得される．
もしツイートの ID を知っている場合は <code>GET statuses/show/:id</code> を呼ぶことによって， <code>:id</code> パラメータで指定された特定のツイートを取得することができる．</p>
</div>
<div class="paragraph">
<p>ツイートの検索を行うためには <code>GET search</code> API を使用する．
この API には，ツイートに含まれる単語や，ハッシュタグ，ツイートの発信された日時や場所など，様々なクエリの条件を渡すことができる．
API からは， <code>GET statuses/home_timeline</code> などと同様， JSON 形式のツイートのデータが返される．</p>
</div>
<div class="paragraph">
<p>ユーザーが新しいツイートを投稿するには <code>POST statuses/update</code> のエンドポイントを利用する．
<code>POST statuses/update</code> には，ツイートの文章や，リプライの場合はリプライ先のツイートの ID などのデータを送信する．
また，ツイートに画像データを添付したい場合は， <code>POST media/upload</code> を併せて使用する．
ツイートの削除を行うには， <code>POST statuses/destroy/:id</code> を用いる．</p>
</div>
<div class="paragraph">
<p>そのほか，頻繁に行われる操作としては， <code>POST statuses/retweet/:id</code> と <code>POST statuses/unretweet/:id</code> がある．
これらは， <code>:id</code> で指定されるツイートに対して，それぞれリツイートを実行あるいは取り消すための API である．
また， <code>POST favorites/create</code>，<code>POST favorites/destroy</code> を使用することによって，選択されたツイートに"いいね"を追加したり，取り消したりする操作を行う．</p>
</div>
<div class="paragraph">
<p>このような一連の操作が， Twitter のアプリの背後では行われている．
また，自分自身でボットを作成したい場合は，これらの API を適切に組み合わせ，カスタムのプログラムを書くことで実現される．</p>
</div>
<div class="paragraph">
<p>このように， API はあらゆるウェブサービスを作るうえで一番基礎となる要素である．
次からの章では本章で紹介した用語が何度も出てくるので，頭の片隅に置いたうえで読み進めていただきたい．</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec_serverless">11. Serverless architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>サーバーレスアーキテクチャ (Serverless architecture) あるいは サーバーレスコンピューティング (Serverless computing) とは，従来とは全く異なるアプローチに基づくクラウドシステムの設計方法である．
歴史的には， AWS が2014年に発表した <a href="https://aws.amazon.com/lambda/">Lamba</a> がサーバーレスアーキテクチャの先駆けとされている．
その後， Google や Microsoft などのクラウドプラットフォームも同様の機能の提供を開始している．
サーバーレスアーキテクチャの利点は，スケーラブルなクラウドシステムを安価かつ簡易に作成できる点であり，近年いたるところで導入が進んでいる．</p>
</div>
<div class="paragraph">
<p>Serverless とは，文字どおりの意味としてはサーバーなしで計算をするということになるが，それは一体どういう意味だろうか？
サーバーレスについて説明するためには，まずは従来的な， "serverful" とよばれるようなシステムについて解説しなければならない．</p>
</div>
<div class="sect2">
<h3 id="chap_serverful_cloud">11.1. Serverful クラウド (従来型)</h3>
<div class="paragraph">
<p>従来的なクラウドシステムのスケッチを <a href="#serverful">Figure 77</a> に示す．
クライアントから送信されたリクエストは，最初に API サーバーに送られる．
API サーバーでは，リクエストの内容に応じてタスクが実行される．
タスクには，APIサーバーだけで完結できるものもあるが，多くの場合，データベースの読み書きが必要である．
データベースには，データベース専用の独立したサーバーマシンが用いられることが一般的である．
また，画像や動画などの容量の大きいデータは，また別のストレージサーバーに保存されることが多い．
これらの APIサーバー，データベースサーバー，ストレージサーバーはそれぞれ独立したサーバーマシンであり， AWS の言葉では EC2 による仮想インスタンスを想定してもらったらよい．</p>
</div>
<div class="paragraph">
<p>多くのウェブサービスでは，多数のクライアントからのリクエストを処理するため，複数のサーバーマシンがクラウド内で起動し，負荷を分散するような設計がなされている．
クライアントから来たリクエストを計算容量に余裕のあるサーバーに振り分けるような操作を <strong>Load balancing</strong> とよび，そのような操作を担当するマシンのことを <strong>Load balancer</strong> という．</p>
</div>
<div class="paragraph">
<p>計算負荷を分散する目的で多数のインスタンスを起動するのはよいのだが，計算負荷が小さすぎてアイドリング状態にあるようではコストと電力の無駄遣いである．
したがって，すべてのサーバーが常に目標とする計算負荷を維持するよう，計算の負荷に応じてクラスター内の仮想サーバーの数を動的に増減させるような仕組みが必要である．
そのような仕組みを<strong>クラスターのスケーリング</strong>とよび，負荷の増大に応答して新しい仮想インスタンスをクラスターに追加する操作を <strong>scale-out</strong>，負荷の減少に応答してインスタンスをシャットダウンする操作を <strong>scale-in</strong> とよぶ．
クラスターのスケーリングは， API サーバーではもちろんのこと，データベースサーバー・ストレージサーバーでも必要になる．
ストレージサーバーでは，例えば頻繁にアクセスされるデータはキャッシュ領域に保存したり，データのコピーを複数作るなどのスケーリングが行われる．
データベースサーバーも同様に，頻繁にアクセスされるデータのアクセスがパンクしてしまわないよう，分散的な処理が必要となる．
このように，<strong>クラウドシステム内すべての箇所で，負荷が均一になるような調整が必要であり，開発者は多くの時間をそのチューニングに費やさなければならない．</strong>
また，サービスの利用者の数などに応じてスケーリングの設定は常に見直される必要があり，継続的な開発が要求される．</p>
</div>
<div class="paragraph">
<p>さらに問題を複雑にするのは，APIサーバーで処理されるべきタスクが，非一様な点である．
非一様であるとは，たとえばタスクAは3000ミリ秒の実行時間と 512MB のメモリーを消費し，別のタスクBは1000ミリ秒の実行時間と 128MB のメモリーを消費する，というような状況を指している．
一つのサーバーマシンが計算負荷が異なる複数のタスクを処理する場合，クラスターのスケーリングはより複雑になる．
この状況をシンプルにするために，１サーバーで実行するタスクは１種類に限る，という設計も可能であるが，そうするとで生まれる弊害も多い
(ほとんど使われないタスクに対してもサーバー一台をまるまる割り当てなければならない = ほとんどアイドリング状態になってしまう，など)．</p>
</div>
<div id="serverful" class="imageblock text-center">
<div class="content">
<img src="imgs/serverful.png" alt="serverful" width="700">
</div>
<div class="title">Figure 77. Serverful なクラウドシステム</div>
</div>
</div>
<div class="sect2">
<h3 id="_serverless_クラウドへ">11.2. Serverless クラウドへ</h3>
<div class="paragraph">
<p><a href="#chap_serverful_cloud">Section 11.1</a> で議論したように，クラスターのスケーリングはクラウドシステムの経済的効率とシステムの安定性を最大化するために必須の作業である．
それを反映して，多くの開発者の時間が投資されてきた．</p>
</div>
<div class="paragraph">
<p>クラスターのスケーリングはすべての開発者が何度も繰り返し行ってきた作業であり，いくつかの側面をテンプレート化し，共通化することができたならば開発のコストを大幅に削減できるだろう．
それを実現するには，根本的なレベルからクラウドシステムの設計を考え直す必要がある．
<strong>スケーリングを前提</strong>として考えることで，もっと<strong>シンプルで見通しがよいクラウドシステムの設計の仕組みはないだろうか</strong>？
そのような動機が，サーバーレスアーキテクチャが誕生する背後にあった．</p>
</div>
<div class="paragraph">
<p>従来の serverful なシステムでの最大の問題点は，<strong>サーバーをまるまる占有してしまう</strong>という点にある．
すなわち， EC2 インスタンスを起動したとき，そのインスタンスは起動したユーザーだけが使えるものであり，<strong>計算のリソース (CPUやRAM) が独占的に割り当てられた状態</strong>になる．
固定した計算資源の割り当てがされてしまっているので，<strong>インスタンスの計算負荷が0%であろうが100%であろうが，均一の使用料金が起動時間に比例</strong>して発生する．</p>
</div>
<div class="paragraph">
<p>サーバーレスアーキテクチャは，このような <strong>独占的に割り当てられた計算リソースというものを完全に廃止する</strong>ことを出発点とする．
サーバーレスアーキテクチャでは，計算のリソースは，クラウドプロバイダーがすべて管理する．
クライアントは，仮想インスタンスを一台まるごと借りるのではなく，計算のタスクの需要が生まれる毎に，<strong>実行したいプログラム・コマンドをクラウドに提出する</strong>．
クラウドプロバイダーは，自身のもつ巨大な計算リソースから空きを探し，提出されたプログラムを実行し，実行結果をクライアントに返す．
言い換えると，計算リソースのスケーリングやアロケーションなどはクラウドプロバイダーが一手に引き受け，ユーザーはジョブをサブミットすることに注力する，という枠組みである．
これを図示すると， <a href="#serverless">Figure 78</a> のようになる．</p>
</div>
<div id="serverless" class="imageblock text-center">
<div class="content">
<img src="imgs/serverless.png" alt="serverless" width="700">
</div>
<div class="title">Figure 78. 従来のクラウドと Serverless クラウドの比較</div>
</div>
<div class="paragraph">
<p>サーバーレスクラウドでは，スケーリングはすべてクラウドプロバイダーが引き受けるので，スケーラビリティーが保証されている．
クライアントが同時に大量のタスクを送信した場合でも，クラウドプロバイダー側の独自の仕組みによってすべてのタスクが遅延なく実行される．
また，サーバーレスクラウドを利用することで，<strong>クラウドのコストは実際に使用した計算の総量 (稼働時間) で決定される</strong>ことになる．
これは，計算の実行総量に関わらずインスタンスの起動時間で料金が決定されていた従来のシステムと比べて大きな違いである．</p>
</div>
<div class="paragraph">
<p>サーバーレスクラウドは，従来のクラウドとは根本から異なったアプローチなので，コードの書き方やシステムの設計が大きく異なる．
サーバーレスクラウドを開発・運用するには，サーバーレス固有の概念や用語に精通している必要がある．
以降では，実際にクラウドを動かしながら，サーバーレスをより具体的に体験していこう．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>従来型の(仮想インスタンスをたくさん起動するような)クラウドシステムは，<strong>賃貸</strong>と似ているかもしれない．
部屋を借りるというのは，その部屋でどれだけの時間を過ごそうが，月々の家賃は一定である．
同様に，仮想サーバーも，それがどれほどの計算を行っているかに関わらず，一定の料金が時間ごとに発生する．</p>
</div>
<div class="paragraph">
<p>一方で，サーバーレスクラウドは，<strong>電気・水道・ガス料金</strong> と似ている．
こちらは，実際に使用した量に比例して料金が決定されている．
サーバーレスクラウドも，実際に計算を行った総時間で料金が決まる仕組みになっている．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_サーバーレスクラウドを構成するコンポーネント">11.3. サーバーレスクラウドを構成するコンポーネント</h3>
<div class="paragraph">
<p>サーバーレスアーキテクチャの概要がわかってきたところで，ここでは AWS においてサーバーレスクラウドを構成する様々なコンポーネントを紹介していこう．
特に， <strong>Lambda</strong>, <strong>S3</strong>, <strong>DynamoDB</strong> を取り上げ，解説する (<a href="#fig:serverless_logos">Figure 79</a>)．
サーバーレスクラウドは，これらのコンポーネントを統合することで一つのシステムが出来上がる．
ここでは， Lambda，S3，DynamoDB を利用する際に押さえておかなければならない知識を一通り説明しきる都合上，具体的なイメージがわきにくいかもしれない．
が，続く <a href="#sec_intro_serverless">Section 12</a> でそれぞれについてハンズオン形式で演習を行うので，そこでさらに理解を深めれば大丈夫である．</p>
</div>
<div id="fig:serverless_logos" class="imageblock">
<div class="content">
<img src="imgs/serverless_logos.png" alt="Lambda" width="500">
</div>
<div class="title">Figure 79. Lambda, S3, DynamoDB のアイコン</div>
</div>
<div class="sect3">
<h4 id="_lambda">11.3.1. Lambda</h4>
<div class="paragraph">
<p>AWS でサーバーレスコンピューティングの中心を担うのが， <a href="https://aws.amazon.com/lambda/">Lambda</a> である．
Lambda の使い方を <a href="#lambda_workflow">Figure 80</a> に図示している．
Lambda の仕組みはシンプルで，まずユーザーは実行したいプログラムのコードを事前に登録しておく．
プログラムは， Python, Node.js, Ruby などの主要な言語がサポートされている．
Lambda に登録されたひとつひとつのプログラムを関数 (Function) とよぶ．
そして，関数を実行したいときに，invoke コマンドを Lambda に送信する．
Lambda では， invoke のリクエストを受け取るとただちに (数ミリセカンドから数百ミリセカンド程度の時間で) プログラムの実行を開始する．
そして，実行結果をクライアントやその他の計算機に返す．</p>
</div>
<div id="lambda_workflow" class="imageblock text-center">
<div class="content">
<img src="imgs/lambda_workflow.png" alt="lambda_workflow" width="500">
</div>
<div class="title">Figure 80. AWS Lambda</div>
</div>
<div class="paragraph">
<p>このように，Lambda では占有された仮想インスタンスは存在せず，実行を待っているプログラムだけがある状態である．
invoke のリクエストに応じて，プログラムが AWS の巨大な計算機プールのどこかに配置され，実行される．
同時に複数のリクエストが来た場合でも， AWS はそれらを実行するための計算リソースを割り当て，並列的に処理を行ってくれる．
原理上は，<strong>数千から数万のリクエストが同時に来たとしても， Lambda はそれらを同時に実行することができる</strong>．
このような，占有された仮想サーバーの存在なしに，動的に関数を実行するサービスのことを総称して <strong>FaaS (Function as a Service)</strong> とよぶ．</p>
</div>
<div class="paragraph">
<p>Lambda ではそれぞれの関数につき， 128MB から 10240MB のメモリーを使用することができる (執筆時点の仕様)．
また，実効的な CPU のパワーはメモリーの量に比例する形で割り当てられる．
すなわち，タスクに割り当てたメモリーの量が多ければ多いほど，より多くの CPU リソースが割り当てられることになる
(しかし， RAM と CPU パワーの具体的な換算表は AWS からは公開されていない)．
実行時間は100ミリ秒の単位で記録され，実行時間に比例して料金が決定される．
<a href="#lambda_pricing">Table 8</a> は Lambda の利用料金表である (執筆時点で <code>ap-north-east1</code> リージョンを選択した場合)．</p>
</div>
<table id="lambda_pricing" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Lambda の料金表</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Memory (MB)</th>
<th class="tableblock halign-left valign-top">Price per 100ms</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">128</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$0.0000002083</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">512</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$0.0000008333</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1024</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$0.0000016667</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3008</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$0.0000048958</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>実行時間に比例する料金に追加して，リクエストを送信するごとに発生する料金が設定されている．
これは，百万回のリクエストにつき $0.2 である．
たとえば， 128MB のメモリーを使用する関数を，それぞれ200ミリ秒，合計で100万回実行した場合，
0.0000002083 * 2 * 10^6 + 0.2 = $0.6 の料金となる．
ウェブサーバーのデータベースの更新など簡単な計算であれば，200ミリ秒程度で実行できる関数も多いことから，100万回データベースの更新を行ったとしても，たった $0.6 しかコストが発生しないことになる．
また，コードが実行されず待機状態になっている場合は，発生する料金は0である．
このように，実際に意味のある処理が行われた時間にのみ，料金が発生する仕組みになっている．</p>
</div>
<div class="paragraph">
<p>Lambda は比較的短時間で完了する，反復性の高いタスクの実行に向いている．
データベースの読み書きはその典型的な例であるが，そのほかにも，画像のサイズをトリミングしたり，サーバーサイドで定期的に実行されるメンテナンス処理などの利用が考えられる．
また，複数の Lambda をリレー式に繋げることも可能で，シンプルな処理を組み合わせることで複雑なロジックを表現することができる．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>上述の Lambda の料金計算は，説明のためコストに寄与する要素をいくつか省いている点は承知いただきたい．
例えば， DynamoDB の読み書きに関する料金や，ネットワークの通信にかかわるコストが考慮されていない．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_サーバーレスストレージ_s3">11.3.2. サーバーレスストレージ: S3</h4>
<div class="paragraph">
<p>サーバーレスの概念は，ストレージにも拡張されている．</p>
</div>
<div class="paragraph">
<p>従来的なストレージ (ファイルシステム) では，必ずホストとなるマシンと OS が存在しなければならない．
したがって，それほどパワーは必要ないまでも，ある程度の CPU リソースを割かなければならない．
また，従来的なファイルシステムでは，データ領域のサイズは最初にディスクを初期化するときに決めなければならず，後から容量を増加させることはしばしば困難である
(ZFS などのファイルシステムを使えばある程度は自由にファイルシステムのサイズを変更することは可能である)．
よって，従来的なクラウドでは，ストレージを借りる際にはあらかじめディスクのサイズを指定せねばならず，ディスクの中身が空であろうと満杯であろうと，同じ利用料金が発生することになる (<a href="#fig:s3_vs_filesystem">Figure 81</a>)．</p>
</div>
<div class="paragraph">
<p><a href="https://aws.amazon.com/s3/">Simple Storage Service (S3)</a> は，サーバーレスなストレージシステムを提供する (<a href="#fig:s3_vs_filesystem">Figure 81</a>)．
S3 は従来的なストレージシステムと異なり， OS に"マウントする”という概念はない．
基本的に API を通じてデータの読み書きの操作が行われる．
また，データの冗長化や暗号化，バックアップの作成など，通常ならば OS と CPU が介在しなければならない操作も， API を通じて行うことができる．
S3 では事前に決められたディスク領域のサイズはなく，データを入れれば入れた分だけ，保存領域は拡大していく
(仕様上はペタバイトスケールのデータを保存することが可能である)．
ストレージにかかる料金は，保存してあるデータの総容量で決定される．</p>
</div>
<div id="fig:s3_vs_filesystem" class="imageblock text-center">
<div class="content">
<img src="imgs/s3_vs_filesystem.png" alt="s3_vs_filesystem" width="700">
</div>
<div class="title">Figure 81. S3 と従来的なファイルシステムの比較</div>
</div>
<div class="paragraph">
<p>S3 を利用する際に，料金に関わってくる主要な事項をまとめたのが <a href="#tab:s3_pricing">Table 9</a> である
(<code>us-east-1</code> リージョンのもの．
説明のため主要な事項のみ取り出している．
詳細は
<a href="https://aws.amazon.com/s3/pricing/?nc=sn&amp;loc=4">公式ドキュメンテーション "Amazon S3 pricing"</a>
を参照)．</p>
</div>
<table id="tab:s3_pricing" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. S3 の利用料金</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項目</th>
<th class="tableblock halign-left valign-top">料金</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data storage (First 50TB)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$0.023 per GB per month</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUT, COPY, POST, LIST requests (per 1,000 requests)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$0.005</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET, SELECT, and all other requests (per 1,000 requests)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$0.0004</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data Transfer IN To Amazon S3 From Internet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data Transfer OUT From Amazon S3 To Internet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$0.09 per GB</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>第一に，データの保存には $0.025 per GB のコストが月ごとに発生する．
したがって，1000GB のデータを S3 に一ヵ月保存した場合， $25 の料金が発生することになる．
また，<code>PUT</code>, <code>COPY</code>, <code>POST</code> などのリクエスト (=データを書き込む操作) に対しては，データ容量に関係なく，1000回ごとに $0.005 のコストが発生する．
<code>GET</code>, <code>SELECT</code> などのリクエスト (=データを読み込む操作) に対しては，1000回ごとに $0.0004 のコストが発生する．
また， S3 はデータを外に取り出す際の通信にもコストが生じる．
執筆時点では，S3 からインターネットを通じて外部にデータを転送 (data-out) すると $0.09 per GB のコストが発生する．
データをインターネットを通じて S3 に入れる (data-in) 通信は無料で行える．
また， AWS の 同じ Region 内のサービス (Lambda や EC2 など) にデータを転送するのは無料である．
AWS のリージョンをまたいだデータの転送にはコストが発生する．
いずれにせよ，サーバーレスの概念に則り，すべての料金が従量課金制で決定される設定になっている．</p>
</div>
</div>
<div class="sect3">
<h4 id="_サーバーレスデータベース_dynamodb">11.3.3. サーバーレスデータベース: DynamoDB</h4>
<div class="paragraph">
<p>サーバーレスの概念は，データベースにも適用することができる．</p>
</div>
<div class="paragraph">
<p>ここでいうデータベースとは， Web サービスなどにおけるユーザーや商品の情報を記録しておくための保存領域のことを指している．
従来的に有名なデータベースとしては
<a href="https://www.mysql.com/">MySQL</a>,
<a href="https://www.postgresql.org/">PostgreSQL</a>,
<a href="https://www.mongodb.com/">MongoDB</a>
などが挙げられる．
データベースと普通のストレージの違いは，データの検索機能にある．
普通のストレージではデータは単純にディスクに書き込まれるだけだが，
データベースでは検索がより効率的になるようなデータの配置がされたり，
頻繁にアクセスされるデータはメモリーにキャッシュされるなどの機能が備わっている．
これにより，巨大なデータの中から，興味のある要素を高速に取得することができる．</p>
</div>
<div class="paragraph">
<p>このような検索機能を実現するには，当然 CPU の存在が必須である．
したがって，従来的なデータベースを構築する際は，ストレージ領域に加えて，たくさんの CPU コアを搭載したマシンが用いられることが多い．
また，データベースが巨大な場合は複数マシンにまたがった分散型のシステムが設計される．
分散型システムの場合は， <a href="#chap_serverful_cloud">Section 11.1</a> で議論したようにデータベースへのアクセス負荷に応じて適切なスケーリングがなされる必要がある．</p>
</div>
<div class="paragraph">
<p><a href="https://aws.amazon.com/dynamodb/">DynamoDB</a> は， AWS が提供しているサーバーレスな分散型データベースである．
サーバーレスであるので，占有されたデータベース用仮想インスタンスは存在せず， API を通じてデータの書き込み・読み出し・検索などの操作を行う．
S3 と同様に，データ保存領域の上限は定められておらず，データを入れれば入れた分だけ，保存領域は拡大していく．
また，データベースへの負荷が増減したときのスケーリングは， DynamoDB が自動で行うので，ユーザーは心配する必要はない．</p>
</div>
<div class="paragraph">
<p>DynamoDB での利用料金の計算はやや複雑なのだが， "On-demand Capacity" というモードで使用した場合の料金に関わってくる主要な事項をまとめたのが <a href="#tab:dynamodb_pricing">Table 10</a> である
(<code>us-east-1</code> リージョンのもの．
詳細は
<a href="https://aws.amazon.com/dynamodb/pricing/on-demand/">公式ドキュメンテーション "Pricing for On-Demand Capacity"</a>
を参照)．</p>
</div>
<table id="tab:dynamodb_pricing" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. DynamoDB の利用料金</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">項目</th>
<th class="tableblock halign-left valign-top">料金</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write request units</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$1.25 per million write request units</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read request units</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$0.25 per million read request units</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data storage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$0.25 per GB-month</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>DynamoDB ではデータの書き込み操作の単位を write request unit とよび，データの読み込み操作の単位を read request unit とよぶ．
基本的に， 1kB 以下のデータを一度書き込むと 1 write request unit を消費し，4kB 以下のデータを一度読み込むと 1 read request unit を消費する
(詳しくは
<a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.ReadWriteCapacityMode.html">公式ドキュメンテーション "Read/Write Capacity Mode"</a>
を参照のこと)．
write request units は100万回ごとに $1.25, read request units は100万回ごとに $0.25 のコストが設定されている．
また，保存されたデータ容量に対して $0.25 per GB のコストが月ごとに発生する．
DynamoDB は高速な検索機能などを備えたデータベースであるので， GB あたりのストレージコストは S3 に比べ10倍程度高い．
DynamoDB のデータの転送に関わるコストは，同じリージョン内ならば data-in，data-out ともに $0 である．
リージョンをまたいだ通信には別途コストが発生する．</p>
</div>
</div>
<div class="sect3">
<h4 id="_その他のサーバーレスクラウドの構成要素">11.3.4. その他のサーバーレスクラウドの構成要素</h4>
<div class="paragraph">
<p>以上で紹介した Lambda, S3, DynamoDB がサーバーレスクラウドの中で最も使用する頻度が高いサービスになる．
その他のサーバーレスクラウドの構成要素を以下に列挙する．
いくつかについては，今後のハンズオンを行う中で改めて解説を行う．</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://aws.amazon.com/api-gateway/">API Gateway</a>: API を構築する際のルーティングを担う．
<a href="#sec_bashoutter">Section 13</a> で取り上げる．</p>
</li>
<li>
<p><a href="https://aws.amazon.com/fargate/">Fargate</a>: <a href="#sec_fargate_qabot">Section 8</a> で触れた Fargate も，サーバーレスクラウドの要素の一部である．
Lambda との違いは，Lambda よりも大容量のメモリーや CPU を要するような計算などを行うことができる点が挙げられる．</p>
</li>
<li>
<p><a href="https://aws.amazon.com/sns/">Simple Notification Service (SNS)</a>: サーバーレスのサービス間でイベントをやり取りするためのサービス．</p>
</li>
<li>
<p><a href="https://aws.amazon.com/step-functions/">Step Functions</a>: サーバーレスのサービス間のオーケストレーションを担う．</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>サーバーレスアーキテクチャは万能か？</strong></p>
</div>
<div class="paragraph">
<p>この問いへの答えは，筆者は NO であると考える．</p>
</div>
<div class="paragraph">
<p>ここまで，サーバーレスの利点を強調して説明をしてきたが，まだまだ新しい技術なだけに，欠点，あるいはサーバーフルなシステムに劣る点は数多くある．</p>
</div>
<div class="paragraph">
<p>大きな欠点を一つあげるとすれば，サーバーレスのシステムは各クラウドプラットフォームに固有なものなので，特定のプラットフォームでしか運用できないシステムになってしまう点であろう．
AWS で作成したサーバーレスのシステムを， Google のクラウドに移植するには，かなり大掛かりなプログラムの書き換えが必要になる．
一方， serverful なシステムであれば，プラットフォーム間のマイグレーションは比較的簡単に行うことができる．
クラウドプロバイダーとしては，自社のシステムへの依存度を強めることで，顧客を離さないようにするという狙いがあるのだろう&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>その他，サーバーレスコンピューティングの欠点や今後の課題などは，次の論文で詳しく議論されている．
興味のある読者はぜひ読んでいただきたい．</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://arxiv.org/abs/1812.03651">Hellerstein et al., "Serverless Computing: One Step Forward, Two Steps Back" arXiv (2018)</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec_intro_serverless">12. Hands-on #5: サーバーレス入門</h2>
<div class="sectionbody">
<div class="paragraph">
<p>前章ではサーバーレスアーキテクチャの概要の説明を行った．
本章では，ハンズオン形式でサーバーレスクラウドを実際に動かしながら，具体的な使用方法を学んでいこう．
今回のハンズオンでは Lambda, S3, DynamoDB の三つのサーバーレスクラウドの構成要素に触れていく．
それぞれについて，短いチュートリアルを用意してある．</p>
</div>
<div class="sect2">
<h3 id="_lambda_ハンズオン">12.1. Lambda ハンズオン</h3>
<div class="paragraph">
<p>まずは， Lambda を実際に動かしてみよう．
ハンズオンのソースコードは GitHub の
<a href="https://github.com/tomomano/learn-aws-by-coding/tree/main/handson/serverless/lambda">handson/serverless/lambda</a>
に置いてある．</p>
</div>
<div class="paragraph">
<p>このハンズオンで使用するアプリケーションのスケッチを <a href="#fig:lambda_deploy">Figure 82</a> に示す．
STEP 1 では，AWS CDK を使用して Python で書かれたコードを Lambda に登録する．
続いて STEP 2 では， Invoke API を使用して，同時にいくつもの Lambda を起動し，並列な計算を行う．
Lambda のワークフローを体験する目的で最小限の設定である．</p>
</div>
<div id="fig:lambda_deploy" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-serverless/lambda_deploy.png" alt="lambda_deploy" width="700">
</div>
<div class="title">Figure 82. Lambda チュートリアルの概要</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このハンズオンは，基本的に <a href="https://aws.amazon.com/free/?all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc">AWS Lambda の無料枠</a> の範囲内で実行することができる．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/serverless/lambda/app.py">app.py</a> にデプロイするプログラムが書かれている．
中身を見てみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="code"><pre><i class="conum" data-value="1"></i><b>(1)</b>
<span class="n">FUNC</span> <span class="o">=</span> <span class="s">"""
import time
from random import choice, randint
def handler(event, context):
    time.sleep(randint(2,5))
    sushi = ["salmon", "tuna", "squid"]
    message = "Welcome to Cloud Sushi. Your order is " + choice(sushi)
    print(message)
    return message
"""</span>

<span class="k">class</span> <span class="nc">SimpleLambda</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Stack</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">App</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">_lambda</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">'LambdaHandler'</span><span class="p">,</span>
            <span class="n">runtime</span><span class="o">=</span><span class="n">_lambda</span><span class="o">.</span><span class="n">Runtime</span><span class="o">.</span><span class="n">PYTHON_3_7</span><span class="p">,</span>
            <span class="n">code</span><span class="o">=</span><span class="n">_lambda</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">from_inline</span><span class="p">(</span><span class="n">FUNC</span><span class="p">),</span>
            <span class="n">handler</span><span class="o">=</span><span class="s">"index.handler"</span><span class="p">,</span>
            <span class="n">memory_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">Duration</span><span class="o">.</span><span class="n">seconds</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
            <span class="n">dead_letter_queue_enabled</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ここで， Lambda で実行されるべき関数を定義している．
これは非常に単純な関数で，2-5秒のランダムな時間スリープした後，["salmon", "tuna", "squid"] のいずれかの文字列をランダムに選択し， "Welcome to Cloud Sushi. Your order is XXXX" (XXXX は選ばれた寿司のネタ) というメッセージをリターンする．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>次に， Lambda に &lt;1&gt; で書いた関数を配置している．
パラメータの意味は，文字どおりの意味なので難しくはないが，以下に解説する．
<div class="ulist">
<ul>
<li>
<p><code>runtime=_lambda.Runtime.PYTHON_3_7</code>:
ここでは， Python3.7 を使って上記で定義された関数を実行せよ，と指定している．
Python3.7 のほかに， Node.js, Java, Ruby, Go などの言語を指定することが可能である．</p>
</li>
<li>
<p><code>code=_lambda.Code.from_inline(FUNC)</code>:
実行されるべき関数が書かれたコードを指定する．
ここでは， <code>FUNC=&#8230;&#8203;</code> で定義した文字列を渡しているが，文字列以外にもファイルのパスを渡すことも可能である．</p>
</li>
<li>
<p><code>handler="index.handler"</code>:
これは，コードの中にいくつかのサブ関数が含まれているときに，メインとサブを区別するためのパラメータである．
<code>handler</code> という名前の関数をメイン関数として実行せよ，という意味である．</p>
</li>
<li>
<p><code>memory_size=128</code>:
メモリーは 128MB を最大で使用することを指定している．</p>
</li>
<li>
<p><code>timeout=core.Duration.seconds(10)</code>
タイムアウト時間を10秒に設定している．
10秒以内に関数の実行が終了しなかった場合，エラーが返される．</p>
</li>
<li>
<p><code>dead_letter_queue_enabled=True</code>:
アドバンストな設定なので説明は省略する．</p>
</li>
</ul>
</div></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>上記のプログラムを実行することで， Lambda 関数がクラウド上に作成される．
早速デプロイしてみよう．</p>
</div>
<div class="sect3">
<h4 id="_デプロイ">12.1.1. デプロイ</h4>
<div class="paragraph">
<p>デプロイの手順は，これまでのハンズオンとほとんど共通である．
ここでは，コマンドのみ列挙する (<code>#</code> で始まる行はコメントである)．
それぞれの意味を忘れてしまった場合は，ハンズオン1, 2に戻って復習していただきたい．
シークレットキーの設定も忘れずに (<a href="#aws_cli_install">Section 15.3</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c"># プロジェクトのディレクトリに移動</span>
<span class="nv">$ </span><span class="nb">cd </span>handson/serverless/lambda

<span class="c"># venv を作成し，依存ライブラリのインストールを行う</span>
<span class="nv">$ </span>python3 <span class="nt">-m</span> venv .env
<span class="nv">$ </span><span class="nb">source</span> .env/bin/activate
<span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt

<span class="c"># デプロイを実行</span>
<span class="nv">$ </span>cdk deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>デプロイのコマンドが無事に実行されれば， <a href="#handson_04_lambda_cdk_output">Figure 83</a> のような出力が得られるはずである．
ここで表示されている <code>SimpleLambda.FunctionName = XXXX</code> の XXXX の文字列は後で使うのでメモしておこう．</p>
</div>
<div id="handson_04_lambda_cdk_output" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-serverless/handson_04_lambda_cdk_output.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 83. CDKデプロイ実行後の出力</div>
</div>
<div class="paragraph">
<p>AWS コンソールにログインして，デプロイされたスタックを確認してみよう．
コンソールから，Lambda のページに行くと <a href="#handson_04_lambda_console_func_list">Figure 84</a> のような画面から Lambda の関数の一覧が確認できる．</p>
</div>
<div id="handson_04_lambda_console_func_list" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-serverless/lambda_console_func_list.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 84. Lambda コンソール - 関数の一覧</div>
</div>
<div class="paragraph">
<p>今回のアプリケーションで作成したのが <code>SimpleLambda</code> で始まるランダムな名前のついた関数だ．
関数の名前をクリックして，詳細を見てみる．
すると <a href="#handson_04_lambda_console_func_detail">Figure 85</a> のような画面が表示されるはずだ．
先ほどプログラムの中で定義したPythonの関数がエディターから確認できる．
さらに下の方にスクロールすると，関数の各種設定も確認できる．</p>
</div>
<div id="handson_04_lambda_console_func_detail" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-serverless/lambda_console_func_detail.png" alt="lambda_console_func_detail" width="700">
</div>
<div class="title">Figure 85. Lambda コンソール - 関数の詳細</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Lambda で実行されるコードは， Lambda のコンソール画面 (<a href="#handson_04_lambda_console_func_detail">Figure 85</a>) のエディターで編集することもできる．
デバッグをするときなどは，こちらを直接いじる方が早い場合もある．
その場合は， CDK のコードに行った編集を反映させなおすことを忘れずに．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_lambda_関数の実行">12.1.2. Lambda 関数の実行</h4>
<div class="paragraph">
<p>それでは，作成した Lambda 関数を実行 (invoke) してみよう．
AWS の API を使うことで，関数の実行をスタートすることができる．
今回は，
<a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/serverless/lambda/invoke_one.py">handson/serverless/lambda/invoke_one.py</a>
に関数を実行するための簡単なプログラムを提供している．
興味のある読者はコードを読んでもらいたい．</p>
</div>
<div class="paragraph">
<p>以下のコマンドで，Lambda の関数を実行する．
コマンドの <code>XXXX</code> の部分は，先ほどデプロイしたときに <code>SimpleLambda.FunctionName = XXXX</code> で得られた XXXX の文字列で置換する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python invoke_one.py XXXX</code></pre>
</div>
</div>
<div class="paragraph">
<p>すると， <code>"Welcome to Cloud Sushi. Your order is salmon"</code> という出力が得られるはずだ．
とてもシンプルではあるが，クラウド上で先ほどの関数が走り，乱数が生成されたうえで，ランダムな寿司ネタが選択されて出力が返されている．
このコマンドを何度か打ってみて，実行ごとに異なる寿司ネタが返されることを確認しよう．</p>
</div>
<div class="paragraph">
<p>さて，このコマンドは，一度につき一回の関数を実行したわけであるが， Lambda の本領は一度に大量のタスクを同時に実行できる点である．
そこで，今度は一度に100個のタスクを同時に送信してみよう．
<a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/serverless/lambda/invoke_many.py">handson/serverless/lambda/invoke_many.py</a>
のスクリプトを使用する．</p>
</div>
<div class="paragraph">
<p>次のコマンドを実行しよう．
XXXX の部分は前述と同様に置き換える．
第二引数の <code>100</code> は 100個のタスクを投入せよ，という意味である．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python invoke_many.py XXXX 100</code></pre>
</div>
</div>
<div class="paragraph">
<p>すると次のような出力が得られるはずだ．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">....................................................................................................
Submitted 100 tasks to Lambda!</code></pre>
</div>
</div>
<div class="paragraph">
<p>実際に，100 個のタスクが同時に実行されていることを確認しよう．
<a href="#handson_04_lambda_console_func_detail">Figure 85</a> の画面に戻り， "Monitoring" というタブがあるので，それをクリックする．
すると， <a href="#handson_04_lambda_console_monitoring">Figure 86</a> のようなグラフが表示されるだろう．</p>
</div>
<div id="handson_04_lambda_console_monitoring" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-serverless/lambda_console_monitoring.png" alt="lambda_console_monitoring" width="700">
</div>
<div class="title">Figure 86. Lambda コンソール - 関数の実行のモニタリング</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="#handson_04_lambda_console_monitoring">Figure 86</a> のグラフの更新には数分かかることがあるので，なにも表示されない場合は少し待つ．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="#handson_04_lambda_console_monitoring">Figure 86</a> で "Invocations" が関数が何度実行されたかを意味している．
たしかに100回実行されていることがわかる．
さらに， "Concurrent executions" は何個のタスクが同時に行われたかを示している．
ここでは 96 となっていることから，96個のタスクが並列的に実行されたことを意味している
(これが 100 とならないのは，タスクの開始のコマンドが送られたのが完全には同タイミングではないことに起因する)．</p>
</div>
<div class="paragraph">
<p>このように，非常にシンプルではあるが， Lambda を使うことで，同時並列的に処理を実行することのできるクラウドシステムを簡単に作ることができた．</p>
</div>
<div class="paragraph">
<p>もしこのようなことを従来的な serverful なクラウドで行おうとした場合，クラスターのスケーリングなど多くのコードを書くことに加えて，いろいろなパラメータを調節する必要がある．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>興味がある人は，一気に1000個などのジョブを投入してみるとよい．
Lambda はそのような大量のリクエストにも対応できることが確認できるだろう．
が，あまりやりすぎると Lambda の無料利用枠を超えて料金が発生してしまうので注意．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_スタックの削除_3">12.1.3. スタックの削除</h4>
<div class="paragraph">
<p>最後にスタックを削除しよう．
スタックを削除するには，次のコマンドを実行すればよい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>cdk destroy</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec:dynamodb_tutorial">12.2. DynamoDB ハンズオン</h3>
<div class="paragraph">
<p>続いて， DynamoDB の簡単なチュートリアルをやってみよう．
ハンズオンのソースコードは GitHub の
<a href="https://github.com/tomomano/learn-aws-by-coding/tree/main/handson/serverless/dynamodb">/handson/serverless/dynamodb</a>
に置いてある．</p>
</div>
<div class="paragraph">
<p>このハンズオンで使用するアプリケーションのスケッチを <a href="#fig:dynamodb_deploy">Figure 87</a> に示す．
STEP 1 では，AWS CDK を使用して DynamoDB のテーブルを初期化し，デプロイする．
続いて STEP 2 では， API を使用してデータベースのデータの書き込み・読み出し・削除などの操作を練習する．</p>
</div>
<div id="fig:dynamodb_deploy" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-serverless/dynamodb_deploy.png" alt="dynamodb_deploy" width="700">
</div>
<div class="title">Figure 87. DynamoDB チュートリアルの概要</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このハンズオンは，基本的に <a href="https://aws.amazon.com/free/?all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc">AWS DynamoDB の無料枠</a> の範囲内で実行できる．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/serverless/dynamodb/app.py">handson/serverless/dynamodb/app.py</a>
にデプロイするプログラムが書かれている．
中身を見てみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">SimpleDynamoDb</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Stack</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">App</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">table</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"SimpleTable"</span><span class="p">,</span>
            <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="n">partition_key</span><span class="o">=</span><span class="n">ddb</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s">"item_id"</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">ddb</span><span class="o">.</span><span class="n">AttributeType</span><span class="o">.</span><span class="n">STRING</span>
            <span class="p">),</span>
            <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="n">billing_mode</span><span class="o">=</span><span class="n">ddb</span><span class="o">.</span><span class="n">BillingMode</span><span class="o">.</span><span class="n">PAY_PER_REQUEST</span><span class="p">,</span>
            <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="n">removal_policy</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">RemovalPolicy</span><span class="o">.</span><span class="n">DESTROY</span>
        <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>このコードで，最低限の設定がなされた空の DynamoDB テーブルが作成される．
それぞれのパラメータの意味を簡単に解説しよう．</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>partition_key</code>:
すべての DynamoDB テーブルには Partition key が定義されていなければならない．
Partition key とは，テーブル内の要素 (レコード) ごとに存在する固有のIDのことである．
同一の Partition key をもった要素がテーブルの中に二つ以上存在することはできない
(注: Sort Key を使用している場合は除く．詳しくは <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.CoreComponents.html">公式ドキュメンテーション "Core Components of Amazon DynamoDB"</a> 参照)．
また， Partition key が定義されていない要素はテーブルの中に存在することはできない．
ここでは， Partition key に <code>item_id</code> という名前をつけている．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>billing_mode</code>:
<code>ddb.BillingMode.PAY_PER_REQUEST</code> を指定することで，
<a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.ReadWriteCapacityMode.html#HowItWorks.OnDemand">On-demand Capacity Mode</a>
の DynamoDB が作成される．
ほかに <code>PROVISIONED</code> というモードがあるが，これはかなり高度なケースを除いて使用しないだろう．</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>removal_policy</code>: CloudFormation のスタックが消去されたときに， DynamoDB も一緒に消去されるかどうかを指定する．
このコードでは <code>DESTROY</code> を選んでいるので，すべて消去される．
ほかのオプションを選択すると，スタックを消去しても DynamoDB のバックアップを残す，などの動作を定義することができる．</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="sec:serverless_dynamodb_deploy">12.2.1. デプロイ</h4>
<div class="paragraph">
<p>デプロイの手順は，これまでのハンズオンとほとんど共通である．
ここでは，コマンドのみ列挙する (<code>#</code> で始まる行はコメントである)．
シークレットキーの設定も忘れずに (<a href="#aws_cli_install">Section 15.3</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c"># プロジェクトのディレクトリに移動</span>
<span class="nv">$ </span><span class="nb">cd </span>handson/serverless/dynamodb

<span class="c"># venv を作成し，依存ライブラリのインストールを行う</span>
<span class="nv">$ </span>python3 <span class="nt">-m</span> venv .env
<span class="nv">$ </span><span class="nb">source</span> .env/bin/activate
<span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt

<span class="c"># デプロイを実行</span>
<span class="nv">$ </span>cdk deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>デプロイのコマンドが無事に実行されれば， <a href="#handson_04_dynamodb_cdk_output">Figure 88</a> のような出力が得られるはずである．
ここで表示されている <code>SimpleDynamoDb.TableName = XXXX</code> の XXXX の文字列は後で使うのでメモしておこう．</p>
</div>
<div id="handson_04_dynamodb_cdk_output" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-serverless/handson_04_dynamodb_cdk_output.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 88. CDKデプロイ実行後の出力</div>
</div>
<div class="paragraph">
<p>AWS コンソールにログインして，デプロイされたスタックを確認してみよう．
コンソールから， DynamoDB のページに行き，左のメニューバーから "Tables" を選択する．
すると， <a href="#handson_04_dynamodb_table_list">Figure 89</a> のような画面からテーブルの一覧が確認できる．</p>
</div>
<div id="handson_04_dynamodb_table_list" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-serverless/dynamodb_table_list.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 89. DynamoDB のコンソール (テーブルの一覧)</div>
</div>
<div class="paragraph">
<p>今回のアプリケーションで作成したのが <code>SimpleDynamoDb</code> で始まるランダムな名前のついたテーブルだ．
テーブルの名前をクリックして，詳細を見てみる．
すると <a href="#handson_04_dynamodb_table_detail">Figure 90</a> のような画面が表示されるはずだ．
"Items" のタブをクリックすると，テーブルの中のレコードを確認できる．
現時点ではなにもデータを書き込んでいないので，空である．</p>
</div>
<div id="handson_04_dynamodb_table_detail" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-serverless/dynamodb_table_detail.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 90. DynamoDB のコンソール (テーブルの詳細画面)</div>
</div>
</div>
<div class="sect3">
<h4 id="_データの読み書き">12.2.2. データの読み書き</h4>
<div class="paragraph">
<p>それでは， <a href="#sec:serverless_dynamodb_deploy">Section 12.2.1</a> で作ったテーブルを使ってデータの読み書きを実践してみよう．
ここでは Python と <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html">boto3</a> ライブラリを用いた方法を紹介する．</p>
</div>
<div class="paragraph">
<p>まずは，テーブルに新しい要素を追加してみよう．
ハンズオンのディレクトリにある
<a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/serverless/dynamodb/simple_write.py">simple_write.py</a>
を開いてみよう．
中には次のような関数が書かれている．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
<span class="n">ddb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">'dynamodb'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write_item</span><span class="p">(</span><span class="n">table_name</span><span class="p">):</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span>
    <span class="n">Item</span><span class="o">=</span><span class="p">{</span>
        <span class="s">'item_id'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
        <span class="s">'first_name'</span><span class="p">:</span> <span class="s">'John'</span><span class="p">,</span>
        <span class="s">'last_name'</span><span class="p">:</span> <span class="s">'Doe'</span><span class="p">,</span>
        <span class="s">'age'</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>コードを上から読んでいくと，まず最初に boto3 ライブラリをインポートし， <code>dynamodb</code> のリソースを呼び出している．
<code>write_item()</code> 関数は， DynamoDB のテーブルの名前 (上で見たSimpleDynamoDb-XXXX) を引数として受け取る．
そして， <code>put_item()</code> メソッドを呼ぶことで，新しいアイテムを DB に書き込んでいる．
アイテムには <code>item_id</code>, <code>first_name</code>, <code>last_name</code>, <code>age</code> の4つの属性が定義されている．
ここで， <code>item_id</code> は先ほど説明した Partition key に相当しており，
<a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">UUID4</a>
を用いたランダムな文字列を割り当てている．</p>
</div>
<div class="paragraph">
<p>では， <code>simple_write.py</code> を実行してみよう．
"XXXX" の部分を自分がデプロイしたテーブルの名前 (<code>SimpleDynamoDb</code> で始まる文字列) に置き換えたうえで，次のコマンドを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python simple_write.py XXXX</code></pre>
</div>
</div>
<div class="paragraph">
<p>新しい要素が正しく書き込めたか， AWS コンソールから確認してみよう．
<a href="#handson_04_dynamodb_table_detail">Figure 90</a> と同じ手順で，テーブルの中身の要素の一覧を表示する．
すると <a href="#fig:dynamodb_table_new_item">Figure 91</a> のように，期待通り新しい要素が見つかるだろう．</p>
</div>
<div id="fig:dynamodb_table_new_item" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-serverless/dynamodb_table_new_item.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 91. DynamoDB に新しい要素が追加されたことを確認</div>
</div>
<div class="paragraph">
<p>boto3 を使ってテーブルから要素を読みだすことも可能である．
ハンズオンのディレクトリにある
<a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/serverless/dynamodb/simple_read.py">simple_read.py</a>
を見てみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">boto3</span>
<span class="n">ddb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">'dynamodb'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">scan_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">):</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Items"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>table.scan().get("Items")</code> によって，テーブルの中にあるすべての要素を読みだしている．</p>
</div>
<div class="paragraph">
<p>次のコマンドで，このスクリプトを実行してみよう
("XXXX" の部分を正しく置き換えることを忘れずに）．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python simple_read.py XXXX</code></pre>
</div>
</div>
<div class="paragraph">
<p>先ほど書き込んだ要素が出力されることを確認しよう．</p>
</div>
</div>
<div class="sect3">
<h4 id="_大量のデータの読み書き">12.2.3. 大量のデータの読み書き</h4>
<div class="paragraph">
<p>DynamoDB の利点は，最初に述べたとおり，負荷に応じて自在にその処理能力を拡大できる点である．</p>
</div>
<div class="paragraph">
<p>そこで，ここでは一度に大量のデータを書き込む場合をシミュレートしてみよう．
<a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/serverless/dynamodb/batch_rw.py">batch_rw.py</a>
に，一度に大量の書き込みを実行するためのプログラムが書いてある．</p>
</div>
<div class="paragraph">
<p>次のコマンドを実行してみよう (XXXX は自分のテーブルの名前に置き換える)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python batch_rw.py XXXX write 1000</code></pre>
</div>
</div>
<div class="paragraph">
<p>このコマンドを実行することで，ランダムなデータが1000個データベースに書き込まれる．</p>
</div>
<div class="paragraph">
<p>さらに，データベースの検索をかけてみよう．
今回書き込んだデータには <code>age</code> という属性に1から50のランダムな整数が割り当てられている．
<code>age</code> が2以下であるような要素だけを検索し拾ってくるには，次のコマンドを実行すればよい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python batch_rw.py XXXX search_under_age 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>上の2つのコマンドを何回か繰り返し実行してみて，データベースに負荷をかけてみよう．
とくに大きな遅延なく結果が返ってくることが確認できるだろう．</p>
</div>
</div>
<div class="sect3">
<h4 id="_スタックの削除_4">12.2.4. スタックの削除</h4>
<div class="paragraph">
<p>DynamoDB で十分に遊ぶことができたら，忘れずにスタックを削除しよう．</p>
</div>
<div class="paragraph">
<p>これまでのハンズオンと同様，スタックを削除するには，次のコマンドを実行すればよい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>cdk destroy</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec:s3_tutorial">12.3. S3 ハンズオン</h3>
<div class="paragraph">
<p>最後に， S3 の簡単なチュートリアルを紹介する．
ハンズオンのソースコードは GitHub の
<a href="https://github.com/tomomano/learn-aws-by-coding/tree/main/handson/serverless/s3">handson/serverless/s3</a>
に置いてある．</p>
</div>
<div class="paragraph">
<p><a href="#fig:s3_deploy">Figure 92</a> が今回提供する S3 チュートリアルの概要である．
STEP 1 として， AWS CDK を用いて S3 に新しい空のバケット (Bucket) を作成する．
続いて STEP 2 では，データのアップロード・ダウンロードの方法を解説する．</p>
</div>
<div id="fig:s3_deploy" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-serverless/s3_deploy.png" alt="s3_deploy" width="700">
</div>
<div class="title">Figure 92. S3 チュートリアルの概要</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このハンズオンは，基本的に <a href="https://aws.amazon.com/free/?all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc">S3 の無料枠</a> の範囲内で実行することができる．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/serverless/s3/app.py">app.py</a>
にデプロイするプログラムが書かれている．
中身を見てみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">SimpleS3</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Stack</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">App</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># S3 bucket to store data
</span>        <span class="n">bucket</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"bucket"</span><span class="p">,</span>
            <span class="n">removal_policy</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">RemovalPolicy</span><span class="o">.</span><span class="n">DESTROY</span><span class="p">,</span>
            <span class="n">auto_delete_objects</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>s3.Bucket()</code> を呼ぶことによって空のバケットが新規に作成される．
上記のコードだと，バケットの名前は自動生成される．
もし，自分の指定した名前を与えたい場合は， <code>bucket_name</code> というパラメータを指定すればよい．
その際， バケットの名前はユニークでなければならない (i.e. AWS のデプロイが行われるリージョン内で名前の重複がない) 点に注意しよう．
もし，同じ名前のバケットが既に存在する場合はエラーが返ってくる．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>デフォルトでは， CloudFormation スタックが削除されたとき， S3 バケットとその中に保存されたファイルは削除されない．
これは，大切なデータを誤って消してしまうことを防止するための安全策である．
<code>cdk destroy</code> を実行したときにバケットも含めてすべて削除されるようにするには， <code>removal_policy=core.RemovalPolicy.DESTROY, auto_delete_objects=True</code> とパラメータを設定する．
結果もよく理解したうえで，自分の用途にあった適切なパラメータを設定しよう．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_デプロイ_2">12.3.1. デプロイ</h4>
<div class="paragraph">
<p>デプロイの手順は，これまでのハンズオンとほとんど共通である．
ここでは，コマンドのみ列挙する (<code>#</code> で始まる行はコメントである)．
シークレットキーの設定も忘れずに (<a href="#aws_cli_install">Section 15.3</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c"># プロジェクトのディレクトリに移動</span>
<span class="nv">$ </span><span class="nb">cd </span>handson/serverless/s3

<span class="c"># venv を作成し，依存ライブラリのインストールを行う</span>
<span class="nv">$ </span>python3 <span class="nt">-m</span> venv .env
<span class="nv">$ </span><span class="nb">source</span> .env/bin/activate
<span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt

<span class="c"># デプロイを実行</span>
<span class="nv">$ </span>cdk deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>デプロイを実行すると， <a href="#fig:s3_deploy_output">Figure 93</a> のような出力が得られるはずである．
ここで表示されている <code>SimpleS3.BucketName = XXXX</code> が，新しく作られたバケットの名前である
(今回提供しているコードを使うとランダムな名前がバケットに割り当てられる）．
これはあとで使うのでメモしておこう．</p>
</div>
<div id="fig:s3_deploy_output" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-serverless/s3_deploy_output.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 93. デプロイ実行後の出力</div>
</div>
</div>
<div class="sect3">
<h4 id="_データの読み書き_2">12.3.2. データの読み書き</h4>
<div class="paragraph">
<p>スタックのデプロイが完了したら，早速バケットにデータをアップロードしてみよう．</p>
</div>
<div class="paragraph">
<p>まずは，以下のコマンドを実行して， <code>tmp.txt</code> という仮のファイルを生成する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"Hello world!"</span> <span class="o">&gt;&gt;</span> tmp.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>ハンズオンのディレクトリにある
<a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/serverless/s3/simple_s3.py">simple_s3.py</a>
に
<a href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html">boto3</a>
ライブラリを使用した S3 のファイルのアップロード・ダウンロードのスクリプトが書いてある．
<code>simple_s3.py</code> を使って，上で作成した <code>tmp.txt</code> を以下のコマンドによりバケットにアップロードする．
<code>XXXX</code> のところは，自分自身のバケットの名前で置き換えること．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python simple_s3.py XXXX upload tmp.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>simple_s3.py</code> のアップロードを担当している部分を以下に抜粋する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">upload_file</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="n">bucket</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>bucket = s3.Bucket(bucket_name)</code> の行で <code>Bucket()</code> オブジェクトを呼び出している．
そして， <code>upload_file()</code> メソッドを呼ぶことでファイルのアップロードを実行している．</p>
</div>
<div class="paragraph">
<p>S3 においてファイルの識別子として使われるのが <strong>Key</strong> である．
これは，従来的なファイルシステムにおけるパス (Path) と相同な概念で，それぞれのファイルに固有な Key が割り当てられる必要がある．
Key という呼び方は， S3 が <a href="https://en.wikipedia.org/wiki/Object_storage">Object storage</a> と呼ばれるシステムに立脚していることに由来する．
<code>--key</code> のオプションを追加して <code>simple_s3.py</code> を実行することで， Key を指定してアップロードを実行することができる．</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ python simple_s3.py XXXX upload tmp.txt --key a/b/tmp.txt</pre>
</div>
</div>
<div class="paragraph">
<p>ここではアップロードされたファイルに <code>a/b/tmp.txt</code> という Key を割り当てている．</p>
</div>
<div class="paragraph">
<p>ここまでコマンドを実行し終えたところで，一度 AWS コンソールに行き S3 の中身を確認してみよう．
S3 のコンソールに行くと，バケットの一覧が見つかるはずである．
その中から， <code>simples3-bucket</code> から始まるランダムな名前のついたバケットを探し，クリックする．
するとバケットの中に含まれるファイルの一覧が表示される (<a href="#fig:s3_bucket_filelist">Figure 94</a>)．</p>
</div>
<div id="fig:s3_bucket_filelist" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-serverless/s3_bucket_filelist.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 94. S3 バケットの中のファイル一覧</div>
</div>
<div class="paragraph">
<p>ここで実行した2つのコマンドによって， <code>tmp.txt</code> というファイルと， <code>a/b/tmp.txt</code> というファイルが見つかることに注目しよう．
従来的なファイルシステムと似た体験を提供するため， S3 では Key が <strong>"/" (スラッシュ)</strong> によって区切られていた場合，<strong>ツリー状の階層構造</strong>によってファイルを管理することができる．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>オブジェクトストレージには本来ディレクトリという概念はない．
上で紹介した "/" による階層づけはあくまでユーザー体験向上の目的のお化粧的な機能である．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>次に，バケットからファイルのダウンロードを実行してみよう．
<code>simple_s3.py</code> を使って，以下のコマンドを実行すればよい．
<code>XXXX</code> のところは，自分自身のバケットの名前で置き換えること．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python simple_s3.py XXXX download tmp.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>simple_s3.py</code> のダウンロードを担当している部分を以下に抜粋する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="n">bucket</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>S3 からのダウンロードはシンプルで， <code>download_file()</code> メソッドを使って，ダウンロードしたい対象の Key を指定すればよい．
ローカルのコンピュータでの保存先のパスを2個目の引数として渡している．</p>
</div>
</div>
<div class="sect3">
<h4 id="_スタックの削除_5">12.3.3. スタックの削除</h4>
<div class="paragraph">
<p>以上のハンズオンで， S3 の一番基本的な使い方を紹介した．
ここまでのハンズオンが理解できたら，忘れずにスタックを削除しよう．
これまでのハンズオンと同様，スタックを削除するには，次のコマンドを実行すればよい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>cdk destroy</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec_bashoutter">13. Hands-on #6: Bashoutter</h2>
<div class="sectionbody">
<div class="paragraph">
<p>さて，最後のハンズオンとなる第六回では，これまで学んできたサーバーレスクラウドの技術を使って，簡単なウェブサービスを作ってみよう．
具体的には，人々が自分の作った俳句を投稿するSNSサービス (<strong>Bashoutter</strong> と名付ける) を作成してみよう．
Lambda, DynamoDB, S3 などの技術をすべて盛り込み，シンプルながらもサーバーレスの利点を生かしたスケーラブルな SNS アプリが誕生する．
最終的には， <a href="#handson_05_bashoutter">Figure 95</a> のような，ミニマルではあるがとても現代風な SNS サイトが完成する！</p>
</div>
<div id="handson_05_bashoutter" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-bashoutter/bashoutter.png" alt="bashoutter" width="700">
</div>
<div class="title">Figure 95. ハンズオン#6で作製する SNS アプリケーション "Bashoutter"</div>
</div>
<div class="sect2">
<h3 id="_準備_3">13.1. 準備</h3>
<div class="paragraph">
<p>ハンズオンのソースコードは GitHub の
<a href="https://github.com/tomomano/learn-aws-by-coding/tree/main/handson/bashoutter">handson/bashoutter</a>
に置いてある．</p>
</div>
<div class="paragraph">
<p>本ハンズオンの実行には，第一回ハンズオンで説明した準備 (<a href="#handson_01_prep">Section 4.1</a>) が整っていることを前提とする．
それ以外に必要な準備はない．</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このハンズオンは，基本的に <a href="https://aws.amazon.com/free/?all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc">AWS の無料枠</a> の範囲内で実行できる．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_アプリケーションの説明_4">13.2. アプリケーションの説明</h3>
<div class="sect3">
<h4 id="_api">13.2.1. API</h4>
<div class="paragraph">
<p>今回のアプリケーションでは，人々からの俳句の投稿を受け付けたり，投稿された俳句の一覧を取得する，といった機能を実装したい．
この機能を実現するための最小限の設計として， <a href="#tab_handson_05_api">Table 11</a> に示すような四つの REST API を今回は実装する．
俳句を投稿する，閲覧する，削除するという基本的なデータ操作を行うための API が完備されている．
また， <code>PATCH /haiku/{item_id}</code> は， <code>{item_id}</code> で指定された俳句に”いいね”をするために使用する．</p>
</div>
<table id="tab_handson_05_api" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Bashoutter API</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET /haiku</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">俳句の一覧を取得する</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST /haiku</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">新しい俳句を投稿する</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PATCH /haiku/{item_id}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{item_id}</code> で指定された俳句にお気に入り票を一つ入れる</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DELETE /haiku/{item_id}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{item_id}</code> で指定された俳句を削除する</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>それぞれのAPIのパラメータおよび返り値の詳細は，ハンズオンのソースコードの中の
<a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/bashoutter/specs/swagger.yml">swagger.yml</a>
に定義してある．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Open API Specification</strong> (OAS; 少し前は Swagger Specification とよばれていた) は， REST API のための記述フォーマットである．
OAS に従って API の仕様が記述されていると，簡単にドキュメンテーションを生成したり，クライアントアプリケーションを自動生成することができる．
<a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/bashoutter/specs/swagger.yml">今回用意したAPI仕様</a>
も， OAS に従って書いてある．
詳しくは
<a href="https://swagger.io/docs/specification/about/">Swagger の公式ドキュメンテーション</a>
などを参照．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="sec:bashoutter_application">13.2.2. アプリケーションアーキテクチャ</h4>
<div class="paragraph">
<p>このハンズオンで作成するアプリケーションの概要を <a href="#handson_05_architecture">Figure 96</a> に示す．</p>
</div>
<div id="handson_05_architecture" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-bashoutter/handson-05-architecture.png" alt="hands-on 05 architecture" width="600">
</div>
<div class="title">Figure 96. ハンズオン#5で作製するアプリケーションのアーキテクチャ</div>
</div>
<div class="paragraph">
<p>簡単にまとめると，次のような設計である．</p>
</div>
<div class="ulist">
<ul>
<li>
<p>クライアントからの API リクエストは， <strong>API Gateway</strong> (後述)にまず送信され， API の URI で指定された Lambda 関数へ転送される．</p>
</li>
<li>
<p>それぞれの API のパス (リソース) ごとに独立した Lambda を用意する．</p>
</li>
<li>
<p>俳句の情報 (作者，本文，投稿日時など) を記録するためのデータベース (DynamoDB) を用意する．</p>
</li>
<li>
<p>各 Lambda 関数には， DynamoDB へのアクセス権を付与する．</p>
</li>
<li>
<p>最後に，ウェブブラウザからコンテンツを表示できるよう， ウェブページの静的コンテンツを配信するための S3 バケットを用意する．クライアントはこの S3 バケットにアクセスすることで HTML/CSS/JS などのコンテンツを取得する．</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>それでは，プログラムのソースコードを見てみよう
(<a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/bashoutter/app.py">handson/bashoutter/app.py</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">Bashoutter</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Stack</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">App</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="c1"># dynamoDB table to store haiku
</span>        <span class="n">table</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"Bashoutter-Table"</span><span class="p">,</span>
            <span class="n">partition_key</span><span class="o">=</span><span class="n">ddb</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s">"item_id"</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">ddb</span><span class="o">.</span><span class="n">AttributeType</span><span class="o">.</span><span class="n">STRING</span>
            <span class="p">),</span>
            <span class="n">billing_mode</span><span class="o">=</span><span class="n">ddb</span><span class="o">.</span><span class="n">BillingMode</span><span class="o">.</span><span class="n">PAY_PER_REQUEST</span><span class="p">,</span>
            <span class="n">removal_policy</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">RemovalPolicy</span><span class="o">.</span><span class="n">DESTROY</span>
        <span class="p">)</span>

        <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="n">bucket</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"Bashoutter-Bucket"</span><span class="p">,</span>
            <span class="n">website_index_document</span><span class="o">=</span><span class="s">"index.html"</span><span class="p">,</span>
            <span class="n">public_read_access</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">removal_policy</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">RemovalPolicy</span><span class="o">.</span><span class="n">DESTROY</span>
        <span class="p">)</span>

        <span class="n">common_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"runtime"</span><span class="p">:</span> <span class="n">_lambda</span><span class="o">.</span><span class="n">Runtime</span><span class="o">.</span><span class="n">PYTHON_3_7</span><span class="p">,</span>
            <span class="s">"environment"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">"TABLE_NAME"</span><span class="p">:</span> <span class="n">table</span><span class="o">.</span><span class="n">table_name</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="c1"># define Lambda functions
</span>        <span class="n">get_haiku_lambda</span> <span class="o">=</span> <span class="n">_lambda</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"GetHaiku"</span><span class="p">,</span>
            <span class="n">code</span><span class="o">=</span><span class="n">_lambda</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">from_asset</span><span class="p">(</span><span class="s">"api"</span><span class="p">),</span>
            <span class="n">handler</span><span class="o">=</span><span class="s">"api.get_haiku"</span><span class="p">,</span>
            <span class="n">memory_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
            <span class="o">**</span><span class="n">common_params</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">post_haiku_lambda</span> <span class="o">=</span> <span class="n">_lambda</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"PostHaiku"</span><span class="p">,</span>
            <span class="n">code</span><span class="o">=</span><span class="n">_lambda</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">from_asset</span><span class="p">(</span><span class="s">"api"</span><span class="p">),</span>
            <span class="n">handler</span><span class="o">=</span><span class="s">"api.post_haiku"</span><span class="p">,</span>
            <span class="o">**</span><span class="n">common_params</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">patch_haiku_lambda</span> <span class="o">=</span> <span class="n">_lambda</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"PatchHaiku"</span><span class="p">,</span>
            <span class="n">code</span><span class="o">=</span><span class="n">_lambda</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">from_asset</span><span class="p">(</span><span class="s">"api"</span><span class="p">),</span>
            <span class="n">handler</span><span class="o">=</span><span class="s">"api.patch_haiku"</span><span class="p">,</span>
            <span class="o">**</span><span class="n">common_params</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">delete_haiku_lambda</span> <span class="o">=</span> <span class="n">_lambda</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"DeleteHaiku"</span><span class="p">,</span>
            <span class="n">code</span><span class="o">=</span><span class="n">_lambda</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">from_asset</span><span class="p">(</span><span class="s">"api"</span><span class="p">),</span>
            <span class="n">handler</span><span class="o">=</span><span class="s">"api.delete_haiku"</span><span class="p">,</span>
            <span class="o">**</span><span class="n">common_params</span><span class="p">,</span>
        <span class="p">)</span>

        <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="c1"># grant permissions
</span>        <span class="n">table</span><span class="o">.</span><span class="n">grant_read_data</span><span class="p">(</span><span class="n">get_haiku_lambda</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">grant_read_write_data</span><span class="p">(</span><span class="n">post_haiku_lambda</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">grant_read_write_data</span><span class="p">(</span><span class="n">patch_haiku_lambda</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">grant_read_write_data</span><span class="p">(</span><span class="n">delete_haiku_lambda</span><span class="p">)</span>

        <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="c1"># define API Gateway
</span>        <span class="n">api</span> <span class="o">=</span> <span class="n">apigw</span><span class="o">.</span><span class="n">RestApi</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"BashoutterApi"</span><span class="p">,</span>
            <span class="n">default_cors_preflight_options</span><span class="o">=</span><span class="n">apigw</span><span class="o">.</span><span class="n">CorsOptions</span><span class="p">(</span>
                <span class="n">allow_origins</span><span class="o">=</span><span class="n">apigw</span><span class="o">.</span><span class="n">Cors</span><span class="o">.</span><span class="n">ALL_ORIGINS</span><span class="p">,</span>
                <span class="n">allow_methods</span><span class="o">=</span><span class="n">apigw</span><span class="o">.</span><span class="n">Cors</span><span class="o">.</span><span class="n">ALL_METHODS</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">haiku</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="s">"haiku"</span><span class="p">)</span>
        <span class="n">haiku</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
            <span class="s">"GET"</span><span class="p">,</span>
            <span class="n">apigw</span><span class="o">.</span><span class="n">LambdaIntegration</span><span class="p">(</span><span class="n">get_haiku_lambda</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">haiku</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
            <span class="s">"POST"</span><span class="p">,</span>
            <span class="n">apigw</span><span class="o">.</span><span class="n">LambdaIntegration</span><span class="p">(</span><span class="n">post_haiku_lambda</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">haiku_item_id</span> <span class="o">=</span> <span class="n">haiku</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="s">"{item_id}"</span><span class="p">)</span>
        <span class="n">haiku_item_id</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
            <span class="s">"PATCH"</span><span class="p">,</span>
            <span class="n">apigw</span><span class="o">.</span><span class="n">LambdaIntegration</span><span class="p">(</span><span class="n">patch_haiku_lambda</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">haiku_item_id</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
            <span class="s">"DELETE"</span><span class="p">,</span>
            <span class="n">apigw</span><span class="o">.</span><span class="n">LambdaIntegration</span><span class="p">(</span><span class="n">delete_haiku_lambda</span><span class="p">)</span>
        <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ここで，俳句の情報を記録しておくための DynamoDB テーブルを定義している．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>静的コンテンツを配信するための S3 バケットを用意している．</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>それぞれの API で実行される Lambda 関数を定義している．
関数は Python3.7 で書かれており，コードは
<a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/bashoutter/api/api.py">handson/bashoutter/api/api.py</a>
にある．</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>&lt;3&gt; で定義された Lambda 関数に対し，データベースへの読み書きのアクセス権限を付与している．</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>ここで，API Gateway により，各APIパスとそこで実行されるべき Lambda 関数を紐付けている．</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>それぞれの項目について，もう少し詳しく説明しよう．</p>
</div>
</div>
<div class="sect3">
<h4 id="_public_access_mode_の_s3_バケット">13.2.3. Public access mode の S3 バケット</h4>
<div class="paragraph">
<p>S3 のバケットを作成しているコードを見てみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="n">bucket</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"Bashoutter-Bucket"</span><span class="p">,</span>
    <span class="n">website_index_document</span><span class="o">=</span><span class="s">"index.html"</span><span class="p">,</span>
    <span class="n">public_read_access</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">removal_policy</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">RemovalPolicy</span><span class="o">.</span><span class="n">DESTROY</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ここで注目してほしいのは <code>public_read_access=True</code> の部分だ．
前章で， S3 について説明を行ったときには触れなかったが， S3 には <strong>Public access mode</strong> という機能がある．
Public access mode をオンにしておくと，バケットの中のファイルは認証なしで (i.e. インターネット上の誰でも) 閲覧できるようになる．
この設定は，一般公開されているウェブサイトの静的なコンテンツを置いておくのに最適であり，多くのサーバーレスによるウェブサービスでこのような設計が行われる．
public access mode を設定しておくと， <code><a href="http://XXXX.s3-website-ap-northeast-1.amazonaws.com/" class="bare">http://XXXX.s3-website-ap-northeast-1.amazonaws.com/</a></code> のような固有の URL がバケットに対して付与される．
そして，クライアントがこの URL にアクセスをすると，バケットの中にある <code>index.html</code> がクライアントに返され，ページがロードされる
(どのファイルが返されるかは， <code>website_index_document="index.html"</code> の部分で設定している．)</p>
</div>
<div class="paragraph">
<p>なお，この時点ではバケットは空である．
HTML/CSS/JS など静的コンテンツの配置は，デプロイを行った後ほどのステップで行う．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>より本格的なウェブページを運用する際には， public access mode の S3 バケットに， <a href="https://aws.amazon.com/cloudfront/">CloudFront</a> という機能を追加することが一般的である．
CloudFront により，　<strong>Content Delivery Nework (CDN)</strong> や暗号化された HTTPS 通信を設定することができる．
CloudFront についての詳細は
<a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Introduction.html">公式ドキュメンテーション "What is Amazon CloudFront?"</a>
などを参照いただきたい．</p>
</div>
<div class="paragraph">
<p>今回のハンズオンでは説明の簡略化のため CloudFront の設定を行わなかったが，興味のある読者は次のリンクのプログラムが参考になるだろう．</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/aws-samples/aws-cdk-examples/tree/master/typescript/static-site" class="bare">https://github.com/aws-samples/aws-cdk-examples/tree/master/typescript/static-site</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>今回の S3 バケットには， AWS によって付与されたランダムな URL がついている．
これを． <code>example.com</code> のような自分のドメインでホストしたければ， AWS によって付与された URL を自分のドメインの DNS レコードに追加すればよい．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_api_のハンドラ関数">13.2.4. API のハンドラ関数</h4>
<div class="paragraph">
<p>API リクエストが来たときに，リクエストされた処理を行う関数のことをハンドラ (handler) 関数とよぶ．
<code>GET /haiku</code> の API に対してのハンドラ関数を Lambda で定義している部分を見てみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="n">get_haiku_lambda</span> <span class="o">=</span> <span class="n">_lambda</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"GetHaiku"</span><span class="p">,</span>
    <span class="n">code</span><span class="o">=</span><span class="n">_lambda</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">from_asset</span><span class="p">(</span><span class="s">"api"</span><span class="p">),</span>
    <span class="n">handler</span><span class="o">=</span><span class="s">"api.get_haiku"</span><span class="p">,</span>
    <span class="n">memory_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
    <span class="o">**</span><span class="n">common_params</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>簡単なところから見ていくと， <code>memory_size=512</code> の箇所でメモリーの使用量を512MBに指定している．
また， <code>code=_lambda.Code.from_asset("api")</code> によって外部のディレクトリ (<code>api/</code>) を参照せよと指定しており，
<code>handler="api.get_haiku"</code> のところで <code>api.py</code> というファイルの <code>get_haiku()</code> という関数をハンドラ関数として実行せよ，と定義している．</p>
</div>
<div class="paragraph">
<p>次に，ハンドラ関数として使用されている <code>get_haiku()</code> のコードを見てみよう
(<a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/bashoutter/api/api.py">handson/bashoutter/api/api.py</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="n">ddb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">"dynamodb"</span><span class="p">)</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">"TABLE_NAME"</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">get_haiku</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="s">"""
    handler for GET /haiku
    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>

        <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Items"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s">"description"</span><span class="p">:</span> <span class="n">f</span><span class="s">"Internal server error. {str(e)}"</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">"statusCode"</span><span class="p">:</span> <span class="n">status_code</span><span class="p">,</span>
        <span class="s">"headers"</span><span class="p">:</span> <span class="n">HEADERS</span><span class="p">,</span>
        <span class="s">"body"</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">DecimalEncoder</span><span class="p">)</span>
    <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>response = table.scan()</code> で，俳句の格納された DynamoDB テーブルから，すべての要素を取り出している．
もしなにもエラーが起きなければステータスコード200が返され，もしなにかエラーが起こればステータスコード500が返されるようになっている．</p>
</div>
<div class="paragraph">
<p>上記のような操作を，ほかの API についても繰り返すことで，すべての API のハンドラ関数が定義されている．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>GET /haiku</code> のハンドラ関数で， <code>response = table.scan()</code> という部分があるが，実はこれは最善の書き方ではない．
DynamoDB の <code>scan()</code> メソッドは，最大で 1MB までのデータしか返さない．
データベースのサイズが大きく， 1MB 以上のデータがある場合には，再帰的に <code>scan()</code> メソッドをよぶ必要がある．
詳しくは <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/dynamodb.html#DynamoDB.Table.scan">boto3 ドキュメンテーション</a> を参照．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="sec:bashoutter_iam">13.2.5. AWS における権限の管理 (IAM)</h4>
<div class="paragraph">
<p>以下の部分のコードに注目してほしい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="n">table</span><span class="o">.</span><span class="n">grant_read_data</span><span class="p">(</span><span class="n">get_haiku_lambda</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">grant_read_write_data</span><span class="p">(</span><span class="n">post_haiku_lambda</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">grant_read_write_data</span><span class="p">(</span><span class="n">patch_haiku_lambda</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">grant_read_write_data</span><span class="p">(</span><span class="n">delete_haiku_lambda</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>これまでは説明の簡略化のためにあえて触れてこなかったが， AWS には <a href="https://aws.amazon.com/iam/">IAM (Identity and Access Management)</a> という重要な概念がある．
IAM は基本的に，あるリソースがほかのリソースに対してどのような権限をもっているか，を規定するものである．
Lambdaは，デフォルトの状態ではほかのリソースにアクセスする権限をなにも有していない．
したがって， Lambda 関数が DynamoDB のデータを読み書きするためには，それを許可するような IAM が Lambda 関数に付与されていなければならない．</p>
</div>
<div class="paragraph">
<p>CDK による <code>dynamodb.Table</code> オブジェクトには <code>grant_read_write_data()</code> という便利なメソッドが備わっており，アクセスを許可したい Lambda 関数を引数としてこのメソッドを呼ぶことで，データベースへの読み書きを許可する IAM を付与することができる．
同様に，CDK の <code>s3.Bucket</code> オブジェクトにも <code>grant_read_write()</code> というメソッドが備わっており，これによってバケットへの読み書きを許可することができる．
このメソッドは，実は <a href="#sec_aws_batch">Section 9</a> で AWS Batch によるクラスターを構成した際に使用した．
興味のある読者は振り返ってコードを確認してみよう．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>各リソースに付与する IAM は，<strong>必要最低限の権限を与えるにとどめる</strong>というのが基本方針である．
これにより，セキュリティを向上させるだけでなく，意図していないプログラムからのデータベースへの読み書きを防止するという点で，バグを未然に防ぐことができる．</p>
</div>
<div class="paragraph">
<p>そのような理由により，このコードでは <code>GET</code> のハンドラー関数に対しては <code>grant_read_data()</code> によって， read 権限のみを付与している．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_api_gateway">13.2.6. API Gateway</h4>
<div class="paragraph">
<p><a href="https://aws.amazon.com/api-gateway/">API Gateway</a> とは， API の"入り口"として，APIのリクエストパスに従って Lambda や EC2 などに接続を行うという機能を担う (<a href="#fig:bashoutter_api_gateway">Figure 97</a>)．
Lambda や EC2 によって行われた処理の結果は，再び API Gateway を経由してクライアントに返される．
このように，クライアントとバックエンドサーバーの間に立ち， API のリソースパスに応じて接続先を振り分けるようなサーバーを<strong>ルーター</strong>，あるいは<strong>リバースプロキシ</strong>とよんだりする．
従来的には，ルーターにはそれ専用の仮想サーバーが置かれることが一般的であった．
しかし， API Gateway はサーバーレスなルーターとして，固定されたサーバーを配置することなく， API のリクエストが来たときのみ起動し，API のルーティングを実行する．
サーバーレスであることの当然の帰結として，アクセスの件数が増大したときにはそれにルーティングの処理能力を自動で増やす機能も備わっている．</p>
</div>
<div id="fig:bashoutter_api_gateway" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-bashoutter/api_gateway.png" alt="api_gateway" width="700">
</div>
<div class="title">Figure 97. API Gateway</div>
</div>
<div class="paragraph">
<p>API Gateway を配置することで，大量 (1秒間に数千から数万件) の API リクエストに対応することのできるシステムを容易に構築することができる．
API Gateway の料金は <a href="#tab_handson_05_apigateway_price">Table 12</a> のように設定されている．
また，無料利用枠により，月ごとに100万件までのリクエストは0円で利用できる．</p>
</div>
<table id="tab_handson_05_apigateway_price" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. API Gateway の利用料金設定 (<a href="https://aws.amazon.com/api-gateway/pricing/">参照</a>)</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Number of Requests (per month)</th>
<th class="tableblock halign-left valign-top">Price (per million)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">First 333 million</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$4.25</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Next 667 million</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$3.53</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Next 19 billion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$3.00</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Over 20 billion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$1.91</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>ソースコードの該当箇所を見てみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="code"><pre><i class="conum" data-value="1"></i><b>(1)</b>
<span class="n">api</span> <span class="o">=</span> <span class="n">apigw</span><span class="o">.</span><span class="n">RestApi</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"BashoutterApi"</span><span class="p">,</span>
    <span class="n">default_cors_preflight_options</span><span class="o">=</span><span class="n">apigw</span><span class="o">.</span><span class="n">CorsOptions</span><span class="p">(</span>
        <span class="n">allow_origins</span><span class="o">=</span><span class="n">apigw</span><span class="o">.</span><span class="n">Cors</span><span class="o">.</span><span class="n">ALL_ORIGINS</span><span class="p">,</span>
        <span class="n">allow_methods</span><span class="o">=</span><span class="n">apigw</span><span class="o">.</span><span class="n">Cors</span><span class="o">.</span><span class="n">ALL_METHODS</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<i class="conum" data-value="2"></i><b>(2)</b>
<span class="n">haiku</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="s">"haiku"</span><span class="p">)</span>
<i class="conum" data-value="3"></i><b>(3)</b>
<span class="n">haiku</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
    <span class="s">"GET"</span><span class="p">,</span>
    <span class="n">apigw</span><span class="o">.</span><span class="n">LambdaIntegration</span><span class="p">(</span><span class="n">get_haiku_lambda</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">haiku</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
    <span class="s">"POST"</span><span class="p">,</span>
    <span class="n">apigw</span><span class="o">.</span><span class="n">LambdaIntegration</span><span class="p">(</span><span class="n">post_haiku_lambda</span><span class="p">)</span>
<span class="p">)</span>

<i class="conum" data-value="4"></i><b>(4)</b>
<span class="n">haiku_item_id</span> <span class="o">=</span> <span class="n">haiku</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="s">"{item_id}"</span><span class="p">)</span>
<i class="conum" data-value="5"></i><b>(5)</b>
<span class="n">haiku_item_id</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
    <span class="s">"PATCH"</span><span class="p">,</span>
    <span class="n">apigw</span><span class="o">.</span><span class="n">LambdaIntegration</span><span class="p">(</span><span class="n">patch_haiku_lambda</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">haiku_item_id</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
    <span class="s">"DELETE"</span><span class="p">,</span>
    <span class="n">apigw</span><span class="o">.</span><span class="n">LambdaIntegration</span><span class="p">(</span><span class="n">delete_haiku_lambda</span><span class="p">)</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>最初に， <code>api = apigw.RestApi()</code> により，空の API Gateway を作成している．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>次に， <code>api.root.add_resource()</code> のメソッドを呼ぶことで， <code>/haiku</code> という API パスを追加している．</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>続いて， <code>add_method()</code> を呼ぶことで， <code>GET</code>, <code>POST</code> のメソッドを <code>/haiku</code> のパスに定義している．</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>さらに， <code>haiku.add_resource("{item_id}")</code> により， <code>/haiku/{item_id}</code> という API パスを追加している．</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>最後に， <code>add_method()</code> を呼ぶことにより， <code>PATCH</code>, <code>DELETE</code> のメソッドを <code>/haiku/{item_id}</code> のパスに定義している．</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>このように， API Gateway の使い方は非常にシンプルで，逐次的に API パスとそこで実行されるメソッド・Lambda を記述していくだけでよい．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このプログラムで 新規 API を作成すると， ランダムな URL がその API のエンドポイントとして割り当てられる．
これを． <code>api.example.com</code> のような自分のドメインでホストしたければ， AWS によって付与された URL を自分のドメインの DNS レコードに追加すればよい．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>API Gateway で新規 API を作成したとき， <code>default_cors_preflight_options=</code> というパラメータで <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">Cross Origin Resource Sharing (CORS)</a> の設定を行っている．
これは，ブラウザで走る Web アプリケーションと API を接続するときに必要な設定である．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_アプリケーションのデプロイ">13.3. アプリケーションのデプロイ</h3>
<div class="paragraph">
<p>アプリケーションの中身が理解できたところで，早速デプロイを行ってみよう．
デプロイの手順は，これまでのハンズオンとほとんど共通である．
ここでは，コマンドのみ列挙する (<code>#</code> で始まる行はコメントである)．
シークレットキーの設定も忘れずに (<a href="#aws_cli_install">Section 15.3</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c"># プロジェクトのディレクトリに移動</span>
<span class="nv">$ </span><span class="nb">cd </span>intro-aws/handson/bashoutter

<span class="c"># venv を作成し，依存ライブラリのインストールを行う</span>
<span class="nv">$ </span>python3 <span class="nt">-m</span> venv .env
<span class="nv">$ </span><span class="nb">source</span> .env/bin/activate
<span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt

<span class="c"># デプロイを実行</span>
<span class="nv">$ </span>cdk deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>デプロイのコマンドが無事に実行されれば， <a href="#handson_05_cdk_output">Figure 98</a> のような出力が得られるはずである．
ここで表示されている <code>Bashoutter.BashoutterApiEndpoint = XXXX</code>, <code>Bashoutter.BucketUrl = YYYY</code> の二つ文字列はあとで使うのでメモしておこう．</p>
</div>
<div id="handson_05_cdk_output" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-bashoutter/cdk_output.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 98. CDKデプロイ実行後の出力</div>
</div>
<div class="paragraph">
<p>AWS コンソールにログインして，デプロイされたスタックを確認してみよう．
まずは，コンソールから API Gateway のページに行く．
すると， <a href="#handson_05_apigw_console_list">Figure 99</a> のような画面が表示され，デプロイ済みの API エンドポイントの一覧が確認できる．</p>
</div>
<div id="handson_05_apigw_console_list" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-bashoutter/apigw_console_list.png" alt="apigw_console_list" width="700">
</div>
<div class="title">Figure 99. API Gateway コンソール画面 (1)</div>
</div>
<div class="paragraph">
<p>今回デプロイした "BashoutterApi" という名前の API をクリックすることで <a href="#handson_05_apigw_console_detail">Figure 100</a> のような画面に遷移し，詳細情報を閲覧できる．
<code>GET /haiku</code>, <code>POST /haiku</code> などが定義されていることが確認できる．</p>
</div>
<div class="paragraph">
<p>それぞれのメソッドをクリックすると，そのメソッドの詳細情報を確認できる．
API Gateway は，前述したルーティングの機能だけでなく，認証機能などを追加することも可能である．
このハンズオンではとくにこれらの機能は使用しないが， "Method Request" と書いてある項目などがそれに相当する．
次に， <a href="#handson_05_apigw_console_detail">Figure 100</a> で画面右端の赤色で囲った部分に，この API で呼ばれる Lambda 関数が指定されていることに注目しよう．
関数名をクリックと，該当する Lambda のコンソールに遷移し，関数の中身を閲覧することが可能である．</p>
</div>
<div id="handson_05_apigw_console_detail" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-bashoutter/apigw_console_detail.png" alt="apigw_console_detail" width="700">
</div>
<div class="title">Figure 100. API Gateway コンソール画面 (2)</div>
</div>
<div class="paragraph">
<p>次に， S3 のコンソール画面に移ってみよう．
<code>bashouter-</code> で始まるランダムな名前のバケットが見つかるはずである (<a href="#handson_05_s3_console">Figure 101</a>)．</p>
</div>
<div id="handson_05_s3_console" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-bashoutter/s3_console.png" alt="s3_console" width="700">
</div>
<div class="title">Figure 101. S3 コンソール画面</div>
</div>
<div class="paragraph">
<p>バケットの名前をクリックすることで，バケットの中身を確認してみよう．
<code>index.html</code> のほか， <code>css/</code>, <code>js/</code> などのディレクトリがあるのが確認できるだろう (<a href="#handson_05_s3_contents">Figure 102</a>)．
これらが，ウェブページの"枠"を定義している静的コンテンツである．</p>
</div>
<div id="handson_05_s3_contents" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-bashoutter/s3_contents.png" alt="s3_contents" width="700">
</div>
<div class="title">Figure 102. S3 バケットの中身</div>
</div>
</div>
<div class="sect2">
<h3 id="sec:bashoutter_test_api">13.4. API リクエストを送信する</h3>
<div class="paragraph">
<p>それでは，デプロイしたアプリケーションに対し，実際に API リクエストを送信してみよう．
まずはコマンドラインから API を送信する演習を行おう．
S3 に配置した GUI は一旦おいておく．</p>
</div>
<div class="paragraph">
<p>ここではコマンドラインから HTTP API リクエストを送信するためのシンプルなHTTPクライアントである <a href="https://httpie.org/">HTTPie</a> を使ってみよう．
HTTPie は，スタックをデプロイするときに Python 仮想環境 (venv) を作成したとき，一緒にインストールされている．
念のためインストールがうまくいっているか確認するには，仮想環境を立ち上げたあとコマンドラインに <code>http</code> と打ってみる．
ヘルプのメッセージが出力されたら準備OKである．</p>
</div>
<div class="paragraph">
<p>まず，先ほどデプロイを実行したときに得られた API のエンドポイントの URL (<code>Bashoutter.BashoutterApiEndpoint = XXXX</code> で得られた <code>XXXX</code> の文字列) をコマンドラインの変数に設定しておく．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">export </span><span class="nv">ENDPOINT_URL</span><span class="o">=</span>XXXX</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に，俳句の一覧を取得するため， <code>GET /haiku</code> の API を送信してみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>http GET <span class="s2">"</span><span class="k">${</span><span class="nv">ENDPOINT_URL</span><span class="k">}</span><span class="s2">/haiku"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>現時点では，まだだれも俳句を投稿していないので，空の配列 (<code>[]</code>) が返ってくる．</p>
</div>
<div class="paragraph">
<p>それでは次に， <code>POST /haiku</code> を使って俳句を投稿してみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>http POST <span class="s2">"</span><span class="k">${</span><span class="nv">ENDPOINT_URL</span><span class="k">}</span><span class="s2">/haiku"</span> <span class="se">\</span>
<span class="nv">username</span><span class="o">=</span><span class="s2">"松尾芭蕉"</span> <span class="se">\</span>
<span class="nv">first</span><span class="o">=</span><span class="s2">"閑さや"</span> <span class="se">\</span>
<span class="nv">second</span><span class="o">=</span><span class="s2">"岩にしみ入る"</span> <span class="se">\</span>
<span class="nv">third</span><span class="o">=</span><span class="s2">"蝉の声"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>次のような出力が得られるだろう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre>HTTP/1.1 201 Created
Connection: keep-alive
Content-Length: 49
Content-Type: application/json
....
{
    "description": "Successfully added a new haiku"
}</pre>
</div>
</div>
<div class="paragraph">
<p>新しい俳句を投稿することに成功したようである．
本当に俳句が追加されたか，再び GET リクエストを呼ぶことで確認してみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>http GET <span class="s2">"</span><span class="k">${</span><span class="nv">ENDPOINT_URL</span><span class="k">}</span><span class="s2">/haiku"</span>

HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 258
Content-Type: application/json
...
<span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">"created_at"</span>: <span class="s2">"2020-07-06T02:46:04+00:00"</span>,
        <span class="s2">"first"</span>: <span class="s2">"閑さや"</span>,
        <span class="s2">"item_id"</span>: <span class="s2">"7e91c5e4d7ad47909e0ac14c8bbab05b"</span>,
        <span class="s2">"likes"</span>: 0.0,
        <span class="s2">"second"</span>: <span class="s2">"岩にしみ入る"</span>,
        <span class="s2">"third"</span>: <span class="s2">"蝉の声"</span>,
        <span class="s2">"username"</span>: <span class="s2">"松尾芭蕉"</span>
    <span class="o">}</span>
<span class="o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>素晴らしい！</p>
</div>
<div class="paragraph">
<p>次に， <code>PATCH /haiku/{item_id}</code> を呼ぶことでこの俳句にいいねを追加してみよう．
一つ前のコマンドで取得した俳句の <code>item_id</code> を，次のコマンドの <code>XXXX</code> に代入した上で実行しよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>http PATCH <span class="s2">"</span><span class="k">${</span><span class="nv">ENDPOINT_URL</span><span class="k">}</span><span class="s2">/haiku/XXXX"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>{"description": "OK"}</code> という出力が得られるはずである．
再び GET リクエストを送ることで，いいね (<code>likes</code>) が1増えたことを確認しよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>http GET <span class="s2">"</span><span class="k">${</span><span class="nv">ENDPOINT_URL</span><span class="k">}</span><span class="s2">/haiku"</span>
...
<span class="o">[</span>
    <span class="o">{</span>
        ...
        <span class="s2">"likes"</span>: 1.0,
        ...
    <span class="o">}</span>
<span class="o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>最後に， DELETE リクエストを送ることで俳句をデータベースから削除しよう．
<code>XXXX</code> は <code>item_id</code> の値で置き換えたうえで次のコマンドを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>http DELETE <span class="s2">"</span><span class="k">${</span><span class="nv">ENDPOINT_URL</span><span class="k">}</span><span class="s2">/haiku/XXXX"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>再び GET リクエストを送ることで，返り値が空 (<code>[]</code>) になっていることを確認しよう．</p>
</div>
<div class="paragraph">
<p>これで，俳句の投稿・取得・削除そしていいねの追加，といった基本的な API がきちんと動作していることが確認できた．</p>
</div>
</div>
<div class="sect2">
<h3 id="simulating_many_apis">13.5. 大量の API リクエストをシミュレートする</h3>
<div class="paragraph">
<p>さて，前節ではマニュアルで一つずつ俳句を投稿した．
多数のユーザーがいるような SNS では，1秒間に数千件以上の投稿がされている．
今回はサーバーレスアーキテクチャを採用したことで，そのような瞬間的な大量アクセスにも容易に対応できるようなシステムが自動的に構築されている．
このポイントを実証するため，ここでは大量の API が送信された状況をシミュレートしてみよう．</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/tomomano/learn-aws-by-coding/blob/main/handson/bashoutter/client.py">handson/bashoutter/client.py</a>
に，大量のAPIリクエストをシミュレートするためのプログラムが書かれている．
このプログラムを使用すると， <code>POST /haiku</code> の API リクエストを指定された回数だけ実行することができる．</p>
</div>
<div class="paragraph">
<p>テストとして， API を300回実行してみよう．
次のコマンドを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python client.py <span class="nv">$ENDPOINT_URL</span> post_many 300</code></pre>
</div>
</div>
<div class="paragraph">
<p>数秒のうちに実行が完了するだろう．
これがもし，単一のサーバーからなる API だったとしたら，このような大量のリクエストの処理にはもっと時間がかかっただろう．
最悪の場合には，サーバーダウンにもつながっていたかもしれない．
したがって，今回作成したサーバーレスアプリケーションは，とてもシンプルながらも1秒間に数百件の処理を行えるような，スケーラブルなクラウドシステムであることがわかる．
サーバーレスでクラウドを設計することの利点を垣間見ることができただろうか？</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>先述のコマンドにより大量の俳句を投稿するとデータベースに無駄なデータがどんどん溜まってしまう．
データベースを完全に空にするには，次のコマンドを使用する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python client.py <span class="nv">$ENDPOINT_URL</span> clear_database</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_bashoutter_gui_を動かしてみる">13.6. Bashoutter GUI を動かしてみる</h3>
<div class="paragraph">
<p>前節ではコマンドラインから API を送信する演習を行った．
ウェブアプリケーションでは，これと同じことがウェブブラウザの背後で行われ，ページのコンテンツが表示されている (<a href="#fig:web_server">Figure 75</a> 参照)．
最後に， API が GUI と統合されるとどうなるのか，見てみよう．</p>
</div>
<div class="paragraph">
<p>CDK のコードで， Public access mode の S3 バケットを作成したことを思い出してほしい．
最初のステップとして，ここにウェブサイトのコンテンツをアップロードしよう．
ハンズオンのソースコードの中に <code>gui/dist</code> というフォルダが見つかるはずである．
ここにはビルド済みのウェブサイトの静的コンテンツ (HTML/CSS/JavaScript) が入っている．
AWS CLI のコマンドを使うことでこれらのファイルを S3 にアップロードしよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws s3 <span class="nb">cp</span> <span class="nt">--recursive</span> ./gui/dist s3://&lt;BUCKET_NAME&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>コマンドを実行する際は， Bashoutter ハンズオンのディレクトリから行うこと (<code>./gui/dist</code> に注目)，そして <code>&lt;BUCKET_NAME&gt;</code> にはデプロイした自身のバケットの名前が入る点に注意．
念のため，AWS コンソールにログインし，バケットにファイルがアップロードされている点を確認しておこう．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>なお，今回は GUI の説明はとくに行わないが， Bashoutter のウェブサイトは <a href="https://vuejs.org/">Vue.js</a> と <a href="https://vuetifyjs.com/">Vuetify</a> という UI フレームワークを使って作成した．
Vue を使うことで， Single page application (SPA) の技術でウェブサイトの画面がレンダリングされる．
ソースコードは
<a href="https://github.com/tomomano/learn-aws-by-coding/tree/main/handson/bashoutter/gui">handson/bashoutter/gui</a>
のディレクトリの中にあるので，興味のある読者は確認してみるとよい．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>アップトードが完了したところで，続いてデプロイを実行したときにコマンドラインの出力を見直してみよう．
<code>Bashoutter.BucketUrl=</code> で与えられた URL が見つかるはずである (<a href="#handson_05_cdk_output">Figure 98</a>)．
これは，先述したとおり， Public access mode の S3 バケットの URL である．</p>
</div>
<div class="paragraph">
<p>ウェブブラウザを開き，アドレスバーに S3 の URL を入力しへアクセスしてみよう．
すると， <a href="#handson_05_bashoutter_2">Figure 103</a> のようなページが表示されるはずである．</p>
</div>
<div id="handson_05_bashoutter_2" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-bashoutter/bashoutter_2.png" alt="bashoutter" width="700">
</div>
<div class="title">Figure 103. "Bashoutter" の GUI 画面</div>
</div>
<div class="paragraph">
<p>ページが表示されたら，一番上の "API Endpoint URL" と書いてあるテキストボックスに，今回デプロイした <strong>API Gateway の URL を入力</strong>する
(今回のアプリケーションでは，API Gateway の URL はランダムに割り当てられるのでこのような GUI の仕様になっている)．
そうしたら，画面の "REFRESH" と書いてあるボタンを押してみよう．
データベースに俳句が登録済みであれば，俳句の一覧が表示されるはずである．
各俳句の左下にあるハートのアイコンをクリックすることで， "like" の票を入れることができる．</p>
</div>
<div class="paragraph">
<p>新しい俳句を投稿するには，五七五と投稿者の名前を入力して， "POST" を押す．
"POST" を押した後は，再び "REFRESH" ボタンを押すことで最新の俳句のリストをデータベースから取得する．</p>
</div>
</div>
<div class="sect2">
<h3 id="_アプリケーションの削除">13.7. アプリケーションの削除</h3>
<div class="paragraph">
<p>これで， Bashoutter プロジェクトが完成した！
この SNS は，インターネットを通じて世界のどこからでもアクセスできる状態にある．
また， <a href="#simulating_many_apis">Section 13.5</a> で見たように，大量のユーザーの同時アクセスによる負荷がかかっても，柔軟にスケールが行われ遅延なく処理を行うことができる．
極めて簡素ながらも，立派なウェブサービスとしてのスペックは満たしているのである！</p>
</div>
<div class="paragraph">
<p>Bashoutter アプリを存分に楽しむことができたら，最後に忘れずにスタックを削除しよう．</p>
</div>
<div class="paragraph">
<p>コマンドラインからスタックの削除を実行するには，次のコマンドを使う．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>cdk destroy</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>CDK のバージョンによっては S3 のバケットが空でないと， <code>cdk destroy</code> がエラーを出力する場合がある．
この場合はスタックを削除する前に， S3 バケットの中身をすべて削除しなければならない．</p>
</div>
<div class="paragraph">
<p>コンソールから実行するには， S3 コンソールに行き，バケットの中身を開いたうえで，すべてのファイルを選択し， "Actions" &#8594; "Delete" を実行すればよいい．</p>
</div>
<div class="paragraph">
<p>コマンドラインから実行するには， 次のコマンドを使う．
&lt;BUCKET NAME&gt; のところは，自分の バケットの名前 ("BashoutterBucketXXXX" というパターンの名前がついているはずである) に置き換えることを忘れずに．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws s3 <span class="nb">rm</span> &lt;BUCKET NAME&gt; <span class="nt">--recursive</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_小括_3">13.8. 小括</h3>
<div class="paragraph">
<p>ここまでが，本書第三部の内容であった．</p>
</div>
<div class="paragraph">
<p>第三部では，クラウドの応用として，一般の人に使ってもらうようなウェブアプリケーション・データベースをどのようにして作るのか，という点に焦点を当てて，説明を行った．
その中で，従来的なクラウドシステムの設計と，ここ数年の最新の設計方法であるサーバーレスアーキテクチャについて解説した．
<a href="#sec_intro_serverless">Section 12</a> では， AWS でのサーバーレスの実践として， Lambda, S3, DynamoDB のハンズオンを行った．
最後に， <a href="#sec_bashoutter">Section 13</a> では，これらの技術を統合することで，完全サーバーレスなウェブアプリケーション "Bashoutter" を作成した．</p>
</div>
<div class="paragraph">
<p>これらの演習を通じて，世の中のウェブサービスがどのようにしてでき上がっているのか，少し理解が深まっただろうか？
また，そのようなウェブアプリケーションを自分が作りたいと思ったとき，今回のハンズオンがその出発点となることができたならば幸いである．</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_まとめ">14. まとめ</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="sec:appendix_settingup">15. Appendix: 環境構築</h2>
<div class="sectionbody">
<div class="paragraph">
<p>本書を読み進めるにあたって，ハンズオンのプログラムを実行するための環境を自分のローカルマシンにセットアップしなければならない．
ここでは， AWS やコマンドラインの初心者を想定して，本章で必要なソフトウェアやライブラリのインストールなどを簡単に解説する．
以下に簡単な目次を示そう．
既に環境構築が済んでいる場合は適宜読み飛ばしていただき，関係のある箇所のみ目を通せば良い．</p>
</div>
<div class="ulist">
<ul>
<li>
<p>AWS アカウントの取得 (<a href="#sec:create_aws_account">Section 15.1</a>)</p>
</li>
<li>
<p>AWS シークレットキーの作成 (<a href="#aws_secrets">Section 15.2</a>)</p>
</li>
<li>
<p>AWS CLI のインストール (<a href="#aws_cli_install">Section 15.3</a>)</p>
</li>
<li>
<p>AWS CDK のインストール (<a href="#aws_cdk_install">Section 15.4</a>)</p>
</li>
<li>
<p>WSL のインストール (<a href="#sec:install_wsl">Section 15.5</a>)</p>
</li>
<li>
<p>Docker のインストール (<a href="#sec:install_docker">Section 15.6</a>)</p>
</li>
<li>
<p>Python venv クイックガイド (<a href="#venv_quick_guide">Section 15.7</a>)</p>
</li>
<li>
<p>ハンズオン実行用の Docker image の使い方 (<a href="#sec_handson_docker">Section 15.8</a>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>使用する OS は Linux/Mac/Windows のどれを用いても構わない．
Windows のユーザーは， Windows Subsytem for Linux (WSL) を使用することを想定している (<a href="#sec:install_wsl">Section 15.5</a>)．</p>
</div>
<div class="paragraph">
<p>また，本書のハンズオンを実行するための
<a href="https://hub.docker.com/repository/docker/tomomano/labc">Docker イメージ</a>
を提供している．
これを用いると， AWS CLI/CDK や Python の設定などをスキップできるので， Docker の使用方法を知っている読者には便利だろう．</p>
</div>
<div class="sect2">
<h3 id="sec:create_aws_account">15.1. AWS アカウントの取得</h3>
<div class="paragraph">
<p>本書で提供するハンズオンを実際に自分で試すには，読者自身で AWS のアカウントの作成をする必要がある．
詳しいアカウントの作成の手順は <a href="https://aws.amazon.com/jp/register-flow/">公式のドキュメンテーション</a> に書かれているので，そちらも参照していただきたい．
以下の手順に従ってアカウントの作成を行う．</p>
</div>
<div class="paragraph">
<p>まず，ウェブブラウザから <a href="https://aws.amazon.com/console/">AWS コンソール</a> にアクセスし，右上の <code>Create an AWS Account</code> をクリックする
(<a href="#fig:aws-signup-1">Figure 104</a> で実線で囲った部分)．</p>
</div>
<div id="fig:aws-signup-1" class="imageblock text-center">
<div class="content">
<img src="imgs/signup-1.png" alt="signup-1" width="500">
</div>
<div class="title">Figure 104. サインアップ (1): AWS コンソールにアクセス</div>
</div>
<div class="paragraph">
<p>次に，遷移した先のページでメールアドレスとパスワードなどの登録を行う (<a href="#fig:aws-signup-3">Figure 105</a>)．</p>
</div>
<div id="fig:aws-signup-3" class="imageblock text-center">
<div class="content">
<img src="imgs/signup-3.png" alt="signup-3" width="500">
</div>
<div class="title">Figure 105. サインアップ (2): メールアドレス・パスワードなどの登録．</div>
</div>
<div class="paragraph">
<p>続いて，住所や電話番号などを訊かれるので，すべて入力しよう (<a href="#fig:aws-signup-4">Figure 106</a>)．</p>
</div>
<div id="fig:aws-signup-4" class="imageblock text-center">
<div class="content">
<img src="imgs/signup-4.png" alt="signup-4" width="500">
</div>
<div class="title">Figure 106. サインアップ (3): 住所・電話番号の入力</div>
</div>
<div class="paragraph">
<p>次に，クレジットカードの情報の登録を求められる (<a href="#fig:aws-signup-5">Figure 107</a>)．
個人で AWS を利用する場合は，利用料金の請求はクレジットカードを経由して行われる．
クレジットカードの登録なしには AWS を使い始めることはできないことに注意．</p>
</div>
<div id="fig:aws-signup-5" class="imageblock text-center">
<div class="content">
<img src="imgs/signup-5.png" alt="signup-5" width="500">
</div>
<div class="title">Figure 107. サインアップ (4): クレジットカードの登録</div>
</div>
<div class="paragraph">
<p>次の画面では，携帯電話の SMS またはボイスメッセージを利用した本人確認が求められる (<a href="#fig:aws-signup-6">Figure 108</a>)．
希望の認証方法を選択し，自分の携帯電話番号を入力しよう．</p>
</div>
<div id="fig:aws-signup-6" class="imageblock text-center">
<div class="content">
<img src="imgs/signup-6.png" alt="signup-6" width="500">
</div>
<div class="title">Figure 108. サインアップ (5): 携帯電話による本人確認</div>
</div>
<div class="paragraph">
<p>無事に本人確認が完了すると，最後にサポートプランの選択を求められる (<a href="#fig:aws-signup-8">Figure 109</a>)．
無料の Basic support を選択しておけば問題ない．</p>
</div>
<div id="fig:aws-signup-8" class="imageblock text-center">
<div class="content">
<img src="imgs/signup-8.png" alt="signup-8" width="500">
</div>
<div class="title">Figure 109. サインアップ (6): サポートプランの選択</div>
</div>
<div class="paragraph">
<p>以上のステップにより，アカウントの作成が完了する (<a href="#fig:aws-signup-9">Figure 110</a>)．
早速ログインをして， AWS コンソールにアクセスできるか確認しておこう．</p>
</div>
<div id="fig:aws-signup-9" class="imageblock text-center">
<div class="content">
<img src="imgs/signup-9.png" alt="signup-9" width="500">
</div>
<div class="title">Figure 110. サインアップ (7): アカウントの作成が完了した</div>
</div>
</div>
<div class="sect2">
<h3 id="aws_secrets">15.2. AWS のシークレットキーの作成</h3>
<div class="paragraph">
<p>AWS シークレットキーとは， AWS CLI や AWS CDK から AWS の API を操作するときに，ユーザー認証を行うための鍵のことである．
AWS CLI/CDK を使うには，最初にシークレットキーを発行する必要がある．
AWS シークレットキーの詳細は
<a href="https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html">公式ドキュメンテーション "Understanding and getting your AWS credentials"</a>
を参照．</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>AWS コンソールにログインする．</p>
</li>
<li>
<p>画面右上のアカウント名をクリックし，表示されるプルダウンメニューから "My Security Credentials" を選択 (<a href="#fig:aws_secret_key_1">Figure 111</a>)</p>
</li>
<li>
<p>"Access keys for CLI, SDK, &amp; API access" の下にある "Create accesss key" のボタンをクリックする (<a href="#fig:aws_secret_key_2">Figure 112</a>)</p>
</li>
<li>
<p>表示された Access key ID, Secret access key を記録しておく (画面を閉じると二度と表示されない)．</p>
</li>
<li>
<p>鍵を忘れてしまった場合などは，同じ手順で再発行が可能である．</p>
</li>
<li>
<p>発行したシークレットキーは， <code>~/.aws/credentials</code> のファイルに書き込むか，環境変数に設定するなどして使う (詳しくは <a href="#aws_cli_install">Section 15.3</a>)．</p>
</li>
</ol>
</div>
<div id="fig:aws_secret_key_1" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_secret_key_1.png" alt="aws_secret_key_1" width="400">
</div>
<div class="title">Figure 111. AWS シークレットキーの発行1</div>
</div>
<div id="fig:aws_secret_key_2" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_secret_key_2.png" alt="aws_secret_key_2" width="700">
</div>
<div class="title">Figure 112. AWS シークレットキーの発行2</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>AWS Educate Starter Account</strong> を用いている場合は，次の手順でシークレットキーを確認する．</p>
</div>
<div class="ulist">
<ul>
<li>
<p>AWS Educate のコンソール画面から， <code>vocareum</code> のコンソールに移動する (<a href="#fig:vocareum_console">Figure 113</a>)．</p>
</li>
<li>
<p><code>Account Details</code> をクリックし，続いて <code>AWS CLI: Show</code> をクリックする．</p>
</li>
<li>
<p><code>aws_access_key_id</code>, <code>aws_secret_access_key</code>, <code>aws_session_token</code> が表示される (<a href="#fig:vocareum_secret">Figure 114</a>)．
ここで表示された内容を <code>~/.aws/credentials</code> にコピーする (<a href="#aws_cli_install">Section 15.3</a> 参照)．
<code>aws_session_token</code> の箇所も漏らさずコピーすること．</p>
</li>
<li>
<p>続いて， <code>~/.aws/config</code> というファイルを用意し，次の内容を書き込む．
現時点では AWS Starter Account は <code>us-east-1</code> リージョンでしか利用できないためである．</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>[default]
region = us-east-1
output = json</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>上記の説明ではプロファイル名が <code>default</code> となっていたが，これは自分の好きな名前に変更してもよい．
<code>default</code> 以外の名前を使用する場合は，コマンドを実行するときにプロファイル名を指定する必要がある (詳しくは <a href="#aws_cli_install">Section 15.3</a>)．</p>
</li>
</ul>
</div>
<div id="fig:vocareum_console" class="imageblock text-center">
<div class="content">
<img src="imgs/vocareum_console.png" alt="vocareum console" width="700">
</div>
<div class="title">Figure 113. vocareum コンソール</div>
</div>
<div id="fig:vocareum_secret" class="imageblock text-center">
<div class="content">
<img src="imgs/vocareum_secret.png" alt="vocareum secret" width="700">
</div>
<div class="title">Figure 114. vocareum から AWS シークレットキーの発行</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="aws_cli_install">15.3. AWS CLI のインストール</h3>
<div class="paragraph">
<p>読者のために，執筆時点におけるインストールの手順 (Linux 向け) を簡単に記述する．
将来のバージョンでは変更される可能性があるので，常に <a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html">公式のドキュメンテーション</a> で最新の情報をチェックすることを忘れずに．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="s2">"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"</span> <span class="nt">-o</span> <span class="s2">"awscliv2.zip"</span>
<span class="nv">$ </span>unzip awscliv2.zip
<span class="nv">$ </span><span class="nb">sudo</span> ./aws/install</code></pre>
</div>
</div>
<div class="paragraph">
<p>インストールできたか確認するため，次のコマンドを打ってバージョン情報が出力されることを確認する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws <span class="nt">--version</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>インストールができたら，次のコマンドにより初期設定を行う
(<a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html">参照</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws configure</code></pre>
</div>
</div>
<div class="paragraph">
<p>コマンドを実行すると， <code>AWS Access Key ID</code>, <code>AWS Secret Access Key</code> を入力するよう指示される．
シークレットキーの発行については <a href="#aws_secrets">Section 15.2</a> を参照．
コマンドは加えて，<code>Default region name</code> を訊いてくる．
ここには自分の好きな地域 (例えば <code>ap-northeast-1</code> =東京リージョン) を指定すればよい．
最後の <code>Default output format</code> は <code>json</code> としておくとよい．</p>
</div>
<div class="paragraph">
<p>このコマンドを完了すると， <code>~/.aws/credentials</code> と <code>~/.aws/config</code>　という名前のファイルが生成されているはずである．
念のため， <code>cat</code> コマンドを使って中身を確認してみるとよい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cat</span> ~/.aws/credentials
<span class="o">[</span>default]
aws_access_key_id <span class="o">=</span> XXXXXXXXXXXXXXXXXX
aws_secret_access_key <span class="o">=</span> YYYYYYYYYYYYYYYYYYY

<span class="nv">$ </span><span class="nb">cat</span> ~/.aws/config
<span class="o">[</span>profile default]
region <span class="o">=</span> ap-northeast-1
output <span class="o">=</span> json</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>~/.aws/credentials</code> には認証鍵の情報が， <code>~/.aws/config</code> には AWS CLI の設定が記録されている．</p>
</div>
<div class="paragraph">
<p>デフォルトでは， <code>[default]</code> という名前でプロファイルが保存される．
いくつかのプロファイルを使い分けたければ， default の例に従って，たとえば <code>[myprofile]</code> などという名前でプロファイルを追加すればよい．</p>
</div>
<div class="paragraph">
<p>AWS CLI でコマンドを打つときに，プロファイルを使い分けるには，</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws s3 <span class="nb">ls</span> <span class="nt">--profile</span> myprofile</code></pre>
</div>
</div>
<div class="paragraph">
<p>のように， <code>--profile</code> というオプションをつけてコマンドを実行する．</p>
</div>
<div class="paragraph">
<p>いちいち <code>--profile</code> オプションをつけるのが面倒だと感じる場合は， <code>AWS_PROFILE</code> という環境変数を設定するとよい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">export </span><span class="nv">AWS_PROFILE</span><span class="o">=</span>myprofile</code></pre>
</div>
</div>
<div class="paragraph">
<p>あるいは，認証情報などを環境変数に設定するテクニックもある．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>XXXXXX
<span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>YYYYYY
<span class="nb">export </span><span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>ap-northeast-1</code></pre>
</div>
</div>
<div class="paragraph">
<p>これらの環境変数は， <code>~/.aws/credentials</code> よりも高い優先度をもつので，環境変数が設定されていればそちらの情報が使用される
(<a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html">参照</a>)．</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>AWS Educate Starter Account</strong> は <code>us-east-1</code> のリージョンのみ利用可能である (執筆時点での情報)．
よって， AWS Educate Starter Account を使用している場合は， default region を <code>us-east-1</code> に設定する必要がある．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="aws_cdk_install">15.4. AWS CDK のインストール</h3>
<div class="paragraph">
<p>読者のために，執筆時点におけるインストールの手順 (Linux 向け) を簡単に記述する．
将来のバージョンでは変更される可能性があるので，常に <a href="https://docs.aws.amazon.com/cdk/latest/guide/getting_started.html">公式のドキュメンテーション</a> で最新の情報をチェックすることを忘れずに．</p>
</div>
<div class="paragraph">
<p>Node.js がインストールされていれば，基本的に次のコマンドを実行すればよい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>npm <span class="nb">install</span> <span class="nt">-g</span> aws-cdk</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>本書のハンズオンはAWS CDK version 1.100.0 で開発した．
CDK は開発途上のライブラリなので，将来的にAPIが変更される可能性がある．
APIの変更によりエラーが生じた場合は， version 1.100.0 を使用することを推奨する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">install</span> <span class="nt">-g</span> aws-cdk@1.100</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>インストールできたか確認するため，次のコマンドを打って正しくバージョンが表示されることを確認する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>cdk <span class="nt">--version</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>インストールができたら，次のコマンドによりAWS側の初期設定を行う．
これは一度実行すればOK．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>cdk bootstrap</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>cdk bootstrap</code> を実行するときは，AWSの認証情報とリージョンが正しく設定されていることを確認する．
デフォルトでは <code>~/.aws/config</code> にあるデフォルトのプロファイルが使用される．
デフォルト以外のプロファイルを用いるときは <a href="#aws_cli_install">Section 15.3</a> で紹介したテクニックを使って切り替える．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>AWS CDK の認証情報の設定は AWS CLI と基本的に同じである．詳しくは <a href="#aws_cli_install">Section 15.3</a> を参照．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="sec:install_wsl">15.5. WSL のインストール</h3>
<div class="paragraph">
<p>本書のハンズオンではコマンドラインから AWS CLI のコマンドを実行したり， Python で書かれたプログラムを実行する．
コマンドは基本的に UNIX のターミナルを想定して書かれている．
Linux や Mac のユーザーは OS に標準搭載されているターミナルを用いれば良い．
Windows を利用している読者は，
<a href="https://docs.microsoft.com/en-us/windows/wsl/">Windows Subsystem for Linux (WSL)</a>
を利用することで，仮想の Linux 環境を構築することを推奨する．
<a href="https://www.cygwin.com/">Cygwin</a>
などの Linux 環境をエミュレートするほかのツールでも構わないが，本書のプログラムは WSL でのみ動作確認を行っている．</p>
</div>
<div class="paragraph">
<p>WSL とは， Windows の OS 上で Linux の仮想環境を起動するための， Microsoft 社が公式で提供しているソフトウェアである．
Ubuntu など希望の Linux distribution が選択でき，基本的にすべての Linux 向けに作られたプログラム・ソフトウェアを使用することができる．</p>
</div>
<div class="paragraph">
<p>執筆時点では
<a href="https://docs.microsoft.com/en-us/windows/wsl/compare-versions#whats-new-in-wsl-2">WSL 2</a>
が最新版として提供されているので，以下では WSL 2 のインストール手順を簡単に説明する．
細かな詳細などは，
<a href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">公式ドキュメンテーション</a>
を参照のこと．</p>
</div>
<div class="paragraph">
<p>前提として，使用される OS は Windows 10 (Pro または Home エディション) でなければならない．
さらに，使用している Windows 10のバージョンがWSLに対応するバージョンであるかを確認する．
X64 のシステムでは Version 1903, Build 18362 以上でなければならない．
バージョンが対応していない場合は、 Windows のアップデートを行う．</p>
</div>
<div class="paragraph">
<p>まず最初に， Administrator 権限で PowerShell を起動する (<a href="#fig:powershell">Figure 115</a>)．
左下の Windows メニューの検索バーに <code>powershell</code> と入力すると， PowerShell のプログラムが見つかるはずである，
これを右クリックし、 <code>Run as administrator</code> を選択し起動する．</p>
</div>
<div id="fig:powershell" class="imageblock text-center">
<div class="content">
<img src="imgs/wsl/powershell.png" alt="powershell" width="500">
</div>
<div class="title">Figure 115. 管理者権限での PowerShell の起動</div>
</div>
<div class="paragraph">
<p>PowerShell が起動したら、次のコマンドを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart</code></pre>
</div>
</div>
<div class="paragraph">
<p>実行して、“The operation completed successfully.” と出力されるのを確認する．
これで WSL が enable される．</p>
</div>
<div class="paragraph">
<p>次に，先ほどと同じ Administrator 権限で開いた PowerShell で次のコマンドを実行する。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart</code></pre>
</div>
</div>
<div class="paragraph">
<p>実行して， “The operation completed successfully.” と出力されるのを確認する．
これが確認出来たら、一度コンピュータを再起動する．</p>
</div>
<div class="paragraph">
<p>続いて， Linux kernel update package を次のリンクからダウンロードする．
<a href="https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi" class="bare">https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi</a></p>
</div>
<div class="paragraph">
<p>ダウンロードしたファイルをダブルクリックして実行する．
ダイアログに従ってインストールを完了させる．</p>
</div>
<div class="paragraph">
<p>そうしたら，再び PowerShell を開き次のコマンドを実行する。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">wsl <span class="nt">--set-default-version</span> 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>最後に、自分の好みの Linux distribution をインストールする．
ここでは Ubuntu 20.04 をインストールしよう．</p>
</div>
<div class="paragraph">
<p>Microsoft store のアプリを起動し，検索バーに <code>Ubuntu</code> と入力する．
Ubuntu 20.04 LTS という項目が見つかるはずなので，それを開き， “Get” ボタンをクリックする (<a href="#fig:microsoft_store">Figure 116</a>)．
しばらく待つと， Ubuntu 20.04 のインストールが完了する．</p>
</div>
<div id="fig:microsoft_store" class="imageblock text-center">
<div class="content">
<img src="imgs/wsl/microsoft_store.png" alt="microsoft_store" width="500">
</div>
<div class="title">Figure 116. Microsoft store から Ubuntu 20.04 をインストール</div>
</div>
<div class="paragraph">
<p>Ubuntu 20.04 を初回に起動すると，初期設定が自動で開始され，数分待つことになる．
初期設定が終わると，ユーザー名・パスワードを設定するようプロンプトが出るので，プロンプトに従い入力する．</p>
</div>
<div class="paragraph">
<p>これで WSL2 のインストールが完了した．
早速 WSL2 を起動してみよう．
左下の Windows メニューの検索バーに <code>Ubuntu</code> と入力すると， Ubuntu 20.04 のプログラムが見つかるはずである (<a href="#fig:ubuntu">Figure 117</a>)．
クリックして起動しよう．</p>
</div>
<div id="fig:ubuntu" class="imageblock text-center">
<div class="content">
<img src="imgs/wsl/ubuntu2004.png" alt="ubuntu2004" width="500">
</div>
<div class="title">Figure 117. Ubuntu 20.04 の起動</div>
</div>
<div class="paragraph">
<p>すると，ターミナルの黒い画面が立ち上がるだろう (<a href="#fig:wsl_window">Figure 118</a>)．
<code>ls</code>, <code>top</code> などのコマンドを打ってみて， WSL がきちんと動作していることを確認しよう．</p>
</div>
<div id="fig:wsl_window" class="imageblock text-center">
<div class="content">
<img src="imgs/wsl/wsl_window.png" alt="wsl_window" width="500">
</div>
<div class="title">Figure 118. WSL の起動画面</div>
</div>
<div class="paragraph">
<p>オプションとして，
<a href="https://docs.microsoft.com/en-us/windows/terminal/get-started">Windows Terminal</a>
というマイクロソフトから提供されているツールを使うと，より快適に WSL を使用することができる．
興味のある読者はこちらのインストールも推奨する．</p>
</div>
</div>
<div class="sect2">
<h3 id="sec:install_docker">15.6. Docker のインストール</h3>
<div class="paragraph">
<p>Docker のインストールの方法は OS によって異なる．</p>
</div>
<div class="paragraph">
<p>Mac ユーザーは， Docker Desktop をインストールする．
インストールの方法は，
<a href="https://docs.docker.com/docker-for-mac/install/">Docker のウェブサイト</a>
から， Mac 版の Docker Desktop をダウンロードし，ダウンロードされたファイルをダブルクリックし， <code>Applications</code> のフォルダにドラッグするだけで良い．
詳細は
<a href="https://docs.docker.com/docker-for-mac/install/">公式ドキュメンテーション</a>
を参照のこと．</p>
</div>
<div class="paragraph">
<p>Windows のユーザーは，Docker Desktop をインストールする．
その際， WSL 2 が事前にインストールされていなければならない．
詳細は
<a href="https://docs.docker.com/desktop/windows/install/">公式ドキュメンテーション</a>
を参照のこと．
Docker Desktop をインストールすると， WSL からも <code>docker</code> コマンドが使用できるようになる．</p>
</div>
<div class="paragraph">
<p>Linux ユーザー (特に Ubuntu ユーザー) については，インストールの方法はいくつかのアプローチがある．
<a href="https://docs.docker.com/engine/install/ubuntu/">公式ドキュメンテーション</a>
にいくつかのインストールの方法が示されているので，詳しい情報はそちらを参照いただきたい．</p>
</div>
<div class="paragraph">
<p>最も簡単な方法は， Docker が公式で提供しているインストールスクリプトを用いる方法である．
この場合，次のコマンドを実行することで Docker がインストールされる．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-fsSL</span> https://get.docker.com <span class="nt">-o</span> get-docker.sh
<span class="nv">$ </span><span class="nb">sudo </span>sh get-docker.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>デフォルトのインストールでは， root ユーザーのみが <code>docker</code> コマンドを使用できる設定になっている．
従って，コマンドには毎回 <code>sudo</code> を付け加える必要がある．
これが面倒だと感じる場合は，次のステップにより，使用するユーザーを <code>docker</code> というグループに追加する (詳細は
<a href="https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user">公式ドキュメンテーション "Post-installation steps for Linux"</a>
を参照)．</p>
</div>
<div class="paragraph">
<p>まず最初に， <code>docker</code> という名前にグループを追加する．
インストールによっては，既に <code>docker</code> グループが作られている場合もある．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>groupadd docker</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に，現在使用しているユーザーを <code>docker</code> グループに加える．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>usermod <span class="nt">-aG</span> docker <span class="nv">$USER</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>ここまでできたら，一度ログアウトし，再度ログインする．
これによって，グループの変更がターミナルのセッションに反映される．</p>
</div>
<div class="paragraph">
<p>設定が正しくできているかを確認するため，次のコマンドを実行してみる．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>docker run hello-world</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>sudo</code> なしでコンテナが実行できたならば，設定は完了である．</p>
</div>
</div>
<div class="sect2">
<h3 id="venv_quick_guide">15.7. Python <code>venv</code> クイックガイド</h3>
<div class="paragraph">
<p>他人からもらったプログラムで， numpy や scipy のバージョンが違う！などの理由で，プログラムが動かない，という経験をしたことがある人は多いのではないだろうか．
もし，自分の計算機の中に一つしか Python 環境がないとすると，プロジェクトを切り替えるごとに正しいバージョンをインストールし直さなければならず，これは大変な手間である．</p>
</div>
<div class="paragraph">
<p>コードのシェアをよりスムーズにするためには，ライブラリのバージョンはプロジェクトごとに管理されるべきである．
それを可能にするのが Python 仮想環境とよばれるツールであり， <a href="https://docs.python.org/3/tutorial/venv.html">venv</a>, <a href="https://github.com/pyenv/pyenv">pyenv</a>, <a href="https://docs.conda.io/en/latest/">conda</a> などがよく使われる．</p>
</div>
<div class="paragraph">
<p>そのなかでも， <code>venv</code> は Python に標準搭載されているのでとても便利である．
<code>pyenv</code> や <code>conda</code> は，別途インストールの必要があるが，それぞれの長所もある．</p>
</div>
<div class="paragraph">
<p><code>venv</code> を使って仮想環境を作成するには，</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python <span class="nt">-m</span> venv .env</code></pre>
</div>
</div>
<div class="paragraph">
<p>と実行する．
これにより <code>.env/</code> というディレクトリが作られ，このディレクトリに依存するライブラリが保存されることになる．</p>
</div>
<div class="paragraph">
<p>この新たな仮想環境を起動するには</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">source</span> .env/bin/activate</code></pre>
</div>
</div>
<div class="paragraph">
<p>と実行する．</p>
</div>
<div class="paragraph">
<p>シェルのプロンプトに <code>(.env)</code> という文字が追加されていることを確認しよう (<a href="#fig_venv_prompt">Figure 119</a>)．
これが， "いまあなたは venv の中にいますよ" というしるしになる．</p>
</div>
<div id="fig_venv_prompt" class="imageblock text-center">
<div class="content">
<img src="imgs/venv_shell.png" alt="venv shell" width="500">
</div>
<div class="title">Figure 119. venv を起動したときのプロンプト</div>
</div>
<div class="paragraph">
<p>仮想環境を起動すると，それ以降実行する <code>pip</code> コマンドは， <code>.env/</code> 以下にインストールされる．このようにして，プロジェクトごとに使うライブラリのバージョンを切り分けることができる．</p>
</div>
<div class="paragraph">
<p>Python では <code>requirements.txt</code> というファイルに依存ライブラリを記述するのが一般的な慣例である．他人からもらったプログラムに， <code>requirements.txt</code> が定義されていれば，</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>と実行することで，必要なライブラリをインストールし，瞬時に Python 環境を再現することができる．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>venv による仮想環境を保存するディレクトリの名前は任意に選べることができるが， <code>.env</code> という名前を用いるのが一般的である．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="sec_handson_docker">15.8. ハンズオン実行用の Docker image の使い方</h3>
<div class="paragraph">
<p>ハンズオンを実行するために必要な， Node.js, Python, AWS CDK などがインストールされた Docker image を用意した．
これを使用することで，自分のローカルマシンに諸々をインストールする必要なく，すぐにハンズオンのコードが実行できる．</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ハンズオンのいくつかのコマンドは Docker の外 = ローカルマシンのリアル環境で実行されなければならない．
それらについてはハンズオンの該当箇所に注意書きとして記してある．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Docker イメージは <a href="https://hub.docker.com/repository/docker/tomomano/labc">Docker Hub</a> においてある．
Docker イメージのビルドファイルは GitHub の
<a href="https://github.com/tomomano/learn-aws-by-coding-source-code/blob/main/docker/Dockerfile">docker/Dockerfile</a>
にある．</p>
</div>
<div class="paragraph">
<p>次のコマンドでコンテナを起動する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>docker run <span class="nt">-it</span> tomomano/labc:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>初回にコマンドを実行したときのみ，イメージが Docker Hub からダウンロード (pull) される．
二回目以降はローカルにダウンロードされたイメージが使用される．</p>
</div>
<div class="paragraph">
<p>コンテナが起動すると，次のようなインタラクティブシェルが表示されるはずである (起動時に <code>-it</code> のオプションをつけたのがポイントである)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>root@aws-handson:~$</code></pre>
</div>
</div>
<div class="paragraph">
<p>この状態で <code>ls</code> コマンドを打つと， <code>handson/</code> というディレクトリがあるはずである．
ここに <code>cd</code> する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ cd handson</pre>
</div>
</div>
<div class="paragraph">
<p>すると，各ハンズオンごとのディレクトリが見つかるはずである．</p>
</div>
<div class="paragraph">
<p>あとは，ハンズオンごとにディレクトリを移動し，ハンズオンごとの virtualenv を作成し，スタックのデプロイを行えばよい (<a href="#sec_handson_ec2_run">Section 4.4</a> など参照)．
ハンズオンごとに使用する依存ライブラリが異なるので，それぞれのハンズオンごとに virtualenv を作成するという設計になっている．</p>
</div>
<div class="paragraph">
<p>AWS の認証情報を設定することも忘れずに．
<a href="#aws_cli_install">Section 15.3</a> で記述したように， <code>AWS_ACCESS_KEY_ID</code> などの環境変数を設定するのが簡単な方法である．
あるいは，<strong>ローカルマシンの</strong> <code>~/.aws/credentials</code> に認証情報が書き込まれているなら，このディレクトリをコンテナに<strong>マウント</strong>することで，同じ認証ファイルをコンテナ内部から参照することが可能である．
この選択肢を取る場合は，次のコマンドでコンテナを起動する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>docker run <span class="nt">-it</span> <span class="nt">-v</span> ~/.aws:/root/.aws:ro tomomano/labc:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>これにより，ローカルマシンの <code>~/.aws</code> をコンテナの <code>/root/.aws</code> にマウントすることができる．
最後の <code>:ro</code> は read-only を意味する．
大切な認証ファイルが誤って書き換えられてしまわないように， read-only のフラグをつけることをおすすめする．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>/root/</code> がコンテナ環境におけるホームディレクトリである．
ここで紹介した認証ファイルをマウントするテクニックは， SSH 鍵をコンテナに渡すときなどにも使える．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_謝辞">16. 謝辞</h2>
<div class="sectionbody">
<div class="paragraph">
<p>本原稿の執筆にあたり，以下の方々からの協力を得た．この場を借りて，感謝を表したい．</p>
</div>
<div class="paragraph">
<p><strong>2021年バージョンの contributors</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>香取真知子氏 - ハンズオンプログラムの動作確認，文章校閲</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><a href="https://gitlab.com/tomomano/intro-aws">2020年バージョン</a>の contributors</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>勝俣敬寛氏 - Docker イメージの作成</p>
</li>
<li>
<p>香取真知子氏 - ハンズオンプログラムの動作確認</p>
</li>
<li>
<p><a href="https://gitlab.com/shuuji3">@shuuji3</a> - MR <a href="https://gitlab.com/tomomano/intro-aws/-/merge_requests/15">!15</a></p>
</li>
<li>
<p><a href="https://gitlab.com/takatama_jp">@takatama_jp</a> - MR <a href="https://gitlab.com/tomomano/intro-aws/-/merge_requests/14">!14</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>本書の執筆には <a href="https://asciidoctor.org/">Asciidoctor</a> を使用した．</p>
</div>
<div class="paragraph">
<p>また，本書はオープンソースの教科書として，すべての読者・ディベロッパーからのフィードバックを受け付けている．
誤植や記述の誤り，改善点など見つかったら，ぜひ <a href="https://github.com/tomomano/learn-aws-by-coding/issues">Issues</a> や <a href="https://github.com/tomomano/learn-aws-by-coding/pulls">Pull request</a> を投稿していただきたい．</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_著者紹介">17. 著者紹介</h2>
<div class="sectionbody">
<div class="paragraph">
<p>真野 智之 (Tomoyuki Mano)</p>
</div>
<div class="paragraph">
<p>情報理工学博士 (東京大学大学院情報理工学系研究科システム情報学専攻)．
2021年より日本学術振興会特別研究員 (PD) (現職)．
沖縄科学技術大学院大学 (OIST) にてポスドク研究員として働く．
現在の研究分野は神経科学・神経情報学．
趣味は料理・ランニング・鉄道・アニメ，村上春樹の熱烈な愛読家．</p>
</div>
<div class="paragraph">
<p>連絡先　<a href="mailto:tomoyukimano@gmail.com">tomoyukimano@gmail.com</a></p>
</div>
<div class="paragraph">
<p>GitHub <a href="https://github.com/tomomano" class="bare">https://github.com/tomomano</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ライセンス">18. ライセンス</h2>
<div class="sectionbody">
<div class="paragraph">
<p>本教科書およびハンズオンのソースコードは <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a> に従うライセンスで公開しています．</p>
</div>
<div class="paragraph">
<p>教育など非商用の目的での本教科書の使用や再配布は自由に行うことが可能です．
商用目的で本書の全体またはその一部を無断で転載する行為は，これを固く禁じます．</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="imgs/cc_by_nc_nd.png" alt="cc_by_nc_nd" width="400">
</div>
</div>
<style>
  .imageblock > .title {
    text-align: inherit;
  }
</style>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0<br>
Last updated 2022-09-12 14:54:16 UTC
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</body>
</html>